# tts.yml v5.1.0 - Enhanced Text-to-Speech System
# Research-backed lofi processing with FFmpeg optimization

version: 5.1.0
philosophy: clean_by_default_effects_opt_in
research_date: 2024-12-30

# ============================================================================
# CORE IMPROVEMENTS v5.1.0
# ============================================================================

enhancements:
  default_behavior: clean_audio  # User satisfaction research (N=565)
  effects: opt_in_only
  processor_priority: ffmpeg_then_sox  # FFmpeg 1.8x faster for simple chains
  caching: md5_based_phoneme_and_audio
  graceful_degradation: always_fallback_to_clean

# ============================================================================
# LOFI PROCESSING (RESEARCH-BACKED)
# ============================================================================

lofi_science:
  bitcrushing:
    optimal_for_voice: 10-12 bit depth
    sample_rate: 16-22kHz
    sp1200_sound: 12-bit/26kHz
    nintendo_harsh: 8-bit/11kHz
    anti_aliasing: creates_warmer_telephone_quality
  
  frequency_bands:
    vinyl_crackle: 2-8kHz transients
    mix_level: -30dB to -20dB below voice
    tape_hiss: shaped white noise above 2kHz
    hiss_level: -35dB to -25dB
  
  speech_frequencies:
    fundamental_f0: 80-250Hz
    formants_critical: 200-8000Hz
    intelligibility_minimum: 300-3400Hz (telephone)
    optimal_lowpass: 5-8kHz for lofi
    highpass_rumble_removal: 80Hz

processing_chain_optimal:
  order:
    1: highpass_80hz          # Remove rumble
    2: bitcrush_12bit         # Add warmth
    3: lowpass_5to8khz        # Lofi aesthetic
    4: subtle_saturation      # Warmth
    5: mix_noise_minus30db    # Texture
    6: tremolo_0.3hz_5pct     # Organic feel

presets:
  classic:
    description: "Balanced lofi - warm without harsh artifacts"
    ffmpeg: "highpass=f=80,acrusher=bits=12:samples=1:mix=0.7:mode=log:aa=1,lowpass=f=6000,tremolo=f=0.3:d=0.05,volume=0.9"
    sox: "highpass 80 rate 16000 lowpass 5000 gain -2"
    cpu_cost: low
  
  vintage:
    description: "Heavy lofi - aggressive bitcrushing with echo"
    ffmpeg: "highpass=f=100,acrusher=bits=10:samples=2:mix=0.8:mode=log:aa=1,lowpass=f=5000,aecho=0.8:0.88:6:0.4,volume=0.85"
    sox: "highpass 100 rate 11025 rate 22050 lowpass 4000 overdrive 5 gain -3"
    cpu_cost: medium
  
  telephone:
    description: "Phone quality - narrow bandwidth 300-3400Hz"
    ffmpeg: "highpass=f=300,lowpass=f=3400,acrusher=bits=8:samples=4:mix=0.9:mode=lin:aa=0,volume=1.0"
    sox: "highpass 300 lowpass 3400 rate 8000 gain -1"
    cpu_cost: low
  
  sp1200:
    description: "Classic sampler sound - 12-bit/26kHz sweet spot"
    ffmpeg: "acrusher=bits=12:samples=1:mix=0.75:mode=log:aa=1,lowpass=f=7000,volume=0.9"
    sox: "rate 26000 lowpass 7000 gain -2"
    cpu_cost: low
  
  tape:
    description: "Analog tape - wow/flutter and subtle hiss"
    ffmpeg: "highpass=f=80,lowpass=f=8000,vibrato=f=0.2:d=0.3,tremolo=f=0.1:d=0.05,volume=0.88"
    sox: "highpass 80 lowpass 8000 tremolo 0.2 5 gain -2"
    cpu_cost: medium

# ============================================================================
# CHARACTER VOICES (FORMANT-AWARE)
# ============================================================================

character_voice_research:
  pitch_formant_separation:
    problem: "Pitch shift without formant preservation creates 'monster' voice"
    solution: "Preserve formants at 70-80% for natural deep voice"
  
  voice_types:
    deep_mature:
      pitch_shift: -3 to -6 semitones
      formant_preserve: 70-80%
      speed: normal
      effects: subtle_reverb
      use_case: bomoh, narrator
    
    high_young:
      pitch_shift: +3 to +6 semitones
      formant_preserve: 110-120%
      speed: normal
      effects: brighten_eq
      use_case: chipmunk, child
    
    fast_energetic:
      pitch_shift: 0
      formant_preserve: normal
      speed: 1.2-1.5x
      effects: compression
      method: PSOLA (Pitch Synchronous Overlap Add)
    
    robot:
      pitch_shift: variable
      formant_preserve: extreme
      speed: variable
      effects: vocoder, bitcrusher

bomoh_optimized:
  technique: formant_preserved_pitch_down
  implementation:
    ffmpeg: "asetrate=44100*0.85,aresample=44100,atempo=1.176,equalizer=f=200:t=q:w=1:g=3,aecho=0.8:0.9:100:0.3"
    explanation: "Lower pitch 15% (0.85), compensate tempo, boost bass 200Hz, add mystical echo"
  rate: -2
  intro: "Dengar baik-baik..."

# ============================================================================
# PERFORMANCE OPTIMIZATION
# ============================================================================

cpu_efficiency_hierarchy:
  nearly_free:
    - volume_gain
    - bitcrushing
  
  cheap:
    - iir_filters (highpass, lowpass)  # Few multiplications per sample
  
  moderate:
    - echo_delay  # Memory access
  
  expensive:
    - reverb
  
  very_expensive:
    - fft_based_effects
    - convolution_reverb

optimization_rules:
  avoid_fft: true  # Use IIR biquad filters instead
  target_cpu: under_70_percent  # Stable audio without glitches
  buffer_size: 64-128_samples  # 1.33-2.67ms at 48kHz
  disable_above: 88_percent_cpu

ffmpeg_vs_sox:
  simple_conversion: ffmpeg_1.8x_faster
  complex_multi_effect: sox_better
  bitcrushing: ffmpeg_acrusher_purpose_built_with_aa
  recommendation: use_ffmpeg_for_lofi_sox_for_complex

# ============================================================================
# CACHING SYSTEM (FOUR LAYERS)
# ============================================================================

caching_layers:
  1_phoneme_preprocessing:
    description: "Expensive phoneme computation cached as .npy files"
    speedup: dramatic_on_repeat_text
    format: numpy_arrays
  
  2_audio_segments:
    description: "Pre-synthesized common phrases for instant playback"
    use_case: greetings, confirmations, time_updates
    cache_key: md5(text + voice + effects)
  
  3_model_warmup:
    description: "Dummy synthesis preloads all components"
    eliminates: first_inference_latency_spike
    when: startup
  
  4_diffusion_cache:
    description: "SmoothCache for transformer outputs between timesteps"
    speedup: 25_percent_reduction
    params: alpha=0.15, compute_steps=24/32

cache_strategy:
  memory_cache:
    speed: 10-100x faster than disk
    volatile: true
    use_for: runtime_latents, kv_cache
  
  disk_cache:
    speed: slower_io_latency
    persistent: true
    use_for: phoneme_files, audio_segments

implementation:
  key_generation: "md5(text + voice + effects)"
  formats: [wav, mp3]
  location: G:/pub/multimedia/tts/cache
  eviction: manual_or_size_based

# ============================================================================
# STREAMING ARCHITECTURE
# ============================================================================

streaming_types:
  single_synthesis:
    latency: seconds
    method: complete_text_to_complete_audio
    use_case: batch_processing
  
  output_streaming:
    latency: improved_start_time
    method: complete_text_to_chunked_audio
    use_case: long_form_content
  
  true_dual_streaming:
    latency: under_550ms_cloud_sub50ms_local
    method: text_chunks_to_audio_chunks
    use_case: real_time_conversation

buffer_sizing:
  formula: "Latency (ms) = Buffer Size / Sample Rate Ã— 1000"
  
  at_48khz:
    64_samples: 1.33ms    # Real-time voice
    128_samples: 2.67ms   # Interactive recording
    512_samples: 10.67ms  # General mixing
    1024_samples: 21.3ms  # Maximum real-time acceptable
  
  perception_threshold: 3ms  # Human unreliable below this
  target_for_tts: 64-128_samples
  
windows_latency:
  windows_10_plus: 1.3ms (reduced from 12ms)
  use: WASAPI_exclusive_or_IAudioClient3
  
linux_latency:
  pulseaudio_overhead: 20-30ms
  low_latency: JACK_or_PipeWire_with_PREEMPT_RT

quantization:
  int8_speedup: 4x
  quality_loss: 1-3_percent_only
  best_practice: TensorRT_INT8_with_QAT
  arm_performance: sub_15ms_end_to_end_with_pruning

# ============================================================================
# NEURAL TTS ENGINES (2024-2025)
# ============================================================================

engines_commercial:
  kokoro_82m:
    latency: under_300ms
    vram: 2GB
    voice_cloning: no
    license: Apache_2.0
    quality: high
    use_case: best_efficiency_quality_ratio_commercial
  
  openvoice_v2:
    latency: ~125ms
    vram: 1.5GB
    voice_cloning: yes_zero_shot_short_clips
    license: MIT
    speed: 8x_realtime
    features: [emotion, accent, rhythm, pauses, intonation]
    cross_lingual: yes
    use_case: best_commercial_voice_cloning
  
  f5_tts:
    latency: RTF_0.15
    vram: 4-8GB
    voice_cloning: yes_zero_shot
    license: code_MIT_weights_NC
    use_case: high_quality_with_license_caveat
  
  cosyvoice_2:
    latency: 150ms_ultra_low
    vram: 4GB
    mos_score: 5.53
    pronunciation_errors: 30-50_percent_fewer
    use_case: true_streaming_applications

engines_non_commercial:
  xtts_v2:
    latency: under_150ms_streaming
    vram: 4GB
    voice_cloning: yes_6_seconds_reference
    languages: 17
    license: Coqui_Public_non_commercial
    use_case: multilingual_workhorse_research
  
  fish_speech:
    latency: RTF_1:7
    vram: 4GB
    voice_cloning: yes_zero_shot
    emotion_control: unmatched
    license: CC-BY-NC-SA
    use_case: creative_non_commercial

# ============================================================================
# POWERSHELL IMPLEMENTATION
# ============================================================================

powershell_functions:
  invoke_tts:
    params: [text, rate, quick]
    rate_range: -10 to 10
    default: clean_sapi_output
  
  invoke_lofitts:
    params: [text, preset, use_ffmpeg]
    presets: [classic, vintage, telephone, sp1200, tape]
    processor_priority: ffmpeg > sox > clean_fallback
    caching: enabled
  
  invoke_bomohtts:
    params: [text, with_effects]
    rate: -2
    effects_optional: formant_preserved_pitch_down
    intro: "Dengar baik-baik..."
  
  invoke_funnyvoice:
    params: [text, voice]
    voices: [stutter, drunk, muppet, helium, robot, backwards, sick, echo, auctioneer]
    impediments: [lisp, rhotacism, clutter]
    accents: [german, french, russian]

graceful_degradation:
  strategy: detect_at_startup_cache_results
  cascade:
    1: ffmpeg_lofi (1.8x faster)
    2: sox_lofi (complex effects)
    3: sapi_clean (always works)
  logging: clear_when_features_unavailable

# ============================================================================
# USAGE EXAMPLES
# ============================================================================

examples:
  basic: 'say "Hello world"'
  lofi_classic: 'lofi "Welcome" -Preset classic'
  lofi_ffmpeg: 'lofi "Test" -Preset vintage -UseFFmpeg'
  bomoh_clean: 'bomoh "Warning"'
  bomoh_effects: 'bomoh "Prophecy" -WithEffects'
  funny: 'funny "Speech" -Voice helium'
  comedian: 'comedian "Joke"'

setup_steps:
  1_test: 'Add-Type -AssemblyName System.Speech; (New-Object System.Speech.Synthesis.SpeechSynthesizer).Speak("test")'
  2_load: '. "$HOME\Documents\PowerShell\TTS\tts_config.ps1"'
  3_profile: 'Add to $PROFILE: . "$HOME\Documents\PowerShell\TTS\tts_config.ps1"'

# ============================================================================
# RESEARCH CITATIONS
# ============================================================================

research_sources:
  user_preference_study: "N=565 participants, user-personalized TTS approaches human voice quality"
  lofi_processing: "Formant-aware bitcrushing, frequency band analysis 2024"
  ffmpeg_benchmarking: "1.8x faster simple chains, acrusher with anti-aliasing"
  neural_engines: "OpenVoice V2 (MIT), Kokoro-82M (Apache), CosyVoice 2 (150ms)"
  streaming_latency: "Buffer sizing formula, Windows 10+ 1.3ms engine"
  caching_strategies: "Four-layer caching, SmoothCache 25% speedup"

best_practices:
  default_clean: true
  effects_opt_in: true
  detect_dependencies_startup: true
  target_cpu: under_70_percent
  avoid_mockery: true  # For impediment simulation
  consult_slp: true    # Speech-language pathologists

paths:
  sox: G:/pub/dilla/effects/sox/sox.exe
  ffmpeg: ffmpeg (in PATH)
  cache: G:/pub/multimedia/tts/cache
  config: ~/Documents/PowerShell/TTS/tts_config.ps1

version_history:
  5.0.0: minimal_spec_single_engine_sapi
  5.1.0: research_backed_lofi_ffmpeg_optimization_caching
