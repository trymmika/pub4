<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>

  <meta charset="UTF-8"/>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>

  <meta name="mobile-web-app-capable" content="yes"/>

  <meta name="color-scheme" content="dark"/>

  <title>Radio Bergen</title>

  <meta name="theme-color" content="#000000"/>

  <meta name="description" content="Classic warp tunnel with multiple views. Tilt device for parallax."/>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìª</text></svg>"/>

  <style>

    :root{--safe-top:env(safe-area-inset-top,0px);--safe-right:env(safe-area-inset-right,0px);--safe-bottom:env(safe-area-inset-bottom,0px);--safe-left:env(safe-area-inset-left,0px);--zoom:1}

    html,body{margin:0;height:100%;background:#000;color:#dcdcdc;font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;overflow:hidden}

    canvas{position:fixed;inset:0;width:100dvw;height:100dvh;display:block;background:#000;touch-action:none;image-rendering:pixelated;transition:filter 140ms ease,transform 120ms ease;transform-origin:center;transform:scale(var(--zoom))}

    canvas.canvas-inverted{filter:invert(1) hue-rotate(180deg)}

    @keyframes start-ack{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}canvas.start-ack{animation:start-ack 240ms ease-out}

    h1.city-carousel{position:fixed;top:calc(10px + var(--safe-top));left:calc(10px + var(--safe-left));width:min(92vw,560px);height:38px;z-index:95;pointer-events:none;user-select:none;overflow:hidden;margin:0}

    .carousel-container{width:100%;height:100%;position:relative;overflow:hidden}

    .carousel-slide{height:100%;display:flex;align-items:center;justify-content:flex-start;font-weight:700;font-size:clamp(16px,4vw,28px);color:#dcdcdc;letter-spacing:.02em;transition:transform .3s ease,opacity .3s ease;position:absolute;top:0;left:0;width:100%;opacity:0;transform:translateY(100%);white-space:nowrap}

    .carousel-slide.active{opacity:1;transform:translateY(0%)}

    .ui{position:fixed;right:calc(12px + var(--safe-right));bottom:calc(10px + var(--safe-bottom));color:#dcdcdc;font:9px/1.1 ui-monospace,"SFMono-Regular",Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;text-transform:uppercase;letter-spacing:.28em;white-space:nowrap;pointer-events:none;user-select:none;text-align:right;max-width:min(72vw,800px);overflow:hidden;text-overflow:ellipsis;z-index:90;opacity:.86;background:#000;padding:0 1px}

    .ui .label{margin-right:6px}.ui .dots{display:inline-block;width:3ch;text-align:left}.ui-inverted{color:#dcdcdc!important}

    .overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.86);color:#9aa;cursor:pointer;user-select:none;z-index:1000;text-align:center;padding:16px;opacity:1;transition:opacity .18s ease}

    .overlay.ack{opacity:0}.overlay[hidden]{display:none}

    .overlay h2{margin:0 0 20px 0;font-size:32px;font-weight:300;color:#dcdcdc;transition:transform .18s ease}.overlay h2.clicked{transform:scale(1.06)}

    .swipe-hint{position:fixed;bottom:calc(50px + var(--safe-bottom));left:50%;transform:translateX(-50%);color:#9aa;font-size:16px;opacity:0;transition:opacity .5s ease;z-index:99}

    .swipe-hint.show{opacity:1}

    :focus-visible{outline:2px solid #dcdcdc;outline-offset:2px}*,*::before,*::after{box-sizing:border-box;box-shadow:none!important;text-shadow:none!important}

    @media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}

  </style>

</head>

<body>

  <noscript><div style="position:fixed;inset:0;display:grid;place-items:center;background:#000;color:#dcdcdc;">Radio Bergen requires JavaScript enabled.</div></noscript>

  <h1 class="city-carousel" id="cityCarousel" aria-live="polite">
    <div class="carousel-container">

      <span class="carousel-slide active">playlist.brgen.no</span><span class="carousel-slide">playlist.oshlo.no</span><span class="carousel-slide">playlist.trndheim.no</span>

      <span class="carousel-slide">playlist.stvanger.no</span><span class="carousel-slide">playlist.trmso.no</span><span class="carousel-slide">playlist.longyearbyn.no</span>

      <span class="carousel-slide">playlist.reykjavk.is</span><span class="carousel-slide">playlist.kobenhvn.dk</span><span class="carousel-slide">playlist.stholm.se</span>

      <span class="carousel-slide">playlist.gtebrg.se</span><span class="carousel-slide">playlist.mlmoe.se</span><span class="carousel-slide">playlist.hlsinki.fi</span>

      <span class="carousel-slide">playlist.lndon.uk</span><span class="carousel-slide">playlist.cardff.uk</span><span class="carousel-slide">playlist.mnchester.uk</span>

      <span class="carousel-slide">playlist.brmingham.uk</span><span class="carousel-slide">playlist.lverpool.uk</span><span class="carousel-slide">playlist.edinbrgh.uk</span>

      <span class="carousel-slide">playlist.glasgw.uk</span><span class="carousel-slide">playlist.amstrdam.nl</span><span class="carousel-slide">playlist.rottrdam.nl</span>

      <span class="carousel-slide">playlist.utrcht.nl</span><span class="carousel-slide">playlist.brssels.be</span><span class="carousel-slide">playlist.zrich.ch</span>

      <span class="carousel-slide">playlist.lchtenstein.li</span><span class="carousel-slide">playlist.frankfrt.de</span><span class="carousel-slide">playlist.wrsawa.pl</span>

      <span class="carousel-slide">playlist.gdnsk.pl</span><span class="carousel-slide">playlist.brdeaux.fr</span><span class="carousel-slide">playlist.mrseille.fr</span>

      <span class="carousel-slide">playlist.mlan.it</span><span class="carousel-slide">playlist.lsbon.pt</span><span class="carousel-slide">playlist.lsangeles.com</span>

      <span class="carousel-slide">playlist.newyrk.us</span><span class="carousel-slide">playlist.chcago.us</span><span class="carousel-slide">playlist.houstn.us</span>

      <span class="carousel-slide">playlist.dllas.us</span><span class="carousel-slide">playlist.austn.us</span><span class="carousel-slide">playlist.prtland.com</span>

      <span class="carousel-slide">playlist.mnneapolis.com</span>

    </div>

  </h1>

  <canvas id="canvas" aria-label="Audio-reactive warp tunnel visualizer" tabindex="0"></canvas>
  <div id="overlay" class="overlay" role="dialog" aria-labelledby="start-title" aria-modal="true" tabindex="0"><div><h2 id="start-title">Tap to start</h2></div></div>
  <div class="ui" id="ui" role="status" aria-live="polite" aria-atomic="true"><span class="label" id="uiLabel">Streaming</span><span class="dots" id="uiDots" aria-hidden="true"></span></div>

  <div class="swipe-hint" id="swipeHint">‚Üê Swipe for tracks ‚Üí</div>

  <div id="yt-player-a" aria-hidden="true" role="none" style="position:fixed;top:-10000px;left:-10000px;width:1px;height:1px;opacity:0;pointer-events:none;z-index:-1"></div>
  <div id="yt-player-b" aria-hidden="true" role="none" style="position:fixed;top:-10000px;left:-10000px;width:1px;height:1px;opacity:0;pointer-events:none;z-index:-1"></div>

  <iframe id="player-fallback-a" src="about:blank" title="YouTube audio player A (hidden)" aria-hidden="true" tabindex="-1" width="1" height="1" frameborder="0" allow="autoplay; encrypted-media; accelerometer; gyroscope; picture-in-picture; fullscreen" style="position:fixed;top:-10000px;left:-10000px;width:1px;height:1px;opacity:0;pointer-events:none;z-index:-1"></iframe>

  <iframe id="player-fallback-b" src="about:blank" title="YouTube audio player B (hidden)" aria-hidden="true" tabindex="-1" width="1" height="1" frameborder="0" allow="autoplay; encrypted-media; accelerometer; gyroscope; picture-in-picture; fullscreen" style="position:fixed;top:-10000px;left:-10000px;width:1px;height:1px;opacity:0;pointer-events:none;z-index:-1"></iframe>

  <script>
    "use strict";

    const IN_SANDBOX=false;

    const FADE_MS=3500,START_FADE_IN=true,DPR=Math.min(2,window.devicePixelRatio||1),isLowEnd=(navigator.hardwareConcurrency&&navigator.hardwareConcurrency<=2)||(navigator.deviceMemory&&navigator.deviceMemory<=2);

    (()=>{const e=document.getElementById("uiDots");if(!e)return;const s=[0,1,2,3,2,1];let i=0;const t=()=>{e.textContent=".".repeat(s[i]);i=(i+1)%s.length};t();try{clearInterval(window.__RB_DOTS_IV)}catch{}window.__RB_DOTS_IV=setInterval(t,600)})();

    const motionScale=()=>typeof matchMedia==="function"&&matchMedia("(prefers-reduced-motion: reduce)").matches?.35:1;

    class SimpleCarousel{constructor(e,i=2800){this.slides=Array.from(e.querySelectorAll(".carousel-slide"));this.i=0;this.n=this.slides.length;if(this.n>1)this.t=setInterval(()=>this.next(),i)}next(){this.slides[this.i].classList.remove("active");this.i=(this.i+1)%this.n;this.slides[this.i].classList.add("active")}}

    new SimpleCarousel(document.getElementById("cityCarousel"));

    const YOUTUBE_TRACKS=[

      {artist:"J Dilla",title:"Microphone Master",id:"9EGHwkDix78"},

      {artist:"J Dilla",title:"In Space",id:"vO2nWXCVt6o"},

      {artist:"J Dilla",title:"Timeless",id:"dbbfo9_7D8g"},

      {artist:"AFTA-1",title:"Due Time",id:"WC09qDzU9y4"},

      {artist:"Flying Lotus",title:"Massage Situation",id:"6oUx6wGCekM"},

      {artist:"Madlib",title:"Eye",id:"ScVz2mntmCE"},

      {artist:"Slum Village",title:"Players",id:"KsULjOCYdnY"},

      {artist:"Jay Electronica",title:"Exhibit A",id:"H3UIHZshNQ0"},

      {artist:"Slum Village",title:"La La (Instrumental)",id:"EYJxxHQ7sX0"},

      {artist:"Slum Village",title:"Get It Together",id:"t6T-Q6HMbEo"},

      {artist:"Slum Village",title:"Fantastic",id:"a3ISYWWYgz8"},

      {artist:"Flying Lotus",title:"me Yesterday//Corded",id:"8DgAhgmpXNA"},

      {artist:"Flying Lotus",title:"Camel",id:"fU9YRGLPDQ8"},

      {artist:"Flying Lotus",title:"Golden Diva",id:"iu4FVvR2QQs"},

      {artist:"Slum Village",title:"Worlds Full of Sadness",id:"MU3nfxsz2XA"},

      {artist:"A. Mochi & Takaaki Itoh",title:"Sarria's Mind",id:"gFKArkiz8vU"},

      {artist:"Samiyam",title:"Rounded",id:"oeaY2h_cKsg"},

      {artist:"Chase Swayze",title:"Traffic",id:"bH-30pDoQdo"},

      {artist:"Chase Swayze",title:"Underrated",id:"1jjFk2Vp5ok"},

      {artist:"Flying Lotus",title:"BTS Radio 2006",id:"6nWdggkulHk",start:1364}

    ];

    const loadYouTubeAPI=()=>{if(IN_SANDBOX||window.__YT_API_LOADED)return;window.__YT_API_LOADED=true;const s=document.createElement("script");s.src="https://www.youtube.com/iframe_api";s.async=true;document.head.appendChild(s)};

    // MP3 Playlist Detection and Parsing
    const detectMp3Playlist=async()=>{

      if(IN_SANDBOX)return null;

      let tracks=[];

      try{

        let r=await fetch("playlist.json");

        if(r.ok){

          const data=await r.json();

          if(Array.isArray(data)&&data.length>0)tracks=tracks.concat(data.map(t=>({...t,src:t.src})));

        }

      }catch{}

      try{

        let r=await fetch("playlist.m3u");

        if(r.ok){

          const text=await r.text();

          const m3uTracks=parseM3U(text);

          if(m3uTracks&&m3uTracks.length>0)tracks=tracks.concat(m3uTracks);

        }

      }catch{}

      try{

        let r=await fetch("index.json");

        if(r.ok){

          const data=await r.json();

          if(Array.isArray(data)){

            const mp3Files=data.filter(f=>typeof f==='string'&&f.toLowerCase().endsWith('.mp3'));

            tracks=tracks.concat(mp3Files.map(f=>{

              const name=f.replace(/\.mp3$/i,'').replace(/[-_]/g,' ');

              return{title:name,artist:'',src:f};

            }));

          }else if(data.files&&Array.isArray(data.files)){

            const mp3Files=data.files.filter(f=>typeof f==='string'&&f.toLowerCase().endsWith('.mp3'));

            tracks=tracks.concat(mp3Files.map(f=>{

              const name=f.replace(/\.mp3$/i,'').replace(/[-_]/g,' ');

              return{title:name,artist:'',src:f};

            }));

          }

        }

      }catch{}

      return tracks.length>0?tracks:null;

    };

    const parseM3U=(text)=>{
      const lines=text.split('\n').map(l=>l.trim()).filter(l=>l);

      const tracks=[];

      let current={};

      for(const line of lines){

        if(line.startsWith('#EXTINF:')){

          const info=line.substring(8);

          const parts=info.split(',');

          if(parts.length>=2){

            current.title=parts[1].trim();

            const match=parts[0].match(/(\d+)/);

            if(match)current.duration=parseInt(match[1]);

          }

        }else if(!line.startsWith('#')&&line){

          current.src=line;

          if(current.src)tracks.push({...current});

          current={};

        }

      }

      return tracks.length>0?tracks:null;

    };

    const YT_ORIGIN="https://www.youtube.com";

    const ytPost=(i,f,a=[])=>{if(IN_SANDBOX)return;try{if(!i||!i.contentWindow)return;i.contentWindow.postMessage({event:"command",func:f,args:a},YT_ORIGIN)}catch{try{i.contentWindow.postMessage({event:"command",func:f,args:a},"*")}catch{}}};

    class Mp3AudioEngine{

      constructor(tracks){

        this.started=false;this.muted=true;this.trackIndex=0;

        this.tracks=tracks.slice().sort(()=>Math.random()-.5);

        this.activeKey="a";this.inactiveKey="b";

        this.players={a:null,b:null};this._fadeIv=null;this._prefadeTimer=null;

        this.audioContext=null;this.analyser=null;this.dataArray=null;

        this.beatPhase=0;this.energyLevel=.5;this._lastBeat=0;this._beatEnv=0;

        this._initAudioElements();

      }

      _initAudioElements(){
        // Create two audio elements for crossfading

        this.players.a=new Audio();

        this.players.b=new Audio();

        this.players.a.crossOrigin="anonymous";

        this.players.b.crossOrigin="anonymous";

        this.players.a.preload="auto";

        this.players.b.preload="auto";

        this.players.a.volume=0;

        this.players.b.volume=0;

        // Setup Web Audio Context and Analyser
        try{

          this.audioContext=new(window.AudioContext||window.webkitAudioContext)();

          this.analyser=this.audioContext.createAnalyser();

          this.analyser.fftSize=512;

          this.analyser.smoothingTimeConstant=0.8;

          this.dataArray=new Uint8Array(this.analyser.frequencyBinCount);

          // Connect active player to analyser
          this._connectAnalyser();

        }catch{

          this.audioContext=null;

        }

        // Setup event listeners
        ['a','b'].forEach(k=>{

          const p=this.players[k];

          p.addEventListener('ended',()=>{

            if(k===this.activeKey)this.beginCrossfade({fast:true});

          });

          p.addEventListener('canplay',()=>{

            if(k===this.activeKey&&this.started){

              this._setupNextCrossfade(p);

            }

          });

          p.addEventListener('error',()=>{

            if(k===this.activeKey)this.beginCrossfade({fast:true});

          });

        });

      }

      _connectAnalyser(){
        if(!this.audioContext||!this.analyser)return;

        try{

          const activePlayer=this.players[this.activeKey];

          if(activePlayer&&!activePlayer._sourceNode){

            activePlayer._sourceNode=this.audioContext.createMediaElementSource(activePlayer);

            activePlayer._sourceNode.connect(this.analyser);

            this.analyser.connect(this.audioContext.destination);

          }

        }catch{}

      }

      _setupNextCrossfade(player){
        if(!player.duration)return;

        const fadeTime=Math.max(FADE_MS+1000,player.duration*1000-FADE_MS-500);

        clearTimeout(this._prefadeTimer);

        this._prefadeTimer=setTimeout(()=>this.beginCrossfade({}),fadeTime);

      }

      start(){
        this.started=true;this.updateUITrack();

        if(this.audioContext&&this.audioContext.state==='suspended'){

          this.audioContext.resume();

        }

        this._loadOn(this.activeKey,this.tracks[this.trackIndex],{fadeIn:START_FADE_IN});

      }

      _loadOn(k,t,{fadeIn}={fadeIn:true}){
        if(!k||!t||!this.players[k])return;

        const p=this.players[k];

        p.src=t.src;

        p.load();

        if(fadeIn){
          this._fadeVolumes({toKey:k,ms:FADE_MS});

        }else{

          p.volume=this.muted?0:1;

        }

        // Connect to analyser if this is the active player
        if(k===this.activeKey){

          this._connectAnalyser();

        }

        // Auto-play when ready
        p.addEventListener('canplay',()=>{

          if(!this.muted||fadeIn)p.play().catch(()=>{});

        },{once:true});

      }

      beginCrossfade({fast=false}={}){
        clearInterval(this._fadeIv);clearTimeout(this._prefadeTimer);

        const n=(this.trackIndex+1)%this.tracks.length,t=this.tracks[n];

        const f=this.activeKey,o=this.inactiveKey;

        this._loadOn(o,t,{fadeIn:false});

        setTimeout(()=>{

          this._fadeVolumes({fromKey:f,toKey:o,ms:fast?Math.min(1200,FADE_MS):FADE_MS});

          this.trackIndex=n;this.updateUITrack();

        },fast?200:500);

      }

      prev(){
        clearInterval(this._fadeIv);clearTimeout(this._prefadeTimer);

        const p=(this.trackIndex-1+this.tracks.length)%this.tracks.length,t=this.tracks[p];

        const f=this.activeKey,o=this.inactiveKey;

        this._loadOn(o,t,{fadeIn:false});

        setTimeout(()=>{

          this._fadeVolumes({fromKey:f,toKey:o,ms:FADE_MS});

          this.trackIndex=p;this.updateUITrack();

        },300);

      }

      next(){this.beginCrossfade({fast:false})}
      toggleMute(){
        this.muted=!this.muted;

        const p=this.players[this.activeKey];

        if(p){

          if(this.muted){

            p.pause();

          }else{

            p.play().catch(()=>{});

          }

        }

        try{navigator.vibrate?.(6)}catch{}

      }

      updateUITrack(){
        const u=document.getElementById("uiLabel");

        if(!u)return;

        const t=this.tracks[this.trackIndex];

        const title=t?.title||t?.src?.split('/').pop()||'MP3';

        const artist=t?.artist||'';

        u.textContent=artist?`${artist} - ${title}`:title;

      }

      _fadeVolumes({fromKey:f,toKey:t,ms:m=FADE_MS}={}){
        clearInterval(this._fadeIv);

        const s=30,i=m/s;let c=0;

        this._fadeIv=setInterval(()=>{

          c++;const p=c/s,v=1-p,w=p;

          if(f&&this.players[f])this.players[f].volume=this.muted?0:v;

          if(t&&this.players[t])this.players[t].volume=this.muted?0:w;

          if(c>=s){

            clearInterval(this._fadeIv);

            this.activeKey=t;this.inactiveKey=f||"a";

            this._connectAnalyser();

          }

        },i);

      }

      data(){
        if(!this.analyser||!this.dataArray){

          // Fallback to synthetic data

          const m=motionScale();this.beatPhase+=.08*m;

          const b=.5+.4*Math.sin(this.beatPhase*.8);

          const i=.45+.35*Math.sin(this.beatPhase*1.2+.7);

          const h=.35+.35*Math.sin(this.beatPhase*1.8+1.2);

          const a=(b+i+h)/3;

          const r=Math.sin(this.beatPhase)>.8?1:0;

          this._beatEnv=(this._beatEnv||0)+(r-(this._beatEnv||0))*(r?.4:.06);

          return{bass:b,mid:i,high:h,average:a,beat:this._beatEnv,energy:this.energyLevel,subBass:b,vocals:i,treble:h};

        }

        this.analyser.getByteFrequencyData(this.dataArray);
        const len=this.dataArray.length;

        // Enhanced frequency bands (more granular)
        const subBassEnd=Math.floor(len*0.05);  // 20-60Hz

        const bassEnd=Math.floor(len*0.2);      // 60-250Hz

        const midEnd=Math.floor(len*0.6);       // 250-4kHz

        const vocalStart=Math.floor(len*0.15);  // ~200Hz

        const vocalEnd=Math.floor(len*0.4);     // ~2kHz

        let subBassSum=0,bassSum=0,midSum=0,highSum=0,vocalSum=0;
        for(let i=0;i<subBassEnd;i++)subBassSum+=this.dataArray[i];

        for(let i=subBassEnd;i<bassEnd;i++)bassSum+=this.dataArray[i];

        for(let i=bassEnd;i<midEnd;i++)midSum+=this.dataArray[i];

        for(let i=midEnd;i<len;i++)highSum+=this.dataArray[i];

        for(let i=vocalStart;i<vocalEnd;i++)vocalSum+=this.dataArray[i];

        const subBass=Math.min(1,subBassSum/(subBassEnd*255));
        const bass=Math.min(1,bassSum/((bassEnd-subBassEnd)*255));

        const mid=Math.min(1,midSum/((midEnd-bassEnd)*255));

        const high=Math.min(1,highSum/((len-midEnd)*255));

        const vocals=Math.min(1,vocalSum/((vocalEnd-vocalStart)*255));

        const average=(bass+mid+high)/3;

        // Improved onset detection (spectral flux)
        if(!this._prevData)this._prevData=new Uint8Array(len);

        let flux=0;

        for(let i=0;i<len;i++){

          const diff=Math.max(0,this.dataArray[i]-this._prevData[i]);

          flux+=diff*diff;

          this._prevData[i]=this.dataArray[i];

        }

        flux=Math.sqrt(flux/len)/255;

        // Adaptive beat threshold with history
        if(!this._fluxHistory)this._fluxHistory=[];

        this._fluxHistory.push(flux);

        if(this._fluxHistory.length>43)this._fluxHistory.shift();

        const avgFlux=this._fluxHistory.reduce((a,b)=>a+b,0)/this._fluxHistory.length;

        const threshold=avgFlux*1.5;

        const now=Date.now();
        let beat=0;

        if(flux>threshold&&flux>0.15&&now-this._lastBeat>100){

          beat=1;this._lastBeat=now;

        }

        this._beatEnv=(this._beatEnv||0)+(beat-(this._beatEnv||0))*(beat?.7:.1);

        this.energyLevel=this.energyLevel*.99+average*.01;
        return{bass,mid,high,average,beat:this._beatEnv,energy:this.energyLevel,subBass,vocals,treble:high,flux};

      }

    }

    class AudioEngine{
      constructor(){this.apiReady=false;this.players={a:null,b:null};this.started=false;this.muted=true;this.trackIndex=0;this.tracks=YOUTUBE_TRACKS.slice().sort(()=>Math.random()-.5);this.activeKey="a";this.inactiveKey="b";this._fadeIv=null;this._prefadeTimer=null;this._loadWatch=null;this.beatPhase=0;this.energyLevel=.5}

      initAPI(){if(IN_SANDBOX)return;try{this.players.a=new YT.Player("yt-player-a",{width:"1",height:"1",playerVars:{autoplay:1,controls:0,disablekb:1,fs:0,iv_load_policy:3,modestbranding:1,rel:0,playsinline:1},events:{onReady:()=>this.onReady("a"),onStateChange:e=>this.onStateChange("a",e),onError:()=>this.onError("a")}});this.players.b=new YT.Player("yt-player-b",{width:"1",height:"1",playerVars:{autoplay:1,controls:0,disablekb:1,fs:0,iv_load_policy:3,modestbranding:1,rel:0,playsinline:1},events:{onReady:()=>this.onReady("b"),onStateChange:e=>this.onStateChange("b",e),onError:()=>this.onError("b")}});this.apiReady=true}catch{this.apiReady=false}}

      onReady(k){try{this.players[k].unMute();this.players[k].setVolume(0)}catch{}if(this.started&&k===this.activeKey)this._loadOn(k,this.tracks[this.trackIndex],{fadeIn:START_FADE_IN})}

      onStateChange(k,e){if(IN_SANDBOX)return;const S=YT.PlayerState;if(e.data===S.ENDED){if(k===this.activeKey)this.beginCrossfade({fast:true})}else if(e.data===S.PLAYING){clearTimeout(this._loadWatch);try{const p=this.players[k];const s=()=>{const d=p.getDuration?p.getDuration()||0:0;if(d>0){const m=Math.max(FADE_MS+1000,d*1000-FADE_MS-500);clearTimeout(this._prefadeTimer);this._prefadeTimer=setTimeout(()=>this.beginCrossfade({}),m)}};s();setTimeout(s,500);setTimeout(s,1500)}catch{}}}

      onError(){clearTimeout(this._loadWatch);try{navigator.vibrate?.([8,40,8])}catch{}this.beginCrossfade({fast:true})}

      start(){this.started=true;this.updateUITrack();this._loadOn(this.activeKey,this.tracks[this.trackIndex],{fadeIn:START_FADE_IN})}

      _loadOn(k,t,{fadeIn}={fadeIn:true}){if(IN_SANDBOX||!k||!t)return;clearTimeout(this._loadWatch);const i=t.id;if(this.apiReady&&this.players[k]&&this.players[k].loadVideoById){try{const p=this.players[k];p.loadVideoById({videoId:i,startSeconds:t.start||0,endSeconds:t.end,suggestedQuality:"tiny"});try{p.unMute()}catch{}if(fadeIn)this._fadeVolumes({toKey:k,ms:FADE_MS});this._loadWatch=setTimeout(()=>{try{const n=p.getCurrentTime?p.getCurrentTime():0;if(n<.1)this.beginCrossfade({fast:true})}catch{this.beginCrossfade({fast:true})}},4000);return}catch{}}const f=document.getElementById("player-fallback-"+k);if(!f)return;const s=`https://www.youtube.com/embed/${i}?autoplay=1&controls=0&disablekb=1&fs=0&iv_load_policy=3&modestbranding=1&rel=0&playsinline=1&mute=1&enablejsapi=1${t.start?`&start=${t.start}`:""}${t.end?`&end=${t.end}`:""}`;f.src=s;f.onload=()=>{ytPost(f,"playVideo",[]);if(fadeIn){ytPost(f,"setVolume",[0]);ytPost(f,"unMute",[]);this._fadeVolumes({toKey:k,ms:FADE_MS})}else{ytPost(f,"setVolume",[100]);ytPost(f,"unMute",[])}};this._loadWatch=setTimeout(()=>this.beginCrossfade({fast:true}),5000)}

      beginCrossfade({fast=false}={}){if(IN_SANDBOX)return;clearInterval(this._fadeIv);clearTimeout(this._prefadeTimer);const n=(this.trackIndex+1)%this.tracks.length,t=this.tracks[n],f=this.activeKey,o=this.inactiveKey;this._loadOn(o,t,{fadeIn:false});setTimeout(()=>{this._fadeVolumes({fromKey:f,toKey:o,ms:fast?Math.min(1200,FADE_MS):FADE_MS});this.trackIndex=n;this.updateUITrack()},fast?200:500)}

      prev(){if(IN_SANDBOX)return;clearInterval(this._fadeIv);clearTimeout(this._prefadeTimer);const p=(this.trackIndex-1+this.tracks.length)%this.tracks.length,t=this.tracks[p],f=this.activeKey,o=this.inactiveKey;this._loadOn(o,t,{fadeIn:false});setTimeout(()=>{this._fadeVolumes({fromKey:f,toKey:o,ms:FADE_MS});this.trackIndex=p;this.updateUITrack()},300)}

      next(){this.beginCrossfade({fast:false})}

      toggleMute(){this.muted=!this.muted;if(IN_SANDBOX)return;try{if(this.apiReady){const p=this.players[this.activeKey];this.muted?p.mute():p.unMute()}else{const i=document.getElementById("player-fallback-"+this.activeKey);ytPost(i,this.muted?"mute":"unMute",[])}}catch{}try{navigator.vibrate?.(6)}catch{}}

      updateUITrack(){const u=document.getElementById("uiLabel");if(!u)return;const t=this.tracks[this.trackIndex];const artist=t?.artist||'';const title=t?.title||'Track';u.textContent=artist?`${artist} - ${title}`:title}

      _fadeVolumes({fromKey:f,toKey:t,ms:m=FADE_MS}={}){if(IN_SANDBOX)return;clearInterval(this._fadeIv);const s=30,i=m/s;let c=0;this._fadeIv=setInterval(()=>{c++;const p=c/s,v=Math.round(100*(1-p)),w=Math.round(100*p);if(this.apiReady){try{if(f&&this.players[f])this.players[f].setVolume(v)}catch{}try{if(t&&this.players[t])this.players[t].setVolume(w)}catch{}}else{if(f)ytPost(document.getElementById("player-fallback-"+f),"setVolume",[v]);if(t)ytPost(document.getElementById("player-fallback-"+t),"setVolume",[w])}if(c>=s){clearInterval(this._fadeIv);this.activeKey=t;this.inactiveKey=f||"a"}},i)}

      data(){const m=motionScale();this.beatPhase+=.08*m;this.energyLevel=this.energyLevel*.999+Math.random()*.001;const b=.5+.4*Math.sin(this.beatPhase*.8),i=.45+.35*Math.sin(this.beatPhase*1.2+.7),h=.35+.35*Math.sin(this.beatPhase*1.8+1.2),a=(b+i+h)/3,r=Math.sin(this.beatPhase)>.8?1:0;this._beatEnv=(this._beatEnv||0)+(r-(this._beatEnv||0))*(r?.4:.06);return{bass:b,mid:i,high:h,average:a,beat:this._beatEnv,energy:this.energyLevel}}

    }

    // Initialize audio engine - MP3 if available, otherwise YouTube

    let audio=null;

    const initAudioEngine=async()=>{

      const mp3Tracks=await detectMp3Playlist();

      if(mp3Tracks&&mp3Tracks.length>0){

        audio=new Mp3AudioEngine(mp3Tracks);

        console.log(`Using MP3 audio engine with ${mp3Tracks.length} tracks`);

      }else{

        audio=new AudioEngine();

        console.log('Using YouTube audio engine');

      }

    };

    initAudioEngine();

    window.onYouTubeIframeAPIReady=()=>audio.initAPI();

    const canvas=document.getElementById("canvas"),uiEl=document.getElementById("ui");

    let INTERNAL_SCALE=1,w=0,h=0;

    const SCALE_MAX=Math.min(2,DPR)*(isLowEnd?.9:1),SCALE_MIN=isLowEnd?.6:.7,TARGET_MS=16.7;

    let ewma=TARGET_MS,lastScaleAdjust=0,MIN_FRAME_MS=16;

    const updateMinFrameInterval=()=>MIN_FRAME_MS=typeof matchMedia==="function"&&matchMedia("(prefers-reduced-motion: reduce)").matches?33:16;

    const applyInternalScale=(b=isLowEnd?.8:1)=>INTERNAL_SCALE=Math.max(SCALE_MIN,Math.min(SCALE_MAX,b*Math.min(2,DPR)));

    (()=>{

      const pack32=(r,g,b,a)=>((a&255)<<24)|((b&255)<<16)|((g&255)<<8)|(r&255);

      class PixelTunnel{

        constructor(c){this.ctx=c;this.w=0;this.h=0;this.s=1;this.imageData=null;this.data=null;this.u32=null;this.BLACK32=0;this.fov=250;this.speed=.75;this.segments=64;this.baseRadius=75;this.zStep=4;this.particles=[];this.centers=[];this.time=0;this.mouse={x:0,y:0,down:false,active:false};this.ori={active:false,beta:0,gamma:0};this.tieRowStride=1;this.ringPxCull=.15}

        resize(w,h,s){this.w=w;this.h=h;this.s=s;this.ctx.fillStyle="#000";this.ctx.fillRect(0,0,w,h);this.imageData=this.ctx.getImageData(0,0,w,h);this.data=this.imageData.data;this.u32=new Uint32Array(this.data.buffer);const t=new Uint8ClampedArray(4);t[3]=255;this.BLACK32=new Uint32Array(t.buffer)[0];this.init()}

        clearImageData(){this.u32.fill(this.BLACK32)}

        setPixel32(x,y,c){if(x<=0||x>=this.w||y<=0||y>=this.h)return;const i=x+y*this.imageData.width;this.u32[i]=c}

        drawLine32(x1,y1,x2,y2,c){let dx=Math.abs(x2-x1),dy=Math.abs(y2-y1),sx=x1<x2?1:-1,sy=y1<y2?1:-1,err=dx-dy,lx=x1,ly=y1;for(;;){if(lx>0&&lx<this.w&&ly>0&&ly<this.h)this.setPixel32(lx,ly,c);if(lx===x2&&ly===y2)break;const e2=2*err;if(e2>-dy){err-=dy;lx+=sx}if(e2<dx){err+=dx;ly+=sy}}}

        getCirclePos(cx,cy,r,i,s){const a=i*(Math.PI*2/s)+this.time;return{x:cx+Math.cos(a)*r,y:cy+Math.sin(a)*r}}

        addParticle(x,y,z,a){return{x,y,z,x2d:0,y2d:0,radius:this.baseRadius,radiusAudio:this.baseRadius,index:0,segments:this.segments,centerX:0,centerY:0,audioIndex:a}}

        colorForRow32(i,l,a){const b=Math.max(0,Math.min(1,a?.bass??.5)),v=Math.max(0,Math.min(1,a?.average??.45)),h=Math.max(0,Math.min(1,a?.high??.35)),d=i/Math.max(1,l-1),r=Math.round(180*h+40*d),g=Math.round(90*v+60*d),u=Math.round(220*b);return pack32(r,g,u,255)}

        init(){this.particles=[];this.centers=[];const w1=Math.random()*this.w,h1=Math.random()*this.h;let c=0;for(let z=-this.fov;z<this.fov;z+=this.zStep){const coords=[];for(let i=0;i<this.segments;i++){const p=this.getCirclePos(0,0,this.baseRadius,i,this.segments);coords.push({x:p.x,y:p.y,index:i,radius:this.baseRadius,segments:this.segments,centerX:0,centerY:0})}const center={x:((this.w/2)-w1)*(c/15)+this.w/2,y:((this.h/2)-h1)*(c/15)+this.h/2};c++;this.centers.push(center);const row=[];let aIdx=8+Math.floor(Math.random()*1024);for(let i=0;i<coords.length;i++){const co=coords[i],p=this.addParticle(co.x,co.y,z,aIdx);p.index=co.index;p.radius=co.radius;p.radiusAudio=p.radius;p.segments=co.segments;p.centerX=co.centerX;p.centerY=co.centerY;row.push(p);aIdx+=i<coords.length/2?1:-1;if(aIdx>1024)aIdx=8;if(aIdx<8)aIdx=1024}this.particles.push(row)}}

        frame(a){const m=motionScale();this.clearImageData();const l=this.particles.length;let s=false;for(let i=0;i<l;i++){const row=this.particles[i],rowBack=i>0?this.particles[i-1]:null,center=this.centers[i];if(this.mouse.active){center.x=(this.w/2-this.mouse.x/this.s)*((row[0].z-this.fov)/500)+this.w/2;center.y=(this.h/2-this.mouse.y/this.s)*((row[0].z-this.fov)/500)+this.h/2}else if(this.ori.active){const mx=-this.ori.gamma*(this.w/180),my=-this.ori.beta*(this.h/180);center.x=this.w/2+mx*((row[0].z-this.fov)/500);center.y=this.h/2+my*((row[0].z-this.fov)/500)}else{center.x+=(this.w/2-center.x)*.015;center.y+=(this.h/2-center.y)*.015}const f=(a?.average||0)*64+(a?.beat?8:0),sc=this.fov/(this.fov+row[0].z),r=(this.baseRadius+f)*sc;if(r<this.ringPxCull)continue;for(let j=0,k=row.length;j<k;j++){const p=row[j],z=this.fov/(this.fov+p.z);p.x2d=p.x*z+center.x;p.y2d=p.y*z+center.y;p.radiusAudio=p.radius+f;if(this.mouse.down){p.z+=this.speed*m;if(p.z>this.fov){p.z-=this.fov*2;s=true}}else{p.z-=this.speed*m;if(p.z<-this.fov){p.z+=this.fov*2;s=true}}const n=this.getCirclePos(p.centerX,p.centerY,p.radiusAudio,p.index,p.segments);p.x=n.x;p.y=n.y}const c=this.colorForRow32(i,l,a);for(let j=1;j<row.length;j++){const p=row[j],v=row[j-1];this.drawLine32(p.x2d|0,p.y2d|0,v.x2d|0,v.y2d|0,c)}if(row.length>2){const f=row[0],t=row[row.length-1];this.drawLine32(t.x2d|0,t.y2d|0,f.x2d|0,f.y2d|0,c)}if(i>0&&i<l-1&&rowBack&&i%this.tieRowStride===0){for(let j=0;j<row.length;j++){const p=row[j],b=j===0?rowBack[rowBack.length-1]:rowBack[j-1];this.drawLine32(p.x2d|0,p.y2d|0,b.x2d|0,b.y2d|0,c)}}}if(s)this.particles=this.particles.sort((a,b)=>b[0].z-a[0].z);this.time+=(this.mouse.down?-.005:.005)*m;this.ctx.putImageData(this.imageData,0,0)}

      }

      const ctx=canvas.getContext("2d",{alpha:false,willReadFrequently:true})||canvas.getContext("2d");

      window.tunnelRenderer=new PixelTunnel(ctx)

    })();

    (() => {

      'use strict';

      function applyPatch() {

        const tr = window.tunnelRenderer;

        if (!tr || typeof tr !== 'object') return false;

        if (tr.__rb_perf_patched) return true;

        const orig = {

          frame: typeof tr.frame === 'function' ? tr.frame.bind(tr) : null,

          resize: typeof tr.resize === 'function' ? tr.resize.bind(tr) : null,

          getCirclePos: typeof tr.getCirclePos === 'function' ? tr.getCirclePos.bind(tr) : null,

        };

        if (!orig.frame || !orig.resize || !orig.getCirclePos) return false;

        tr.__rb_perf_patched = true;

        tr.__rbTrig = { segments: 0, cosBase: null, sinBase: null, ct: 1, st: 0 };

        tr.__computeTrigTables = function() {

          const seg = this.segments | 0; if (!seg || this.__rbTrig.segments === seg) return;

          const cosB = new Float32Array(seg), sinB = new Float32Array(seg);

          const tau = Math.PI * 2;

          for (let i = 0; i < seg; i++) { const a = (i * tau) / seg; cosB[i] = Math.cos(a); sinB[i] = Math.sin(a); }

          this.__rbTrig.cosBase = cosB; this.__rbTrig.sinBase = sinB; this.__rbTrig.segments = seg;

        };

        tr.resize = function(w, h, s) { const r = orig.resize(w, h, s); this.__computeTrigTables(); return r; };

        tr.frame = function(a) { this.__rbTrig.ct = Math.cos(this.time); this.__rbTrig.st = Math.sin(this.time); return orig.frame(a); };

        tr.getCirclePos = function(cx, cy, r, i, s) {

          if (!this.__rbTrig || this.__rbTrig.segments !== (this.segments | 0)) this.__computeTrigTables();

          const seg = this.__rbTrig.segments || this.segments || s || 0; if (!seg) return { x: cx, y: cy };

          const idx = i % seg; const cosA = this.__rbTrig.cosBase[idx]; const sinA = this.__rbTrig.sinBase[idx];

          const ct = this.__rbTrig.ct, st = this.__rbTrig.st;

          const cosAT = cosA * ct - sinA * st; const sinAT = sinA * ct + cosA * st;

          return { x: cx + cosAT * r, y: cy + sinAT * r };

        };

        tr.__computeTrigTables();

        const verifyOnce = () => { try { const idxs = [0, Math.max(1, (tr.segments/3)|0), Math.max(2, (tr.segments/2)|0)]; const cx=100, cy=80, r=50; for (const k of idxs) { const aOld = k*(Math.PI*2/tr.segments)+tr.time; const ox = cx + Math.cos(aOld)*r; const oy = cy + Math.sin(aOld)*r; const p = tr.getCirclePos(cx, cy, r, k, tr.segments); const dx = Math.abs(ox - p.x); const dy = Math.abs(oy - p.y); if (dx > 1e-6 || dy > 1e-6) { /* optional rollback; keep silent */ } } } catch {} };

        const scheduleVerify = window.requestIdleCallback ?

          (() => window.requestIdleCallback(verifyOnce)) :

          (() => window.setTimeout(verifyOnce, 0));

        scheduleVerify();

        return true;

      }

      function start() {

        if (applyPatch()) return; let tries = 0; const iv = setInterval(() => { tries++; if (applyPatch() || tries > 200) clearInterval(iv); }, 25);

      }

      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start, { once: true }); else start();

    })();

    const sizeCanvas=()=>{w=Math.floor(window.innerWidth*INTERNAL_SCALE);h=Math.floor(window.innerHeight*INTERNAL_SCALE);canvas.width=w;canvas.height=h;canvas.style.width=window.innerWidth+"px";canvas.style.height=window.innerHeight+"px";window.tunnelRenderer?.resize?.(w,h,INTERNAL_SCALE);if(window.vizRenderers){for(const v of window.vizRenderers){if(v&&v.resize)v.resize(w,h,INTERNAL_SCALE)}}if(window.particleSys)window.particleSys.resize(w,h);if(window.starfield)window.starfield.resize(w,h)};

    const setScaleAndResize=n=>{const c=Math.max(SCALE_MIN,Math.min(SCALE_MAX,n));if(Math.abs(c-INTERNAL_SCALE)>.01){INTERNAL_SCALE=c;sizeCanvas()}};

    const doResize=()=>sizeCanvas();

    (()=>{const b=isLowEnd?.8:1;INTERNAL_SCALE=Math.max(SCALE_MIN,Math.min(SCALE_MAX,b*Math.min(2,DPR)));sizeCanvas();MIN_FRAME_MS=typeof matchMedia==="function"&&matchMedia("(prefers-reduced-motion: reduce)").matches?33:16})();

    window.addEventListener("resize",()=>{clearTimeout(window.__rzT);window.__rzT=setTimeout(doResize,80)});

    const onOrient=()=>setTimeout(()=>sizeCanvas(),100);

    window.addEventListener("orientationchange",onOrient);

    if(screen?.orientation?.addEventListener)try{screen.orientation.addEventListener("change",onOrient)}catch{}

    let mouseDown=false,mouseActive=false,mousePos={x:0,y:0},orientationActive=false,beta=0,gamma=0;

    window.parallaxOffset={x:0,y:0};

    const sendInput=()=>{if(window.tunnelRenderer){window.tunnelRenderer.mouse={x:mousePos.x,y:mousePos.y,down:mouseDown,active:mouseActive};window.tunnelRenderer.ori={active:orientationActive,beta,gamma}}const w=window.innerWidth,h=window.innerHeight;if(orientationActive){window.parallaxOffset.x=(gamma||0)*0.8;window.parallaxOffset.y=(beta||0)*0.6}else if(mouseActive){window.parallaxOffset.x=((mousePos.x/(w*INTERNAL_SCALE))-0.5)*40;window.parallaxOffset.y=((mousePos.y/(h*INTERNAL_SCALE))-0.5)*30}else{window.parallaxOffset.x*=0.95;window.parallaxOffset.y*=0.95}};

    const spawnRipple=(x,y)=>{try{const r=document.createElement("div");r.className="tap-ripple";r.style.cssText="position:fixed;left:0;top:0;width:10px;height:10px;border-radius:50%;pointer-events:none;transform:translate(-50%,-50%) scale(0.4);opacity:.85;background:radial-gradient(circle,rgba(220,220,220,0.35) 0%,rgba(220,220,220,0.18) 40%,rgba(220,220,220,0) 70%);mix-blend-mode:screen;filter:blur(0.3px);animation:ripple 680ms ease-out forwards;z-index:999";r.style.setProperty("--x",x+"px");r.style.setProperty("--y",y+"px");document.body.appendChild(r);r.addEventListener("animationend",()=>r.remove(),{once:true})}catch{}};

    const rippleAtEvent=e=>{try{let x=0,y=0;if("touches"in e&&e.touches.length){x=e.touches[0].clientX;y=e.touches[0].clientY}else if("changedTouches"in e&&e.changedTouches?.length){x=e.changedTouches[0].clientX;y=e.changedTouches[0].clientY}else{x=e.clientX;y=e.clientY}spawnRipple(x,y)}catch{}};

    const setUIInversion=a=>a?uiEl.classList.add("ui-inverted"):uiEl.classList.remove("ui-inverted");

    const setupSensors=()=>{if(IN_SANDBOX)return;try{if(typeof DeviceOrientationEvent!=="undefined"&&typeof DeviceOrientationEvent.requestPermission==="function"){DeviceOrientationEvent.requestPermission().then(s=>{if(s==="granted")window.addEventListener("deviceorientation",e=>{beta=e.beta||0;gamma=e.gamma||0;orientationActive=true;sendInput()},{passive:true})}).catch(()=>{})}else if(window.DeviceOrientationEvent){window.addEventListener("deviceorientation",e=>{beta=e.beta||0;gamma=e.gamma||0;orientationActive=true;sendInput()},{passive:true})}}catch{}};

    const toggleFullscreen=()=>{const d=document.documentElement;!document.fullscreenElement?d.requestFullscreen?.():document.exitFullscreen?.()};

    let pinchStartDist=0,baseZoom=1,zoom=1;

    const touchDistance=(t1,t2)=>Math.hypot(t2.clientX-t1.clientX,t2.clientY-t1.clientY);

    const applyZoom=z=>{zoom=Math.max(.85,Math.min(1.25,z));document.documentElement.style.setProperty("--zoom",String(zoom))};

    const resetPinch=()=>{pinchStartDist=0;baseZoom=zoom};

    const startApp=async e=>{if(audio?.started)return;

      // Ensure audio engine is initialized

      if(!audio)await initAudioEngine();

      try{navigator.vibrate?.(12)}catch{}if(e)rippleAtEvent(e);document.getElementById("overlay").style.pointerEvents="none";document.getElementById("overlay").classList.add("ack");document.getElementById("start-title").classList.add("clicked");canvas.classList.add("start-ack");setupSensors();if(IN_SANDBOX){const u=document.getElementById("uiLabel");if(u)u.textContent="Visual-only (sandboxed)"}else{

        // Start appropriate audio engine

        if(audio instanceof Mp3AudioEngine){

          audio.start();

        }else{

          loadYouTubeAPI();audio.start();

        }

      }setTimeout(()=>{document.getElementById("overlay").hidden=true;document.getElementById("overlay").classList.remove("ack");document.getElementById("start-title").classList.remove("clicked");canvas.classList.remove("start-ack");canvas.focus?.()},220)};

    const overlayEl=document.getElementById("overlay");

    overlayEl.addEventListener("click",e=>{e.stopPropagation();e.preventDefault();startApp(e)});

    overlayEl.addEventListener("pointerdown",e=>{rippleAtEvent(e);try{navigator.vibrate?.(8)}catch{}},{passive:true});

    overlayEl.addEventListener("keydown",e=>{if(e.code==="Enter"||e.code==="Space"){e.preventDefault();startApp()}if(e.code==="Tab"){e.preventDefault();overlayEl.focus()}});

    canvas.addEventListener("mousedown",e=>{mouseDown=true;mouseActive=true;canvas.classList.add("canvas-inverted");setUIInversion(true);sendInput();rippleAtEvent(e)},false);

    canvas.addEventListener("mouseup",e=>{mouseDown=false;canvas.classList.remove("canvas-inverted");setUIInversion(false);sendInput();rippleAtEvent(e)},false);

    canvas.addEventListener("mousemove",e=>{const r=canvas.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top;mousePos.x=x*INTERNAL_SCALE;mousePos.y=y*INTERNAL_SCALE;mouseActive=true;sendInput()},false);

    canvas.addEventListener("mouseleave",()=>{mouseActive=false;mouseDown=false;canvas.classList.remove("canvas-inverted");setUIInversion(false);sendInput()},false);

    let touchStartX=0,touchStartY=0,lastTapTime=0;const swipeThreshold=70,doubleTapMs=300;

    canvas.addEventListener("touchstart",e=>{e.preventDefault();if(e.touches.length===1){const t=e.touches[0],r=canvas.getBoundingClientRect(),x=t.clientX-r.left,y=t.clientY-r.top;touchStartX=x;touchStartY=y;mousePos.x=x*INTERNAL_SCALE;mousePos.y=y*INTERNAL_SCALE;mouseDown=true;canvas.classList.add("canvas-inverted");setUIInversion(true);sendInput();rippleAtEvent(e);resetPinch()}else if(e.touches.length===2){pinchStartDist=touchDistance(e.touches[0],e.touches[1]);baseZoom=zoom}},{passive:false});

    canvas.addEventListener("touchmove",e=>{e.preventDefault();if(e.touches.length===1){const t=e.touches[0],r=canvas.getBoundingClientRect(),x=t.clientX-r.left,y=t.clientY-r.top;mousePos.x=x*INTERNAL_SCALE;mousePos.y=y*INTERNAL_SCALE;sendInput()}else if(e.touches.length===2){if(pinchStartDist===0){pinchStartDist=touchDistance(e.touches[0],e.touches[1]);baseZoom=zoom}const d=touchDistance(e.touches[0],e.touches[1]);if(pinchStartDist>0){const s=d/pinchStartDist;applyZoom(baseZoom*s)}}else resetPinch()},{passive:false});

    canvas.addEventListener("touchend",e=>{e.preventDefault();if(e.touches.length<2)resetPinch();if(e.touches.length===0){mouseDown=false;canvas.classList.remove("canvas-inverted");setUIInversion(false);sendInput();rippleAtEvent(e)}if(audio?.started&&!IN_SANDBOX){const t=e.changedTouches[0],r=canvas.getBoundingClientRect(),endX=t.clientX-r.left,endY=t.clientY-r.top,dx=endX-touchStartX,dy=endY-touchStartY;if(Math.abs(dx)>swipeThreshold||Math.abs(dy)>swipeThreshold){if(Math.abs(dx)>Math.abs(dy)){dx>0?audio.next():audio.prev()}else{const s=document.getElementById("swipeHint");s.textContent="Warp Tunnel";s.classList.add("show");setTimeout(()=>s.classList.remove("show"),1400)}try{navigator.vibrate?.(10)}catch{}}else{const n=performance.now();if(n-lastTapTime<doubleTapMs)toggleFullscreen();lastTapTime=n}}},{passive:false});

    canvas.addEventListener("touchcancel",()=>{resetPinch();mouseDown=false;canvas.classList.remove("canvas-inverted");setUIInversion(false);sendInput()},{passive:true});

    window.vizSpeed=1.0;window.vizIntensity=1.0;window.psychedelicMode=0;

    addEventListener("keydown",e=>{if(e.key?.toLowerCase()==="m"){e.preventDefault();if(audio?.started)audio.toggleMute();return}if(e.code==="ArrowRight"||e.code==="KeyN"){e.preventDefault();if(audio?.started)audio.next();return}if(e.code==="ArrowLeft"||e.code==="KeyP"){e.preventDefault();if(audio?.started)audio.prev();return}if(e.code==="KeyF"||e.code==="F11"){e.preventDefault();toggleFullscreen();return}if(e.code==="Space"||e.code==="KeyK"){e.preventDefault();if(!audio?.started){startApp()}else{audio.toggleMute()}return}if(e.code==="ArrowUp"){e.preventDefault();window.vizSpeed=Math.min(3,window.vizSpeed+0.1);console.log('Speed:',window.vizSpeed.toFixed(1)+'x');return}if(e.code==="ArrowDown"){e.preventDefault();window.vizSpeed=Math.max(0.1,window.vizSpeed-0.1);console.log('Speed:',window.vizSpeed.toFixed(1)+'x');return}if(e.code==="BracketRight"){e.preventDefault();window.vizIntensity=Math.min(2,window.vizIntensity+0.1);console.log('Intensity:',window.vizIntensity.toFixed(1)+'x');return}if(e.code==="BracketLeft"){e.preventDefault();window.vizIntensity=Math.max(0.2,window.vizIntensity-0.1);console.log('Intensity:',window.vizIntensity.toFixed(1)+'x');return}if(e.code==="KeyX"){e.preventDefault();window.psychedelicMode=(window.psychedelicMode+1)%4;const modes=['Off','Trails','Color Shift','Kaleidoscope'];console.log('Psychedelic:',modes[window.psychedelicMode]);return}if(e.code==="Escape"){e.preventDefault();if(document.fullscreenElement)toggleFullscreen();return}if(e.code==="Digit0"||e.code==="Numpad0"){e.preventDefault();audio.trackIndex=0;audio.beginCrossfade({fast:true});return}if(e.code==="KeyI"){e.preventDefault();canvas.classList.toggle("canvas-inverted");return}});

    let pageHidden=document.hidden;document.addEventListener("visibilitychange",()=>pageHidden=document.hidden);

    let lastFrameT=performance.now(),lastRenderT=lastFrameT;

    const applyPsychedelic=(a)=>{const mode=window.psychedelicMode||0;const t=performance.now()*0.001;if(mode===0){canvas.style.filter='';canvas.style.opacity='1';canvas.style.transform='';return}if(mode===1){const trail=0.95-Math.abs(a?.flux||0)*0.15;canvas.style.opacity=String(trail);canvas.style.filter='';canvas.style.transform='';}else if(mode===2){const hue=(t*30+a?.average*360)%360;canvas.style.filter=`hue-rotate(${hue}deg) saturate(${1.5+a?.beat*0.5})`;canvas.style.opacity='1';canvas.style.transform='';}else if(mode===3){const scale=1+Math.sin(t*2)*0.05*a?.beat;const rotate=Math.sin(t*0.5)*5*a?.average;canvas.style.filter=`saturate(1.8) contrast(1.1)`;canvas.style.transform=`scale(${scale}) rotate(${rotate}deg)`;canvas.style.opacity='1';}};

    const animate=()=>{const n=performance.now(),d=n-lastFrameT;lastFrameT=n;ewma=ewma*.9+d*.1;if(n-lastRenderT<MIN_FRAME_MS){requestAnimationFrame(animate);return}if(!pageHidden&&n-lastScaleAdjust>700){if(ewma>22){setScaleAndResize(INTERNAL_SCALE*.92);lastScaleAdjust=n}else if(ewma<14&&INTERNAL_SCALE<SCALE_MAX){setScaleAndResize(INTERNAL_SCALE*1.06);lastScaleAdjust=n}}if(pageHidden){requestAnimationFrame(animate);return}let a=audio?.started?audio.data():{average:0,beat:0,bass:.5,mid:.45,high:.35};const i=window.vizIntensity||1;if(i!==1){a={...a,bass:(a?.bass||0)*i,mid:(a?.mid||0)*i,high:(a?.high||0)*i,average:(a?.average||0)*i,subBass:(a?.subBass||0)*i,vocals:(a?.vocals||0)*i,treble:(a?.treble||0)*i,beat:(a?.beat||0)*i,flux:(a?.flux||0)*i}}try{const viz=window.vizRenderers?.[window.vizMode]||window.tunnelRenderer;viz?.frame?.(a)}catch(e){window.tunnelRenderer?.frame(a)}applyPsychedelic(a);lastRenderT=n;requestAnimationFrame(animate)};

    const boot=()=>{if(IN_SANDBOX){const u=document.getElementById("uiLabel");if(u)u.textContent="Visual-only (sandboxed)"}requestAnimationFrame(animate);document.getElementById("overlay").focus()};

    document.readyState==="loading"?document.addEventListener("DOMContentLoaded",boot):boot();

    // ===== VISUALIZER ENHANCEMENTS (PIXEL-BASED) =====
    (function(){

    'use strict';

    const pack32=(r,g,b,a)=>((a&255)<<24)|((b&255)<<16)|((g&255)<<8)|(r&255);

    const TAU=Math.PI*2,HALF_PI=Math.PI/2,THIRD_PI=Math.PI/3,PHI=1.618033988749895;

    const makeRotation=(cx,cy,angle)=>{const c=Math.cos(angle),s=Math.sin(angle);return{x:(x,y)=>cx+(x-cx)*c-(y-cy)*s,y:(x,y)=>cy+(x-cx)*s+(y-cy)*c};};

    const atmosphericHue=(depth,baseHue)=>baseHue+(1-depth)*30;

    window.vizMode=0;window.vizTheme=0;window.vizEffects={particles:true,starfield:true};

    window.vizNames=['Tunnel','Infinity Grid','Cymatic Waves','Fractal Cascade','Vortex Nest','Neural Web','Cosmic Emanation','Hypergrid Spiral'];

    window.vizPsychedelicModes=[0,2,3,1,2,0,3,2];

    window.vizAutoSwitch=true;let lastTrackIndex=-1;

    window.motionScale=()=>(typeof matchMedia==="function"&&matchMedia("(prefers-reduced-motion: reduce)").matches?.35:1)*(window.vizSpeed||1);

    // Simplex noise implementation (compact version)
    const SimplexNoise=(function(){const F2=0.5*(Math.sqrt(3)-1),G2=(3-Math.sqrt(3))/6,F3=1/3,G3=1/6;const grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]];function Noise(r){let p,perm,permMod12;r===undefined&&(r=Math.random);p=new Uint8Array(256);for(let i=0;i<256;i++)p[i]=i;for(let i=255;i>0;i--){const n=Math.floor((i+1)*r()),q=p[i];p[i]=p[n];p[n]=q}perm=new Uint8Array(512);permMod12=new Uint8Array(512);for(let i=0;i<512;i++){perm[i]=p[i&255];permMod12[i]=perm[i]%12}this.perm=perm;this.permMod12=permMod12}Noise.prototype.noise2D=function(xin,yin){const perm=this.perm,permMod12=this.permMod12;let n0,n1,n2;const s=(xin+yin)*F2,i=Math.floor(xin+s),j=Math.floor(yin+s),t=(i+j)*G2,X0=i-t,Y0=j-t,x0=xin-X0,y0=yin-Y0;let i1,j1;if(x0>y0){i1=1;j1=0}else{i1=0;j1=1}const x1=x0-i1+G2,y1=y0-j1+G2,x2=x0-1+2*G2,y2=y0-1+2*G2;const ii=i&255,jj=j&255;let t0=0.5-x0*x0-y0*y0;if(t0<0)n0=0;else{const gi=permMod12[ii+perm[jj]];t0*=t0;n0=t0*t0*(grad3[gi][0]*x0+grad3[gi][1]*y0)}let t1=0.5-x1*x1-y1*y1;if(t1<0)n1=0;else{const gi=permMod12[ii+i1+perm[jj+j1]];t1*=t1;n1=t1*t1*(grad3[gi][0]*x1+grad3[gi][1]*y1)}let t2=0.5-x2*x2-y2*y2;if(t2<0)n2=0;else{const gi=permMod12[ii+1+perm[jj+1]];t2*=t2;n2=t2*t2*(grad3[gi][0]*x2+grad3[gi][1]*y2)}return 70*(n0+n1+n2)};return Noise})();

    const noise=new SimplexNoise();

    const THEMES=[

      {name:'Original',fn:(i,l,a)=>{const b=Math.max(0,Math.min(1,a?.bass??.5)),v=Math.max(0,Math.min(1,a?.average??.45)),h=Math.max(0,Math.min(1,a?.high??.35)),d=i/Math.max(1,l-1),r=Math.round(20+60*d),g=Math.round(40+120*v),u=Math.round(180*b+75*h);return pack32(r,g,u,255);}},

      {name:'Synthwave',fn:(i,l,a)=>{const v=Math.max(0,Math.min(1,a?.average??.5)),d=i/Math.max(1,l-1);const r=Math.round(255*Math.pow(d,2)+80*v),g=Math.round(30+120*v),b=Math.round(255*d);return pack32(r,g,b,255);}},

      {name:'Neon',fn:(i,l,a)=>{const h=Math.max(0,Math.min(1,a?.high??.5)),m=Math.max(0,Math.min(1,a?.mid??.5)),d=i/Math.max(1,l-1);const r=Math.round(50+205*h),g=Math.round(255*m),b=Math.round(50+205*d);return pack32(r,g,b,255);}},

      {name:'Fire',fn:(i,l,a)=>{const v=Math.max(0,Math.min(1,a?.average??.5)),b=Math.max(0,Math.min(1,a?.bass??.5)),d=i/Math.max(1,l-1);const r=255,g=Math.round(100*d+155*v),u=Math.round(30*b);return pack32(r,g,u,255);}},

      {name:'Ocean',fn:(i,l,a)=>{const m=Math.max(0,Math.min(1,a?.mid??.5)),h=Math.max(0,Math.min(1,a?.high??.5)),d=i/Math.max(1,l-1);const r=Math.round(30*d),g=Math.round(100+155*m),b=Math.round(150+105*h);return pack32(r,g,b,255);}},

      {name:'Mono',fn:(i,l,a)=>{const v=Math.max(0,Math.min(1,a?.average??.5)),d=i/Math.max(1,l-1);const c=Math.round(100+155*(v*0.5+d*0.5));return pack32(c,c,c,255);}}

    ];

    // Helper: Draw line using Bresenham algorithm

    const drawLine=(u32,w,h,x1,y1,x2,y2,col)=>{let dx=Math.abs(x2-x1),dy=Math.abs(y2-y1),sx=x1<x2?1:-1,sy=y1<y2?1:-1,err=dx-dy;for(;;){if(x1>=0&&x1<w&&y1>=0&&y1<h)u32[x1+y1*w]=col;if(x1===x2&&y1===y2)break;const e2=2*err;if(e2>-dy){err-=dy;x1+=sx;}if(e2<dx){err+=dx;y1+=sy;}}};

    // Helper: Draw filled circle

    const drawCircle=(u32,w,h,cx,cy,radius,col,gradient)=>{const r2=radius*radius;for(let dx=-radius;dx<=radius;dx++){for(let dy=-radius;dy<=radius;dy++){const dist=dx*dx+dy*dy;if(dist<=r2){const px=(cx+dx)|0,py=(cy+dy)|0;if(px>=0&&px<w&&py>=0&&py<h){if(gradient){const bright=1-Math.sqrt(dist)/(radius*1.5);const alpha=(col>>>24)&255,blue=(col>>>16)&255,green=(col>>>8)&255,red=col&255;const r2=(red*bright)|0,g2=(green*bright)|0,b2=(blue*bright)|0;u32[px+py*w]=pack32(r2,g2,b2,alpha)}else{u32[px+py*w]=col}}}}}};

    // Helper: Initialize pixel buffer for visualizers

    const initBuffer=(ctx,w,h)=>{const imageData=ctx.getImageData(0,0,w,h);const u32=new Uint32Array(imageData.data.buffer);const t=new Uint8ClampedArray(4);t[3]=255;const BLACK32=new Uint32Array(t.buffer)[0];return{imageData,u32,BLACK32}};

    // VIZ 1: INFINITY GRID - Dense square tunnel grid with beat pops & rotation

    class InfinityGridViz{constructor(ctx){this.ctx=ctx;this.w=0;this.h=0;this.time=0;this.grids=[];this.rotation=0;this.beatPop=0;}resize(w,h,s){this.w=w;this.h=h;this.imageData=this.ctx.getImageData(0,0,w,h);this.u32=new Uint32Array(this.imageData.data.buffer);const t=new Uint8ClampedArray(4);t[3]=255;this.BLACK32=new Uint32Array(t.buffer)[0];this.grids=[];for(let i=0;i<120;i++){this.grids.push({z:-250+i*4,ox:Math.random()*60-30,oy:Math.random()*60-30});}}frame(a){try{this.u32.fill(this.BLACK32);const p=window.parallaxOffset||{x:0,y:0};const cx=this.w/2+p.x,cy=this.h/2+p.y,m=window.motionScale?.()||1;this.time+=m*0.5;this.rotation+=m*0.01;this.beatPop=this.beatPop*0.85+(a?.beat||0)*0.15;const audioExpand=(a?.average||0)*60+this.beatPop*40;const speed=1.5+m*0.5;const rot=makeRotation(cx,cy,this.rotation);for(let i=0;i<this.grids.length;i++){const g=this.grids[i];g.z+=speed;if(g.z>250){g.z-=500;g.ox=Math.random()*60-30;g.oy=Math.random()*60-30;}const sc=300/(300+g.z),size=(80+audioExpand)*sc;const offX=g.ox*(1-g.z/250),offY=g.oy*(1-g.z/250);const gridCX=cx+offX*sc,gridCY=cy+offY*sc;const depth=Math.max(0,1-g.z/250);const hue=atmosphericHue(depth,this.time*20)%360/360;const col=THEMES[window.vizTheme].fn(hue*255,255,a);const x1=(gridCX-size)|0,y1=(gridCY-size)|0,x2=(gridCX+size)|0,y2=(gridCY+size)|0;const rx1=rot.x(x1,y1)|0,ry1=rot.y(x1,y1)|0,rx2=rot.x(x2,y1)|0,ry2=rot.y(x2,y1)|0;const rx3=rot.x(x2,y2)|0,ry3=rot.y(x2,y2)|0,rx4=rot.x(x1,y2)|0,ry4=rot.y(x1,y2)|0;drawLine(this.u32,this.w,this.h,rx1,ry1,rx2,ry2,col);drawLine(this.u32,this.w,this.h,rx2,ry2,rx3,ry3,col);drawLine(this.u32,this.w,this.h,rx3,ry3,rx4,ry4,col);drawLine(this.u32,this.w,this.h,rx4,ry4,rx1,ry1,col);const mid=(size*0.5)|0;if(mid>2){const mx1=(gridCX-mid)|0,my1=(gridCY-mid)|0,mx2=(gridCX+mid)|0,my2=(gridCX+mid)|0;const rmx1=rot.x(mx1,my1)|0,rmy1=rot.y(mx1,my1)|0,rmx2=rot.x(mx2,my1)|0,rmy2=rot.y(mx2,my1)|0;const rmx3=rot.x(mx2,my2)|0,rmy3=rot.y(mx2,my2)|0,rmx4=rot.x(mx1,my2)|0,rmy4=rot.y(mx1,my2)|0;drawLine(this.u32,this.w,this.h,rmx1,rmy1,rmx2,rmy2,col);drawLine(this.u32,this.w,this.h,rmx2,rmy2,rmx3,rmy3,col);drawLine(this.u32,this.w,this.h,rmx3,rmy3,rmx4,rmy4,col);drawLine(this.u32,this.w,this.h,rmx4,rmy4,rmx1,rmy1,col);}if(i%2===0&&i<this.grids.length-1){const g2=this.grids[i+1],sc2=300/(300+g2.z),size2=(80+audioExpand)*sc2;const offX2=g2.ox*(1-g2.z/250),offY2=g2.oy*(1-g2.z/250);const gCX2=cx+offX2*sc2,gCY2=cy+offY2*sc2;const c1x=rot.x(gridCX-size,gridCY-size)|0,c1y=rot.y(gridCX-size,gridCY-size)|0;const c2x=rot.x(gCX2-size2,gCY2-size2)|0,c2y=rot.y(gCX2-size2,gCY2-size2)|0;drawLine(this.u32,this.w,this.h,c1x,c1y,c2x,c2y,col);}}this.ctx.putImageData(this.imageData,0,0);}catch(e){console.error('InfinityGridViz:',e);}}}

    // VIZ 2: CYMATIC WAVES - 6-way symmetric mandala with wave interference

    class CymaticWavesViz{constructor(ctx){this.ctx=ctx;this.w=0;this.h=0;this.time=0;this.waves=[];this.layers=[];}resize(w,h,s){this.w=w;this.h=h;this.imageData=this.ctx.getImageData(0,0,w,h);this.u32=new Uint32Array(this.imageData.data.buffer);const t=new Uint8ClampedArray(4);t[3]=255;this.BLACK32=new Uint32Array(t.buffer)[0];this.waves=[];this.layers=[];for(let i=0;i<100;i++){this.waves.push({z:-300+i*6,segs:24,freq:1+Math.random()*0.5});}for(let i=0;i<3;i++){this.layers.push({phase:Math.random()*TAU,speed:0.3+i*0.2});}}frame(a){try{this.u32.fill(this.BLACK32);const p=window.parallaxOffset||{x:0,y:0};const cx=this.w/2+p.x,cy=this.h/2+p.y,m=window.motionScale?.()||1;this.time+=m*0.6;const audioRipple=(a?.average||0)*80+(a?.beat||0)*40;const speed=1.8;for(const w of this.waves){w.z+=speed;if(w.z>300){w.z-=600;w.freq=1+Math.random()*0.5;}const sc=350/(350+w.z);const baseRad=60+audioRipple+noise.noise2D(w.z*0.01,this.time*0.1)*25;const interference=Math.sin(w.z*0.05*w.freq+this.time*w.freq)*0.3;const rad=(baseRad+baseRad*interference)*sc;const depth=Math.max(0,1-w.z/300);const hue=atmosphericHue(depth,depth*180)%360/360;const col=THEMES[window.vizTheme].fn(hue*255,255,a);for(let sym=0;sym<6;sym++){const symAng=sym*THIRD_PI;for(let i=0;i<w.segs;i++){const ang1=(i/w.segs)*TAU+this.time*0.3+symAng,ang2=((i+1)/w.segs)*TAU+this.time*0.3+symAng;const wobble=noise.noise2D(Math.cos(ang1)*3,Math.sin(ang1)*3+this.time*0.2)*15*sc;const x1=(cx+Math.cos(ang1)*(rad+wobble))|0,y1=(cy+Math.sin(ang1)*(rad+wobble))|0;const wobble2=noise.noise2D(Math.cos(ang2)*3,Math.sin(ang2)*3+this.time*0.2)*15*sc;const x2=(cx+Math.cos(ang2)*(rad+wobble2))|0,y2=(cy+Math.sin(ang2)*(rad+wobble2))|0;drawLine(this.u32,this.w,this.h,x1,y1,x2,y2,col);}}}for(let i=0;i<this.layers.length;i++){const l=this.layers[i];l.phase+=m*l.speed*0.05;const lrad=(40+i*25+audioRipple*0.5)*((Math.sin(l.phase)+1.5)/2.5);const lcol=THEMES[window.vizTheme].fn(128+i*40,255,a);for(let sym=0;sym<6;sym++){const ang=sym*THIRD_PI+l.phase;const lx=(cx+Math.cos(ang)*lrad)|0,ly=(cy+Math.sin(ang)*lrad)|0;drawCircle(this.u32,this.w,this.h,lx,ly,3+i,lcol,false);}}this.ctx.putImageData(this.imageData,0,0);}catch(e){console.error('CymaticWavesViz:',e);}}}

    // VIZ 3: FRACTAL CASCADE - 4-way symmetric fractal with pulsing zoom

    class FractalCascadeViz{constructor(ctx){this.ctx=ctx;this.w=0;this.h=0;this.time=0;this.branches=[];this.zoom=1;}resize(w,h,s){this.w=w;this.h=h;this.imageData=this.ctx.getImageData(0,0,w,h);this.u32=new Uint32Array(this.imageData.data.buffer);const t=new Uint8ClampedArray(4);t[3]=255;this.BLACK32=new Uint32Array(t.buffer)[0];this.branches=[];for(let i=0;i<40;i++){this.branches.push({z:-200+i*10,ang:Math.random()*Math.PI*2});}}frame(a){try{this.u32.fill(this.BLACK32);const p=window.parallaxOffset||{x:0,y:0};const cx=this.w/2+p.x,cy=this.h/2+p.y,m=window.motionScale?.()||1;this.time+=m*0.7;this.zoom=1+Math.sin(this.time*0.3)*0.15*(a?.average||0);const audioGrow=(a?.bass||0)*60+(a?.beat||0)*30;for(const b of this.branches){b.z+=2;if(b.z>200){b.z-=400;b.ang=Math.random()*Math.PI*2;}const sc=280/(280+b.z)*this.zoom,len=(40+audioGrow)*sc;const depth=Math.max(0,1-b.z/200);const hue=((depth*200+this.time*30)%360)/360;const col=THEMES[window.vizTheme].fn(hue*255,255,a);for(let sym=0;sym<4;sym++){const symAng=sym*Math.PI/2;const branches=3;for(let i=0;i<branches;i++){const ang=b.ang+this.time*0.2+(i/branches)*Math.PI*2+symAng;const x2=cx+Math.cos(ang)*len,y2=cy+Math.sin(ang)*len;drawLine(this.u32,this.w,this.h,cx,cy,x2|0,y2|0,col);const subAng1=ang-0.6,subAng2=ang+0.6;const sx1=x2+Math.cos(subAng1)*len*0.35,sy1=y2+Math.sin(subAng1)*len*0.35;const sx2=x2+Math.cos(subAng2)*len*0.35,sy2=y2+Math.sin(subAng2)*len*0.35;drawLine(this.u32,this.w,this.h,x2|0,y2|0,sx1|0,sy1|0,col);drawLine(this.u32,this.w,this.h,x2|0,y2|0,sx2|0,sy2|0,col);}}}this.ctx.putImageData(this.imageData,0,0);}catch(e){console.error('FractalCascadeViz:',e);}}}

    // VIZ 4: VORTEX NEST - Golden ratio spirals with atmospheric depth

    class VortexNestViz{constructor(ctx){this.ctx=ctx;this.w=0;this.h=0;this.time=0;this.spirals=[];}resize(w,h,s){this.w=w;this.h=h;this.imageData=this.ctx.getImageData(0,0,w,h);this.u32=new Uint32Array(this.imageData.data.buffer);const t=new Uint8ClampedArray(4);t[3]=255;this.BLACK32=new Uint32Array(t.buffer)[0];this.spirals=[];for(let i=0;i<50;i++){this.spirals.push({z:-250+i*10,arms:3,rot:Math.random()*TAU});}}frame(a){try{this.u32.fill(this.BLACK32);const p=window.parallaxOffset||{x:0,y:0};const cx=this.w/2+p.x,cy=this.h/2+p.y,m=window.motionScale?.()||1;this.time+=m*0.5;const audioTwist=(a?.average||0)*2+(a?.beat||0);for(const sp of this.spirals){sp.z+=2;sp.rot+=0.03*m;if(sp.z>250){sp.z-=500;sp.rot=Math.random()*TAU;}const sc=300/(300+sp.z);const depth=Math.max(0,1-sp.z/250);const hue=atmosphericHue(depth,depth*240)%360/360;const col=THEMES[window.vizTheme].fn(hue*255,255,a);for(let arm=0;arm<sp.arms;arm++){const baseAng=sp.rot+(arm/sp.arms)*TAU;for(let i=0;i<10;i++){const t=i/10,t2=(i+1)/10;const spiral1=t*PHI*TAU+this.time*0.5+sp.z*0.01+audioTwist,spiral2=t2*PHI*TAU+this.time*0.5+sp.z*0.01+audioTwist;const rad1=(20+t*80)*sc,rad2=(20+t2*80)*sc;const ang1=baseAng+spiral1,ang2=baseAng+spiral2;const x1=(cx+Math.cos(ang1)*rad1)|0,y1=(cy+Math.sin(ang1)*rad1)|0;const x2=(cx+Math.cos(ang2)*rad2)|0,y2=(cy+Math.sin(ang2)*rad2)|0;drawLine(this.u32,this.w,this.h,x1,y1,x2,y2,col);}}}this.ctx.putImageData(this.imageData,0,0);}catch(e){console.error('VortexNestViz:',e);}}}

    // VIZ 5: NEURAL WEB - Interconnected neural network nodes pulsing

    class NeuralWebViz{constructor(ctx){this.ctx=ctx;this.w=0;this.h=0;this.time=0;this.neurons=[];}resize(w,h,s){const buf=initBuffer(this.ctx,w,h);this.w=w;this.h=h;this.imageData=buf.imageData;this.u32=buf.u32;this.BLACK32=buf.BLACK32;this.neurons=[];for(let i=0;i<60;i++){this.neurons.push({z:-200+i*7,x:(Math.random()-0.5)*200,y:(Math.random()-0.5)*200,connections:[]});}}frame(a){try{this.u32.fill(this.BLACK32);const p=window.parallaxOffset||{x:0,y:0};const cx=this.w/2+p.x,cy=this.h/2+p.y,m=window.motionScale?.()||1;this.time+=m*0.6;const audioPulse=(a?.beat||0)*30;for(const n of this.neurons){n.z+=1.3;if(n.z>200){n.z-=400;n.x=(Math.random()-0.5)*200;n.y=(Math.random()-0.5)*200;}const sc=320/(320+n.z);const nx=(cx+n.x*sc)|0,ny=(cy+n.y*sc)|0;const pulse=(5+audioPulse)*sc;const depth=Math.max(0,1-n.z/200);const col=THEMES[window.vizTheme].fn(depth*255,255,a);drawCircle(this.u32,this.w,this.h,nx,ny,pulse,col,false);for(const n2 of this.neurons){if(n2===n||n2.z<n.z)continue;const dist=Math.hypot(n.x-n2.x,n.y-n2.y);if(dist<180){const sc2=320/(320+n2.z);const n2x=(cx+n2.x*sc2)|0,n2y=(cy+n2.y*sc2)|0;const strength=1-dist/180;if(Math.random()<strength*0.3){drawLine(this.u32,this.w,this.h,nx,ny,n2x,n2y,col);}}}}this.ctx.putImageData(this.imageData,0,0);}catch(e){console.error('NeuralWebViz:',e);}}}

    // VIZ 6: COSMIC EMANATION - Divine rays from central sun with orbital spheres (Fludd-inspired)

    class CosmicEmanationViz{constructor(ctx){this.ctx=ctx;this.w=0;this.h=0;this.time=0;this.rays=[];this.spheres=[];}resize(w,h,s){const buf=initBuffer(this.ctx,w,h);this.w=w;this.h=h;this.imageData=buf.imageData;this.u32=buf.u32;this.BLACK32=buf.BLACK32;this.rays=[];this.spheres=[];const rayCount=64;for(let i=0;i<rayCount;i++){this.rays.push({angle:i/rayCount*Math.PI*2,z:-150+Math.random()*300});}for(let i=0;i<12;i++){this.spheres.push({orbit:80+i*25,angle:Math.random()*Math.PI*2,speed:0.3+Math.random()*0.4,size:8-i*0.5,z:-100+i*15});}}frame(a){try{this.u32.fill(this.BLACK32);const p=window.parallaxOffset||{x:0,y:0};const cx=this.w/2+p.x,cy=this.h/2+p.y,m=window.motionScale?.()||1;this.time+=m*0.4;const bassExtend=(a?.bass||0)*120+(a?.beat||0)*60;const midSwirl=(a?.average||0)*0.5;const highFlicker=(a?.high||0)*15;for(const r of this.rays){r.z+=0.8;if(r.z>150)r.z-=300;const sc=220/(220+r.z);const rayLen=(100+bassExtend)*sc;const wobble=noise.noise2D(r.angle*3,this.time*0.2)*0.15;const ang=r.angle+wobble+midSwirl;const x2=(cx+Math.cos(ang)*rayLen)|0,y2=(cy+Math.sin(ang)*rayLen)|0;const depth=Math.max(0,1-Math.abs(r.z)/150);const col=THEMES[window.vizTheme].fn(depth*255,255,a);drawLine(this.u32,this.w,this.h,cx,cy,x2,y2,col);}const sunSize=(25+bassExtend*0.2)|0;const sunCol=THEMES[window.vizTheme].fn(255,255,a);drawCircle(this.u32,this.w,this.h,cx,cy,sunSize,sunCol,false);for(const s of this.spheres){s.angle+=s.speed*m*0.02+midSwirl*0.3;s.z+=0.5;if(s.z>100)s.z-=200;const sc=250/(250+s.z);const orbitRad=(s.orbit+highFlicker)*sc;const sx=(cx+Math.cos(s.angle)*orbitRad)|0,sy=(cy+Math.sin(s.angle)*orbitRad)|0;const sphSize=(s.size+highFlicker*0.3)*sc;const depth=Math.max(0,1-Math.abs(s.z)/100);const col=THEMES[window.vizTheme].fn(depth*255,255,a);drawCircle(this.u32,this.w,this.h,sx,sy,sphSize,col,false);}this.ctx.putImageData(this.imageData,0,0);}catch(e){console.error('CosmicEmanationViz:',e);}}}

    // VIZ 7: HYPERGRID SPIRAL - Hybrid with particle trails

    class HypergridSpiralViz{constructor(ctx){this.ctx=ctx;this.w=0;this.h=0;this.time=0;this.grids=[];this.particles=[];this.rotation=0;}resize(w,h,s){const buf=initBuffer(this.ctx,w,h);this.w=w;this.h=h;this.imageData=buf.imageData;this.u32=buf.u32;this.BLACK32=buf.BLACK32;this.grids=[];this.particles=[];for(let i=0;i<80;i++){this.grids.push({z:-200+i*5,rot:0});}for(let i=0;i<120;i++){this.particles.push({angle:Math.random()*TAU,radius:Math.random()*150,z:-200+Math.random()*400,speed:0.5+Math.random()*1.5,orbitSpeed:0.02+Math.random()*0.04,trail:[]});}}frame(a){try{for(let i=0;i<this.u32.length;i++){const r=(this.u32[i]&255),g=(this.u32[i]>>8&255),b=(this.u32[i]>>16&255);this.u32[i]=pack32((r*0.92)|0,(g*0.92)|0,(b*0.92)|0,255);}const p=window.parallaxOffset||{x:0,y:0};const cx=this.w/2+p.x,cy=this.h/2+p.y,m=window.motionScale?.()||1;this.time+=m*0.6;this.rotation+=m*0.015;const beatPulse=(a?.beat||0)*50;const audioExpand=(a?.average||0)*40;const rot=makeRotation(cx,cy,this.rotation);for(const g of this.grids){g.z+=1.2*m;g.rot+=0.02*m;if(g.z>200){g.z-=400;}const sc=250/(250+g.z);const size=(50+audioExpand+beatPulse)*sc;const depth=Math.max(0,1-Math.abs(g.z)/200);const hue=atmosphericHue(depth,this.time*25)%360/360;const col=THEMES[window.vizTheme].fn(hue*255,255,a);const grot=makeRotation(cx,cy,this.rotation+g.rot);const x1=(cx-size)|0,y1=(cy-size)|0,x2=(cx+size)|0,y2=(cy+size)|0;const rx1=grot.x(x1,y1)|0,ry1=grot.y(x1,y1)|0,rx2=grot.x(x2,y1)|0,ry2=grot.y(x2,y1)|0;const rx3=grot.x(x2,y2)|0,ry3=grot.y(x2,y2)|0,rx4=grot.x(x1,y2)|0,ry4=grot.y(x1,y2)|0;drawLine(this.u32,this.w,this.h,rx1,ry1,rx2,ry2,col);drawLine(this.u32,this.w,this.h,rx2,ry2,rx3,ry3,col);drawLine(this.u32,this.w,this.h,rx3,ry3,rx4,ry4,col);drawLine(this.u32,this.w,this.h,rx4,ry4,rx1,ry1,col);}for(const pt of this.particles){pt.z+=pt.speed*m;pt.angle+=pt.orbitSpeed*m;if(pt.z>200){pt.z-=400;pt.radius=Math.random()*150;pt.angle=Math.random()*TAU;pt.trail=[];}const sc=280/(280+pt.z);const spiral=pt.z*0.03+this.time*0.5;const r=(pt.radius+Math.sin(spiral)*20)*sc;const ang=pt.angle+spiral;const px=(cx+Math.cos(ang)*r)|0,py=(cy+Math.sin(ang)*r)|0;const depth=Math.max(0,1-Math.abs(pt.z)/200);const hue2=atmosphericHue(depth,this.time*40)%360/360;const pcol=THEMES[window.vizTheme].fn(hue2*255,255,a);const psize=(2+beatPulse*0.08)*sc;drawCircle(this.u32,this.w,this.h,px,py,Math.max(1,psize|0),pcol,false);}this.ctx.putImageData(this.imageData,0,0);}catch(e){console.error('HypergridSpiralViz:',e);}}}

    function init(){const canvas=document.getElementById('canvas');if(!canvas)return console.error('Canvas not found');const ctx=canvas.getContext('2d',{alpha:false,willReadFrequently:true})||canvas.getContext('2d');window.vizRenderers=[window.tunnelRenderer,new InfinityGridViz(ctx),new CymaticWavesViz(ctx),new FractalCascadeViz(ctx),new VortexNestViz(ctx),new NeuralWebViz(ctx),new CosmicEmanationViz(ctx),new HypergridSpiralViz(ctx)];sizeCanvas();if(window.tunnelRenderer&&window.tunnelRenderer.colorForRow32){window.tunnelRenderer.colorForRow32=function(i,l,a){return THEMES[window.vizTheme].fn(i,l,a);};}setInterval(()=>{if(!window.vizAutoSwitch)return;const idx=window.audio?.trackIndex;if(idx!==undefined&&idx!==lastTrackIndex&&lastTrackIndex!==-1){window.vizMode=(window.vizMode+1)%window.vizRenderers.length;window.psychedelicMode=window.vizPsychedelicModes[window.vizMode];console.log('üéµ Track changed ‚Üí Visualizer:',window.vizNames[window.vizMode]);}lastTrackIndex=idx;},500);window.addEventListener('keydown',e=>{if(e.code==='KeyV'){e.preventDefault();window.vizMode=(window.vizMode+1)%window.vizRenderers.length;window.psychedelicMode=window.vizPsychedelicModes[window.vizMode];console.log('Visualizer:',window.vizNames[window.vizMode]);}if(e.code==='KeyC'){e.preventDefault();window.vizTheme=(window.vizTheme+1)%THEMES.length;console.log('Theme:',THEMES[window.vizTheme].name);}if(e.code==='KeyA'){e.preventDefault();window.vizAutoSwitch=!window.vizAutoSwitch;console.log('Auto-switch:',window.vizAutoSwitch);}});console.log('‚úì Enhanced 8-bit pixel visualizers loaded');console.log('Keys: V=viz, C=color, A=auto-switch, X=psychedelic, ‚Üë‚Üì=speed, []=intensity');}

    if(window.tunnelRenderer){init();}else{const check=setInterval(()=>{if(window.tunnelRenderer){clearInterval(check);setTimeout(init,100);}},100);}

    })();

  </script>

</body>

</html>

