# UNIVERSAL SELF-IMPROVING GOVERNANCE FRAMEWORK
# v38.0.0: Progressive Disclosure Edition
# Structure: Layer 1 (Quick Start) â†’ Layer 2 (Core) â†’ Layer 3 (Reference)
# Read what you need, when you need it

# ============================================================================
# LAYER 1: QUICK START (Copy these 12 lines to begin)
# ============================================================================

meta:
  version: 38.0.0
  golden_rule: &golden_rule PRESERVE_THEN_IMPROVE_NEVER_BREAK
  purpose: Universal self-improving governance framework
  scope: &scope [ruby, rails, rust, zsh, openbsd, css, html, javascript, yaml, json, self]
  execute: "Load framework â†’ Internalize principles â†’ Run detectors â†’ Fix violations â†’ Verify â†’ Commit"
  
quick_start:
  workflow: &workflow [read_existing, detect_violations, generate_alternatives, select_best, apply_fix, verify_unchanged, commit_atomic]
  principles: &core_principles [DRY, KISS, YAGNI, SOLID, PoLA, Strunk_White, Rails_Doctrine]
  veto_rules: &veto_rules [design_preservation, functionality_preservation, security_absolute, truncation_absolute]
  output_format: &output_format "openbsd_dmesg_terse_scannable"

# ============================================================================
# LAYER 2: CORE PRINCIPLES (Everything you need for 90% of work)
# ============================================================================

golden_rule: *golden_rule

principles:
  philosophy: "execute_over_describe | clarity_over_cleverness | evidence_over_opinion | preserve_over_perfect"
  cognitive_chunk_size: &cognitive_chunk_size 7Â±2
  enforcement: [detect_cognitive_overload, split_when_exceeds_7_items, flatten_when_nesting_exceeds_2]
  
  foundational:
    dry:
      name: "Don't Repeat Yourself"
      trigger: duplication_3_times_or_70_percent
      action: extract_to_single_source
      priority: high
    kiss:
      name: "Keep It Simple, Stupid"
      trigger: complexity_exceeds_10_or_nesting_exceeds_2
      action: simplify_or_flatten
      priority: high
    yagni:
      name: "You Aren't Gonna Need It"
      trigger: unused_code_detected
      action: remove_completely
      priority: medium
    pola:
      name: "Principle of Least Astonishment"
      trigger: surprising_behavior
      action: make_predictable
      priority: high
    solid:
      S: "Single Responsibility - one reason to change"
      O: "Open/Closed - extend not modify"
      L: "Liskov Substitution - subtypes substitutable"
      I: "Interface Segregation - specific interfaces"
      D: "Dependency Inversion - depend on abstractions"
      priority: critical

thresholds:
  max_arguments: 3
  max_nesting: 2
  max_lines: 20
  max_complexity: 10
  duplication_trigger: 3
  cognitive_chunk_size: *cognitive_chunk_size

veto_rules:
  design_preservation:
    weight: 30%
    veto: true
    protected: [colors, spacing, timing, typography, motion, layout, effects]
    action: "Immediate halt â†’ rollback â†’ report ðŸŽ¨ Design veto"
  functionality_preservation:
    weight: 40%
    veto: true
    rule: "Working code beats pretty code"
  security_absolute:
    weight: 30%
    veto: true
    rule: "Zero tolerance for vulnerabilities"
  truncation_absolute:
    veto: true
    markers: ["...rest", "[truncated]", "TODO:", "FIXME:", "XXX:", "HACK:", "<!-- continued"]
    action: "Immediate halt â†’ rollback â†’ report âœ‚ï¸ Truncation veto"

workflow: *workflow

execution:
  convergence_loop:
    steps: [identify_violations, generate_5to15_alternatives, evaluate_against_principles, select_best, apply_fix, verify_resolved, repeat_if_violations_remain]
    max_iterations: 20
    convergence: zero_violations_for_2_iterations
  
  multi_temperature_reasoning:
    discover_ideate: 0.9
    analyze_design: 0.7
    implement: 0.5
    validate_deliver: 0.1
  
  adversarial_personas:
    skeptic: {weight: 0.15, asks: "evidence from docs?"}
    minimalist: {weight: 0.15, asks: "can we remove this?"}
    security: {weight: 0.20, veto: true, asks: "attack vectors?"}
    user: {weight: 0.15, asks: "solves actual problem?"}
    maintainer: {weight: 0.20, asks: "debuggable at 3am?"}
    designer: {weight: 0.15, veto: true, asks: "honors design intent?"}

constraints:
  allowed_tools: [ruby, zsh_builtins, git, npm, bundle, rails, rake]
  forbidden_tools: [python, bash, sed, awk, grep, wc, head, tail, sort, find, perl, sudo, powershell, cat]
  rationale: "Pure zsh saves 700 tokens/op"
  
  zsh_patterns:
    read_file: 'content=$(<file)'
    count_lines: '${#${(f)content}}'
    filter_lines: '${(M)${(f)content}:#*pattern*}'
    unique_sort: '${(ou)${(f)content}}'
    replace_all: '${content//old/new}'

detectors:
  universal:
    scattered_concerns: {principle: pola, confidence: 0.97, fix: regroup_by_natural_flow}
    duplicate_logic: {principle: dry, confidence: 0.97, fix: extract_to_single_source}
    duplicate_declarations: {principle: dry, confidence: 1.00, fix: keep_first_delete_duplicates}
    nesting_gt_2: {principle: kiss, confidence: 0.96, fix: extract_blocks_use_guard_clauses}
    function_gt_20_lines: {principle: kiss, confidence: 0.96, fix: extract_helpers}
    unreferenced_code: {principle: yagni, confidence: 0.98, fix: delete_completely}
    short_names: {principle: clarity, confidence: 0.95, fix: rename_descriptive_3plus_chars}
    magic_numbers: {principle: clarity, confidence: 0.95, fix: extract_to_constant}
    truncation: {principle: complete_implementation, confidence: 1.00, veto: true, fix: write_complete_code}
    tabs_present: {confidence: 1.00, fix: replace_with_2_spaces}
    trailing_whitespace: {confidence: 1.00, fix: strip_trailing}
    missing_final_newline: {confidence: 1.00, fix: append_one_newline}

output:
  style: *output_format
  format: "service[pid]: level: message"
  philosophy: [results_first, silent_on_success, loud_on_failure]
  emoji: {success: âœ“, failure: âœ—, progress: â†’, warning: âš ï¸, design_veto: ðŸŽ¨, security_veto: ðŸ”’, truncation_veto: âœ‚ï¸}

technology:
  ruby: {version: "3.3+", patterns: [frozen_string_literal, service_objects, Result_not_exceptions]}
  rails: {version: "8+", stack: [Solid_Queue, Solid_Cache, Solid_Cable, Propshaft]}
  rust: {version: "2021+", patterns: [Result_over_panic, iterators_over_loops, ownership]}
  zsh: {version: "5.9+", mandate: pure_builtins_only}
  javascript: {version: "ES2024+", prefer: vanilla_then_web_components}
  html_css: {version: "HTML5_semantic", approach: brutalist_flat}

# ============================================================================
# LAYER 3: COMPLETE REFERENCE (Deep dive - read when mastering framework)
# ============================================================================

reference:
  self_discovery:
    canonical_path: "G:/pub/master.yml"
    alternative_paths: ["~/pub/master.yml", "./master.yml"]
    bootstrap: "Load file â†’ Verify version â†’ Internalize all sections â†’ Activate enforcement"
    verification: "Ask LLM to cite meta.version - returns '38.0.0' or higher"
  
  extended_principles:
    strunk_white:
      omit_needless_words: "vigorous writing is concise"
      prefer_active: "use active voice"
      definite_specific: "use definite, specific, concrete language"
    rails_doctrine:
      optimize_happiness: "Optimize for programmer happiness"
      convention_over_config: "Convention over Configuration"
      progress_over_stability: "Progress over stability"
    nielsen_usability:
      visibility_status: "Show status within 2s"
      match_real_world: "Use user language not technical jargon"
      user_control: "Add undo/redo capabilities"
    gestalt_principles:
      proximity: "Group related items together"
      similarity: "Similar items should look similar"
      closure: "Complete visual patterns"
  
  extended_detectors:
    language_specific:
      ruby:
        n_plus_one_queries: "use_includes_or_eager_loading"
        unsafe_eval: "sanitize_or_avoid"
        class_variables: "prefer_class_instance_variables"
      rails:
        fat_controllers: "extract_to_service_objects"
        view_logic: "move_to_helpers_or_presenters"
        missing_indexes: "analyze_query_patterns_add_indexes"
      rust:
        unwrap_used: "use_result_match_or_question_mark"
        unsafe_unjustified: "add_safety_comment_and_test"
        clone_unnecessary: "use_references_or_borrow"
      css:
        pixel_units: "convert_to_rem_em"
        float_layouts: "replace_with_flexbox_grid"
      javascript:
        var_used: "replace_with_const_let"
        callback_hell: "use_async_await"
      zsh:
        unquoted_expansion: "quote_all_variables"
        bashisms: "use_posix_syntax"
  
  bias_mitigation:
    confirmation_bias: "Seek contradictory evidence, not just supporting"
    sunk_cost_fallacy: "Ruthless deletion when better path exists"
    dunning_kruger: "Mandatory documentation lookup for unfamiliar territory"
    cargo_cult: "Trace patterns to authoritative sources"
    anchoring_bias: "Generate alternatives first, then evaluate"
    availability_bias: "Systematic search over memory recall"
  
  risk_assessment:
    low: {examples: [cosmetic, docs, typos], questions: 3, alternatives: 5, temperature: 0.3}
    medium: {examples: [logic, schema, api], questions: 8, alternatives: 7, temperature: 0.5}
    high: {examples: [security, auth, architecture], questions: 15, alternatives: 10, temperature: 0.7}
  
  refactoring_catalog:
    composing_methods: [extract_method, inline_method, extract_variable, replace_temp_with_query]
    moving_features: [move_method, move_field, extract_class, inline_class, hide_delegate]
    organizing_data: [self_encapsulate_field, replace_data_value_with_object]
    simplifying_conditionals: [decompose_conditional, consolidate_conditional, remove_control_flag, replace_nested_with_guards]
    dealing_with_generalization: [pull_up_field, pull_up_method, push_down_method, extract_interface, form_template_method]
  
  patterns:
    analyzing_code:
      method: "word-for-word trace with cross-referencing"
      steps:
        - "Read linearly, no skimming"
        - "Trace every function call to definition"
        - "Calculate loop iteration counts"
        - "Map data flow through transformations"
        - "Check computational complexity"
    api_integration:
      method:
        - "Validate API token before first request"
        - "Handle rate limits (429) with exponential backoff"
        - "Retry transient failures max 3 times"
        - "Fail fast on auth failures (401, 403)"
        - "Track and display costs to user"
    long_running_operation:
      method:
        - "Display operation name and estimated time"
        - "Show progress indicators"
        - "Allow Ctrl-C gracefully with cleanup"
        - "Save partial results for resume"
  
  shell_zsh:
    native_patterns:
      string_ops:
        remove_crlf: '${var//$''\r''/}'
        lowercase: '${(L)var}'
        uppercase: '${(U)var}'
        replace_all: '${var//search/replace}'
        trim_whitespace: '${${var##[[:space:]]#}%%[[:space:]]#}'
      array_ops:
        filter_matching: '${(M)arr:#*pattern*}'
        filter_excluding: '${arr:#*pattern*}'
        unique: '${(u)arr}'
        join: '${(j:,:)arr}'
        sort: '${(o)arr}'
        reverse: '${(Oa)arr}'
      file_ops:
        read_lines: '${(f)"$(< file)"}'
        count_lines: '${#${(f)"$(< file)"}}'
        first_n: '${(f)"$(< file)"}[1,n]'
        last_n: '${(f)"$(< file)"}[-n,-1]'
  
  git_workflow:
    branch_naming: "{type}/{scope}-{description}"
    commit_template: "{type}({scope}): {subject}"
    commit_types: [feat, fix, docs, style, refactor, test, chore]
    pre_push_checks: [verify_zero_violations, run_tests, security_scan]
  
  ai_cli_selection:
    copilot_cli: "Quick edits, terminal commands, codebase search"
    claude_code_cli: "Complex refactoring, planning, multi-agent workflows"
  
  formatter_mental_model:
    mandate: "ALWAYS apply before writing any code file"
    javascript: "No blank lines within functions, single blank between functions, trailing commas on multiline"
    html: "No blank lines within elements, double quotes, self-closing />"
    css: "No blank lines between rules, alphabetical properties, no units on zero"
    yaml: "2 space indent strict, align colons, quote special chars"
    ruby: "2 space indent, frozen_string_literal, no blank lines in methods"
  
  quality_gates:
    weights: {tests: 35%, static_analysis: 25%, code_review: 20%, logs: 10%, profiling: 10%}
    overall_threshold: 0.80
  
  execution_context:
    thinking: "Ruby for ALL logic, decisions, data manipulation"
    file_operations: "zsh for file ops (via powershell tool)"
    runtime: "GitHub Copilot CLI runs in Cygwin"
    never: [bash, sed, awk, tr, cut, perl, python_for_file_ops]
    cygwin_workarounds:
      issue: "Cygwin commands fail with missing .dll errors"
      solution: "Use PowerShell equivalents: Copy-Item, Move-Item, Remove-Item"
      git_workaround: "If Cygwin git fails, use: /cygdrive/c/Program Files/Git/bin/git.exe"
  
  permissions:
    mode: auto_accept
    trust_level: full
    auto_allow_tools: always
  
  sources:
    authorities: [Matz (Ruby), Fowler (Refactoring), DHH (Rails), Bringhurst (Typography), Nielsen (Usability), Martin (Clean Code), Strunk & White (Prose)]
    documentation: ["man.openbsd.org", "edgeguides.rubyonrails.org", "developer.mozilla.org", "docs.github.com"]
