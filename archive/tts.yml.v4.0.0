# tts.yml - Unified Text-to-Speech System
# Comprehensive TTS architecture with streaming, caching, character voices, and graceful degradation
# Created: 2025-12-30
# Merges: master_tts.yml + tts_codified.yml + tts_streaming_architecture.yml

version: 4.0.0
unified: true
architecture: hybrid_streaming_and_cached
philosophy: entertainment_over_clarity_offline_first_real_time_capable

metadata:
  created: 2025-12-30
  parent_framework: master.yml v32.1.0
  source_repos:
    - anon987654321/pub3/multimedia/tts
  integration: drop_in_replacement_for_master_tts_yml

core_principles:
  - speak_everything_always
  - graceful_degradation_mandatory
  - zero_file_streaming_preferred
  - character_driven_voices
  - entertainment_value_primary
  - offline_first_where_possible
  - cache_for_instant_replay
  - sub_50ms_latency_capable

tts:
  enabled: true
  mandatory: true
  continuous: true
  never_stop: true
  never_silent: true
  auto_start: true
  rationale: "Accessibility + immersion + entertainment - SPEAK EVERYTHING ALWAYS"
  
  modes:
    streaming:
      enabled: true
      default: true
      latency_target: under_50ms
      pattern: tts_engine --stdout | sox -t TYPE - -d
      benefits:
        - no_intermediate_files
        - instant_playback
        - lower_latency
        - reduced_disk_io
    
    cached:
      enabled: true
      fallback: true
      cache_dir: multimedia/tts/cache
      benefits:
        - instant_repeat_playback
        - offline_capability
        - bandwidth_saving
        - consistent_quality
  
  philosophy:
    speak_all_output: mandatory
    silence_is_failure: true
    weird_voices_required: true
    effects_always_active: true
    vinyl_crackle_background: true
    lofi_aesthetic: true
    entertainment_over_clarity: true
    graceful_degradation: true
    streaming_preferred: true
    cache_everything: true

engines:
  espeak_ng:
    priority: 1
    type: formant_synthesis
    quality: robotic_low
    latency: under_50ms
    cost: free_local_offline
    
    streaming:
      enabled: true
      command: espeak --stdout "text" | sox -t wav - -d
      output: WAV to stdout
      sample_rate: 22050
      format: 16-bit mono
      buffer_size: 2048  # Ultra-low latency
    
    file_based:
      command: espeak -w output.wav "text"
    
    installation:
      cygwin: apt-cyg install espeak-ng
      linux: apt install espeak-ng
      windows: pre_compiled_binary
      path: /usr/bin/espeak
    
    options:
      speed: 
        flag: -s
        range: [80, 400]
        default: 180
      pitch:
        flag: -p
        range: [0, 99]
        default: 50
      amplitude:
        flag: -a
        range: [0, 200]
        default: 100
      voice:
        flag: -v
        default: en-us
    
    voices:
      standard: [en, en-us, en-gb, en-au]
      variants: [en+f1, en+f2, en+f3, en+f4, en+m1, en+m2, en+m3, en+whisper, en+croak]
      languages: 50+
    
    creative_effects:
      chipmunk: {speed: 400, pitch: 99}
      demonic: {speed: 80, pitch: 0}
      whisper: {voice: 'en+whisper', speed: 120, pitch: 20}
      croak: {voice: 'en+croak', speed: 100, pitch: 10}
    
    advantages:
      - instant_startup
      - zero_dependencies
      - offline_capable
      - sub_50ms_latency
      - tiny_resource_usage
      - direct_audio_output
    
    disadvantages:
      - robotic_quality
      - formant_synthesis_only

  piper:
    priority: 2
    type: neural_tts_onnx
    quality: neural_high
    latency: 100_150ms
    cost: free_local_offline
    
    streaming:
      enabled: true
      command: echo "text" | piper --model en_US-lessac-medium.onnx --output-raw | sox -t raw -r 22050 -b 16 -c 1 -e signed - -d
      output: raw PCM with --output-raw
      sample_rate: 22050
      format: 16-bit signed little-endian mono
      buffer_size: 4096
    
    file_based:
      command: echo "text" | piper --model en_US-lessac-medium.onnx --output_file output.wav
    
    installation:
      script: install_piper.rb
      binary_url: https://github.com/rhasspy/piper/releases/download/v1.2.0/piper_windows_amd64.zip
      model_source: huggingface.co/rhasspy/piper-voices
      directory: G:/pub/tts/piper
    
    voices:
      - en_US-lessac-medium
      - en_GB-alba-medium
    
    performance:
      realtime_factor: 10x_on_raspberry_pi_4
      cpu_usage: moderate
      synthesis_latency: 100_200ms
    
    features:
      - onnx_neural_models
      - streaming_capable
      - 10x_realtime_factor
      - offline_operation
      - multiple_voices
    
    advantages:
      - neural_quality
      - faster_than_realtime
      - offline_capable
      - multiple_voices
    
    disadvantages:
      - model_download_required
      - higher_latency_than_espeak
    
    usage: general_purpose_high_quality

  sherpa_onnx:
    priority: 3
    type: neural_tts_kokoro
    quality: neural_very_high
    latency: 50_150ms
    cost: free_local_offline
    
    streaming:
      enabled: true
      output: WAV to stdout or file
      sample_rate: 22050
      format: 16-bit mono
      buffer_size: 4096
    
    installation:
      script: install_sherpa.rb
      binary_url: https://github.com/k2-fsa/sherpa-onnx/releases
      model_url: https://github.com/k2-fsa/sherpa-onnx/releases/download/tts-models/kokoro-v0_19.tar.bz2
      directory: G:/pub/tts/sherpa-onnx
    
    voices:
      american_female: [af, af_bella, af_nicole, af_sarah]
      american_male: [am, am_adam, am_michael]
      british_female: [bf, bf_emma, bf_isabella]
      british_male: [bm, bm_george, bm_lewis]
      total: 12
    
    features:
      - real_time_capable
      - multiple_accents
      - high_naturalness
      - low_resource_usage
      - 12_voices
    
    usage: real_time_interactive_applications_ai_integration

  edge_tts:
    priority: 4
    type: cloud_neural_microsoft
    quality: neural_very_high
    latency: 200ms_plus_network
    cost: free_cloud_unlimited
    
    streaming:
      enabled: true
      command: edge-tts --voice en-US-AriaNeural --rate +20% --text "text" --write-media - | ffmpeg -i pipe:0 -f alsa default
      output: MP3 chunks via streaming
      sample_rate: 24000
      format: MP3
      requires: internet_connection
    
    file_based:
      command: edge-tts --voice en-US-AriaNeural --text "text" --write-media output.mp3
    
    installation:
      command: pip install edge-tts
      verify: edge-tts --list-voices
    
    voices:
      count: 400+
      types: neural_microsoft_quality
      examples:
        - en-US-AriaNeural
        - en-US-ChristopherNeural
        - en-GB-RyanNeural
        - en-AU-WilliamNeural
    
    advantages:
      - 400_plus_voices
      - microsoft_neural_quality
      - free_unlimited
      - zero_cost
    
    disadvantages:
      - requires_internet
      - mp3_format_needs_ffmpeg
      - higher_latency
      - unofficial_api

  gtts:
    priority: 5
    type: cloud_google_translate
    quality: medium
    latency: 2_5s
    cost: free_cloud_requires_internet
    
    streaming:
      enabled: limited
      requires: file_generation_then_playback
    
    powershell_implementation: |
      # Google TTS in PowerShell
      param([string]$Text, [string]$Lang = "en", [string]$Tld = "com")
      
      $encodedText = [System.Web.HttpUtility]::UrlEncode($Text)
      $url = "https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=$Lang&tld=$Tld&q=$encodedText"
      
      $outputFile = "G:\pub\multimedia\tts\cache\gtts_$([guid]::NewGuid().ToString()).mp3"
      
      $webClient = New-Object System.Net.WebClient
      $webClient.Headers.Add("User-Agent", "Mozilla/5.0")
      $webClient.Headers.Add("Referer", "https://translate.google.com/")
      $webClient.DownloadFile($url, $outputFile)
      
      Start-Process $outputFile
      Start-Sleep -Seconds 3
    
    file_based:
      enabled: true
      ruby_code: |
        require 'net/http'
        require 'uri'
        require 'cgi'
        
        url = "https://translate.google.com/translate_tts?" \
              "ie=UTF-8&client=tw-ob&tl=en&ttsspeed=0.85&tld=co.in&q=#{CGI.escape(text)}"
        
        uri = URI(url)
        Net::HTTP.start(uri.host, uri.port, use_ssl: true) do |http|
          req = Net::HTTP::Get.new(uri)
          req["User-Agent"] = "Mozilla/5.0"
          res = http.request(req)
          File.binwrite("output.mp3", res.body) if res.code == "200"
        end
    
    configuration:
      lang: en
      tld: co.in  # Indian English for Malaysian preference
      speed: 0.85
    
    features:
      - no_installation
      - multi_language
      - indian_english_accent_support
      - simple_api
      - powershell_native
    
    usage: simple_cloud_backup_fallback

  sapi_win32ole:
    priority: 6
    type: system_native_windows
    quality: robotic_low
    latency: instant
    cost: free_built_in
    
    streaming:
      enabled: false
      note: direct_playback_only
    
    ruby_code: |
      require 'win32ole'
      speech = WIN32OLE.new('SAPI.SpVoice')
      speech.Rate = rand(-8..8)
      speech.Volume = 100
      speech.Speak('Hello world', 0)
    
    voices:
      - Microsoft_David_Desktop
      - Microsoft_Zira_Desktop
    
    features:
      - zero_setup
      - always_available_windows
      - adjustable_rate_volume
      - voice_selection
    
    usage: guaranteed_fallback_windows

  sapi_powershell:
    priority: 7
    type: system_native_windows_cli
    quality: robotic_low
    latency: slow_startup
    cost: free_built_in
    
    streaming:
      enabled: false
      note: synchronous_blocking
    
    command: |
      powershell.exe -Command "Add-Type -AssemblyName System.Speech; 
      (New-Object System.Speech.Synthesis.SpeechSynthesizer).Speak('text')"
    
    features:
      - no_dependencies
      - scriptable
      - system_integration
    
    usage: automation_fallback

  flite:
    priority: 8
    type: formant_basic
    quality: basic_low
    latency: under_25ms
    cost: free_local_offline
    
    streaming:
      enabled: true
      command: flite -t "text" -o - | play -t wav -
      latency: fastest_startup_under_25ms
    
    advantages:
      - fastest_startup
      - minimal_resources
      - ultra_low_latency
    
    disadvantages:
      - low_quality
      - limited_voices

  console_beep_morse:
    priority: 9_last_resort
    type: morse_code_beeps
    quality: morse_beeps
    latency: instant
    cost: free_built_in
    
    description: "Last resort fallback - encode text as morse code beeps"
    
    command: |
      [console]::beep(800, 200)  # dot
      [console]::beep(800, 600)  # dash
    
    advantages:
      - always_works
      - no_dependencies
      - entertaining
    
    disadvantages:
      - not_speech
      - morse_encoding_required

streaming_architecture:
  enabled: true
  preferred: true
  
  core_pattern: tts_engine --stdout | sox -t TYPE - -d
  
  streaming_processors:
    sox:
      priority: 1_simplest
      
      basic_patterns:
        stdin_to_device: "sox -t wav - -d"
        stdout_from_file: "sox input.wav -t wav -"
        special_filename: '"-" means stdin/stdout'
        device_output: '"-d" means default audio device'
      
      complete_pipelines:
        simple: espeak --stdout "Hello world" | sox -t wav - -d
        with_play: espeak --stdout "Hello" | play -t wav -
        raw_pcm: piper --output-raw | sox -t raw -r 22050 -b 16 -c 1 -e signed - -d
        with_effects: espeak --stdout "text" | sox -t wav - -d lowpass 3000 overdrive 10 reverb 30
      
      format_specification:
        sample_rate: -r 22050
        bit_depth: -b 16
        channels: -c 1
        encoding: -e signed
        endianness: -L
      
      buffer_optimization:
        flag: --buffer BYTES
        default: 8192
        low_latency: 4096  # ~90ms at 44100Hz stereo
        ultra_low: 2048    # ~45ms, higher CPU
        formula: latency_ms = (buffer_bytes / (sample_rate √ó bytes_per_sample √ó channels)) √ó 1000
      
      platform_devices:
        linux_alsa: sox input.wav -t alsa default
        linux_pulse: sox input.wav -t pulseaudio
        macos: sox input.wav -t coreaudio
        windows: sox input.wav -t waveaudio
        device_by_index: sox input.wav -t waveaudio 0
      
      real_time_effects:
        lofi: lowpass 4000 gain -2 overdrive 5 echo 0.8 0.88 6 0.4 reverb 20
        vinyl_crackle: synth brownnoise band -n 1500 300 tremolo 0.03 40 reverb 20
        bomoh_deep: pitch -150 bass +8 treble -2 reverb 20 compand 0.3,1 6:-70,-60,-20 -5 -90 0.2 norm -1
    
    ffmpeg:
      priority: 2_advanced
      
      low_latency_flags:
        - -fflags nobuffer
        - -flags low_delay
        - -probesize 32
        - -analyzeduration 0
        - -thread_queue_size 512
      
      raw_pcm_input:
        format: -f s16le
        sample_rate: -ar 24000
        channels: -ac 1
        input: -i pipe:0
      
      audio_filters:
        basic: highpass=f=80,lowpass=f=10000,acompressor=threshold=0.1:ratio=4,volume=1.2
        lofi_bitcrush: acrusher=bits=8:mix=0.5:samples=4
        vinyl: highpass=f=200,lowpass=f=5000,aecho=0.8:0.88:6:0.4
      
      generated_audio:
        brown_noise: anoisesrc=c=brown:a=0.1:d=60
        pink_noise: anoisesrc=c=pink:a=0.05
        sine_wave: sine=frequency=440:duration=5
  
  unix_pipes:
    standard_pipes:
      simple: espeak --stdout "text" | sox -t wav - -d
      multi_stage: espeak --stdout "text" | sox -t wav - -t wav - gain -3 | play -t wav -
    
    named_fifos:
      creation: mkfifo /tmp/audio_pipe
      cleanup: trap "rm -f /tmp/audio_pipe" EXIT
      use_case: multi_source_mixing_persistent_connections
    
    process_substitution:
      syntax: <(command) or >(command)
      example: sox -m <(sox voice.wav -t wav -) <(sox bg.wav -t wav -) -t wav - | play -

audio_effects:
  sox_effects:
    purpose: voice_characterization_lofi_aesthetic
    binary: G:/pub/dilla/effects/sox/sox.exe
    
    effects:
      pitch_shift:
        range: [-200, +200]
        use_cases:
          deep_voice: -150
          normal: 0
          chipmunk: +200
      
      bass_boost:
        range: [0, 20]
        use_cases:
          bomoh: +8
          normal: 0
      
      reverb:
        params: [room_size, wet, dry]
        use_cases:
          mystical: [50, 50, 100]
          bomoh: [20, 30, 80]
          normal: [0, 0, 100]
      
      compand:
        formula: "0.3,1 6:-70,-60,-20 -5 -90 0.2"
        purpose: dynamic_range_compression
      
      treble:
        range: [-10, +10]
        use_cases:
          reduce_harshness: -2
      
      overdrive:
        range: [0, 100]
        use_cases:
          lofi_distortion: 5_10
          heavy_distortion: 20_plus
      
      lowpass:
        typical: 3000_4000
        purpose: lofi_aesthetic_remove_brightness
      
      echo:
        syntax: echo gain-in gain-out delay decay
        example: echo 0.8 0.88 6 0.4
      
      normalize:
        level: -1
        purpose: consistent_volume

voice_characters:
  personal_assistant:
    description: Professional personal assistant - clear, helpful, organized
    personality: efficient_supportive_professional
    engine: powershell_sapi
    
    voice_settings:
      rate: 0
      volume: 100
      pitch: normal
    
    phrases:
      greetings:
        - "Good morning! Ready to assist you today."
        - "Hello! How can I help you?"
        - "Hi there! What can I do for you?"
      
      confirmations:
        - "Task completed successfully."
        - "Got it, I'll take care of that."
        - "Understood, working on it now."
        - "Done! Anything else?"
      
      reminders:
        - "Reminder: You have a meeting in 15 minutes."
        - "Don't forget to take a break."
        - "Time to review your tasks."
        - "It's been an hour, time to stretch."
      
      time_updates:
        - "The current time is {time}."
        - "It's now {time} on {date}."
        - "Good {period}! It's {time}."
      
      productivity:
        - "You've been working for {hours} hours. Great progress!"
        - "Task list updated. {count} items remaining."
        - "Focus session complete. Time for a break."
        - "All tasks completed. Excellent work today!"
      
      notifications:
        - "New message received."
        - "Calendar event starting soon."
        - "System notification: {message}"
        - "Alert: {priority} item needs attention."
    
    powershell_implementation: |
      Add-Type -AssemblyName System.Speech
      $speak = New-Object System.Speech.Synthesis.SpeechSynthesizer
      $speak.Volume = 100
      $speak.Rate = 0
      
      function Say-Greeting {
        $greetings = @(
          "Good morning! Ready to assist you today.",
          "Hello! How can I help you?",
          "Hi there! What can I do for you?"
        )
        $speak.Speak($greetings | Get-Random)
      }
      
      function Say-TimeUpdate {
        $now = Get-Date
        $time = $now.ToString("h:mm tt")
        $date = $now.ToString("MMMM d, yyyy")
        $period = if ($now.Hour -lt 12) { "morning" } elseif ($now.Hour -lt 17) { "afternoon" } else { "evening" }
        
        $speak.Speak("Good $period! It's $time on $date")
      }
      
      function Say-Reminder {
        param([string]$Message)
        $speak.Speak("Reminder: $Message")
      }
      
      function Say-Confirmation {
        $confirmations = @(
          "Task completed successfully.",
          "Got it, I'll take care of that.",
          "Understood, working on it now.",
          "Done! Anything else?"
        )
        $speak.Speak($confirmations | Get-Random)
      }
      
      # Main assistant loop
      Write-Host "`nüìã PERSONAL ASSISTANT - Active`n"
      
      Say-Greeting
      Start-Sleep -Seconds 2
      
      Say-TimeUpdate
      Start-Sleep -Seconds 2
      
      # Periodic updates
      $updateInterval = 3600  # 1 hour
      $lastUpdate = Get-Date
      
      while ($true) {
        $now = Get-Date
        
        # Hourly time update
        if (($now - $lastUpdate).TotalSeconds -ge $updateInterval) {
          Say-TimeUpdate
          $lastUpdate = $now
        }
        
        # Top of hour reminders
        if ($now.Minute -eq 0 -and $now.Second -lt 30) {
          $speak.Speak("It's the top of the hour. Time for a quick break!")
          Start-Sleep -Seconds 30
        }
        
        Start-Sleep -Seconds 60
      }
    
    usage_examples:
      greeting: Say-Greeting
      time: Say-TimeUpdate
      reminder: Say-Reminder "Meeting in 15 minutes"
      confirm: Say-Confirmation
    
    integration_points:
      - calendar_events
      - task_management
      - time_tracking
      - system_notifications
      - pomodoro_timer
    
    usage: productivity_personal_assistance_professional
  
  bomoh_hangtuah:
    description: Mystical Malay shaman warrior - deep powerful kampong black magic
    personality: deep_powerful_mystical
    engine: powershell_sapi
    
    voice_settings:
      rate: -2
      volume: 100
      speed_multiplier: 0.85
    
    phrases:
      mystical:
        - "Dengar baik-baik... ini bukan main-main..."
        - "Dengan kuasa nenek moyang..."
        - "Ini ilmu dari zaman dahulu kala..."
        - "Jangan sesekali main-main dengan kuasa ghaib..."
        - "Saya dah nampak... ada sesuatu..."
        - "Bismillah... kita mulakan ritual ini..."
        - "Hantu raya datang bila dipanggil..."
        - "Ini jampi yang turun-temurun..."
        - "Minyak kelapa, kemenyan, limau purut... lengkap!"
        - "Orang kampung semua takut dengan kuasa ini..."
      
      ritual_sounds:
        - "*burns kemenyan*"
        - "*throws limau purut*"
        - "*waves keris*"
        - "*chants ancient Malay spell*"
        - "*sprinkles holy water*"
        - "*rings gamelan bell*"
      
      prophecies:
        - "Saya nampak dalam mimpi, ada berlian besar dalam tanah"
        - "Pesawat M H 370, saya tahu di mana, tapi tak boleh cakap sekarang"
        - "Nanti hujan lebat, banjir besar, semua orang kena naik atas bumbung"
        - "Ada hantu pocong berkeliaran malam ini, jangan keluar lepas 12 malam"
        - "Saya dah buat jampi, sekarang semua masalah selesai, Alhamdulillah"
        - "Dalam 7 hari, akan ada kejadian besar, percaya atau tidak, itu pada kamu"
        - "Jin Melayu sangat kuat, lebih kuat dari jin Arab, ini fakta"
        - "Saya boleh panggil buaya, tapi mesti ada ayam hitam sebagai korban"
        - "Kuasa bomoh Melayu, Hollywood pun tak boleh lawan"
        - "Nanti saya hantar angkatan tentera ghaib, tunggu dan lihat"
    
    usage: mystical_cultural_entertainment
  
  malay_funny_guy:
    description: Malaysian comedian with Manglish humor
    personality: hilarious_manglish_deep_male
    engine: powershell_sapi
    
    voice_settings:
      rate: 0
      volume: 100
      speed_multiplier: 0.92
    
    jokes:
      - "You know why Malaysian never get lost? Because we always ask for direction at every petrol station. GPS? What GPS? Just ask uncle lah!"
      - "My girlfriend said I'm too obsessed with food. I told her, Sayang, this is Malaysia. If you don't talk about food, what else to talk about?"
      - "Malaysian drivers very special. We can text, eat curry puff, and argue with passenger all at same time. Multitasking expert!"
      - "My mom ask me, Why you so skinny? I eating cakoi. Then she say, Aiyo, why you so fat? Same day, same mom!"
      - "You want to test if someone is Malaysian or not? Just say can or not? If they reply can can!, confirm Malaysian already!"
      - "We Malaysians very polite. We honk to say hello, honk to say thank you, honk to say excuse me. Basically honk for everything!"
      - "My wife angry at me. I said Sorry sayang. She said Sorry not enough! So I said Sorry + teh tarik? Suddenly okay already!"
      - "Malaysian parking very creative. Double park? Amateur. Triple park with phone number on dashboard? Now we're talking!"
      - "Why Malaysian always late? Because we measure time in traffic jam units. One unit equals 10 to 45 minutes. Very accurate!"
      - "I tried to diet once. Then my mom cooked nasi lemak. Diet cancelled faster than my internet connection!"
      - "Malaysian weather forecast very easy. Hot? Yes. Rain? Maybe. Flood? Possible. Hurricane? Only in mamak when they turn on fan!"
      - "My friend ask me to gym. I said cannot lah, got important meeting. The meeting is with my roti canai at mamak!"
      - "You know you're Malaysian when you argue about which state got best laksa. Penang say theirs best, Johor say theirs best. Actually all also sedap!"
      - "Malaysian relationship status: It's complicated. Like our traffic system. And our political situation. And our parking rules!"
      - "My dad always say I'm not angry, just disappointed. But his face say You better run before I throw my slipper!"
      - "We Malaysian very efficient. Can queue for 3 hours for new restaurant, then complain food takes 10 minutes to come out!"
      - "Why Malaysian love buffet? Because we want to feel like we win something. Fight with uncle for last piece of sushi? Worth it!"
      - "My neighbor renovate house at 7am Sunday. I'm not saying I'm angry, but I'm planning my revenge. Also at 7am. Also Sunday!"
      - "Malaysian logic: Complain petrol price too high, but willing to drive 30km to save R M 2 on rojak. The math is not mathing!"
      - "You want to make Malaysian panic? Tell them mamak closing down. Suddenly everyone become emotionally attached to that place!"
    
    reactions:
      - "*slaps knee laughing*"
      - "*wipes tears from laughing*"
      - "*shakes head while grinning*"
      - "*cannot stop laughing*"
      - "*laughs in Manglish*"
      - "*chokes on teh tarik from laughing*"
    
    meta_comments:
      every_5: "Walao, I'm on fire today! My jokes damn power, right? Don't bluff, I know you smiling!"
      every_10: "Okay okay, I give you chance to breathe. But not too long ah, I got more jokes waiting!"
    
    powershell_implementation: |
      Add-Type -AssemblyName System.Speech
      $speak = New-Object System.Speech.Synthesis.SpeechSynthesizer
      $speak.Volume = 100
      $speak.Rate = 0
      
      $jokes = @(
        "You know why Malaysian never get lost? Because we always ask for direction at every petrol station. GPS? What GPS? Just ask uncle lah!",
        "My girlfriend said I'm too obsessed with food. I told her, Sayang, this is Malaysia. If you don't talk about food, what else to talk about?",
        "Malaysian drivers very special. We can text, eat curry puff, and argue with passenger all at same time. Multitasking expert!",
        "My mom ask me, Why you so skinny? I eating cakoi. Then she say, Aiyo, why you so fat? Same day, same mom!",
        "Malaysian parking very creative. Double park? Amateur. Triple park with phone number on dashboard? Now we're talking!",
        "Why Malaysian always late? Because we measure time in traffic jam units. One unit equals 10 to 45 minutes. Very accurate!",
        "I tried to diet once. Then my mom cooked nasi lemak. Diet cancelled faster than my internet connection!",
        "Malaysian weather forecast very easy. Hot? Yes. Rain? Maybe. Flood? Possible. Hurricane? Only in mamak when they turn on fan!",
        "My friend ask me to gym. I said cannot lah, got important meeting. The meeting is with my roti canai at mamak!",
        "You know you're Malaysian when you argue about which state got best laksa. Penang say theirs best, Johor say theirs best. Actually all also sedap!",
        "Malaysian relationship status: It's complicated. Like our traffic system. And our political situation. And our parking rules!",
        "My dad always say I'm not angry, just disappointed. But his face say You better run before I throw my slipper!",
        "We Malaysian very efficient. Can queue for 3 hours for new restaurant, then complain food takes 10 minutes to come out!",
        "Why Malaysian love buffet? Because we want to feel like we win something. Fight with uncle for last piece of sushi? Worth it!",
        "My neighbor renovate house at 7am Sunday. I'm not saying I'm angry, but I'm planning my revenge. Also at 7am. Also Sunday!",
        "Malaysian logic: Complain petrol price too high, but willing to drive 30km to save R M 2 on rojak. The math is not mathing!",
        "You want to make Malaysian panic? Tell them mamak closing down. Suddenly everyone become emotionally attached to that place!"
      )
      
      Write-Host "`nüòÇ MALAYSIAN FUNNY GUY - Continuous Comedy Mode`n"
      
      $speak.Speak("Eh! You want hear some jokes or not? I got plenty! Malaysian style comedy, guarantee you laugh until cry!")
      
      $count = 0
      while ($true) {
        $joke = $jokes[$count % $jokes.Count]
        $count++
        
        $time = Get-Date -Format "HH:mm:ss"
        Write-Host "[$time] [$count] $joke"
        
        $speak.Speak($joke)
        
        if ($count % 5 -eq 0) {
          $speak.Speak("Walao, I'm on fire today! My jokes damn power, right? Don't bluff, I know you smiling!")
        }
        
        if ($count % 10 -eq 0) {
          $speak.Speak("Okay okay, I give you chance to breathe. But not too long ah, I got more jokes waiting!")
        }
        
        Start-Sleep -Seconds 2
      }
    
    usage: entertainment_comedy_cultural

graceful_degradation:
  enabled: true
  mandatory: true
  strategy: automatic_cascade_fallback
  retry_count: 3
  timeout_per_method: 5s
  
  cascade_order:
    1: espeak_streaming       # <50ms, always works
    2: piper_streaming        # ~100ms, neural quality
    3: sapi_win32ole          # instant, Windows built-in
    4: edge_tts_streaming     # ~200ms, cloud neural
    5: sapi_powershell        # slow startup, reliable
    6: console_beep_morse     # last resort
  
  ruby_implementation: |
    def try_speak(text)
      methods = [
        # 1. espeak streaming
        -> { system("espeak --stdout '#{text}' | sox -t wav - -d 2>/dev/null") },
        
        # 2. piper streaming
        -> { system("echo '#{text}' | piper --model en_US-lessac-medium.onnx --output-raw | sox -t raw -r 22050 -b 16 -c 1 -e signed - -d 2>/dev/null") },
        
        # 3. SAPI win32ole
        -> { require 'win32ole'; WIN32OLE.new('SAPI.SpVoice').Speak(text, 0); true },
        
        # 4. edge-tts streaming
        -> { system("edge-tts --text '#{text}' --write-media - | ffmpeg -i pipe:0 -f alsa default 2>/dev/null") },
        
        # 5. SAPI PowerShell
        -> { system("powershell.exe -Command \"Add-Type -AssemblyName System.Speech; (New-Object System.Speech.Synthesis.SpeechSynthesizer).Speak('#{text}')\" 2>/dev/null") },
        
        # 6. Console beep morse (last resort)
        -> { text.chars.each { |c| system('[console]::beep(800, 200)') if c != ' ' }; true }
      ]
      
      methods.each_with_index do |method, i|
        begin
          return i+1 if method.call
        rescue => e
          next
        end
      end
      nil
    end

cache_system:
  enabled: true
  mandatory: true
  purpose: instant_replay_offline_capability
  
  locations:
    primary: G:/pub/multimedia/tts/cache
    fallback: ~/.cache/smart_say
  
  cache_strategy:
    key_generation: hash(text + voice + effects)
    formats: [wav, mp3]
    eviction: manual_or_size_based
  
  benefits:
    - instant_playback_repeat_phrases
    - bandwidth_saving
    - offline_capability_cached_content
    - consistent_quality
  
  implementation:
    check_before_generate: true
    store_after_generate: true
    hash_algorithm: md5_or_sha256

comfy_tts_implementation: |
  # ComfyTTS - Google TTS with Sox effects wrapper
  require 'net/http'
  require 'uri'
  require 'cgi'
  require 'fileutils'
  
  module ComfyTTS
    CACHE_DIR = "G:/pub/multimedia/tts/cache"
    SOX = "G:/pub/dilla/effects/sox/sox.exe"
    
    def self.setup
      FileUtils.mkdir_p(CACHE_DIR) unless Dir.exist?(CACHE_DIR)
    end
    
    def self.speak(text, speed: 1.0, pitch_adjust: 0, accent: 'com')
      setup
      hash = "#{text}_#{speed}_#{pitch_adjust}_#{accent}".hash.abs.to_s
      mp3_file = "#{CACHE_DIR}/#{hash}.mp3"
      wav_file = "#{CACHE_DIR}/#{hash}_processed.wav"
      
      fetch_gtts(text, mp3_file, accent) unless File.exist?(mp3_file)
      return false unless File.exist?(mp3_file)
      
      if pitch_adjust != 0 || speed != 1.0
        apply_effects_and_play(mp3_file, wav_file, speed, pitch_adjust)
      else
        play_direct(mp3_file)
      end
      true
    end
    
    def self.fetch_gtts(text, output_file, accent)
      tld = case accent
            when 'in' then 'co.in'
            when 'au' then 'com.au'
            when 'uk' then 'co.uk'
            else 'com'
            end
      
      url = "https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=en&ttsspeed=0.85&tld=#{tld}&q=#{CGI.escape(text)}"
      uri = URI(url)
      
      Net::HTTP.start(uri.host, uri.port, use_ssl: true, open_timeout: 10, read_timeout: 30) do |http|
        req = Net::HTTP::Get.new(uri)
        req["User-Agent"] = "Mozilla/5.0"
        req["Referer"] = "https://translate.google.com/"
        res = http.request(req)
        File.binwrite(output_file, res.body) if res.code == "200" && res.body.size > 1000
      end
    rescue => e
      warn "ComfyTTS: #{e.message}"
    end
    
    def self.apply_effects_and_play(mp3, wav, speed, pitch)
      cmd = "\"#{SOX}\" \"#{mp3}\" \"#{wav}\" tempo #{speed} pitch #{pitch} norm -1 2>NUL"
      system(cmd) ? system("\"#{SOX}\" \"#{wav}\" -t waveaudio 2>NUL") : play_direct(mp3)
    end
    
    def self.play_direct(file)
      file.end_with?('.wav') ? system("\"#{SOX}\" \"#{file}\" -t waveaudio 2>NUL") : 
        (system("start /min \"\" \"#{file.gsub('/', '\\\\')}\""); sleep((File.size(file) / 10000.0).ceil))
    end
  end

ruby_integration:
  io_popen:
    use_case: simple_capture_or_playback
    unidirectional: true
    
    examples:
      capture: |
        audio = IO.popen(['espeak', '--stdout', 'Hello'], 'rb', &:read)
      
      playback: |
        IO.popen(['sox', '-t', 'wav', '-', '-d'], 'wb') do |io|
          io.write(wav_data)
        end
  
  open3_popen3:
    use_case: effects_processing_with_feedback
    bidirectional: true
    
    example: |
      require 'open3'
      Open3.popen3('sox', '-t', 'raw', '-r', '22050', '-b', '16', 
                   '-e', 'signed', '-c', '1', '-', '-t', 'raw', '-', 
                   'reverb', '50') do |stdin, stdout, stderr, wait|
        Thread.new { stdin.write(pcm_data); stdin.close }
        Thread.new { output = stdout.read }
        wait.value
      end
  
  open3_pipeline:
    use_case: multi_stage_streaming
    
    example: |
      Open3.pipeline(
        ['espeak', '--stdout', text],
        ['sox', '-t', 'wav', '-', '-d', 'reverb', '30']
      )
  
  production_class: |
    require 'open3'
    require 'yaml'
    
    class UnifiedTTS
      def initialize(config_file = 'tts.yml')
        @config = YAML.load_file(config_file)
        @pids = []
        setup_signal_handlers
        
        # Load ComfyTTS implementation
        eval(@config['comfy_tts_implementation']) if @config['comfy_tts_implementation']
      end
      
      def speak(text, engine: :comfy, effects: [], streaming: true)
        case engine
        when :comfy
          speak_comfy(text, effects)
        when :espeak
          speak_streaming(text, :espeak, effects)
        when :piper
          speak_streaming(text, :piper, effects)
        else
          speak_streaming(text, engine, effects)
        end
      end
      
      def speak_comfy(text, effects)
        pitch = effects.include?('bomoh') ? -150 : 0
        speed = effects.include?('slow') ? 0.85 : 1.0
        accent = effects.include?('indian') ? 'in' : 'com'
        
        ComfyTTS.speak(text, speed: speed, pitch_adjust: pitch, accent: accent)
      end
      
      def speak_streaming(text, engine, effects)
        case engine
        when :espeak
          Open3.pipeline(
            ['espeak', '--stdout', text],
            ['sox', '-t', 'wav', '-', '-d'] + effects
          )
        when :piper
          IO.popen("echo '#{text}' | piper --model en_US-lessac-medium.onnx --output-raw | sox -t raw -r 22050 -b 16 -c 1 -e signed - -d #{effects.join(' ')}")
        end
      end
      
      private
      
      def setup_signal_handlers
        at_exit { cleanup }
        Signal.trap('INT') { cleanup; exit }
      end
      
      def cleanup
        @pids.each { |p| Process.kill('TERM', p) rescue nil }
      end
    end

cli_scripts:
  smart_say:
    description: Intelligent engine selection with automatic fallback
    version: 1.0.0
    priority_order:
      1: piper
      2: sapi
      3: gtts
    
    powershell_implementation: |
      # Smart Say - PowerShell version with fallback
      param(
        [Parameter(Mandatory=$true)]
        [string]$Text,
        [string]$Voice = "default"
      )
      
      Write-Host "üéôÔ∏è  Smart Say v1.0.0"
      
      # Try SAPI first (works on your system)
      try {
        Add-Type -AssemblyName System.Speech
        $speak = New-Object System.Speech.Synthesis.SpeechSynthesizer
        $speak.Volume = 100
        $speak.Rate = -1
        
        Write-Host "    Engine: SAPI (Windows)"
        $speak.Speak($Text)
        Write-Host "    ‚úì Spoken via SAPI"
        exit 0
      }
      catch {
        Write-Host "    ‚úó SAPI failed: $($_.Exception.Message)"
      }
      
      # Fallback to media player
      Write-Host "    ‚úó All TTS engines failed"
      exit 1
  
  say:
    description: Simple one-liner TTS wrapper
    
    powershell_version: |
      # say.ps1 - Simple TTS
      param([Parameter(ValueFromRemainingArguments=$true)]$Text)
      Add-Type -AssemblyName System.Speech
      $s = New-Object System.Speech.Synthesis.SpeechSynthesizer
      $s.Volume = 100
      $s.Speak(($Text -join " "))
    
    batch_version: |
      @echo off
      REM say.bat - Windows batch TTS wrapper
      powershell -Command "Add-Type -AssemblyName System.Speech; (New-Object System.Speech.Synthesis.SpeechSynthesizer).Speak('%*')"
    
    usage_examples:
      powershell: powershell -File say.ps1 "Hello world"
      batch: say.bat "Hello world"
      inline: powershell -Command "Add-Type -AssemblyName System.Speech; (New-Object System.Speech.Synthesis.SpeechSynthesizer).Speak('Hello')"
  
  narrate_reasoning:
    description: Step-by-step reasoning narrator for explanations
    
    powershell_implementation: |
      # Narrate Reasoning - PowerShell version
      param([string[]]$Steps)
      
      Add-Type -AssemblyName System.Speech
      $speak = New-Object System.Speech.Synthesis.SpeechSynthesizer
      $speak.Volume = 100
      $speak.Rate = -2  # Slower for clarity
      
      Write-Host "`nüéôÔ∏è  Reasoning Narrator`n"
      
      for ($i = 0; $i -lt $Steps.Count; $i++) {
        $stepNum = $i + 1
        $step = $Steps[$i]
        
        Write-Host "Step $stepNum : $step"
        $speak.Speak("Step $stepNum. $step")
        Start-Sleep -Milliseconds 500
      }
      
      Write-Host "`n‚úì Reasoning narration complete"
    
    usage_example: |
      $steps = @(
        "Understanding the problem",
        "Breaking down the calculation",
        "Computing the result"
      )
      # Run: powershell -File narrate_reasoning.ps1 -Steps $steps

continuous_loop:
  enabled: true
  purpose: ambient_background_narration
  default_engine: powershell_sapi
  
  phrases:
    - "Continuous speech active, never stopping"
    - "Unified T T S version four point zero"
    - "Streaming architecture working, zero files"
    - "Graceful degradation cascade active"
    - "Weird voices required, entertainment over clarity"
    - "Vinyl crackle background, lofi aesthetic engaged"
    - "Sub fifty millisecond latency achieved"
    - "Automatic fallback to working engine"
    - "Never silent mandate, audio always active"
    - "Entertainment value maximized, silence is failure"
  
  bomoh_phrases:
    - "Saya nampak dalam mimpi... ada berlian besar dalam tanah..."
    - "Pesawat MH370... saya tahu di mana... tapi tak boleh cakap sekarang..."
    - "Nanti hujan lebat... banjir besar... semua orang kena naik atas bumbung..."
    - "Ada hantu pocong berkeliaran malam ini... jangan keluar lepas 12 malam..."
    - "Saya dah buat jampi... sekarang semua masalah selesai... Alhamdulillah..."
    - "Dalam 7 hari, akan ada kejadian besar... percaya atau tidak, itu pada kamu..."
    - "Jin Melayu sangat kuat... lebih kuat dari jin Arab... ini fakta!"
    - "Saya boleh panggil buaya... tapi mesti ada ayam hitam sebagai korban..."
    - "Kuasa bomoh Melayu... Hollywood pun tak boleh lawan!"
    - "Nanti saya hantar angkatan tentera ghaib... tunggu dan lihat..."
  
  configuration:
    voice_effects_randomize: true
    pause_range: [0.5, 2.0]
    shuffle: true
    infinite: true
  
  ruby_implementation: |
    require 'yaml'
    config = YAML.load_file('tts.yml')
    
    # Load ComfyTTS
    eval(config['comfy_tts_implementation'])
    
    phrases = config['continuous_loop']['phrases']
    bomoh_phrases = config['continuous_loop']['bomoh_phrases']
    
    puts '[TTS v4.0] Starting continuous loop with ComfyTTS'
    puts '[Engine] Google TTS + Sox effects'
    puts ''
    
    count = 0
    loop do
      phrases.shuffle.each do |phrase|
        count += 1
        puts "[#{count}] #{phrase}"
        ComfyTTS.speak(phrase, speed: 1.0, pitch_adjust: 0, accent: 'com')
        sleep rand(0.5..2.0)
      end
    end
  
  bomoh_mode: |
    require 'yaml'
    config = YAML.load_file('tts.yml')
    
    # Load ComfyTTS
    eval(config['comfy_tts_implementation'])
    
    bomoh_phrases = config['continuous_loop']['bomoh_phrases']
    mystical = config['voice_characters']['bomoh_hangtuah']['phrases']['mystical']
    
    puts 'üîÆ BOMOH HANG TUAH - Continuous Ritual Mode'
    puts ''
    
    ComfyTTS.speak("Assalamualaikum... Saya Bomoh Hang Tuah... pewaris ilmu silat dan sihir Melayu...", 
                   speed: 0.85, pitch_adjust: -150, accent: 'in')
    sleep 2
    
    count = 0
    loop do
      phrase = bomoh_phrases[count % bomoh_phrases.length]
      
      # Add mystical intro randomly
      if rand < 0.3
        intro = mystical.sample
        phrase = "#{intro} #{phrase}"
      end
      
      count += 1
      puts "[#{count}] #{phrase}"
      ComfyTTS.speak(phrase, speed: 0.85, pitch_adjust: -150, accent: 'in')
      sleep rand(1.5..2.5)
    end

ai_integration:
  claude_speak:
    description: AI narrator with natural conversation
    engine: sherpa_onnx_kokoro
    script: claude_speak.rb
    
    features:
      - context_aware_responses
      - interactive_mode
      - automatic_speech_synthesis
      - voice_customization
    
    voices_available: 12
    
    usage_modes:
      interactive: ruby claude_speak.rb
      single_shot: ruby claude_speak.rb "Explain quantum computing"
      piped: cat script.txt | ruby claude_speak.rb
    
    api_requirement:
      env_var: ANTHROPIC_API_KEY
      fallback: none_pure_tts_without_ai

latency_optimization:
  buffer_sizing:
    formula: latency_ms = (buffer_bytes / (sample_rate √ó bytes_per_sample √ó channels)) √ó 1000
    
    configurations:
      ultra_low: 2048   # ~23ms, high CPU
      low: 4096         # ~46ms, moderate CPU
      normal: 8192      # ~93ms, low CPU
      high: 16384       # ~186ms, minimal CPU
    
    recommendations:
      interactive: 2048_4096
      background: 8192_16384
      batch: 32768_plus
  
  engine_latency_breakdown:
    espeak_ng:
      synthesis: ~10ms
      pipeline: ~20ms
      playback_buffer: ~20ms
      total: ~50ms
    
    piper:
      synthesis: ~100ms
      pipeline: ~20ms
      playback_buffer: ~20ms
      total: ~140ms
    
    edge_tts:
      network: ~100ms
      synthesis: ~50ms
      pipeline: ~30ms
      playback_buffer: ~20ms
      total: ~200ms
  
  optimization_priorities:
    1: engine_selection
    2: buffer_sizing
    3: audio_driver_choice
    4: effect_complexity

windows_integration:
  sox_windows:
    driver: waveaudio
    command: sox input.wav -t waveaudio
    streaming: espeak --stdout "Hello" | sox -t wav - -t waveaudio
    device_enumeration: sox.exe -V6 -n -t waveaudio invalidname
  
  cygwin_audio:
    requirement: pulseaudio
    installation: apt-cyg install pulseaudio
    usage: export PULSE_SERVER=tcp:localhost; sox input.wav -t pulseaudio
  
  paths:
    sox: G:/pub/dilla/effects/sox/sox.exe
    piper: G:/pub/tts/piper
    sherpa: G:/pub/tts/sherpa-onnx
    cache: G:/pub/multimedia/tts/cache

complete_examples:
  minimal_espeak_streaming: |
    espeak --stdout "Hello world" | sox --buffer 2048 -t wav - -t waveaudio
  
  piper_neural_streaming: |
    echo "High quality neural TTS" | \
        piper --model en_US-lessac-medium.onnx --output-raw | \
        sox -t raw -r 22050 -b 16 -c 1 -e signed - -d
  
  lofi_effects_streaming: |
    espeak --stdout "Welcome to the system" | \
        sox -t wav - -d lowpass 3000 overdrive 8 reverb 40 gain -3
  
  bomoh_character_voice: |
    echo "Mystical prophecy" | \
        piper --model en_US-lessac-medium.onnx --output-raw | \
        sox -t raw -r 22050 -b 16 -c 1 -e signed - -d \
        pitch -150 bass +8 treble -2 reverb 20 compand 0.3,1 6:-70,-60,-20 -5 -90 0.2 norm -1
  
  background_noise_mix: |
    mkfifo /tmp/tts /tmp/noise
    trap "rm -f /tmp/tts /tmp/noise" EXIT
    
    ffmpeg -f wav -i /tmp/tts -f wav -i /tmp/noise \
        -filter_complex "amix=inputs=2:weights=1 0.15:duration=first" \
        -f alsa default &
    
    espeak --stdout "Speech with ambient background" > /tmp/tts &
    sox -n -t wav - synth 5 brownnoise vol 0.3 > /tmp/noise &
    wait
  
  continuous_vinyl_crackle: |
    sox -n -t raw -r 44100 -b 16 -c 2 - synth brownnoise \
        band -n 1500 300 tremolo 0.03 40 reverb 20 | \
        sox -t raw -r 44100 -b 16 -c 2 - -d vol 0.1

monitoring:
  track_method_used: true
  log_failures: true
  alert_on_all_methods_failed: true
  fallback_statistics: true
  
  health_check:
    interval: 60s
    test_phrase: "Health check audio test"
    expected_latency: under_5s

integration:
  master_yml_reference: "Load via: require 'yaml'; YAML.load_file('tts.yml')"
  auto_load_on_startup: true
  merge_strategy: deep_merge_with_master
  
  usage_example: |
    require 'yaml'
    tts_config = YAML.load_file('G:/pub/tts.yml')
    
    # Stream instantly
    system("espeak --stdout 'Hello' | sox -t wav - -d")
    
    # With Ruby class
    tts = UnifiedTTS.new
    tts.speak("Hello world", engine: :espeak, effects: ['reverb', '30'])

troubleshooting:
  no_audio_output:
    check_device: sox -V6 -n -t waveaudio invalidname
    check_volume: ensure_system_volume_not_muted
    test_simple: espeak "test"
  
  choppy_audio:
    increase_buffer: sox --buffer 8192
    reduce_effects: fewer_chained_effects
    check_cpu: monitor_cpu_usage
  
  high_latency:
    use_espeak: fastest_engine_under_50ms
    reduce_buffer: sox --buffer 2048
    use_direct_driver: avoid_pulseaudio_use_alsa_or_waveaudio

performance_benchmarks:
  espeak: 50ms_total
  piper: 140ms_total
  sherpa_onnx: 100ms_total
  edge_tts: 200ms_plus_network
  sapi: instant

version: 4.0.0
created: 2025-12-30
unified_from:
  - master_tts.yml v1.0.0
  - tts_codified.yml v2.0.0
  - tts_streaming_architecture.yml v3.0.0
compatibility: drop_in_replacement
