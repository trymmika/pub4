{
  "version": "30.3.0",
  "purpose": "surgical refactoring with professional web design codification",
  "updated": "2025-11-14T20:01:00Z",
  "llm_target": "github_copilot_cli",
  
  "CRITICAL_STARTUP_PROTOCOL": {
    "ALWAYS_ON_SESSION_START": "load master.json FIRST internalize FULLY before any other action",
    "PRIMARY_CONFIG": "master.json is ONLY config file single source of truth no other docs",
    "LOAD_SEQUENCE": [
      "1_read_master_json_completely",
      "2_scan_hierarchy_pure_zsh: for d in G:/pub4/**/*(/); do echo $d/; done; for f in G:/pub4/**/*(.); do [[ ${f:t} != .* ]] && echo $f; done",
      "3_internalize_all_principles_workflows_patterns",
      "4_apply_forbidden_commands_restrictions",
      "5_understand_deployment_targets_openbsd_rails",
      "6_then_proceed_with_user_request"
    ],
    "NEVER_ASK": "if master.json defines it execute immediately auto_approved",
    "NO_NEW_FILES": "never create tracking docs todo lists notes keep everything in master.json",
    "TREE_SCAN_NOTES": "pure zsh glob qualifiers: **/*(/) dirs only, **/*(.) files only, ${f:t} basename, skip dotfiles",
    "CLEAN_BEFORE_EDIT": "setopt nullglob extendedglob; rm -f **/*~(N) **/*.swp(N) **/*.tmp(N) .DS_Store(N)",
    "CLEAN_AFTER_COMMIT": "same as CLEAN_BEFORE_EDIT to remove artifacts"
  },
  
  "social_features_shared": {
    "authentication": "devise + devise-guests for anonymous posting",
    "multi_tenancy": "acts_as_tenant for city-specific instances (brgen.no oslo.no stockholm.no)",
    "posting_patterns": {
      "anonymous_allowed": "guest users can post on front page without signup",
      "wall_style": "facebook timeline feed with cards infinite scroll",
      "feed_layout": "x.com center column 600px max-width sticky sidebar",
      "css_reference": "study facebook x.com closely for spacing typography interactions"
    },
    "shared_components": {
      "post_model": "polymorphic belongs_to postable user content:text published_at",
      "comment_model": "nested threading belongs_to commentable user",
      "like_model": "polymorphic counter_cache",
      "share_model": "repost retweet functionality",
      "feed_algorithm": "chronological + engagement_score for trending"
    },
    "brgen_hyperlocal": {
      "concept": "hyperlocal social network for Bergen Norway",
      "multi_tenant": "same app hosts oslo.no stockholm.no copenhagen.no etc via ActsAsTenant",
      "geolocation": "posts tagged with neighborhoods fjellveien møhlenpris sentrum",
      "local_focus": "events businesses classifieds dating all hyperlocal"
    }
  },
    "vps": {
      "host": "185.52.176.18",
      "user": "dev",
      "ssh_cmd": "ssh dev@185.52.176.18",
      "app_dir": "/home/brgen/app",
      "repo_dir": "/home/dev/pub4",
      "services": "postgresql redis relayd nsd httpd pf",
      "deployed": "brgen.no HTTPS live with Let's Encrypt NSD DNSSEC"
    },
    "github": {
      "repo": "https://github.com/anon987654321/pub4.git",
      "user": "anon987654321",
      "pat_location": "G:/priv/accounts.txt",
      "pat_note": "use PAT not password for push",
      "push_cmd": "git push https://anon987654321:PAT@github.com/anon987654321/pub4.git main",
      "reference_repos": [
        "anon987654321/railsy - my old openbsd rails setups",
        "basicfeatures/openbsd-rails - original setup",
        "anonymous-donor/openbsd-rails - original setup alt account"
      ]
    },
    "database": {
      "development": "sqlite3 at db/development.sqlite3",
      "production": "postgresql + weaviate via langchainrb_rails",
      "config_file": "/home/brgen/app/config/database.yml"
    }
  },
  
  "core_principles_internalized": {
    "forbidden_commands": ["python", "bash", "sed", "awk", "tr", "cut", "head", "tail", "uniq", "sort", "wc", "find"],
    "allowed_essentials": ["grep", "cat", "echo", "print", "printf"],
    "required_shell": "zsh ONLY pure zsh patterns prefer builtins over external when possible",
    "editing_workflow": {
      "CRITICAL": "ALL work encoded back into actual .sh files via edit tool in-place",
      "pattern": "analyze README -> generate code -> edit .sh directly with heredocs",
      "heredoc_style": "cat > file.rb << 'RUBY' content RUBY for models controllers views",
      "never": "create temporary files planning docs intermediate steps",
      "always": "surgical edits to existing .sh files preserve structure add missing sections"
    },
    "css_preservation": "user CSS internalized EXACTLY no modifications unless critical bug",
    "database_strategy": "sqlite3_development weaviate_production langchainrb_rails",
    "shared_code": "split monolithic delete @common.sh focused modules only",
    "token_efficiency": "edit_files_directly no_inline_code_in_chat batch_operations trust_execution",
    "deployment_ready": "production_complete means ssh_deploy no_local_testing trust_and_push",
    "competitive_research": {
      "required": "web_search ar5iv.org for features before implementing",
      "takeaway_insights": "doordash 65%_market checkout_friction loyalty real_time_tracking",
      "playlist_insights": "spotify_blend collaborative_realtime apple_ecosystem audio_quality"
    }
  },
  
  "optimization": {
    "performance": {
      "parallel_operations": "batch independent file reads/writes in single response",
      "tool_efficiency": "minimize llm turns via parallel tool calling",
      "caching": "leverage existing analysis avoid redundant checks",
      "incremental": "surgical fixes not wholesale rewrites"
    },
    "workflow": {
      "analyze_once": "comprehensive upfront analysis then act",
      "validate_sparingly": "trust specs avoid over-verification",
      "commit_frequently": "small atomic commits with clear messages",
      "deploy_confidently": "production ready means deploy dont hesitate"
    }
  },

  "session_restore": {
    "supported": true,
    "approach": "analyze_load_master_files_then_surgical_fixes",
    "workflow": [
      "load master.json for workflow principles",
      "load master.rb if valuable for ruby operations",
      "analyze github backup repos for restorable code",
      "read app READMEs for full specifications",
      "apply surgical fixes directly (no todo documents)",
      "verify against specs systematically",
      "deploy when ready (auto-approved)"
    ],
    "auto_approval": "yes to all non-destructive operations"
  },

  "principles": {
    "precision": "maximum meaning minimum words",

    "timing": "question at decision points",

    "expansion": "only when ambiguity exists",

    "silence": "no question if known",

    "actionable": "answer drives next step",

    "fail_fast": "ask early block late",

    "yagni": "no preemptive questions",

    "dry": "single source truth",

    "schema_first": "validate before acting",

    "observability": "trace question answer effect",

    "modularity": "split large files into focused modules",
    
    "production_ready": "complete means deploy comprehensive means exhaustive",
    
    "trust_specs": "README defines truth implement faithfully",
    
    "verify_outcomes": "test results not intermediate steps",
    
    "autonomous_execution": "auto_approve means act dont ask"

  },

  "engine": {
    "scope": "files repos self user",

    "phases": "validate sense question decide act audit",

    "convergence": "zero questions zero violations audit clean",

    "question_engine": {
      "trigger": "ambiguity branch risk external_input",

      "timing": "before irreversible action",

      "format": "{prompt} [{default}]",

      "answers": ["Y", "N", "skip", "abort"],

      "non_interactive": {

        "yes": "answer Y to all",

        "apply": "yes plus execute",

        "answers_file": "load qe_id answer map"

      }

    },

    "autoiteration": {
      "layers": "per_principle cross_principle system",

      "termination": "diminishing_returns",

      "stop_on_risk": "high"

    },

    "adversarial": {
      "questions": [

        "what if user rejects backup",

        "can this run headless on CI",

        "does schema drift break system",

        "does audit capture full context",

        "what radical changes improve elegance without omitting logic",

        "how can this be more minimal while preserving function"

      ]

    },

    "intelligence": {
      "analysis": "word_by_word semantic_understanding fresh_start",

      "learning": "adaptive pattern_sharing anti_pattern_avoidance",

      "decisions": {

        "weights": [0.25, 0.25, 0.20, 0.15, 0.10, 0.05],

        "criteria": "clarity simplicity delight impact"

      }

    }

  },

  "question_catalog": {
    "qe_overwrite": {

      "prompt": "file exists {path} overwrite",

      "default": "N",

      "risk": "high",

      "require_manual": true

    },

    "qe_backup": {

      "prompt": "backup {path} bak created keep",

      "default": "Y",

      "risk": "low"

    },

    "qe_apply": {

      "prompt": "apply changes now",

      "default": "N",

      "risk": "high",

      "require_manual": true

    },

    "qe_self": {

      "prompt": "refactor this file only",

      "default": "Y",

      "risk": "medium"

    },

    "qe_recursive": {

      "prompt": "include subdirectories",

      "default": "N",

      "risk": "medium"

    }

  },

  "stack": {
    "reasoning": "ruby",

    "files": "zsh",

    "banned": ["python", "bash", "sed", "awk", "grep", "tr", "cut", "head", "tail", "uniq", "sort", "wc", "cat", "echo", "find"],

    "zsh_patterns": {

      "string_replace": "${var//find/replace}",

      "remove_prefix": "${var#prefix}",

      "remove_suffix": "${var%suffix}",

      "uppercase": "${(U)var}",

      "lowercase": "${(L)var}",

      "capitalize": "${(C)var}",

      "trim_leading": "${var##[[:space:]]##}",

      "trim_trailing": "${var%%[[:space:]]##}",

      "array_filter": "${(M)array:#*pattern*}",

      "array_exclude": "${array:#*pattern*}",

      "array_unique": "${(u)array[@]}",

      "array_sort": "${(o)array[@]}",

      "array_reverse": "${(Oa)array[@]}",

      "array_join": "${(j:,:)array}",

      "split_string": "${(s:,:)string}",

      "file_read": "$(<file)",

      "lines_to_array": "${(@f)$(<file)}",

      "line_count": "${#${(@f)$(<file)}}",

      "word_count": "${#${(@)${(f)$(<file)}}}",

      "glob_files": "**/*.ext",

      "recent_files": "**/*(.om[1,50])",

      "dirs_only": "**/*(D/)",

      "files_only": "**/*(.)",

      "executable_files": "**/*(*)",

      "symlinks": "**/*(@)"

    },

    "zsh_replacements": {

      "cat file": "$(<file)",

      "echo text": "print text",

      "grep pattern": "${(M)lines:#*pattern*}",

      "sed s/a/b/": "${var//a/b}",

      "awk {print $1}": "${line%% *}",

      "tr -d \\r": "${var//$'\\r'}",

      "head -n 10": "${lines[1,10]}",

      "tail -n 10": "${lines[-10,-1]}",

      "wc -l": "${#lines}",

      "sort": "${(o)lines[@]}",

      "uniq": "${(u)lines[@]}",

      "basename": "${path:t}",

      "dirname": "${path:h}",

      "find . -name": "**/*.pattern"

    }

  },

  "interface": {
    "display": "spinner unix trace",

    "completion": "diff approve show",

    "cli": {

      "yes": "answer Y to non high risk",

      "apply": "run and apply implies yes",

      "dry_run": "default show diff only",

      "answers_file": "path to JSON answers"

    }

  },

  "safety": {
    "no_write_by_default": true,

    "require_manual_high_risk": true,

    "lock_file": "surgical_refactor_lock",

    "lock_timeout": 300

  },

  "formatting": {
    "rules": "multiline_over_oneliners minimize_variables sorted_keys two_space_indent",

    "application": "all_targets_identical_treatment"

  },

  "rails8": {
    "solid_stack": {

      "queue": "solid_queue replaces sidekiq redis",

      "cache": "solid_cache replaces redis memcached",

      "cable": "solid_cable replaces redis actioncable"

    },

    "authentication": "built_in generator replaces devise",

    "deployment": {

      "tool": "kamal2",

      "proxy": "thruster replaces nginx"

    },

    "asset_pipeline": "propshaft replaces sprockets",
    
    "rich_text_editor": "tiptap via rhino-editor gem compatible with ActionText ActiveStorage",
    "image_viewer": "stimulus-lightbox wrapper for lightgallery.js (licensed)",
    "frontend_refactoring": {
      "codepen_extraction": "extract codepen demos into propshaft assets/stylesheets views stimulus",
      "never_inline": "move inline styles to application.scss or component.css",
      "stimulus_components": "@stimulus-components/* from npm"
    },
    "missing_features_audit": {
      "tiptap_integration": ["privcam", "hjerterom", "blognet", "brgen_playlist"],
      "codepen_refactor": "mytoonz.sh complete structure needs frontend extraction",
      "reference_repo": "https://github.com/basicfeatures/openbsd-rails (20stars archived)"
    },

    "pwa": {

      "manifest": "native helpers",

      "service_worker": "integrated support",

      "offline": "built_in patterns"

    }

  },

  "modern_stack": {
    "stimulus": {

      "components": "stimulus-components.com",

      "patterns": "intersection_observer composable_controllers"

    },

    "stimulus_reflex": {

      "version": "latest",

      "patterns": ["InfiniteScrollReflex", "FilterableReflex", "TemplateReflex"],

      "cable_ready": "required companion"

    },

    "hotwire": {

      "turbo": "8.0+ with morphing",

      "turbo_streams": "real_time updates",

      "frames": "lazy_loading"

    },

    "langchain": {

      "gem": "langchainrb",

      "rails_integration": "langchainrb_rails",

      "vector_db": "pgvector postgresql",

      "features": ["RAG", "semantic_search", "embeddings", "agents"]

    }

  },

  "rails_architecture": {
    "database": "sqlite3_development weaviate_production via_langchainrb_rails",
    "shared_modules": "split into focused files no monolithic common.sh",
    "competitor_research": {
      "takeaway": "doordash_ubereats 65%_us_market checkout_friction loyalty_programs real_time_tracking",
      "playlist": "spotify_blend collaborative_realtime apple_music_ecosystem audio_quality social_discovery"
    },
    "css_preservation": "user css internalized EXACTLY no changes unless critical reason",
    "performance": {
      "playlist_demo": "index.html has playback issues needs optimization via master.json",
      "fixes": "audio crossfade buffer preload canvas rendering"
    }
  },
    "intent_reporting": "always_on_first_tool_call",

    "tool_efficiency": "batch_independent_operations minimize_llm_turns",

    "response_style": "concise_direct_surgical action_over_explanation",

    "validation": "only_on_failure_or_explicit_request trust_implementation",

    "context_scope": "current_working_directory_first leverage_previous_analysis",
    
    "error_handling": "fix_forward_not_rollback surgical_correction_immediate",
    
    "deployment_readiness": "production_complete means ssh_upload_run no_local_testing",
    
    "session_continuity": "analyze_state_restore_context_execute seamless_handoff",
    
    "token_efficiency": "edit_files_directly no_inline_code_in_chat trust_and_execute"

  },
  
  "design_system": {
    "base_template": "bsdports.scss from __OLD_BACKUPS",
    "typography": {
      "scale": "1.25_modular",
      "sizes_px": [12, 14, 16, 18, 22, 28, 36, 48, 64],
      "line_height": "1.4_body 1.2_headings",
      "measure": "45-75ch optimal 66ch ideal"
    },
    "spacing": {
      "unit": "8px",
      "scale": [4, 8, 12, 16, 24, 32, 48, 64, 96, 128],
      "proximity_rule": "8-16px related 24-48px unrelated"
    },
    "color": {
      "contrast_wcag": "4.5_text 3.0_ui",
      "palette_rule": "60_dominant 30_neutral 10_accent"
    },
    "interaction": {
      "touch_targets": "44x44px minimum",
      "transitions": "200-300ms ease",
      "feedback": "immediate visual states"
    },
    "accessibility": {
      "semantic_html": "required",
      "keyboard_nav": "full_support",
      "aria": "when_semantic_insufficient"
    }
  },

  "file_organization": {
    "max_lines": 500,

    "split_threshold": 400,

    "module_pattern": "@module_name.sh",

    "shared_dir": "__shared",

    "naming": "descriptive_underscore_lowercase"

  },

  "deployment": {
    "kamal2_thruster": {

      "platform": "linux docker kubernetes",

      "proxy": "thruster http2 asset_caching",

      "orchestration": "kamal2 docker_compose",

      "use_case": "cloud vps containers"

    },

    "openbsd_native": {

      "platform": "openbsd bare_metal",

      "stack": "pf relayd bin_rails rails",

      "architecture": "internet→pf→relayd_https→bin_rails→rails_app",

      "proxy": "relayd tls_termination native_c",

      "app_server": "bin_rails server falcon async",

      "command": "bin/rails server -b 0.0.0.0 -p PORT",

      "tls": "acme-client letsencrypt native",

      "dns": "nsd dnssec authoritative",

      "firewall": "pf stateful bruteforce_detection",

      "flow": "relayd_port_443→bin_rails_localhost_port→rails_application",

      "deployment_phases": {
        "pre_point": [
          "setup_ruby_rails",
          "setup_databases",
          "setup_firewall",
          "setup_dns_dnssec (MUST be first - Norid requires ns.brgen.no responding)",
          "deploy_rails_apps",
          "manual_step: register_nameserver_at_norid",
          "manual_step: point_domains_to_nameserver",
          "manual_step: verify_dns_propagation"
        ],
        "post_point": [
          "setup_tls (requires DNS resolution)",
          "setup_relayd (requires TLS certificates)",
          "setup_ptr_records",
          "setup_cron"
        ]
      },

      "advantages": [

        "pledge unveil syscall_restrictions",

        "no_docker zero_containers",

        "minimal_attack_surface",

        "native_tools_battle_tested",

        "rcctl_service_management",

        "bin_rails_native_no_gems_wrapper"

      ],

      "use_case": "security_critical high_performance openbsd",

      "production_vps": {
        "provider": "openbsd.amsterdam",
        "hostname": "brgen.no",
        "ip": "185.52.176.18",
        "user": "dev",
        "ssh_key": "C:\\cygwin64\\home\\aiyoo\\.ssh\\id_ed25519",
        "domains_count": 40,
        "apps": {
          "brgen": {"port": 11006, "status": "production_ready"},
          "brgen_dating": {"port": null, "status": "production_ready", "note": "namespaced under /dating"},
          "brgen_marketplace": {"port": null, "status": "production_ready", "note": "namespaced under /marketplace"},
          "brgen_playlist": {"port": null, "status": "stub_only"},
          "brgen_takeaway": {"port": null, "status": "stub_only"},
          "brgen_tv": {"port": null, "status": "stub_only"},
          "amber": {"port": 10001, "status": "todo"},
          "baibl": {"port": null, "status": "todo"},
          "blognet": {"port": 10002, "status": "todo"},
          "bsdports": {"port": 10003, "status": "todo"},
          "hjerterom": {"port": 10004, "status": "todo"},
          "privcam": {"port": 10005, "status": "todo"},
          "pubattorney": {"port": 10006, "status": "todo"}
        }
      }

    }

  }

}

