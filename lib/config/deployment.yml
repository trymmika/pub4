# Deployment Configuration
# 12 Rails apps, ports, parallel installation from pub2
---
version: 1
deployment:
  mode: parallel  # parallel, sequential
  max_concurrent: 4
  timeout: 600  # seconds per app
  
platform:
  os: openbsd
  ruby_version: 3.2
  rails_version: 7.1
  
apps:
  - name: auth
    port: 3000
    description: Authentication and user management
    dependencies: [postgres, redis]
    env_required:
      - SECRET_KEY_BASE
      - DATABASE_URL
    
  - name: api
    port: 3001
    description: REST API gateway
    dependencies: [auth, postgres]
    env_required:
      - SECRET_KEY_BASE
      - AUTH_SERVICE_URL
    
  - name: admin
    port: 3002
    description: Admin dashboard
    dependencies: [auth, api]
    env_required:
      - SECRET_KEY_BASE
      - API_URL
    
  - name: blog
    port: 3003
    description: Content management
    dependencies: [auth, postgres]
    env_required:
      - SECRET_KEY_BASE
      - DATABASE_URL
    
  - name: shop
    port: 3004
    description: E-commerce
    dependencies: [auth, postgres, redis]
    env_required:
      - SECRET_KEY_BASE
      - STRIPE_KEY
    
  - name: chat
    port: 3005
    description: Real-time messaging
    dependencies: [auth, redis, postgres]
    websockets: true
    env_required:
      - SECRET_KEY_BASE
      - REDIS_URL
    
  - name: docs
    port: 3006
    description: Documentation site
    dependencies: []
    static: true
    
  - name: analytics
    port: 3007
    description: Analytics dashboard
    dependencies: [auth, postgres]
    env_required:
      - SECRET_KEY_BASE
      - TIMESCALE_URL
    
  - name: media
    port: 3008
    description: Media processing
    dependencies: [auth, postgres, redis]
    workers: true
    env_required:
      - SECRET_KEY_BASE
      - S3_BUCKET
    
  - name: search
    port: 3009
    description: Search service
    dependencies: [elasticsearch]
    env_required:
      - ELASTICSEARCH_URL
    
  - name: notifications
    port: 3010
    description: Notification service
    dependencies: [auth, redis]
    workers: true
    env_required:
      - SECRET_KEY_BASE
      - SMTP_URL
    
  - name: webhooks
    port: 3011
    description: Webhook processor
    dependencies: [auth, redis]
    workers: true
    env_required:
      - SECRET_KEY_BASE
      - WEBHOOK_SECRET

services:
  postgres:
    port: 5432
    version: 15
    config:
      max_connections: 100
      shared_buffers: 256MB
      
  redis:
    port: 6379
    version: 7
    config:
      maxmemory: 256mb
      maxmemory_policy: allkeys-lru
      
  elasticsearch:
    port: 9200
    version: 8
    config:
      cluster_name: master
      
scripts:
  install_all:
    path: deploy/rails/__install_all.sh
    description: Parallel installation of all apps
    strategy: parallel
    max_failures: 2
    rollback_on_failure: true
    
  health_check:
    path: deploy/rails/__health_check.sh
    interval: 60
    timeout: 5
    
  backup:
    path: deploy/rails/__backup.sh
    schedule: "0 2 * * *"  # 2 AM daily
    
monitoring:
  prometheus:
    enabled: true
    port: 9090
    scrape_interval: 15s
    
  grafana:
    enabled: true
    port: 3100
    
  alerting:
    enabled: true
    channels:
      - email
      - slack
      
networking:
  reverse_proxy: nginx
  ssl: true
  http2: true
  
  rate_limiting:
    enabled: true
    requests_per_minute: 100
    burst: 20
    
load_balancing:
  strategy: round_robin
  health_check: true
  health_check_interval: 10
  
security:
  firewall: pf
  fail2ban: true
  automatic_updates: false  # Manual on OpenBSD
  
backup:
  strategy: incremental
  frequency: daily
  retention: 30  # days
  offsite: true
