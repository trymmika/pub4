<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Blob Orb</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{background:#000}
canvas{position:fixed;inset:0;width:100%;height:100%;image-rendering:pixelated;image-rendering:crisp-edges}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
// 8-bit palette: 256 colors
const PAL=[];
for(let r=0;r<6;r++)for(let g=0;g<7;g++)for(let b=0;b<6;b++)PAL.push([r*51,g*42,b*51]);
for(let i=0;i<4;i++)PAL.push([i*85,i*85,i*85]);

function quantize(r,g,b){
  let minD=Infinity,best=PAL[0];
  for(const c of PAL){
    const dr=r-c[0],dg=g-c[1],db=b-c[2];
    if(dr*dr+dg*dg+db*db<minD){minD=dr*dr+dg*dg+db*db;best=c}
  }
  return best;
}

const canvas=document.getElementById('c'),ctx=canvas.getContext('2d',{willReadFrequently:true});
let w,h,scale=2,time=0,audio=0;
let blobs=[
  {x:0,y:0,r:60,phase:0,speed:0.02,color:[0,206,209]},
  {x:0,y:0,r:55,phase:2,speed:0.015,color:[64,224,208]},
  {x:0,y:0,r:50,phase:4,speed:0.025,color:[72,209,204]}
];

function resize(){
  w=Math.floor(window.innerWidth/scale);
  h=Math.floor(window.innerHeight/scale);
  canvas.width=w;canvas.height=h;
  blobs.forEach(b=>{b.x=w/2;b.y=h/2});
}
resize();
window.addEventListener('resize',resize);

function draw(){
  time+=0.016;
  
  // Clear with trail
  ctx.fillStyle='rgba(10,10,12,0.15)';
  ctx.fillRect(0,0,w,h);
  
  const img=ctx.getImageData(0,0,w,h);
  const cx=w/2,cy=h/2;
  
  // Draw each blob
  for(const blob of blobs){
    blob.phase+=blob.speed+audio*0.03;
    const breathe=Math.sin(time*1.5+blob.phase)*8+audio*15;
    const r=blob.r+breathe;
    
    for(let y=Math.max(0,Math.floor(cy-r-5));y<Math.min(h,Math.ceil(cy+r+5));y++){
      for(let x=Math.max(0,Math.floor(cx-r-5));x<Math.min(w,Math.ceil(cx+r+5));x++){
        const dx=x-cx,dy=y-cy;
        // Morphing shape
        const angle=Math.atan2(dy,dx);
        const morph=1+Math.sin(angle*3+blob.phase)*0.2+Math.sin(angle*5-time)*0.1;
        const dist=Math.sqrt(dx*dx+dy*dy)/morph;
        
        if(dist<r){
          const edge=1-dist/r;
          const intensity=Math.pow(edge,1.5)*0.7;
          
          let R=blob.color[0]*intensity;
          let G=blob.color[1]*intensity;
          let B=blob.color[2]*intensity;
          
          // Quantize
          const q=quantize(R,G,B);
          
          // Dither
          const dith=((x+y)%2)*16-8;
          
          const i=(y*w+x)*4;
          img.data[i]=Math.min(255,Math.max(0,q[0]+dith+img.data[i]*0.3));
          img.data[i+1]=Math.min(255,Math.max(0,q[1]+dith+img.data[i+1]*0.3));
          img.data[i+2]=Math.min(255,Math.max(0,q[2]+dith+img.data[i+2]*0.3));
          img.data[i+3]=255;
        }
      }
    }
  }
  
  ctx.putImageData(img,0,0);
  requestAnimationFrame(draw);
}

// Audio
navigator.mediaDevices?.getUserMedia({audio:true}).then(stream=>{
  const actx=new AudioContext(),src=actx.createMediaStreamSource(stream),an=actx.createAnalyser();
  an.fftSize=256;src.connect(an);
  const data=new Uint8Array(an.frequencyBinCount);
  (function loop(){
    an.getByteFrequencyData(data);
    let sum=0;for(let i=0;i<50;i++)sum+=data[i];
    audio=sum/50/255;
    requestAnimationFrame(loop);
  })();
}).catch(()=>{});

// Mood from parent
window.addEventListener('message',e=>{
  if(e.data?.mood){
    const moods={
      positive:[[77,223,152],[68,173,125],[116,225,160]],
      negative:[[223,77,77],[173,68,68],[225,116,116]],
      calm:[[77,125,223],[68,84,173],[116,160,225]],
      excited:[[223,77,223],[173,68,173],[225,116,225]]
    };
    if(moods[e.data.mood])blobs.forEach((b,i)=>b.color=moods[e.data.mood][i]||b.color);
  }
});

draw();
</script>
</body>
</html>
