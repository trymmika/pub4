<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Connected Orbs</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{background:#000}
canvas{position:fixed;inset:0;width:100%;height:100%;image-rendering:pixelated;image-rendering:crisp-edges}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
// 8-bit palette: 256 colors
const PAL=[];
for(let r=0;r<6;r++)for(let g=0;g<7;g++)for(let b=0;b<6;b++)PAL.push([r*51,g*42,b*51]);
for(let i=0;i<4;i++)PAL.push([i*85,i*85,i*85]);

function quantize(r,g,b){
  let best=PAL[0],minD=Infinity;
  for(const c of PAL){const d=(r-c[0])**2+(g-c[1])**2+(b-c[2])**2;if(d<minD){minD=d;best=c}}
  return best;
}

const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');
let w,h,scale=2,audio=0,colorAngle=7,orbs=[];

function resize(){
  w=Math.floor(window.innerWidth/scale);
  h=Math.floor(window.innerHeight/scale);
  canvas.width=w;canvas.height=h;
  initOrbs();
}

function initOrbs(){
  orbs=[];
  for(let i=0;i<40;i++){
    orbs.push({
      x:Math.random()*w,
      y:Math.random()*h,
      vx:(Math.random()-0.5)*1.5,
      vy:(Math.random()-0.5)*1.5
    });
  }
}

function phaseColor(angle){
  const r=Math.floor(Math.sin(0.3*angle)*127+128);
  const g=Math.floor(Math.sin(0.3*angle+2.094)*127+128);
  const b=Math.floor(Math.sin(0.3*angle+4.188)*127+128);
  return [r,g,b];
}

function draw(){
  colorAngle+=0.02+audio*0.05;
  const [cr,cg,cb]=phaseColor(colorAngle);
  const proximity=(60+audio*25)/scale;
  
  // Fade effect
  const img=ctx.getImageData(0,0,w,h);
  for(let i=0;i<img.data.length;i+=4){
    img.data[i]=Math.max(0,img.data[i]-3);
    img.data[i+1]=Math.max(0,img.data[i+1]-3);
    img.data[i+2]=Math.max(0,img.data[i+2]-3);
  }
  
  // Draw connections with Bresenham
  for(let i=0;i<orbs.length;i++){
    for(let j=i+1;j<orbs.length;j++){
      const dx=orbs[i].x-orbs[j].x,dy=orbs[i].y-orbs[j].y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      if(dist<=proximity){
        const alpha=(1-dist/proximity)*0.5;
        drawLine(img,Math.floor(orbs[i].x),Math.floor(orbs[i].y),
                 Math.floor(orbs[j].x),Math.floor(orbs[j].y),cr,cg,cb,alpha);
      }
    }
  }
  
  // Update and draw orbs
  for(const o of orbs){
    o.x+=o.vx;o.y+=o.vy;
    if(o.x<0||o.x>=w)o.vx*=-1;
    if(o.y<0||o.y>=h)o.vy*=-1;
    
    const px=Math.floor(o.x),py=Math.floor(o.y);
    const r=1+Math.floor(audio*2);
    for(let dy=-r;dy<=r;dy++){
      for(let dx=-r;dx<=r;dx++){
        if(dx*dx+dy*dy<=r*r){
          const x=px+dx,y=py+dy;
          if(x>=0&&x<w&&y>=0&&y<h){
            const q=quantize(cr,cg,cb);
            const i=(y*w+x)*4;
            img.data[i]=q[0];img.data[i+1]=q[1];img.data[i+2]=q[2];img.data[i+3]=255;
          }
        }
      }
    }
  }
  
  ctx.putImageData(img,0,0);
  requestAnimationFrame(draw);
}

function drawLine(img,x0,y0,x1,y1,r,g,b,alpha){
  const dx=Math.abs(x1-x0),dy=-Math.abs(y1-y0);
  const sx=x0<x1?1:-1,sy=y0<y1?1:-1;
  let err=dx+dy;
  while(true){
    if(x0>=0&&x0<w&&y0>=0&&y0<h){
      const dith=((x0+y0)%2)*15-7;
      const q=quantize(r*alpha+dith,g*alpha+dith,b*alpha+dith);
      const i=(y0*w+x0)*4;
      img.data[i]=Math.min(255,img.data[i]+q[0]);
      img.data[i+1]=Math.min(255,img.data[i+1]+q[1]);
      img.data[i+2]=Math.min(255,img.data[i+2]+q[2]);
    }
    if(x0===x1&&y0===y1)break;
    const e2=2*err;
    if(e2>=dy){err+=dy;x0+=sx}
    if(e2<=dx){err+=dx;y0+=sy}
  }
}

navigator.mediaDevices?.getUserMedia({audio:true}).then(s=>{
  const ac=new AudioContext(),src=ac.createMediaStreamSource(s),an=ac.createAnalyser();
  an.fftSize=256;src.connect(an);
  const data=new Uint8Array(an.frequencyBinCount);
  (function loop(){
    an.getByteFrequencyData(data);
    let sum=0;for(let i=0;i<50;i++)sum+=data[i];
    audio=sum/50/255;
    requestAnimationFrame(loop);
  })();
}).catch(()=>{});

resize();
window.addEventListener('resize',resize);
draw();
</script>
</body>
</html>
