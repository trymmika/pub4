<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Backlight Orb</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{background:#000}
canvas{position:fixed;inset:0;width:100%;height:100%;image-rendering:pixelated;image-rendering:crisp-edges}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
// 8-bit palette: 256 colors (6-8-5 levels RGB cube + grays)
const PAL=[];
for(let r=0;r<6;r++)for(let g=0;g<8;g++)for(let b=0;b<5;b++)PAL.push([r*51,g*36,b*64]);
for(let i=0;i<16;i++)PAL.push([i*17,i*17,i*17]);

function quantize(r,g,b){
  let best=PAL[0],minD=Infinity;
  for(const c of PAL){const d=(r-c[0])**2+(g-c[1])**2+(b-c[2])**2;if(d<minD){minD=d;best=c}}
  return best;
}

const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');
let w,h,scale=2,audio=0,time=0,mood='neutral';

const MOODS={
  neutral:{bg:[0,0,0],c1:[0,206,209],c2:[64,224,208]},
  positive:{bg:[0,0,0],c1:[72,209,204],c2:[127,255,212]},
  negative:{bg:[0,0,0],c1:[0,139,139],c2:[32,178,170]},
  calm:{bg:[0,0,0],c1:[0,206,209],c2:[64,224,208]},
  excited:{bg:[0,0,0],c1:[0,255,255],c2:[127,255,212]}
};

function resize(){
  w=Math.floor(window.innerWidth/scale);
  h=Math.floor(window.innerHeight/scale);
  canvas.width=w;canvas.height=h;
}

function lerp(a,b,t){return a+(b-a)*t}

function draw(){
  time+=0.016;
  const m=MOODS[mood]||MOODS.neutral;
  const cx=w/2,cy=h/2;
  const baseRadius=Math.min(w,h)*0.25;
  const radius=baseRadius+audio*baseRadius*0.3;
  
  // Clear with pure black
  ctx.fillStyle='#000';
  ctx.fillRect(0,0,w,h);
  
  const img=ctx.getImageData(0,0,w,h);
  
  // Draw backlight glow
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const dx=x-cx,dy=y-cy;
      const dist=Math.sqrt(dx*dx+dy*dy);
      const angle=Math.atan2(dy,dx);
      
      // Animated glow position
      const glowOffX=Math.sin(time*0.5)*radius*0.15;
      const glowOffY=Math.cos(time*0.7)*radius*0.15;
      const glowDist=Math.sqrt((dx-glowOffX)**2+(dy-glowOffY)**2);
      
      if(glowDist<radius*1.8){
        // Gradient between two colors based on angle
        const t=(Math.sin(angle*2+time)+1)/2;
        const r=lerp(m.c1[0],m.c2[0],t);
        const g=lerp(m.c1[1],m.c2[1],t);
        const b=lerp(m.c1[2],m.c2[2],t);
        
        // Falloff
        const falloff=1-glowDist/(radius*1.8);
        const intensity=falloff*falloff*(0.4+audio*0.3);
        
        // Dither
        const dith=((x+y)%2)*8-4;
        
        const fr=m.bg[0]+r*intensity+dith;
        const fg=m.bg[1]+g*intensity+dith;
        const fb=m.bg[2]+b*intensity+dith;
        
        const q=quantize(fr,fg,fb);
        const i=(y*w+x)*4;
        img.data[i]=q[0];img.data[i+1]=q[1];img.data[i+2]=q[2];img.data[i+3]=255;
      }
      
      // Dark orb center (pure black)
      if(dist<radius){
        const i=(y*w+x)*4;
        img.data[i]=0;img.data[i+1]=0;img.data[i+2]=0;img.data[i+3]=255;
      }
    }
  }
  
  ctx.putImageData(img,0,0);
  requestAnimationFrame(draw);
}

navigator.mediaDevices?.getUserMedia({audio:true}).then(s=>{
  const ac=new AudioContext(),src=ac.createMediaStreamSource(s),an=ac.createAnalyser();
  an.fftSize=256;src.connect(an);
  const data=new Uint8Array(an.frequencyBinCount);
  (function loop(){
    an.getByteFrequencyData(data);
    let sum=0;for(let i=0;i<50;i++)sum+=data[i];
    audio=sum/50/255;
    requestAnimationFrame(loop);
  })();
}).catch(()=>{});

mood=new URLSearchParams(location.search).get('mood')||'neutral';
window.addEventListener('message',e=>{if(e.data?.mood)mood=e.data.mood});
resize();
window.addEventListener('resize',resize);
draw();
</script>
</body>
</html>
