<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Particle Orb</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{background:#000}
canvas{position:fixed;inset:0;width:100%;height:100%;image-rendering:pixelated;image-rendering:crisp-edges}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
// 8-bit palette (256 colors)
const PAL=[];
for(let r=0;r<6;r++)for(let g=0;g<7;g++)for(let b=0;b<6;b++)PAL.push([r*51,g*42,b*51]);
for(let i=0;i<4;i++)PAL.push([i*85,i*85,i*85]);
function quantize(r,g,b){
  let best=PAL[0],minD=Infinity;
  for(const c of PAL){const d=(r-c[0])**2+(g-c[1])**2+(b-c[2])**2;if(d<minD){minD=d;best=c}}
  return best;
}

const canvas=document.getElementById('c'),ctx=canvas.getContext('2d',{willReadFrequently:true});
let w,h,scale=2,audio=0,time=0;
let particles=[];

function resize(){
  w=Math.floor(window.innerWidth/scale);
  h=Math.floor(window.innerHeight/scale);
  canvas.width=w;canvas.height=h;
  initParticles();
}

function initParticles(){
  particles=[];
  const cx=w/2,cy=h/2;
  for(let i=0;i<150;i++){
    const angle=Math.random()*Math.PI*2;
    const r=Math.random()*50;
    particles.push({
      x:cx+Math.cos(angle)*r,
      y:cy+Math.sin(angle)*r,
      vx:(Math.random()-0.5)*0.8,
      vy:(Math.random()-0.5)*0.8,
      phase:Math.random()*Math.PI*2,
      hue:170+Math.random()*20
    });
  }
}

function draw(){
  time+=0.016;
  const cx=w/2,cy=h/2;
  
  // Trail fade
  ctx.fillStyle='rgba(0,0,0,0.12)';
  ctx.fillRect(0,0,w,h);
  
  const img=ctx.getImageData(0,0,w,h);
  
  for(const p of particles){
    // Wander
    p.phase+=0.02;
    p.vx+=Math.cos(p.phase)*0.1;
    p.vy+=Math.sin(p.phase*1.3)*0.1;
    
    // Attract to center
    const dx=cx-p.x,dy=cy-p.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    p.vx+=dx*0.002;
    p.vy+=dy*0.002;
    
    // Audio push
    p.vx+=(Math.random()-0.5)*audio*2;
    p.vy+=(Math.random()-0.5)*audio*2;
    
    // Damping
    p.vx*=0.98;p.vy*=0.98;
    
    // Move
    p.x+=p.vx;p.y+=p.vy;
    
    // Constrain
    const maxR=60+audio*20;
    if(dist>maxR){
      const a=Math.atan2(dy,dx);
      p.x=cx-Math.cos(a)*maxR;
      p.y=cy-Math.sin(a)*maxR;
      p.vx*=-0.5;p.vy*=-0.5;
    }
    
    // Draw with quantization
    const px=Math.floor(p.x),py=Math.floor(p.y);
    if(px>=0&&px<w&&py>=0&&py<h){
      // Warm color based on position
      const hue=p.hue+time*10+audio*30;
      const sat=0.7,lit=0.5+audio*0.2;
      
      // HSL to RGB approx
      const c=(1-Math.abs(2*lit-1))*sat;
      const x2=c*(1-Math.abs((hue/60)%2-1));
      const m=lit-c/2;
      let R,G,B;
      const h6=Math.floor(hue/60)%6;
      if(h6===0){R=c;G=x2;B=0}
      else if(h6===1){R=x2;G=c;B=0}
      else if(h6===2){R=0;G=c;B=x2}
      else if(h6===3){R=0;G=x2;B=c}
      else if(h6===4){R=x2;G=0;B=c}
      else{R=c;G=0;B=x2}
      
      R=Math.floor((R+m)*255);
      G=Math.floor((G+m)*255);
      B=Math.floor((B+m)*255);
      
      const q=quantize(R,G,B);
      const dith=((px+py)%2)*20-10;
      
      const i=(py*w+px)*4;
      img.data[i]=Math.min(255,q[0]+dith);
      img.data[i+1]=Math.min(255,q[1]+dith);
      img.data[i+2]=Math.min(255,q[2]+dith);
      img.data[i+3]=255;
      
      // 2x2 pixel for visibility
      if(px+1<w){
        const i2=(py*w+px+1)*4;
        img.data[i2]=q[0];img.data[i2+1]=q[1];img.data[i2+2]=q[2];img.data[i2+3]=255;
      }
    }
  }
  
  ctx.putImageData(img,0,0);
  requestAnimationFrame(draw);
}

navigator.mediaDevices?.getUserMedia({audio:true}).then(s=>{
  const ac=new AudioContext(),src=ac.createMediaStreamSource(s),an=ac.createAnalyser();
  an.fftSize=256;src.connect(an);
  const data=new Uint8Array(an.frequencyBinCount);
  (function loop(){
    an.getByteFrequencyData(data);
    let sum=0;for(let i=0;i<50;i++)sum+=data[i];
    audio=sum/50/255;
    requestAnimationFrame(loop);
  })();
}).catch(()=>{});

resize();
window.addEventListener('resize',resize);
draw();
</script>
</body>
</html>
