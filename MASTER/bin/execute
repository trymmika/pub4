#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/json_protocol"
require_relative "../lib/pledge"
require 'tempfile'

MASTER::Protocol.pipe do |input|
  response = input[:response] || ""
  
  # Extract code blocks
  code_blocks = response.scan(/```(\w+)?\n(.*?)```/m).map { |lang, code| { lang: lang, code: code } }
  
  if code_blocks.empty?
    input.merge(
      success: true,
      output: "",
      errors: "",
      executed: false,
      message: "No code blocks found"
    )
  else
    results = []
    
    code_blocks.each do |block|
      lang = block[:lang] || "ruby"
      code = block[:code]
      
      # Only execute safe languages
      next unless ['ruby', 'rb', 'bash', 'sh'].include?(lang)
      
      begin
        # Apply pledge sandbox
        MASTER::Pledge.sandbox(stdio: true, rpath: true, wpath: false, exec: true)
        
        # Execute in tempfile
        Tempfile.create(['execute', lang == 'ruby' ? '.rb' : '.sh']) do |f|
          f.write(code)
          f.flush
          
          cmd = lang == 'ruby' ? "ruby #{f.path}" : "sh #{f.path}"
          output = `#{cmd} 2>&1`
          success = $?.success?
          
          results << {
            lang: lang,
            success: success,
            output: output,
            exit_code: $?.exitstatus
          }
        end
      rescue => e
        results << {
          lang: lang,
          success: false,
          error: e.message
        }
      end
    end
    
    all_success = results.all? { |r| r[:success] }
    
    input.merge(
      success: all_success,
      executed: true,
      results: results,
      output: results.map { |r| r[:output] }.join("\n"),
      errors: results.select { |r| !r[:success] }.map { |r| r[:error] || r[:output] }.join("\n")
    )
  end
end
