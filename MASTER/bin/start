#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/db"
require_relative "../lib/llm_client"
require "tty-prompt"
require "tty-spinner"

MASTER::DB.initialize_schema
MASTER::LLM.configure

prompt = TTY::Prompt.new

puts "master0: booted"

chat = RubyLLM.chat
chat.with_instructions(MASTER::DB.system_prompt)

loop do
  input = prompt.ask("›")
  break if input.nil? || input.strip == "exit"
  next if input.strip.empty?

  spinner = TTY::Spinner.new("  :spinner thinking…", format: :dots)
  spinner.auto_spin

  begin
    response = chat.ask(input) do |chunk|
      spinner.stop if spinner.spinning?
      print chunk.content if chunk.content
    end

    puts "\n"
  rescue => e
    spinner.stop if spinner.spinning?
    puts "\nError: #{e.message}"
  end
end

puts "master0: shutdown"
