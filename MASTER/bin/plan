#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/json_protocol"

PHASES = [
  { name: "discover", next: "analyze", criteria: ["problem understood", "constraints identified"] },
  { name: "analyze", next: "ideate", criteria: ["root cause found", "requirements clear"] },
  { name: "ideate", next: "design", criteria: ["solutions proposed", "trade-offs evaluated"] },
  { name: "design", next: "implement", criteria: ["architecture defined", "plan created"] },
  { name: "implement", next: "validate", criteria: ["code written", "tests added"] },
  { name: "validate", next: "deliver", criteria: ["tests passing", "quality checks passed"] },
  { name: "deliver", next: "learn", criteria: ["deployed", "documented"] },
  { name: "learn", next: nil, criteria: ["retrospective done", "insights captured"] }
].freeze

MASTER::Protocol.pipe do |input|
  current_phase = input[:phase] || "discover"
  completed_criteria = input[:completed_criteria] || []
  
  phase_info = PHASES.find { |p| p[:name] == current_phase }
  
  unless phase_info
    input.merge(
      error: "Unknown phase: #{current_phase}",
      phase: current_phase
    )
    next input
  end
  
  # Check if all criteria met
  criteria_met = phase_info[:criteria].all? do |criterion|
    completed_criteria.include?(criterion)
  end
  
  next_phase = criteria_met ? phase_info[:next] : current_phase
  complete = next_phase.nil?
  
  input.merge(
    phase: current_phase,
    next_phase: next_phase,
    criteria_met: criteria_met,
    required_criteria: phase_info[:criteria],
    completed_criteria: completed_criteria,
    workflow_complete: complete
  )
end
