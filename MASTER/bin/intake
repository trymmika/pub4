#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/json_protocol"
require_relative "../lib/strunk"
require_relative "../lib/db"

MASTER::DB.initialize_schema

MASTER::Protocol.pipe do |input|
  text = input[:text] || input[:prompt] || ""
  
  # Apply Strunk & White compression
  compressed = MASTER::Strunk.compress(text)
  
  # Calculate information density
  density = MASTER::Strunk.density(compressed)
  
  # Load persona if specified
  persona_name = input[:persona] || "generic"
  persona = MASTER::DB.get_persona(persona_name)
  
  input.merge(
    text: compressed,
    original_text: text,
    persona: persona ? persona["instructions"] : nil,
    persona_name: persona_name,
    density: density
  )
end
