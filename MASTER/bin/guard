#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/json_protocol"
require_relative "../lib/db"

MASTER::DB.initialize_schema

MASTER::Protocol.pipe do |input|
  text = input[:text] || ""
  
  # Check protection levels from principles
  absolute_principles = MASTER::DB.get_principles(protection_level: "ABSOLUTE")
  protected_principles = MASTER::DB.get_principles(protection_level: "PROTECTED")
  
  # Check for dangerous operations
  dangerous_keywords = [
    "rm -rf", "delete database", "drop table", "format disk",
    "sudo rm", "rm -fr", "> /dev/sda"
  ]
  
  blocked = false
  reason = nil
  
  dangerous_keywords.each do |keyword|
    if text.downcase.include?(keyword)
      blocked = true
      reason = "Dangerous operation detected: #{keyword}"
      break
    end
  end
  
  # Check against absolute principles
  unless blocked
    absolute_principles.each do |principle|
      principle_text = principle["text"] || ""
      # Simple check - could be enhanced with more sophisticated matching
      if text.downcase.include?("violate") && text.downcase.include?(principle["name"].downcase)
        blocked = true
        reason = "Violates ABSOLUTE principle: #{principle['name']}"
        break
      end
    end
  end
  
  input.merge(
    allowed: !blocked,
    blocked: blocked,
    reason: reason,
    protection_check_passed: !blocked
  )
end
