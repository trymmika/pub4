#!/usr/bin/env bash
# Weekly automation for MASTER framework
# Harvests ecosystem intelligence, runs self-optimization, generates report

set -e

# Configuration
MASTER_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
TIMESTAMP=$(date +%Y-%m-%d)
REPORT_DIR="${MASTER_ROOT}/data/reports"
REPORT_FILE="${REPORT_DIR}/weekly_${TIMESTAMP}.md"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Banner
echo "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo "${BLUE}â•‘  MASTER Weekly Automation                 â•‘${NC}"
echo "${BLUE}â•‘  $(date +'%Y-%m-%d %H:%M:%S')                       â•‘${NC}"
echo "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# Ensure directories exist
mkdir -p "${REPORT_DIR}"
mkdir -p "${MASTER_ROOT}/data/intelligence"
mkdir -p "${MASTER_ROOT}/data/monitoring"

# Initialize report
cat > "${REPORT_FILE}" << 'EOF'
# MASTER Weekly Report

> Automated intelligence harvest, optimization, and monitoring

---

## Summary

EOF

echo "ðŸ“… Generated: $(date -Iseconds)" >> "${REPORT_FILE}"
echo >> "${REPORT_FILE}"

# Step 1: Harvest ecosystem intelligence
echo "${YELLOW}â†’${NC} Step 1/3: Harvesting ecosystem intelligence..."
echo >> "${REPORT_FILE}"
echo "## 1. Ecosystem Intelligence Harvest" >> "${REPORT_FILE}"
echo >> "${REPORT_FILE}"

if ruby "${MASTER_ROOT}/lib/harvester.rb" >> "${REPORT_FILE}" 2>&1; then
  echo "${GREEN}âœ“${NC} Harvest complete"
  echo "âœ“ Harvest completed successfully" >> "${REPORT_FILE}"
else
  echo "${RED}âœ—${NC} Harvest failed (continuing anyway)"
  echo "âœ— Harvest encountered errors (see logs)" >> "${REPORT_FILE}"
fi

echo >> "${REPORT_FILE}"

# Step 2: Self-optimization (if evolve.rb supports --converge)
echo "${YELLOW}â†’${NC} Step 2/3: Running self-optimization..."
echo "## 2. Self-Optimization" >> "${REPORT_FILE}"
echo >> "${REPORT_FILE}"

if [[ -f "${MASTER_ROOT}/lib/evolve.rb" ]]; then
  # Check if evolve.rb can be run standalone
  echo "Attempting self-optimization cycle..." >> "${REPORT_FILE}"
  echo "Note: Manual optimization recommended for safety" >> "${REPORT_FILE}"
  echo "${BLUE}Â·${NC} Self-optimization deferred (manual review recommended)"
else
  echo "${BLUE}Â·${NC} Evolve module not configured for standalone execution"
  echo "Evolve module requires interactive session" >> "${REPORT_FILE}"
fi

echo >> "${REPORT_FILE}"

# Step 3: Generate monitoring report
echo "${YELLOW}â†’${NC} Step 3/3: Generating monitoring report..."
echo "## 3. Resource Monitoring" >> "${REPORT_FILE}"
echo >> "${REPORT_FILE}"

if ruby "${MASTER_ROOT}/lib/monitor.rb" >> "${REPORT_FILE}" 2>&1; then
  echo "${GREEN}âœ“${NC} Monitoring report generated"
else
  echo "${YELLOW}!${NC} No monitoring data available"
  echo "No usage data recorded this period" >> "${REPORT_FILE}"
fi

echo >> "${REPORT_FILE}"

# Footer
cat >> "${REPORT_FILE}" << 'EOF'

---

## Next Steps

- [ ] Review harvested skills for integration opportunities
- [ ] Check monitoring data for optimization targets
- [ ] Update principles based on ecosystem trends
- [ ] Schedule manual evolution cycle if needed

EOF

echo "ðŸ“„ Report saved: ${REPORT_FILE}" >> "${REPORT_FILE}"

# Summary
echo
echo "${GREEN}âœ“${NC} Weekly automation complete"
echo "${BLUE}Â·${NC} Report: ${REPORT_FILE}"
echo

# Display report summary
if command -v bat &> /dev/null; then
  bat --style=plain --paging=never "${REPORT_FILE}"
elif command -v cat &> /dev/null; then
  cat "${REPORT_FILE}"
fi

exit 0

# Cron configuration example:
# 
# Run every Monday at 9 AM:
# 0 9 * * 1 cd ~/pub4/MASTER && ./bin/weekly
#
# Run every Sunday at midnight:
# 0 0 * * 0 cd ~/pub4/MASTER && ./bin/weekly
#
# To install:
# crontab -e
# Add one of the lines above (adjust path as needed)
