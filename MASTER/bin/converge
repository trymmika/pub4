#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/json_protocol"

MASTER::Protocol.pipe do |input|
  current = input[:response] || ""
  previous = input[:previous_response] || input[:previous] || ""
  iteration = input[:iteration] || 1
  threshold = input[:threshold] || 0.02
  
  if previous.empty?
    # First iteration
    input.merge(
      converged: false,
      delta: 1.0,
      iterations: iteration,
      message: "First iteration"
    )
  else
    # Calculate delta (simple Levenshtein-like measure)
    if current == previous
      delta = 0.0
    else
      # Simple character-based difference
      max_len = [current.length, previous.length].max
      return input.merge(converged: true, delta: 0.0, iterations: iteration) if max_len.zero?
      
      differences = 0
      [current.length, previous.length].min.times do |i|
        differences += 1 if current[i] != previous[i]
      end
      differences += (current.length - previous.length).abs
      
      delta = differences.to_f / max_len
    end
    
    converged = delta < threshold
    
    input.merge(
      converged: converged,
      delta: delta,
      iterations: iteration,
      threshold: threshold,
      previous_response: current
    )
  end
end
