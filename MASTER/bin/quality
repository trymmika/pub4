#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/json_protocol"
require_relative "../lib/metz"

MASTER::Protocol.pipe do |input|
  response = input[:response] || ""
  file_path = input[:file]
  
  violations = []
  
  # Check file if specified
  if file_path && File.exist?(file_path)
    violations.concat(MASTER::Metz.check_file(file_path))
  end
  
  # Check code blocks in response
  code_blocks = response.scan(/```(?:\w+)?\n(.*?)```/m).flatten
  code_blocks.each do |code|
    violations.concat(MASTER::Metz.check_code(code))
  end
  
  score = MASTER::Metz.score(violations)
  passed = violations.empty?
  
  input.merge(
    quality_passed: passed,
    quality_score: score,
    quality_results: violations,
    violations_count: violations.length
  )
end
