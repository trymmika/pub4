#!/usr/bin/env ruby
# frozen_string_literal: true

# Main CLI dispatcher
VERSION = "4.0.0"

def usage

  puts <<~USAGE

    repligen v#{VERSION} - AI generation orchestrator
    Commands:
      sync [limit]           Sync models from Replicate API (default: 1000)

      search <query>         Search local model database
      chain [template] [prompt]  Execute generation chain
      stats                  Show database statistics
    Templates:
      masterpiece            8-20 step chain with all effects (default)

      quick                  2 step chain (fast)
    Examples:
      repligen sync 500

      repligen search "stable diffusion"
      repligen chain masterpiece "cyberpunk portrait"
      repligen chain quick "mountain landscape"
    Setup:
      export REPLICATE_API_TOKEN=r8_...

    Or:
      echo '{"api_token":"r8_..."}' > ~/.config/repligen/config.json
  USAGE
end
cmd = ARGV.shift
case cmd

when "sync"

  exec "ruby", File.join(__dir__, "repligen-sync"), *ARGV
when "search"
  exec "ruby", File.join(__dir__, "repligen-search"), *ARGV
when "chain"
  exec "ruby", File.join(__dir__, "repligen-chain"), *ARGV
when "stats"
  require_relative "../lib/db"
  db = Repligen::Database.new
  stats = db.stats
  puts "Models: #{stats[:total]}"
  puts "\nBy type:"
  stats[:by_type].first(10).each { |r| puts "  #{r['type'].ljust(20)} #{r['count']}" }
when "-h", "--help", "help", nil
  usage
else
  abort "Unknown command: #{cmd}\n\n#{usage}"
end
