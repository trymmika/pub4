<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MASTER</title>
<script src="https://unpkg.com/css-doodle@0.40.5/css-doodle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{
  background:#000;
  color:#fff;
  font:14px/1.4 system-ui,-apple-system,sans-serif;
  display:grid;
  grid-template-rows:1fr auto auto;
  place-items:center;
  min-height:100vh;
}
main{display:grid;place-items:center}
#orb{
  width:clamp(180px,45vmin,320px);
  aspect-ratio:1;
  border-radius:50%;
  overflow:hidden;
  cursor:pointer;
  transition:transform .3s ease,filter .3s ease;
}
#orb:hover{transform:scale(1.03);filter:brightness(1.1)}
#orb[data-state="thinking"]{animation:breathe 2s ease-in-out infinite}
@keyframes breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}
output{
  position:fixed;
  inset:auto 1rem 4rem;
  max-height:30vh;
  overflow-y:auto;
  font-family:monospace;
  font-size:13px;
  display:none;
}
output.show{display:block}
output p{margin:.25rem 0;opacity:.85}
output p.user{opacity:.5}
footer{
  position:fixed;
  inset:auto 0 0;
  display:grid;
}
input{
  background:transparent;
  border:none;
  border-top:1px solid #111;
  color:#fff;
  font:inherit;
  padding:1rem;
  outline:none;
}
input::placeholder{color:#333}
aside{
  position:fixed;
  top:.5rem;
  right:.5rem;
  font:11px monospace;
  opacity:.3;
  display:none;
}
aside.show{display:block}
</style>
</head>
<body>
<main>
  <css-doodle id="orb" onclick="this.update()">
    :doodle {
      @grid: 20x1 / 100%;
      overflow: hidden;
    }
    @place: center;
    @size: calc(100% - @i * 4%);
    border-radius: 50%;
    border: 1px solid hsla(
      calc(200 + @i * 3),
      50%,
      calc(10% + @i * 2%),
      calc(.1 + @i * .02)
    );
    animation: orbit calc(10s + @i * .5s) linear infinite;
    animation-direction: @pn(normal, reverse);
    transform-origin: center;
    @keyframes orbit {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </css-doodle>
</main>
<output id="out"></output>
<aside id="cost"></aside>
<footer>
  <input id="in" type="text" placeholder="" autofocus>
</footer>
<script>
const orb=document.getElementById('orb'),out=document.getElementById('out'),inp=document.getElementById('in'),cost=document.getElementById('cost');
let last='';
function add(t,isUser){
  out.classList.add('show');
  const p=document.createElement('p');
  if(isUser)p.className='user';
  p.textContent=isUser?'> '+t:t;
  out.appendChild(p);
  out.scrollTop=out.scrollHeight;
}
function upd(c){cost.textContent='$'+c.toFixed(4);cost.classList.add('show')}
inp.addEventListener('keydown',e=>{
  if(e.key!=='Enter')return;
  const m=inp.value.trim();
  if(!m)return;
  add(m,true);
  inp.value='';
  orb.dataset.state='thinking';
  fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:m})})
    .then(r=>r.json())
    .then(d=>{orb.dataset.state='';if(d.response)add(d.response);if(d.cost)upd(d.cost)})
    .catch(()=>{orb.dataset.state='';add('...')});
});
(function poll(){
  fetch('/poll',{signal:AbortSignal.timeout(10000)})
    .then(r=>r.json())
    .then(d=>{if(d.cost)upd(d.cost);if(d.text&&d.text!==last){last=d.text;add(d.text)}setTimeout(poll,1000)})
    .catch(()=>setTimeout(poll,3000));
})();
</script>
</body>
</html>
