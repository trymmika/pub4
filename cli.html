<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MASTER</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{
  background:var(--bg,#000);
  color:#fff;
  font:14px/1.4 system-ui,-apple-system,sans-serif;
  display:grid;
  grid-template-rows:1fr auto auto;
  place-items:center;
  min-height:100vh;
  transition:background 1s ease;
}
/* Mood palettes */
.mood-neutral{--bg:#0a0a0f;--orb1:#984ddf;--orb2:#4344ad;--orb3:#74d9e1}
.mood-positive{--bg:#0a1a0f;--orb1:#4ddf98;--orb2:#44ad7d;--orb3:#74e1a0}
.mood-negative{--bg:#1a0a0a;--orb1:#df4d4d;--orb2:#ad4444;--orb3:#e17474}
.mood-calm{--bg:#0a0a1a;--orb1:#4d7ddf;--orb2:#4454ad;--orb3:#74a0e1}
.mood-excited{--bg:#1a0a1a;--orb1:#df4ddf;--orb2:#ad44ad;--orb3:#e174e1}

main{display:grid;place-items:center}
#orb-container{
  width:clamp(200px,50vmin,400px);
  height:clamp(200px,50vmin,400px);
  display:grid;place-items:center;
}
/* Blob Orb */
.blob-orb svg{width:100%;height:100%}
.blob-orb .blob{animation:rotate 25s infinite alternate ease-in-out;transform-origin:50% 50%;opacity:0.7}
.blob-orb .blob path{animation:morph 5s infinite alternate cubic-bezier(0.45,0.2,0.55,0.8);transition:fill 800ms ease}
.blob-orb .blob-1 path{fill:var(--orb1);filter:blur(1rem)}
.blob-orb .blob-2 path{fill:var(--orb2);filter:blur(0.75rem);animation-duration:7s}
.blob-orb .blob-3 path{fill:var(--orb3);filter:blur(0.5rem);animation-duration:6s}
@keyframes rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes morph{
  0%{d:path("M 100 600 q 0 -500, 500 -500 t 500 500 t -500 500 T 100 600 z")}
  33%{d:path("M 100 600 q -50 -400, 500 -500 t 450 550 t -500 500 T 100 600 z")}
  66%{d:path("M 150 600 q 0 -600, 500 -500 t 500 550 t -500 500 T 150 600 z")}
  100%{d:path("M 100 600 q 100 -600, 500 -500 t 400 500 t -500 500 T 100 600 z")}
}
/* Glow Orb */
.glow-orb{
  width:200px;height:200px;border-radius:50%;
  background:radial-gradient(circle at 30% 30%,var(--orb3),var(--orb2),var(--orb1));
  box-shadow:0 0 60px 30px var(--orb1);
  animation:pulse 3s ease-in-out infinite;
}
@keyframes pulse{0%,100%{transform:scale(1);box-shadow:0 0 60px 30px var(--orb1)}50%{transform:scale(1.1);box-shadow:0 0 80px 40px var(--orb1)}}
/* Backlight Orb */
.backlight-orb{position:relative;width:250px;height:250px;background:var(--bg);border-radius:50%}
.backlight-orb::after{
  content:"";position:absolute;width:100%;height:100%;border-radius:50%;z-index:-1;
  filter:blur(40px);background:linear-gradient(270deg,var(--orb1),var(--orb2));
  background-size:200% 200%;animation:glow-move 10s ease infinite;
}
@keyframes glow-move{0%{background-position:0% 50%;transform:scale(0.9)}50%{background-position:100% 50%;transform:scale(1.1)}100%{background-position:0% 50%;transform:scale(0.9)}}

/* Orb selector */
#orb-selector{position:fixed;top:10px;left:10px;display:flex;gap:6px}
#orb-selector button{
  padding:6px 12px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);
  color:#fff;cursor:pointer;font:11px system-ui;border-radius:3px;
}
#orb-selector button:hover{background:rgba(255,255,255,0.2)}
#orb-selector button.active{background:rgba(255,255,255,0.3);border-color:#fff}

output{position:fixed;inset:auto 1rem 4rem;max-height:30vh;overflow-y:auto;font-family:monospace;font-size:13px;display:none}
output.show{display:block}
output p{margin:.25rem 0;opacity:.85}
output p.user{opacity:.5}
footer{position:fixed;inset:auto 0 0;display:grid}
input{background:transparent;border:none;border-top:1px solid #111;color:#fff;font:inherit;padding:1rem;outline:none}
input::placeholder{color:#333}
#mood{position:fixed;top:10px;right:10px;font:11px monospace;opacity:.5}
#cost{position:fixed;bottom:50px;right:10px;font:11px monospace;opacity:.3;display:none}
#cost.show{display:block}
</style>
</head>
<body class="mood-neutral">

<div id="orb-selector">
  <button data-orb="blob" class="active">morphing</button>
  <button data-orb="glow">glowing</button>
  <button data-orb="backlight">backlit</button>
</div>

<main>
  <div id="orb-container">
    <div class="blob-orb">
      <svg viewBox="0 0 1200 1200">
        <g class="blob blob-1"><path/></g>
        <g class="blob blob-2"><path/></g>
        <g class="blob blob-3"><path/></g>
      </svg>
    </div>
  </div>
</main>

<output id="out"></output>
<div id="mood">neutral</div>
<div id="cost"></div>
<footer><input id="in" type="text" placeholder="" autofocus></footer>

<script>
const orbs = {
  blob: `<div class="blob-orb"><svg viewBox="0 0 1200 1200">
    <g class="blob blob-1"><path/></g>
    <g class="blob blob-2"><path/></g>
    <g class="blob blob-3"><path/></g>
  </svg></div>`,
  glow: `<div class="glow-orb"></div>`,
  backlight: `<div class="backlight-orb"></div>`
};

// Orb switching
document.querySelectorAll('#orb-selector button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#orb-selector button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('orb-container').innerHTML = orbs[btn.dataset.orb];
    localStorage.setItem('orb', btn.dataset.orb);
  });
});
// Restore saved orb
const savedOrb = localStorage.getItem('orb');
if (savedOrb && orbs[savedOrb]) {
  document.getElementById('orb-container').innerHTML = orbs[savedOrb];
  document.querySelectorAll('#orb-selector button').forEach(b => {
    b.classList.toggle('active', b.dataset.orb === savedOrb);
  });
}

// Mood detection
function detectMood(text) {
  const t = text.toLowerCase();
  if (/\b(excited|wow|incredible|fantastic|amazing|awesome)\b/.test(t)) return 'excited';
  if (/\b(great|love|happy|thanks|excellent|good|nice|wonderful|perfect)\b/.test(t)) return 'positive';
  if (/\b(bad|hate|angry|sad|terrible|awful|wrong|error|fail|broken|frustrated)\b/.test(t)) return 'negative';
  if (/\b(calm|peaceful|quiet|relax|serene|gentle|soft)\b/.test(t)) return 'calm';
  return 'neutral';
}
function setMood(mood) {
  document.body.className = `mood-${mood}`;
  document.getElementById('mood').textContent = mood;
}

// Chat
const out = document.getElementById('out'), inp = document.getElementById('in'), costEl = document.getElementById('cost');
let last = '';
function add(t, isUser) {
  out.classList.add('show');
  const p = document.createElement('p');
  if (isUser) p.className = 'user';
  p.textContent = isUser ? '> ' + t : t;
  out.appendChild(p);
  out.scrollTop = out.scrollHeight;
  if (!isUser) setMood(detectMood(t));
}
function upd(c) { costEl.textContent = '$' + c.toFixed(4); costEl.classList.add('show'); }

inp.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  const m = inp.value.trim();
  if (!m) return;
  add(m, true);
  setMood(detectMood(m));
  inp.value = '';
  fetch('/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: m }) })
    .then(r => r.json())
    .then(d => { if (d.response) add(d.response); if (d.cost) upd(d.cost); })
    .catch(() => add('...'));
});

(function poll() {
  fetch('/poll', { signal: AbortSignal.timeout(10000) })
    .then(r => r.json())
    .then(d => { if (d.cost) upd(d.cost); if (d.text && d.text !== last) { last = d.text; add(d.text); } setTimeout(poll, 1000); })
    .catch(() => setTimeout(poll, 3000));
})();

// Keyboard mood override (1-5)
document.addEventListener('keydown', e => {
  if (document.activeElement === inp) return;
  if (e.key === '1') setMood('neutral');
  if (e.key === '2') setMood('positive');
  if (e.key === '3') setMood('negative');
  if (e.key === '4') setMood('calm');
  if (e.key === '5') setMood('excited');
});
</script>
</body>
</html>
