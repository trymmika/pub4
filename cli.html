<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>Ares</title>
<style>
*{margin:0;padding:0}
body{background:#000;color:#fff;font:14px monospace}
#i{position:fixed;top:10px;left:10px;background:none;border:none;color:#fff;font:inherit;outline:none}
#o{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:40vmin;height:40vmin;background:#fff;border-radius:50%}
#s{position:fixed;top:10px;right:10px;opacity:.5}
</style>
</head>
<body>
<input id="i" placeholder="...">
<div id="o"></div>
<div id="s"></div>
<script>
const o=document.getElementById('o'),s=document.getElementById('s'),i=document.getElementById('i');
let state='idle';
function set(st){state=st;s.textContent=st==='idle'?'':st;}
const A={
  syn:speechSynthesis,rec:null,voice:null,speaking:false,listening:false,last:null,
  init(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(SR){this.rec=new SR();this.rec.continuous=false;this.rec.lang='en-US';
      this.rec.onresult=e=>{set('...');this.send(e.results[0][0].transcript);};
      this.rec.onend=()=>{this.listening=false;if(state==='listening')set('idle');};
    }
    const v=()=>{this.voice=this.syn.getVoices().find(v=>v.lang.startsWith('en'))||this.syn.getVoices()[0];};
    this.syn.getVoices().length?v():this.syn.onvoiceschanged=v;
    i.onkeydown=e=>{if(e.key==='Enter'&&i.value.trim()){set('...');this.send(i.value.trim());i.value='';}};
    i.onclick=e=>e.stopPropagation();
    document.body.onclick=()=>{if(this.speaking){this.syn.cancel();this.speaking=false;set('idle');}
      else if(this.listening){this.rec.stop();this.listening=false;set('idle');}
      else if(this.rec){this.listening=true;set('listening');this.rec.start();}};
    this.poll();
  },
  poll(){fetch('/poll',{signal:AbortSignal.timeout(10000)}).then(r=>r.json()).then(d=>{
    if(d.audio&&!this.speaking)this.play(d.audio,d.text);
    else if(d.text&&d.text!==this.last&&!this.speaking)this.speak(d.text);
    setTimeout(()=>this.poll(),1000);}).catch(()=>setTimeout(()=>this.poll(),3000));},
  send(m){fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:m})})
    .then(r=>r.json()).then(d=>{if(d.audio)this.play(d.audio,d.response);else if(d.response)this.speak(d.response);})
    .catch(()=>this.speak('...'));},
  play(url,txt){this.last=txt;const a=new Audio(url);a.onplay=()=>{this.speaking=true;set('speaking');};
    a.onended=()=>{this.speaking=false;set('idle');};a.onerror=()=>{if(txt)this.speak(txt);};a.play().catch(()=>{if(txt)this.speak(txt);});},
  speak(t){if(!t)return;this.syn.cancel();this.last=t;const u=new SpeechSynthesisUtterance(t.replace(/[#_*]/g,'').slice(0,500));
    u.voice=this.voice;u.onstart=()=>{this.speaking=true;set('speaking');};u.onend=()=>{this.speaking=false;set('idle');};this.syn.speak(u);}
};
A.init();
</script>
</body>
</html>
