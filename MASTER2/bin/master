#!/usr/bin/env ruby
# frozen_string_literal: true

require "dotenv/load" rescue nil

require_relative "../lib/master"

# Setup database
db_path = "#{MASTER.root}/master.db"
MASTER::DB.setup(path: db_path)

# Configure LLM
MASTER::LLM.configure

# Arm Pledge security boundary (OpenBSD only)
if MASTER::Pledge.available?
  # Unveil paths we need
  MASTER::Pledge.unveil(MASTER.root, "r")        # read project files
  MASTER::Pledge.unveil(db_path, "rwc")          # read/write/create DB
  MASTER::Pledge.unveil("/tmp", "rwc")           # temp files
  MASTER::Pledge.unveil(nil, nil)                # lock unveil

  # Pledge syscalls we need
  MASTER::Pledge.pledge("stdio rpath wpath cpath fattr inet dns")
end

# Determine mode
if ARGV.include?("--pipe")
  MASTER::Pipeline.pipe
else
  MASTER::Pipeline.repl
end
