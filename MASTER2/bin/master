#!/usr/bin/env ruby
# frozen_string_literal: true

# Force UTF-8 encoding
Encoding.default_external = Encoding::UTF_8
Encoding.default_internal = Encoding::UTF_8
$stdout.set_encoding(Encoding::UTF_8)
$stderr.set_encoding(Encoding::UTF_8)

require_relative "../lib/master"

MASTER::DB.setup

case ARGV[0]
when "--web", "-w"
  server = MASTER::Server.new
  MASTER::Boot.banner
  server.start
  puts "\nPress Ctrl+C to stop"
  sleep
when "--pipe", "-p"
  input = JSON.parse($stdin.read) rescue { "text" => $stdin.read }
  result = MASTER::Pipeline.new.call(input)
  puts JSON.generate(result.ok? ? result.value : { error: result.error })
else
  MASTER::Pipeline.repl
end
