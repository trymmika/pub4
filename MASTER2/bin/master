#!/usr/bin/env ruby
# frozen_string_literal: true

# Force UTF-8 encoding
Encoding.default_external = Encoding::UTF_8
Encoding.default_internal = Encoding::UTF_8
$stdout.set_encoding(Encoding::UTF_8)
$stderr.set_encoding(Encoding::UTF_8)

require "json"
require_relative "../lib/master"

MASTER::DB.setup
MASTER::Session.install_crash_handlers

case ARGV[0]
when "--help", "-h"
  puts "MASTER v#{MASTER::VERSION}"
  puts "\nUsage: master [OPTIONS]"
  puts "\nOptions:"
  puts "  -h, --help        Show this help message"
  puts "  -v, --version     Show version information"
  puts "  -w, --web         Start web-only mode (no REPL)"
  puts "  -p, --pipe        Pipe mode for automation"
  puts "  -t, --tts [TOPIC] TTS test mode - continuous talking"
  puts "  -d, --daemon      Daemon mode for agentd"
  puts "\nDefault: Start REPL with integrated web server"
  exit 0
when "--version", "-v"
  puts "MASTER v#{MASTER::VERSION}"
  exit 0
when "--web", "-w"
  # Web-only mode (no REPL)
  server = MASTER::Server.new
  MASTER::Boot.banner_with_web(server.port)
  server.start
  puts "Press Ctrl+C to stop"
  sleep
when "--pipe", "-p"
  # Pipe mode for automation
  input = JSON.parse($stdin.read) rescue { "text" => $stdin.read }
  result = MASTER::Pipeline.new.call(input)
  puts JSON.generate(result.ok? ? result.value : { error: result.error })
when "--tts", "-t"
  # TTS test mode - continuous talking (Windows/Cygwin)
  topic = ARGV[1]&.to_sym || :master
  puts "Starting continuous TTS (#{topic})... Ctrl+C to stop"
  MASTER::StreamTTS.windows_chatter(topic: topic)
when "--daemon", "-d"
  # Daemon mode for agentd
  require_relative "../sbin/agentd" if File.exist?(File.join(__dir__, "../sbin/agentd"))
else
  # Default: REPL with integrated web server
  server = MASTER::Server.new
  Thread.new { server.start }
  MASTER::Pipeline.repl
end
