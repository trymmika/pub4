<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Retro Orb</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{background:#000;display:flex;align-items:center;justify-content:center}
canvas{image-rendering:pixelated;image-rendering:crisp-edges}
.scanlines{position:fixed;inset:0;background:repeating-linear-gradient(transparent 0px,transparent 2px,rgba(0,0,0,0.15) 2px,rgba(0,0,0,0.15) 4px);pointer-events:none;z-index:10}
.crt{position:fixed;inset:0;box-shadow:inset 0 0 120px rgba(0,0,0,0.7);pointer-events:none;z-index:11}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div class="scanlines"></div>
<div class="crt"></div>
<script>
var canvas=document.getElementById('canvas');
var ctx=canvas.getContext('2d');
var w,h,cx,cy;
var time=0;
var bassWobble=0;
var beatEnv=0;
var audio={bass:0.5,mid:0.5,high:0.5,beat:0};

var PAL=[];
for(var r=0;r<6;r++)for(var g=0;g<7;g++)for(var b=0;b<6;b++)PAL.push([r*51,g*42,b*51]);
for(var i=0;i<4;i++)PAL.push([i*85,i*85,i*85]);

function quantize(r,g,b){
  var best=PAL[0],minD=Infinity;
  for(var i=0;i<PAL.length;i++){
    var c=PAL[i],d=(r-c[0])*(r-c[0])+(g-c[1])*(g-c[1])+(b-c[2])*(b-c[2]);
    if(d<minD){minD=d;best=c}
  }
  return best;
}

function rgb(r,g,b){var q=quantize(r,g,b);return 'rgb('+q[0]+','+q[1]+','+q[2]+')'}

function resize(){
  w=Math.min(256,window.innerWidth);
  h=Math.min(256,window.innerHeight);
  canvas.width=w;
  canvas.height=h;
  canvas.style.width=window.innerWidth+'px';
  canvas.style.height=window.innerHeight+'px';
  cx=w/2;cy=h/2;
}
resize();
window.addEventListener('resize',resize);

var segments=16;
var cosTable=new Float32Array(segments);
var sinTable=new Float32Array(segments);
for(var i=0;i<segments;i++){
  var a=i*Math.PI*2/segments;
  cosTable[i]=Math.cos(a);
  sinTable[i]=Math.sin(a);
}

function drawLine(x1,y1,x2,y2,color){
  var dx=Math.abs(x2-x1),dy=Math.abs(y2-y1);
  var sx=x1<x2?1:-1,sy=y1<y2?1:-1;
  var err=dx-dy;
  ctx.fillStyle=color;
  while(true){
    if(x1>=0&&x1<w&&y1>=0&&y1<h)ctx.fillRect(Math.floor(x1),Math.floor(y1),1,1);
    if(Math.floor(x1)===Math.floor(x2)&&Math.floor(y1)===Math.floor(y2))break;
    var e2=2*err;
    if(e2>-dy){err-=dy;x1+=sx}
    if(e2<dx){err+=dx;y1+=sy}
  }
}

function drawOrb(){
  var layers=6;
  var baseRadius=28;
  var fov=150+audio.bass*30;
  
  for(var layer=0;layer<layers;layer++){
    var z=(layer-layers/2)*20+bassWobble*5;
    var scale=fov/(fov+z);
    var radius=(baseRadius+audio.bass*8+beatEnv*4)*scale;
    
    var pulse=beatEnv*40;
    var depth=layer/6;
    var r=0+depth*30+pulse*0.1;
    var g=160+depth*50+pulse*0.3;
    var b=180+depth*30+pulse*0.2;
    var color=rgb(r,g,b);
    
    var prevX,prevY;
    for(var i=0;i<=segments;i++){
      var idx=i%segments;
      var wobble=bassWobble*0.1;
      var ct=Math.cos(time+wobble);
      var st=Math.sin(time+wobble);
      var cosA=cosTable[idx]*ct-sinTable[idx]*st;
      var sinA=sinTable[idx]*ct+cosTable[idx]*st;
      var px=cx+cosA*radius;
      var py=cy+sinA*radius;
      
      if(i>0)drawLine(prevX,prevY,px,py,color);
      prevX=px;prevY=py;
    }
  }
}

function frame(){
  ctx.fillStyle='#000';
  ctx.fillRect(0,0,w,h);
  
  bassWobble=bassWobble*0.92+audio.bass*audio.beat*0.08;
  beatEnv=beatEnv*0.94+(audio.beat>0.5?0.4:0)*0.06;
  
  drawOrb();
  
  time+=0.02;
  requestAnimationFrame(frame);
}

navigator.mediaDevices?.getUserMedia({audio:true}).then(function(stream){
  var actx=new AudioContext();
  var src=actx.createMediaStreamSource(stream);
  var an=actx.createAnalyser();
  an.fftSize=256;
  src.connect(an);
  var data=new Uint8Array(an.frequencyBinCount);
  (function audioLoop(){
    an.getByteFrequencyData(data);
    var bass=0;
    for(var i=0;i<20;i++)bass+=data[i];
    audio.bass=bass/20/255;
    audio.beat=audio.bass>0.6?1:0;
    requestAnimationFrame(audioLoop);
  })();
}).catch(function(){});

frame();
</script>
</body>
</html>
