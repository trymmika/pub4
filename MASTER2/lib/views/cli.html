<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="color-scheme" content="dark">
<title>MASTER</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{
  background:#000;color:#fff;
  font:14px/1.5 -apple-system,system-ui,sans-serif;
  display:grid;grid-template-rows:1fr;
  height:100dvh;
}
#scene{display:grid;place-items:center;overflow:hidden;grid-row:1/2;grid-column:1/2}
#scene canvas{display:block;width:100%;height:100%}
#chat{
  grid-row:1/2;grid-column:1/2;align-self:end;
  max-height:30vh;overflow-y:auto;padding:0 16px 80px;
  scrollbar-width:none;pointer-events:none;
  opacity:0;transition:opacity .4s;
}
#chat::-webkit-scrollbar{display:none}
#chat.visible{opacity:1}
#chat p{margin:4px 0;color:#666;font-size:13px}
#chat .user{opacity:.4}
#bar-wrap{
  grid-row:1/2;grid-column:1/2;align-self:end;
  padding:12px 16px;
  transform:translateY(100%);opacity:0;
  transition:transform .3s ease,opacity .3s ease;
}
#bar-wrap.visible{transform:translateY(0);opacity:1}
#bar{
  display:grid;grid-template-columns:1fr auto;
  border:1px solid #333;border-radius:8px;
  background:rgba(0,0,0,.8);backdrop-filter:blur(8px);
}
#bar input{
  background:none;border:none;color:#fff;
  font:inherit;padding:10px 14px;outline:none;min-width:0;
}
#bar input::placeholder{color:#666}
#mic{
  background:none;border:none;border-left:1px solid #333;
  color:#666;font-size:18px;padding:0 14px;cursor:pointer;
  display:flex;align-items:center;
}
#mic:hover{color:#fff}
#mic.active{color:#f44}
@media(prefers-reduced-motion:reduce){
  *{animation-duration:.01ms!important;transition-duration:.01ms!important}
}
</style>
</head>
<body>
<div id="scene"></div>
<div id="chat"></div>
<div id="bar-wrap">
  <div id="bar">
    <input id="in" type="text" placeholder="type a message…">
    <button id="mic" title="Voice (v)">&#9679;</button>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// --- Three.js particle orb ---
const scene=new THREE.Scene(),camera=new THREE.PerspectiveCamera(50,1,.1,100);
camera.position.z=3.2;
const renderer=new THREE.WebGLRenderer({antialias:true,alpha:false});
renderer.setClearColor(0x000000);
document.getElementById('scene').appendChild(renderer.domElement);

const N=4000,geo=new THREE.BufferGeometry();
const pos=new Float32Array(N*3),base=new Float32Array(N*3);
for(let i=0;i<N;i++){
  const phi=Math.acos(2*Math.random()-1),theta=Math.random()*Math.PI*2;
  const r=.9+Math.random()*.1;
  const x=r*Math.sin(phi)*Math.cos(theta),y=r*Math.sin(phi)*Math.sin(theta),z=r*Math.cos(phi);
  pos[i*3]=base[i*3]=x;pos[i*3+1]=base[i*3+1]=y;pos[i*3+2]=base[i*3+2]=z;
}
geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
geo.setAttribute('base',new THREE.BufferAttribute(base,3));
const mat=new THREE.PointsMaterial({color:0xffffff,size:.012,sizeAttenuation:true});
const points=new THREE.Points(geo,mat);
scene.add(points);

let orbState='idle',clock=new THREE.Clock();
function orbResize(){
  const w=window.innerWidth,h=window.innerHeight;
  renderer.setSize(w,h);renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  camera.aspect=w/h;camera.updateProjectionMatrix();
}
orbResize();window.addEventListener('resize',orbResize);

function animateOrb(){
  requestAnimationFrame(animateOrb);
  const t=clock.getElapsedTime(),p=geo.attributes.position.array,b=geo.attributes.base.array;
  let breathe=1+Math.sin(t*.8)*.03,rotSpeed=.08,jitter=.002;
  if(orbState==='thinking'){breathe=1+Math.sin(t*2)*.06;rotSpeed=.3;jitter=.006;}
  else if(orbState==='speaking'){breathe=1+Math.sin(t*4)*.08;rotSpeed=.12;jitter=.003;}
  for(let i=0;i<N;i++){
    const i3=i*3;
    p[i3]=b[i3]*breathe+(Math.random()-.5)*jitter;
    p[i3+1]=b[i3+1]*breathe+(Math.random()-.5)*jitter;
    p[i3+2]=b[i3+2]*breathe+(Math.random()-.5)*jitter;
  }
  geo.attributes.position.needsUpdate=true;
  points.rotation.y+=rotSpeed*.016;points.rotation.x=Math.sin(t*.3)*.05;
  renderer.render(scene,camera);
}
animateOrb();

// --- Progressive disclosure ---
const barWrap=document.getElementById('bar-wrap'),inp=document.getElementById('in');
const chatEl=document.getElementById('chat');
let barTimer=null,chatTimer=null,barVisible=false;

function showBar(){
  barWrap.classList.add('visible');barVisible=true;inp.focus();
  clearTimeout(barTimer);barTimer=setTimeout(hideBar,3000);
}
function hideBar(){
  if(document.activeElement===inp&&inp.value)return;
  barWrap.classList.remove('visible');barVisible=false;
}
function showChat(){chatEl.classList.add('visible');clearTimeout(chatTimer);chatTimer=setTimeout(()=>chatEl.classList.remove('visible'),5000)}
function resetBarTimer(){clearTimeout(barTimer);barTimer=setTimeout(hideBar,3000)}

document.getElementById('scene').addEventListener('click',showBar);
document.addEventListener('keydown',e=>{
  if(document.activeElement===inp)return;
  if(e.key==='t'||e.key==='v')return;
  if(!barVisible)showBar();
});
inp.addEventListener('input',resetBarTimer);
inp.addEventListener('focus',()=>{clearTimeout(barTimer)});
inp.addEventListener('blur',()=>{barTimer=setTimeout(hideBar,3000)});

// --- TTS ---
let ttsOn=localStorage.getItem('tts')!=='off';
const synth=window.speechSynthesis;
function speak(text){
  if(!ttsOn||!synth)return;synth.cancel();
  const clean=text.replace(/```[\s\S]*?```/g,'code block').replace(/[*_#`~>|]/g,'').substring(0,500);
  const u=new SpeechSynthesisUtterance(clean);u.rate=1.1;
  u.onstart=()=>{orbState='speaking'};
  u.onend=()=>{orbState='idle'};
  synth.speak(u);
}

// --- Chat ---
let pending=false,offlineN=0,lastSent='';
function addMsg(t,isUser){
  const p=document.createElement('p');p.className=isUser?'user':'';
  p.textContent=isUser?'› '+t:t;chatEl.appendChild(p);
  chatEl.scrollTop=chatEl.scrollHeight;showChat();
  if(!isUser){speak(t);if(!synth||!ttsOn){orbState='speaking';setTimeout(()=>orbState='idle',2000)}}
}
function setPending(v){pending=v;inp.disabled=v;inp.placeholder=v?'thinking…':'type a message…'}

inp.addEventListener('keydown',e=>{
  resetBarTimer();
  if(e.key==='ArrowUp'&&!inp.value){inp.value=lastSent||'';return}
  if(e.key!=='Enter')return;
  const m=inp.value.trim();if(!m||pending)return;
  addMsg(m,true);lastSent=m;inp.value='';
  orbState='thinking';setPending(true);
  fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+(window.MASTER_TOKEN||'')},body:JSON.stringify({message:m})})
    .then(r=>r.ok?r.json():r.json().then(err=>Promise.reject(err)))
    .catch(err=>{addMsg(err?.error||'[offline]');setPending(false);orbState='idle';offlineN++});
});

// --- Poll ---
(function poll(){
  const delay=offlineN===0?800:Math.min(3000*Math.pow(2,offlineN-1),30000);
  fetch('/poll',{signal:AbortSignal.timeout(10000),headers:{'Authorization':'Bearer '+(window.MASTER_TOKEN||'')}})
    .then(r=>r.json()).then(d=>{
      offlineN=0;
      if(d.text){addMsg(d.text);setPending(false);orbState=ttsOn?orbState:'idle'}
      setTimeout(poll,delay);
    }).catch(()=>{offlineN++;setTimeout(poll,delay)});
})();

// --- Voice input ---
const micBtn=document.getElementById('mic');
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
if(SR){
  const rec=new SR();rec.continuous=false;rec.interimResults=true;rec.lang='en-US';
  let on=false;
  function micStart(){if(pending)return;showBar();rec.start();on=true;micBtn.classList.add('active')}
  function micStop(){rec.stop();on=false;micBtn.classList.remove('active')}
  micBtn.addEventListener('click',()=>on?micStop():micStart());
  rec.addEventListener('result',e=>{
    const t=Array.from(e.results).map(r=>r[0].transcript).join('');inp.value=t;
    if(e.results[e.results.length-1].isFinal){micStop();if(t.trim())inp.dispatchEvent(new KeyboardEvent('keydown',{key:'Enter'}))}
  });
  rec.addEventListener('end',()=>micStop());
  rec.addEventListener('error',e=>{micStop()});
  document.addEventListener('keydown',e=>{if(e.key==='v'&&document.activeElement!==inp){on?micStop():micStart()}});
}else{micBtn.style.display='none'}

// --- TTS toggle ---
document.addEventListener('keydown',e=>{
  if(document.activeElement===inp)return;
  if(e.key==='t'){ttsOn=!ttsOn;localStorage.setItem('tts',ttsOn?'on':'off');if(!ttsOn&&synth)synth.cancel()}
});
</script>
</body>
</html>
