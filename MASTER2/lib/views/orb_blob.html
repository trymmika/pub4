<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Blob Orb</title>
<style>
:root {
  --mint: #5af0b6;
  --mint-dim: #2a7a5a;
  --mint-ghost: #153a2d;
  --bg: #050505;
  --text: #c8d0cc;
  --text-2: #5a6a62;
  --error: #f06050;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{background:var(--bg)}
canvas{position:fixed;inset:0;width:100%;height:100%;image-rendering:pixelated;image-rendering:crisp-edges}
@media (prefers-reduced-motion: reduce) {
  * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; }
}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script src="orb_shared.js"></script>
<script>
setupDefaultMessageHandler();

const canvas=document.getElementById('c'),ctx=canvas.getContext('2d',{willReadFrequently:true});
let w,h,scale=2,time=0;
let U,V,U2,V2;

function resize(){
  w=Math.floor(window.innerWidth/scale);
  h=Math.floor(window.innerHeight/scale);
  canvas.width=w;canvas.height=h;
  
  U=new Float32Array(w*h);
  V=new Float32Array(w*h);
  U2=new Float32Array(w*h);
  V2=new Float32Array(w*h);
  
  for(let i=0;i<w*h;i++)U[i]=1.0;
  const cx=Math.floor(w/2),cy=Math.floor(h/2);
  for(let dy=-10;dy<=10;dy++){
    for(let dx=-10;dx<=10;dx++){
      const idx=(cy+dy)*w+(cx+dx);
      if(idx>=0&&idx<w*h)V[idx]=1.0;
    }
  }
}
resize();
window.addEventListener('resize',resize);

function laplacian(arr,x,y){
  const idx=y*w+x;
  const xm=x>0?x-1:w-1,xp=x<w-1?x+1:0;
  const ym=y>0?y-1:h-1,yp=y<h-1?y+1:0;
  return arr[idx]*-1+arr[y*w+xm]*0.2+arr[y*w+xp]*0.2+arr[ym*w+x]*0.2+arr[yp*w+x]*0.2+arr[ym*w+xm]*0.05+arr[ym*w+xp]*0.05+arr[yp*w+xm]*0.05+arr[yp*w+xp]*0.05;
}

function step(){
  const Du=1.0,Dv=0.5;
  const feed=Math.max(0.035,0.025+audioLevel*0.045*STATE_PARAMS[state].reactivity);
  const k=0.062-audioLevel*0.008*STATE_PARAMS[state].reactivity;
  const dt=0.8*STATE_PARAMS[state].speed;
  
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const idx=y*w+x;
      const u=U[idx],v=V[idx];
      const lapU=laplacian(U,x,y);
      const lapV=laplacian(V,x,y);
      const uvv=u*v*v;
      U2[idx]=u+(Du*lapU-uvv+feed*(1-u))*dt;
      V2[idx]=v+(Dv*lapV+uvv-(feed+k)*v)*dt;
    }
  }
  const tempU=U;U=U2;U2=tempU;
  const tempV=V;V=V2;V2=tempV;
}

const reducedMotion=window.matchMedia('(prefers-reduced-motion: reduce)').matches;

function draw(){
  time+=0.016;
  
  ctx.fillStyle='rgba(5,5,5,0.12)';
  ctx.fillRect(0,0,w,h);
  
  if(!reducedMotion){
    for(let i=0;i<2;i++)step();
  }
  
  const img=ctx.getImageData(0,0,w,h);
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const idx=y*w+x;
      const v=V[idx];
      const intensity=Math.pow(v,0.8);
      const color=shade(intensity);
      const rgb=color.match(/\d+/g);
      const pi=idx*4;
      img.data[pi]=parseInt(rgb[0]);
      img.data[pi+1]=parseInt(rgb[1]);
      img.data[pi+2]=parseInt(rgb[2]);
      img.data[pi+3]=255;
    }
  }
  ctx.putImageData(img,0,0);
  requestAnimationFrame(draw);
}

navigator.mediaDevices&&navigator.mediaDevices.getUserMedia({audio:true}).then(function(stream){
  const actx=new AudioContext(),src=actx.createMediaStreamSource(stream),an=actx.createAnalyser();
  an.fftSize=256;src.connect(an);
  const data=new Uint8Array(an.frequencyBinCount);
  (function loop(){
    an.getByteFrequencyData(data);
    let sum=0;for(let i=0;i<50;i++)sum+=data[i];
    audioLevel=sum/50/255;
    requestAnimationFrame(loop);
  })();
}).catch(function(){});

draw();
</script>
</body>
</html>
