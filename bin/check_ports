#!/usr/bin/env ruby
# frozen_string_literal: true

# Port consistency checker for Rails app deployment

require 'yaml'

# Colors
RED = "\e[31m"
GREEN = "\e[32m"
YELLOW = "\e[33m"
CYAN = "\e[36m"
RESET = "\e[0m"

def puts_colored(color, message)
  puts "#{color}#{message}#{RESET}"
end

# Load deployment config
config_file = File.expand_path('../lib/config/deployment.yml', __dir__)

unless File.exist?(config_file)
  puts_colored(RED, "Error: deployment.yml not found")
  exit 1
end

config = YAML.safe_load(File.read(config_file), permitted_classes: [], symbolize_names: true)

puts_colored(CYAN, "=" * 60)
puts_colored(CYAN, "Port Consistency Check".center(60))
puts_colored(CYAN, "=" * 60)
puts

# Check for port conflicts
apps = config[:apps] || []
ports = {}
conflicts = []

apps.each do |app|
  port = app[:port]
  name = app[:name]
  
  if ports[port]
    conflicts << {
      port: port,
      apps: [ports[port], name]
    }
  else
    ports[port] = name
  end
end

# Report conflicts
if conflicts.any?
  puts_colored(RED, "❌ Port conflicts detected:")
  puts
  
  conflicts.each do |conflict|
    puts_colored(RED, "  Port #{conflict[:port]}:")
    conflict[:apps].each do |app|
      puts "    - #{app}"
    end
  end
  
  puts
  exit 1
end

# Check for reserved ports
reserved_ports = [80, 443, 22, 21, 25, 53, 3306, 5432, 6379, 9200]
reserved_conflicts = []

apps.each do |app|
  if reserved_ports.include?(app[:port])
    reserved_conflicts << {
      app: app[:name],
      port: app[:port]
    }
  end
end

if reserved_conflicts.any?
  puts_colored(YELLOW, "⚠ Warning: Apps using reserved ports:")
  puts
  
  reserved_conflicts.each do |conflict|
    puts_colored(YELLOW, "  #{conflict[:app]}: #{conflict[:port]}")
  end
  
  puts
end

# Check port range
out_of_range = []

apps.each do |app|
  port = app[:port]
  if port < 1024 || port > 65535
    out_of_range << {
      app: app[:name],
      port: port
    }
  end
end

if out_of_range.any?
  puts_colored(RED, "❌ Ports out of valid range (1024-65535):")
  puts
  
  out_of_range.each do |item|
    puts_colored(RED, "  #{item[:app]}: #{item[:port]}")
  end
  
  puts
  exit 1
end

# Summary
puts_colored(GREEN, "✓ Port configuration is valid")
puts
puts "Apps configured: #{apps.size}"
puts "Port range: #{ports.keys.min} - #{ports.keys.max}"
puts
puts "Port assignments:"
apps.sort_by { |a| a[:port] }.each do |app|
  puts "  #{app[:port].to_s.ljust(6)} → #{app[:name]}"
end
puts

exit 0
