<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Okai Dilla Machine</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root { 
  --bg: #ffffff; 
  --panel: #f5f5f5; 
  --accent: #e8e8e8; 
  --surface: #eee;
  --blue: #2563eb; 
  --yellow: #eab308; 
  --cyan: #06b6d4;
  --magenta: #d946ef;
  --green: #22c55e;
  --text: #333; 
  --dim: #888; 
  --light: #ccc; 
}
body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 12px; }
.okai { max-width: 960px; margin: 0 auto; }
.display { background: var(--panel); padding: 12px; margin-bottom: 10px; border-radius: 4px; }
.display-top { display: flex; justify-content: space-between; align-items: center; }
.display-title { color: var(--blue); font-weight: 700; font-size: 12px; letter-spacing: 1px; text-transform: uppercase; }
.display-time { font-family: 'JetBrains Mono', monospace; color: var(--text); font-size: 12px; }
.display-status { font-size: 10px; color: var(--dim); margin-top: 6px; display: flex; align-items: center; gap: 6px; }
.led { width: 6px; height: 6px; background: var(--light); border-radius: 50%; transition: all 0.2s; }
.led.on { background: var(--green); }
.transport { display: flex; gap: 6px; margin-top: 8px; }
.transport button { padding: 8px 16px; border: none; background: var(--accent); color: var(--text); font-size: 10px; font-weight: 600; cursor: pointer; border-radius: 3px; transition: all 0.15s; }
.transport button:hover { background: #ddd; }
.transport .play { background: var(--blue); color: #fff; }
.transport .play:hover { background: #1d4ed8; }
.transport .stop { background: var(--accent); color: var(--text); }
.transport #randomize { background: var(--magenta); color: #fff; }
.transport #randomize:hover { background: #c026d3; }
.transport #export { background: var(--yellow); color: #000; }
.transport #export:hover { background: #ca8a04; }
.main { display: grid; grid-template-columns: 160px 1fr 160px; gap: 10px; }
@media (max-width: 700px) { .main { grid-template-columns: 1fr; } }
.panel { background: var(--panel); padding: 10px; margin-bottom: 10px; border-radius: 4px; }
.panel-title { font-size: 9px; font-weight: 600; color: var(--dim); letter-spacing: 1px; margin-bottom: 8px; text-transform: uppercase; }
.pads { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
.pad { aspect-ratio: 1; background: var(--accent); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; font-size: 9px; font-weight: 600; color: var(--text); text-transform: uppercase; border-radius: 3px; transition: all 0.1s; }
.pad:hover { background: #ddd; }
.pad:active { transform: scale(0.95); }
.pad sub { font-size: 7px; color: var(--dim); margin-top: 1px; font-weight: 400; }
.pad.on { outline: 2px solid var(--blue); outline-offset: -2px; }
.pad.dim { opacity: 0.3; }
/* Instrument pads: dimmed when not .on */
#drums-on:not(.on), #bass-on:not(.on), #keys-on:not(.on), #pads-on:not(.on) { opacity: 0.4; }
/* Pad glow animation on trigger */
.pad.triggered { animation: pad-glow 0.15s ease-out; }
@keyframes pad-glow { 
  0% { transform: scale(1.08); outline: 2px solid currentColor; } 
  100% { transform: scale(1); outline: none; } 
}
.pad.blue { background: var(--blue); color: #fff; } .pad.blue sub { color: #fff9; }
.pad.yellow { background: var(--yellow); color: #000; } .pad.yellow sub { color: #0006; }
.pad.cyan { background: var(--cyan); color: #fff; } .pad.cyan sub { color: #fff9; }
.pad.magenta { background: var(--magenta); color: #fff; } .pad.magenta sub { color: #fff9; }
.pad.cyan.on, .pad.magenta.on { outline: 2px solid #fff; outline-offset: -2px; }
.pad.green { background: var(--green); color: #fff; } .pad.green sub { color: #fff9; }
.pad.grey { background: #bbb; color: #333; } .pad.grey sub { color: #666; }
.pad.dark { background: #666; color: #fff; } .pad.dark sub { color: #ccc; }
.slider-row { margin-bottom: 6px; }
.slider-label { display: flex; justify-content: space-between; font-size: 9px; color: var(--dim); margin-bottom: 2px; }
.slider-label span:last-child { color: var(--blue); font-family: monospace; }
input[type=range] { width: 100%; height: 3px; background: var(--light); -webkit-appearance: none; border-radius: 2px; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--blue); border-radius: 50%; cursor: pointer; }
.select-row { margin-bottom: 6px; }
.select-row label { display: block; font-size: 9px; color: var(--dim); margin-bottom: 2px; text-transform: uppercase; }
select { width: 100%; padding: 5px; background: var(--accent); color: var(--text); border: none; font-size: 10px; cursor: pointer; border-radius: 3px; }
select:focus { outline: 2px solid var(--blue); outline-offset: -1px; }
optgroup { background: var(--panel); font-weight: 600; color: var(--blue); }
option { background: #fff; }
.footer { display: flex; gap: 10px; justify-content: center; font-size: 9px; color: var(--dim); margin-top: 10px; }
.footer kbd { background: var(--accent); padding: 2px 4px; color: var(--blue); margin-right: 2px; border-radius: 2px; }
#log { background: var(--panel); padding: 6px; font-family: monospace; font-size: 9px; color: var(--dim); max-height: 40px; overflow-y: auto; margin-top: 6px; border-radius: 3px; }

/* FX Panel Styles */
.fx-section { margin-top: 10px; }
.fx-header { display: flex; justify-content: space-between; align-items: center; background: var(--accent); padding: 8px 10px; cursor: pointer; border-radius: 4px; margin-bottom: 2px; }
.fx-header:hover { background: #ddd; }
.fx-title { font-size: 10px; font-weight: 700; color: var(--blue); text-transform: uppercase; letter-spacing: 1px; }
.fx-toggle { font-size: 10px; color: var(--dim); transition: transform 0.2s; }
.fx-header.open .fx-toggle { transform: rotate(180deg); }
.fx-body { display: none; padding: 10px; background: var(--panel); border-radius: 0 0 4px 4px; }
.fx-body.show { display: block; }
.fx-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 8px; }
.fx-btn { padding: 8px 4px; background: var(--accent); border: none; font-size: 9px; font-weight: 600; cursor: pointer; border-radius: 3px; transition: all 0.15s; text-transform: uppercase; color: var(--text); }
.fx-btn:hover { background: #ddd; }
.fx-btn.active { background: var(--cyan); color: #fff; outline: 2px solid #fff; outline-offset: -2px; }
.fx-btn.active.magenta { background: var(--magenta); }
.fx-btn.active.yellow { background: var(--yellow); color: #000; }
.fx-btn.active.green { background: var(--green); }
/* Mood buttons - Non-musician friendly (KISS) */
.mood-btn { padding: 6px 10px; background: var(--accent); border: none; font-size: 11px; cursor: pointer; border-radius: 4px; transition: all 0.15s; }
.mood-btn:hover { background: #ddd; transform: scale(1.02); }
.mood-btn.active { background: var(--magenta); color: #fff; outline: 2px solid #fff; outline-offset: -2px; }
.fx-row { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
.fx-row label { font-size: 9px; color: var(--dim); min-width: 60px; text-transform: uppercase; }
.fx-row input[type=range] { flex: 1; }
.fx-row .val { font-family: monospace; font-size: 9px; color: var(--blue); min-width: 35px; text-align: right; }
.fx-mode-row { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px; }
.fx-mode { padding: 4px 8px; background: var(--accent); border: none; font-size: 8px; cursor: pointer; border-radius: 2px; color: var(--text); }
.fx-mode.active { background: var(--blue); color: #fff; }
.fx-divider { height: 1px; background: var(--light); margin: 10px 0; }

/* FX Status indicator (H1: Visibility of system status) */
.fx-status { display: inline-flex; gap: 3px; margin-left: 8px; }
.fx-status .fx-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--light); transition: all 0.2s; }
.fx-status .fx-dot.on { background: var(--cyan); }
.fx-status .fx-dot.on.magenta { background: var(--magenta); }

/* Tooltips (H6: Recognition rather than recall) */
[title] { position: relative; }
.fx-btn[title]:hover::after {
  content: attr(title);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: #fff;
  padding: 4px 8px;
  border-radius: 3px;
  font-size: 8px;
  white-space: nowrap;
  z-index: 100;
  margin-bottom: 4px;
}

/* Help text (H10: Help and documentation) */
.fx-help { font-size: 8px; color: var(--dim); margin-bottom: 8px; font-style: italic; }

/* Keyboard focus (WCAG 2.1 AA – keyboard navigability) */
button:focus-visible,
select:focus-visible,
input[type=range]:focus-visible { outline: 2px solid var(--blue); outline-offset: 1px; }
.pad:focus-visible { outline: 3px solid var(--blue); outline-offset: -3px; }

/* Audio level meter */
.meter-wrap { flex: 1; max-width: 60px; height: 6px; background: #ddd; border-radius: 2px; overflow: hidden; margin-left: auto; }
.meter-bar { width: 0%; height: 100%; background: var(--green); transition: width 0.05s; }
</style>
</head>
<body>
<div class="okai">
  <!-- Display -->
  <div class="display">
    <div class="display-top">
      <span class="display-title">Okai Dilla Machine</span>
      <span class="display-time" id="time">00:00:00</span>
    </div>
    <div class="display-status">
      <span class="led" id="led"></span>
      <span id="status">Ready — Press PLAY or Space</span>
      <!-- FX Status dots (H1: Visibility of system status) -->
      <div class="fx-status" title="Active FX">
        <span class="fx-dot" id="fx-dot-arp" title="ARP"></span>
        <span class="fx-dot" id="fx-dot-stutter" title="STUTTER"></span>
        <span class="fx-dot" id="fx-dot-drunk" title="DRUNK"></span>
        <span class="fx-dot" id="fx-dot-filtlfo" title="FILTER"></span>
        <span class="fx-dot" id="fx-dot-tapedelay"></span>
        <span class="fx-dot" id="fx-dot-binaural"></span>
        <span class="fx-dot" id="fx-dot-entrain"></span>
      </div>
      <!-- Audio level meter -->
      <div class="meter-wrap">
        <div class="meter-bar" id="meter"></div>
      </div>
    </div>
    <div class="transport">
      <button class="play" id="play" aria-label="Play">Play</button>
      <button class="stop" id="stop" aria-label="Stop">Stop</button>
      <div style="display:flex; align-items:center; gap:6px; margin-left:12px; background:var(--accent); padding:4px 10px; border-radius:6px;">
        <span style="font-size:11px; font-weight:600; color:var(--blue);">BPM</span>
        <input type="range" id="bpm" min="70" max="110" value="88" aria-label="BPM" style="width:70px;">
        <span id="bpm-val" style="font-size:14px; font-weight:700; color:var(--blue); font-family:monospace; min-width:28px;">88</span>
      </div>
      <div style="display:flex; align-items:center; gap:4px;">
        <span style="font-size:9px; color:var(--dim);">Swing</span>
        <input type="range" id="swing" min="0" max="100" value="30" style="width:50px;">
        <span id="swing-val" style="font-size:10px; color:var(--blue); font-family:monospace; min-width:24px;">30%</span>
      </div>
      <button id="randomize" title="Randomize all patterns (Ctrl+Z to undo)">Rand</button>
      <button id="reset" title="Reset all to defaults">Reset</button>
      <button id="export" title="Export audio (10 sec)">Export</button>
    </div>
  </div>

  <!-- Main 3-column layout -->
  <div class="main">
    <!-- Left: Controls -->
    <div>
      <div class="panel">
        <div class="panel-title">Lo-Fi</div>
        <div class="slider-row">
          <div class="slider-label"><span>Vinyl</span><span id="vinyl-val">25%</span></div>
          <input type="range" id="lofi-vinyl" min="0" max="100" value="25" aria-label="Vinyl noise amount">
        </div>
        <div class="slider-row">
          <div class="slider-label"><span>Saturation</span><span id="sat-val">15%</span></div>
          <input type="range" id="lofi-sat" min="0" max="100" value="15" aria-label="Saturation amount">
        </div>
        <div class="slider-row">
          <div class="slider-label"><span>Rolloff</span><span id="rolloff-val">12kHz</span></div>
          <input type="range" id="lofi-rolloff" min="4000" max="16000" value="12000" aria-label="High-frequency rolloff">
        </div>
        <!-- BitCrusher (SP-404 style) -->
        <div class="slider-row">
          <div class="slider-label"><span>Bits</span><span id="bits-val">16</span></div>
          <input type="range" id="lofi-bits" min="4" max="16" value="16" aria-label="Bit depth" title="BitCrusher - lower = grittier (like MPC60's 12-bit)">
        </div>
        <div class="slider-row">
          <div class="slider-label"><span>Crush</span><span id="crush-val">0%</span></div>
          <input type="range" id="lofi-crush" min="0" max="100" value="0" aria-label="Sample rate crush amount" title="Sample rate reduction - adds aliasing">
        </div>
      </div>
    </div>

    <!-- Center: Pads -->
    <div class="panel">
      <div class="pads">
        <!-- Row 1: Instrument Toggles (drums ON by default, others OFF) -->
        <div class="pad blue on" id="drums-on" tabindex="0" role="button" aria-label="Toggle drums">Drums<sub>808</sub></div>
        <div class="pad grey" id="bass-on" tabindex="0" role="button" aria-label="Toggle bass">Bass<sub>Moog</sub></div>
        <div class="pad yellow" id="keys-on" tabindex="0" role="button" aria-label="Toggle keys">Keys<sub>Rhodes</sub></div>
        <div class="pad dark" id="pads-on" tabindex="0" role="button" aria-label="Toggle pads">Pads<sub>Shimmer</sub></div>
        <!-- Row 2: Primary FX (most used) -->
        <div class="pad cyan" id="pad-drunk" tabindex="0" role="button" aria-label="Toggle Drunk timing">Drunk<sub>Timing</sub></div>
        <div class="pad cyan" id="pad-stutter" tabindex="0" role="button" aria-label="Toggle Stutter">Stutter<sub>Scatter</sub></div>
        <div class="pad cyan" id="pad-arp" tabindex="0" role="button" aria-label="Toggle Arpeggiator">Arp<sub>Pattern</sub></div>
        <div class="pad cyan" id="pad-filtlfo" tabindex="0" role="button" aria-label="Toggle Filter LFO">Filter<sub>LFO</sub></div>
        <!-- Row 3: Atmosphere FX -->
        <div class="pad magenta" id="pad-tapedelay" tabindex="0" role="button" aria-label="Toggle Tape Delay">Tape<sub>Delay</sub></div>
        <div class="pad magenta" id="pad-binaural" tabindex="0" role="button" aria-label="Toggle Binaural">Binaural<sub>Spatial</sub></div>
        <div class="pad magenta" id="pad-lofi" tabindex="0" role="button" aria-label="Toggle Lo-Fi">Lo-Fi+<sub>Vinyl</sub></div>
        <div class="pad magenta" id="pad-entrain" tabindex="0" role="button" aria-label="Toggle Entrainment">Entrain<sub>Brain</sub></div>
        <!-- Row 4: Preset Combos (H4: Consistent - all set full vibe) -->
        <div class="pad green" data-preset="dilla" tabindex="0" role="button" aria-label="Dilla preset" title="Full Dilla vibe: boom-bap + donut chords">Dilla<sub>Preset</sub></div>
        <div class="pad green" data-preset="soul" tabindex="0" role="button" aria-label="Soul preset" title="Neo-soul vibe: shuffle + D'Angelo chords">Soul<sub>Preset</sub></div>
        <div class="pad green" data-preset="techno" tabindex="0" role="button" aria-label="Techno preset" title="Industrial vibe: pounding + chromatic">Techno<sub>Preset</sub></div>
        <div class="pad green" data-preset="detroit" tabindex="0" role="button" aria-label="Detroit preset" title="Detroit house: theo-swing + quartal">Detroit<sub>Preset</sub></div>
      </div>
    </div>

    <!-- Right: Patterns & Mix -->
    <div>
      <div class="panel">
        <div class="panel-title">Patterns</div>
        <div class="select-row">
          <label>Drums</label>
          <select id="drums-pat">
            <optgroup label="J Dilla">
              <option>boom-bap</option><option>shuffle</option><option>sparse</option><option>pocket</option><option>swing</option>
            </optgroup>
            <optgroup label="Industrial Techno">
              <option>industrial</option><option>pounding</option><option>perc</option><option>ansome</option>
            </optgroup>
            <optgroup label="Theo Parrish / Detroit">
              <option>deep-house</option><option>theo-swing</option><option>theo-jazz</option><option>detroit</option>
            </optgroup>
          </select>
        </div>
        <div class="select-row">
          <label>Bass</label>
          <select id="bass-line">
            <option value="groove1">Groove 1</option><option value="groove2">Groove 2</option><option value="pocket">Pocket</option>
            <option value="thump">Thump</option><option value="funk">Funk</option><option value="deep">Deep</option>
          </select>
        </div>
        <div class="select-row">
          <label>Keys</label>
          <select id="key-pat">
            <optgroup label="J Dilla Classics">
              <option value="donut">Donut of Heart</option><option value="fallinlove">Fall in Love</option>
              <option value="getdismoney">Get Dis Money</option><option value="slumvil">Slum Village</option>
              <option value="flowers">Flowers</option><option value="twocanwin">Two Can Win</option>
              <option value="sofartogo">So Far to Go</option><option value="lightworks">Lightworks</option>
              <option value="workinonit">Workinonit</option><option value="life">Life</option>
            </optgroup>
            <optgroup label="Neo-Soul">
              <option value="soul1">Soul</option><option value="dangelo">D'Angelo</option><option value="erykah">Erykah</option>
              <option value="twoFiveOne">ii-V-I Jazz</option><option value="minorTwoFive">Minor ii-V-i</option>
              <option value="descending">Descending Maj7</option><option value="emc2">E=MC2</option>
            </optgroup>
            <optgroup label="Hip-Hop Classics">
              <option value="stakes">Stakes Is High</option><option value="runnin">Runnin'</option>
              <option value="electric">Electric Relaxation</option>
            </optgroup>
            <optgroup label="Textures">
              <option value="gospel">Gospel</option><option value="chromatic">Chromatic</option>
              <option value="quartal">Quartal</option><option value="m9loop">Minor 9 Loop</option>
              <option value="rhodes">Rhodes</option><option value="wurli">Wurli</option>
              <option value="stabs">Stabs</option><option value="cluster">Cluster</option>
              <option value="arp">Arpeggio</option><option value="pad">Pad</option>
            </optgroup>
            <optgroup label="L.A. Beat Scene / Low End Theory">
              <option value="afta1">Afta-1 Sunset</option>
              <option value="aftaSunset">Afta-1 Dorian</option>
              <option value="rasG">Ras G Cosmic</option>
              <option value="daedelus">Daedelus Chromatic</option>
              <option value="tokimonsta">TOKiMONSTA Dreamy</option>
              <option value="flylo">Flying Lotus</option>
              <option value="knxwledge">Knxwledge Wonky</option>
              <option value="chillhop">Chill-Hop</option>
              <option value="nujabes">Nujabes Tribute</option>
              <option value="spiritual">Spiritual Jazz</option>
            </optgroup>
          </select>
        </div>
        <div class="select-row">
          <label>Pads</label>
          <select id="pad-prog">
            <optgroup label="Neo-Soul Signatures">
              <option value="minor11s">Minor 11ths</option>
              <option value="eleven">Stacked 11ths</option>
              <option value="shells">Shell Voicings</option>
              <option value="quartalm">Quartal Minor</option>
            </optgroup>
            <optgroup label="J Dilla Tracks">
              <option value="fallinlove">Fall in Love</option>
              <option value="getdismoney">Get Dis Money</option>
              <option value="fantastic">Fantastic</option>
            </optgroup>
            <optgroup label="Textures">
              <option value="velvet">Velvet</option>
              <option value="haze">Haze</option>
              <option value="dream">Dream</option>
              <option value="cosmic">Cosmic</option>
              <option value="soul">Soul</option>
              <option value="jazz">Jazz</option>
              <option value="neo">Neo</option>
              <option value="lofi">Lo-Fi</option>
              <option value="vinyl">Vinyl</option>
            </optgroup>
          </select>
        </div>
      </div>
      <div class="panel" style="margin-top:12px">
        <div class="panel-title">Mix</div>
        <div class="slider-row">
          <div class="slider-label"><span>Drums</span><span id="drums-vol-val">75%</span></div>
          <input type="range" id="drums-vol" min="0" max="100" value="75">
        </div>
        <div class="slider-row">
          <div class="slider-label"><span>Bass</span><span id="bass-vol-val">70%</span></div>
          <input type="range" id="bass-vol" min="0" max="100" value="70">
        </div>
        <div class="slider-row">
          <div class="slider-label"><span>Keys</span><span id="keys-vol-val">60%</span></div>
          <input type="range" id="keys-vol" min="0" max="100" value="60">
        </div>
        <div class="slider-row">
          <div class="slider-label"><span>Pads</span><span id="pads-vol-val">55%</span></div>
          <input type="range" id="pads-vol" min="0" max="100" value="55">
        </div>
      </div>
      <!-- Non-Musician Friendly: Mood Selector -->
      <div class="panel" style="margin-top:12px">
        <div class="panel-title">Mood</div>
        <div style="display:flex; flex-wrap:wrap; gap:4px;">
          <button class="mood-btn" data-mood="chill">Chill</button>
          <button class="mood-btn" data-mood="hype">Hype</button>
          <button class="mood-btn" data-mood="dreamy">Dreamy</button>
          <button class="mood-btn" data-mood="dark">Dark</button>
          <button class="mood-btn" data-mood="funky">Funky</button>
          <button class="mood-btn" data-mood="jazzy">Jazzy</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FX Section -->
  <div class="fx-section">
    <div class="fx-header" onclick="this.classList.toggle('open'); this.nextElementSibling.classList.toggle('show')">
      <span class="fx-title">Advanced FX</span>
      <span class="fx-toggle">▼</span>
    </div>
    <div class="fx-body">
      <!-- Quick FX Buttons -->
      <div class="fx-grid">
        <button class="fx-btn" id="fx-arp">ARP</button>
        <button class="fx-btn" id="fx-stutter">STUTTER</button>
        <button class="fx-btn" id="fx-drunk">DRUNK</button>
        <button class="fx-btn" id="fx-filtlfo">FILT LFO</button>
        <button class="fx-btn" id="fx-tapedelay">TAPE DLY</button>
        <button class="fx-btn" id="fx-binaural">BINAURAL</button>
        <button class="fx-btn" id="fx-lofi">LO-FI+</button>
        <button class="fx-btn" id="fx-entrain">ENTRAIN</button>
      </div>

      <!-- Arpeggiator Controls -->
      <div id="arp-controls" style="display:none;">
        <div class="panel-title" style="margin-bottom:6px;">Arpeggiator</div>
        <div class="fx-mode-row">
          <button class="fx-mode active" data-arp="up">Up</button>
          <button class="fx-mode" data-arp="down">Down</button>
          <button class="fx-mode" data-arp="upDown">Up-Down</button>
          <button class="fx-mode" data-arp="downUp">Down-Up</button>
          <button class="fx-mode" data-arp="random">Random</button>
          <button class="fx-mode" data-arp="alternateUp">Alt Up</button>
          <button class="fx-mode" data-arp="alternateDown">Alt Down</button>
        </div>
        <div class="fx-row">
          <label>Rate</label>
          <div class="fx-mode-row" style="flex:1;">
            <button class="fx-mode" data-arprate="1n">1</button>
            <button class="fx-mode" data-arprate="2n">1/2</button>
            <button class="fx-mode active" data-arprate="4n">1/4</button>
            <button class="fx-mode" data-arprate="8n">1/8</button>
            <button class="fx-mode" data-arprate="16n">1/16</button>
          </div>
        </div>
        <div class="fx-row">
          <label>Octaves</label>
          <div class="fx-mode-row" style="flex:1;">
            <button class="fx-mode" data-arpoct="1">1</button>
            <button class="fx-mode active" data-arpoct="2">2</button>
            <button class="fx-mode" data-arpoct="3">3</button>
            <button class="fx-mode" data-arpoct="4">4</button>
          </div>
        </div>
        <div class="fx-divider"></div>
      </div>

      <!-- Stutter / Beat Repeat Controls (SP-404 Scatter Style) -->
      <div id="stutter-controls" style="display:none;">
        <div class="panel-title" style="margin-bottom:6px;">Scatter / Stutter <span style="opacity:0.5;font-size:9px;">SP-404</span></div>
        <!-- Scatter Type Selector (H4: Buttons like Arp Rate for consistency) -->
        <div class="fx-row" style="margin-bottom:8px; flex-wrap:wrap;">
          <label style="width:100%; margin-bottom:4px;">Type</label>
          <div class="fx-mode-row" style="flex-wrap:wrap; gap:3px;">
            <button class="fx-mode" data-scatter="1" title="Mild Shuffle - subtle reordering">1</button>
            <button class="fx-mode" data-scatter="2" title="Step Gate - rhythmic gating">2</button>
            <button class="fx-mode active" data-scatter="3" title="Classic Stutter - traditional beat repeat">3</button>
            <button class="fx-mode" data-scatter="4" title="Reverse Hits - backwards glitches">4</button>
            <button class="fx-mode" data-scatter="5" title="Heavy Swap - aggressive reorder">5</button>
            <button class="fx-mode" data-scatter="6" title="Drunk Gate - Dilla-style wobbly gates">6</button>
            <button class="fx-mode" data-scatter="7" title="Pitch Wobble - pitch modulation">7</button>
            <button class="fx-mode" data-scatter="8" title="Granular Chaos - extreme glitch">8</button>
          </div>
        </div>
        <input type="hidden" id="scatter-type" value="3">
        <div class="fx-mode-row">
          <button class="fx-mode active" data-stutter="4n">1/4</button>
          <button class="fx-mode" data-stutter="8n">1/8</button>
          <button class="fx-mode" data-stutter="16n">1/16</button>
          <button class="fx-mode" data-stutter="32n">1/32</button>
          <button class="fx-mode" data-stutter="triplet">Trip</button>
        </div>
        <div class="fx-row">
          <label>Depth</label>
          <input type="range" id="stutter-chance" min="0" max="100" value="30">
          <span class="val" id="stutter-chance-val">30%</span>
        </div>
        <div class="fx-row">
          <label>Decay</label>
          <input type="range" id="stutter-decay" min="0" max="100" value="50">
          <span class="val" id="stutter-decay-val">50%</span>
        </div>
        <div class="fx-row" style="align-items:center;">
          <label style="flex:1;">Humanize</label>
          <input type="checkbox" id="scatter-humanize" checked style="margin:0;">
          <span style="font-size:10px; color:#888; margin-left:4px;">Dilla micro-timing</span>
        </div>
        <div class="fx-divider"></div>
      </div>

      <!-- Drunk / Humanizer Controls -->
      <div id="drunk-controls" style="display:none;">
        <div class="panel-title" style="margin-bottom:6px;">Dilla Drunk Timing</div>
        <div class="fx-row">
          <label>Timing</label>
          <input type="range" id="drunk-time" min="0" max="50" value="20">
          <span class="val" id="drunk-time-val">±20ms</span>
        </div>
        <div class="fx-row">
          <label>Velocity</label>
          <input type="range" id="drunk-vel" min="0" max="50" value="25">
          <span class="val" id="drunk-vel-val">±25%</span>
        </div>
        <div class="fx-row">
          <label>Pitch</label>
          <input type="range" id="drunk-pitch" min="0" max="20" value="0">
          <span class="val" id="drunk-pitch-val">±0¢</span>
        </div>
        <div class="fx-divider"></div>
      </div>

      <!-- Filter LFO Controls -->
      <div id="filtlfo-controls" style="display:none;">
        <div class="panel-title" style="margin-bottom:6px;">Filter LFO (Auto-Wah)</div>
        <div class="fx-mode-row">
          <button class="fx-mode active" data-filttype="lowpass">LP</button>
          <button class="fx-mode" data-filttype="highpass">HP</button>
          <button class="fx-mode" data-filttype="bandpass">BP</button>
        </div>
        <div class="fx-row">
          <label>Rate</label>
          <input type="range" id="filt-rate" min="0.1" max="20" step="0.1" value="2">
          <span class="val" id="filt-rate-val">2 Hz</span>
        </div>
        <div class="fx-row">
          <label>Depth</label>
          <input type="range" id="filt-depth" min="0" max="100" value="50">
          <span class="val" id="filt-depth-val">50%</span>
        </div>
        <div class="fx-row">
          <label>Resonance</label>
          <input type="range" id="filt-q" min="0" max="20" step="0.5" value="4">
          <span class="val" id="filt-q-val">4</span>
        </div>
        <div class="fx-divider"></div>
      </div>

      <!-- Tape Delay Controls -->
      <div id="tapedelay-controls" style="display:none;">
        <div class="panel-title" style="margin-bottom:6px;">Tape Delay (Zan-Zou)</div>
        <div class="fx-row">
          <label>Time</label>
          <input type="range" id="delay-time" min="50" max="1000" value="300">
          <span class="val" id="delay-time-val">300ms</span>
        </div>
        <div class="fx-row">
          <label>Feedback</label>
          <input type="range" id="delay-fb" min="0" max="90" value="40">
          <span class="val" id="delay-fb-val">40%</span>
        </div>
        <div class="fx-row">
          <label>Wet</label>
          <input type="range" id="delay-wet" min="0" max="100" value="30">
          <span class="val" id="delay-wet-val">30%</span>
        </div>
        <div class="fx-row">
          <label>Wobble</label>
          <input type="range" id="delay-wobble" min="0" max="50" value="15">
          <span class="val" id="delay-wobble-val">15%</span>
        </div>
        <div class="fx-divider"></div>
      </div>

      <!-- Binaural / Spatial Controls -->
      <div id="binaural-controls" style="display:none;">
        <div class="panel-title" style="margin-bottom:6px;">Binaural Spatial</div>
        <div class="fx-row">
          <label>Detune</label>
          <input type="range" id="bin-detune" min="0" max="30" value="8">
          <span class="val" id="bin-detune-val">8¢</span>
        </div>
        <div class="fx-row">
          <label>Pan Rate</label>
          <input type="range" id="bin-panrate" min="0.1" max="5" step="0.1" value="0.5">
          <span class="val" id="bin-panrate-val">0.5 Hz</span>
        </div>
        <div class="fx-row">
          <label>Width</label>
          <input type="range" id="bin-width" min="0" max="100" value="80">
          <span class="val" id="bin-width-val">80%</span>
        </div>
        <div class="fx-divider"></div>
      </div>

      <!-- Entrainment Mode -->
      <div id="entrain-controls" style="display:none;">
        <div class="panel-title" style="margin-bottom:6px;">Brainwave Entrainment</div>
        <div class="fx-mode-row">
          <button class="fx-mode" data-brain="delta">Delta 1-4Hz<br><small>Deep Sleep</small></button>
          <button class="fx-mode" data-brain="theta">Theta 4-8Hz<br><small>Creativity</small></button>
          <button class="fx-mode active" data-brain="alpha">Alpha 8-12Hz<br><small>Relaxation</small></button>
          <button class="fx-mode" data-brain="beta">Beta 12-30Hz<br><small>Focus</small></button>
          <button class="fx-mode" data-brain="gamma">Gamma 30+Hz<br><small>Insight</small></button>
        </div>
        <div class="fx-row">
          <label>Intensity</label>
          <input type="range" id="entrain-intensity" min="0" max="100" value="50">
          <span class="val" id="entrain-intensity-val">50%</span>
        </div>
        <div class="fx-row">
          <label>Freq</label>
          <input type="range" id="entrain-freq" min="1" max="40" value="10">
          <span class="val" id="entrain-freq-val">10 Hz</span>
        </div>
        <div class="fx-divider"></div>
      </div>

      <!-- Synth FX -->
      <div id="synthfx-section" style="margin-top:8px;">
        <div class="panel-title" style="margin-bottom:6px;">Synth FX</div>
        <div class="fx-mode-row" style="margin-bottom:6px;">
          <button class="fx-mode" id="sfx-chorus">Chorus</button>
          <button class="fx-mode" id="sfx-phaser">Phaser</button>
          <button class="fx-mode" id="sfx-vibrato">Vibrato</button>
          <button class="fx-mode" id="sfx-reverb">Reverb</button>
        </div>
        <div class="fx-mode-row" style="margin-bottom:6px;">
          <button class="fx-mode" id="sfx-pitch">Pitch</button>
          <button class="fx-mode" id="sfx-widen">Widen</button>
          <button class="fx-mode" id="sfx-cheby">Warm</button>
          <button class="fx-mode" id="sfx-pingpong">PingPong</button>
        </div>
        <div class="fx-mode-row" style="margin-bottom:6px;">
          <button class="fx-mode" id="sfx-stretch">Stretch</button>
          <button class="fx-mode" id="sfx-freqshift">FreqShift</button>
          <button class="fx-mode" id="sfx-autowah">AutoWah</button>
          <button class="fx-mode" id="sfx-tremolo">Tremolo</button>
        </div>
        <div id="synthfx-controls" style="display:none; margin-top:8px;">
          <div class="fx-row">
            <label id="sfx-param-label">Wet</label>
            <input type="range" id="sfx-wet" min="0" max="100" value="50">
            <span class="val" id="sfx-wet-val">50%</span>
          </div>
          <div class="fx-row">
            <label>Depth</label>
            <input type="range" id="sfx-depth" min="0" max="100" value="50">
            <span class="val" id="sfx-depth-val">50%</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Onboarding Modal (First-time users) -->
  <div id="onboard-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fff; max-width:400px; padding:24px; border-radius:8px; text-align:center;">
      <h2 style="color:var(--blue); margin-bottom:12px;">Welcome to Dilla Machine</h2>
      <p style="font-size:13px; color:#555; margin-bottom:16px;">Make beats inspired by J Dilla and neo-soul.</p>
      <div style="text-align:left; font-size:12px; color:#666; margin-bottom:16px;">
        <p><strong>1.</strong> Click <span style="color:var(--blue); font-weight:600;">Drums</span>, <span style="font-weight:600;">Bass</span>, <span style="color:var(--yellow); font-weight:600;">Keys</span>, or <span style="font-weight:600;">Pads</span> to add sounds</p>
        <p style="margin-top:8px;"><strong>2.</strong> Use <span style="color:var(--magenta); font-weight:600;">Mood</span> buttons for quick vibes</p>
        <p style="margin-top:8px;"><strong>3.</strong> Tweak effects and sliders to taste</p>
      </div>
      <button id="onboard-close" style="background:var(--blue); color:#fff; border:none; padding:12px 24px; border-radius:4px; font-weight:600; cursor:pointer;">Start</button>
    </div>
  </div>

  <!-- Help Modal (Press ? to show) -->
  <div id="help-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fff; max-width:400px; max-height:80vh; overflow-y:auto; padding:24px; border-radius:8px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2 style="color:var(--blue);">Shortcuts</h2>
        <button id="help-close" style="background:none; border:none; font-size:20px; cursor:pointer;">×</button>
      </div>
      <div style="font-size:12px; color:#555;">
        <p><kbd>Space</kbd> Play/Stop</p>
        <p><kbd>1-4</kbd> Toggle instruments</p>
        <p><kbd>Q W E R</kbd> Drunk, Stutter, Arp, Filter</p>
        <p><kbd>A S D F</kbd> Tape, Binaural, Lo-Fi, Entrain</p>
        <p><kbd>Z X C V</kbd> Chorus, Phaser, Reverb, Stretch</p>
        <p><kbd>Ctrl+Z</kbd> Undo</p>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <span><kbd>Space</kbd>Play</span>
    <span><kbd>1-4</kbd>Instruments</span>
    <span><kbd>?</kbd>Help</span>
  </div>
  <div id="log" style="display:none;"></div>
</div>
<script>
// Minimal logging - console only
const log = m => console.log('[Dilla]', m);

let Tone, playing = false, ready = false;
let kick, snare, snareBody, ghost, hat, openHat, bass, sub, keys, pads, shimmer;
let kickSeq, snareSeq, ghostSeq, hatSeq, openSeq, bassSeq, keysSeq, padLoop;
let masterBus, saturation, lofiFilter, vinyl, vinylGain, bitCrusher;
let drumsVol, bassVol, keysVol, padsVol;

// Audio monitoring
let analyser;
let triggerCounts = { kick: 0, snare: 0, hat: 0, bass: 0, keys: 0, pads: 0 };
let lastTriggerTime = { kick: 0, snare: 0, hat: 0, bass: 0, keys: 0, pads: 0 };

// ============= FX ENGINE =============
// SP-404 / FlyLo / Psychoacoustic effects
let fxState = {
  arp: false,
  stutter: false,
  drunk: false,
  filtlfo: false,
  tapedelay: false,
  binaural: false,
  lofi: false,
  entrain: false
};

// Synth FX state (for pads/keys)
let synthFXState = {
  chorus: false,
  phaser: false,
  vibrato: false,
  reverb: false,
  pitch: false,
  widen: false,
  cheby: false,
  pingpong: false,
  stretch: false,
  freqshift: false,
  autowah: false,
  tremolo: false
};

// Synth FX nodes
let sfxChorus, sfxPhaser, sfxVibrato, sfxReverb, sfxPitch, sfxWiden, sfxCheby, sfxPingPong;
let sfxStretch, sfxFreqShift, sfxAutoWah, sfxTremolo;

// FX Nodes (created on init)
let fxArpPattern = null;
let fxFilterLFO = null, fxAutoFilter = null;
let fxTapeDelay = null, fxDelayWobble = null;
let fxBinauralPanL = null, fxBinauralPanR = null, fxPanLFO = null;
let fxEntrainLFO = null;

// FX Settings
let fxSettings = {
  arp: { mode: 'up', rate: '8n', octaves: 2 },
  stutter: { division: '8n', chance: 0.3, decay: 0.5, type: 3, humanize: true },
  drunk: { time: 20, velocity: 25, pitch: 0 },  // ms, %, cents
  filtlfo: { type: 'lowpass', rate: 2, depth: 50, q: 4 },
  delay: { time: 300, feedback: 0.4, wet: 0.3, wobble: 0.15 },
  binaural: { detune: 8, panRate: 0.5, width: 0.8 },
  entrain: { mode: 'alpha', freq: 10, intensity: 0.5 },
  crush: { bits: 16, wet: 0 },  // BitCrusher settings
  synthfx: { wet: 0.5, depth: 0.5 }  // Synth FX global settings
};

// Scatter Type behaviors (SP-404 inspired)
const scatterTypes = {
  1: { name: 'Mild Shuffle', swap: 0.1, reverse: 0, gate: 0, pitch: 0 },
  2: { name: 'Step Gate', swap: 0, reverse: 0, gate: 0.5, pitch: 0 },
  3: { name: 'Classic Stutter', swap: 0, reverse: 0, gate: 0, pitch: 0 },
  4: { name: 'Reverse Hits', swap: 0.2, reverse: 0.4, gate: 0, pitch: 0 },
  5: { name: 'Heavy Swap', swap: 0.6, reverse: 0.2, gate: 0.3, pitch: 0 },
  6: { name: 'Drunk Gate', swap: 0.3, reverse: 0, gate: 0.4, pitch: 0, timing: 30 },
  7: { name: 'Pitch Wobble', swap: 0.2, reverse: 0, gate: 0, pitch: 0.5 },
  8: { name: 'Granular Chaos', swap: 0.5, reverse: 0.3, gate: 0.5, pitch: 0.3 }
};

// FX Load calculation
function calculateFXLoad() {
  let load = 0;
  if (fxState.arp) load += 15;
  if (fxState.stutter) load += 20 + (fxSettings.stutter.type > 5 ? 10 : 0);
  if (fxState.drunk) load += 5;
  if (fxState.filtlfo) load += 10;
  if (fxState.tapedelay) load += 15;
  if (fxState.binaural) load += 10;
  if (fxState.lofi) load += 5;
  if (fxState.entrain) load += 10;
  if (fxSettings.crush.wet > 0) load += 10;
  // Synth FX load
  if (synthFXState.chorus) load += 8;
  if (synthFXState.phaser) load += 8;
  if (synthFXState.vibrato) load += 5;
  if (synthFXState.reverb) load += 10;
  if (synthFXState.pitch) load += 12;
  if (synthFXState.widen) load += 5;
  if (synthFXState.cheby) load += 8;
  if (synthFXState.pingpong) load += 10;
  if (synthFXState.stretch) load += 15; // Stretch is CPU heavy
  if (synthFXState.freqshift) load += 8;
  if (synthFXState.autowah) load += 6;
  if (synthFXState.tremolo) load += 4;
  return Math.min(100, load);
}

function updateFXLoadMeter() {
  // Removed - no longer displaying FX load meter
}

// Rate divisions for arp
const arpRates = ['1n', '2n', '4n', '8n', '16n'];

// Humanize function - applies Dilla "drunk" timing
function humanize(time, vel = 0.8) {
  if (!fxState.drunk) return { time, vel };
  const offsetMs = (Math.random() * 2 - 1) * fxSettings.drunk.time;
  const velVar = 1 + (Math.random() * 2 - 1) * (fxSettings.drunk.velocity / 100);
  return { 
    time: time + offsetMs / 1000,
    vel: Math.max(0.1, Math.min(1, vel * velVar))
  };
}

// Stutter check - returns true if note should repeat
function shouldStutter() {
  if (!fxState.stutter) return false;
  return Math.random() < fxSettings.stutter.chance;
}

// Pad glow visual feedback on trigger
function flashPad(padId) {
  const pad = document.getElementById(padId);
  if (!pad) return;
  pad.classList.remove('triggered');
  void pad.offsetWidth; // Force reflow to restart animation
  pad.classList.add('triggered');
}

// Initialize FX chain (called in init())
function initFX() {
  log('Initializing FX engine...');
  
  // Filter LFO (Auto-wah style)
  // Note: 'type' is for LFO shape (sine), filter.type is for filter type (lowpass)
  fxAutoFilter = new Tone.AutoFilter({
    frequency: fxSettings.filtlfo.rate,
    type: 'sine',  // LFO shape
    depth: fxSettings.filtlfo.depth / 100,
    baseFrequency: 200,
    octaves: 4,
    filter: { 
      type: fxSettings.filtlfo.type,  // Filter type: lowpass/highpass/bandpass
      Q: fxSettings.filtlfo.q 
    }
  }).connect(masterBus);
  fxAutoFilter.wet.value = 0; // Start bypassed
  
  // Tape Delay with wobble (SP-404 Zan-Zou style)
  fxTapeDelay = new Tone.FeedbackDelay({
    delayTime: fxSettings.delay.time / 1000,
    feedback: fxSettings.delay.feedback,
    wet: 0 // Start bypassed
  }).connect(masterBus);
  
  // Wobble LFO for tape delay modulation
  fxDelayWobble = new Tone.LFO({
    frequency: 0.3,
    min: -0.01,
    max: 0.01
  });
  
  // Binaural panning (left/right with slight detune for spatial effect)
  fxBinauralPanL = new Tone.Panner(-0.8).connect(masterBus);
  fxBinauralPanR = new Tone.Panner(0.8).connect(masterBus);
  fxPanLFO = new Tone.LFO({
    frequency: fxSettings.binaural.panRate,
    min: -1,
    max: 1
  });
  
  // Entrainment LFO (brainwave sync)
  fxEntrainLFO = new Tone.LFO({
    frequency: fxSettings.entrain.freq,
    min: 0.7,
    max: 1.0
  });
  
  log('FX engine ready: Filter, Delay, Binaural, Entrainment');
  updateFXLoadMeter();
}

// Initialize Synth FX chain (for pads/keys)
async function initSynthFX() {
  // These effects can be toggled on/off for pads/keys
  // All start with wet=0 (bypassed)
  const isFileProtocol = location.protocol === 'file:';
  
  // Non-worklet effects (always work)
  sfxChorus = new Tone.Chorus({ frequency: 1.5, delayTime: 3.5, depth: 0.7, wet: 0 }).start().connect(masterBus);
  sfxPhaser = new Tone.Phaser({ frequency: 0.5, octaves: 3, baseFrequency: 350, wet: 0 }).connect(masterBus);
  sfxVibrato = new Tone.Vibrato({ frequency: 5, depth: 0.1, wet: 0 }).connect(masterBus);
  sfxWiden = new Tone.StereoWidener({ width: 0.5, wet: 0 }).connect(masterBus);
  sfxCheby = new Tone.Chebyshev({ order: 50, wet: 0 }).connect(masterBus); // Warm harmonic distortion
  sfxPingPong = new Tone.PingPongDelay({ delayTime: '8n', feedback: 0.4, wet: 0 }).connect(masterBus);
  sfxAutoWah = new Tone.AutoWah({ baseFrequency: 100, octaves: 6, sensitivity: 0, wet: 0 }).connect(masterBus);
  sfxTremolo = new Tone.Tremolo({ frequency: 4, depth: 0.8, wet: 0 }).start().connect(masterBus);
  
  // Worklet-based effects - skip entirely on file:// to avoid console errors
  if (!isFileProtocol) {
    try {
      sfxReverb = new Tone.Reverb({ decay: 3, wet: 0 });
      await sfxReverb.generate();
      sfxReverb.connect(masterBus);
    } catch (e) {
      sfxReverb = null;
    }
    
    try {
      sfxPitch = new Tone.PitchShift({ pitch: 0, wet: 0 }).connect(masterBus);
    } catch (e) {
      sfxPitch = null;
    }
    
    try {
      sfxFreqShift = new Tone.FrequencyShifter({ frequency: 0, wet: 0 }).connect(masterBus);
    } catch (e) {
      sfxFreqShift = null;
    }
    
    // Stretch: Paulstretch-inspired using PitchShift + long reverb + feedback
    sfxStretch = new Tone.FeedbackDelay({ delayTime: 0.1, feedback: 0.85, wet: 0 });
    try {
      const stretchReverb = new Tone.Reverb({ decay: 8, wet: 0.9 });
      await stretchReverb.generate();
      stretchReverb.connect(masterBus);
      const stretchPitch = new Tone.PitchShift({ pitch: -12, wet: 0.7 }).connect(stretchReverb);
      sfxStretch.connect(stretchPitch);
    } catch (e) {
      sfxStretch.connect(masterBus);
    }
  } else {
    // file:// mode - simple delay-only stretch, no reverb/pitch effects
    sfxReverb = null;
    sfxPitch = null;
    sfxFreqShift = null;
    sfxStretch = new Tone.FeedbackDelay({ delayTime: 0.1, feedback: 0.85, wet: 0 }).connect(masterBus);
    log('Note: Reverb/Pitch/FreqShift disabled (run via server for full effects)');
  }
  
  log('Synth FX ready');
}

// Toggle Synth FX
function toggleSynthFX(name) {
  synthFXState[name] = !synthFXState[name];
  const btn = document.getElementById('sfx-' + name);
  const controlsEl = document.getElementById('synthfx-controls');
  
  const effectMap = {
    chorus: sfxChorus,
    phaser: sfxPhaser,
    vibrato: sfxVibrato,
    reverb: sfxReverb,
    pitch: sfxPitch,
    widen: sfxWiden,
    cheby: sfxCheby,
    pingpong: sfxPingPong,
    stretch: sfxStretch,
    freqshift: sfxFreqShift,
    autowah: sfxAutoWah,
    tremolo: sfxTremolo
  };
  
  const effect = effectMap[name];
  if (!effect) return;
  
  if (synthFXState[name]) {
    btn.classList.add('active');
    effect.wet.value = fxSettings.synthfx.wet;
    if (controlsEl) controlsEl.style.display = 'block';
  } else {
    btn.classList.remove('active');
    effect.wet.value = 0;
    // Hide controls if no synth FX active
    const anyActive = Object.values(synthFXState).some(v => v);
    if (!anyActive && controlsEl) controlsEl.style.display = 'none';
  }
  
  updateFXLoadMeter();
  log('Synth FX ' + name + ': ' + (synthFXState[name] ? 'ON' : 'OFF'));
}

// Toggle FX on/off
function toggleFX(fxName) {
  fxState[fxName] = !fxState[fxName];
  const btn = document.getElementById('fx-' + fxName);
  const controls = document.getElementById(fxName + '-controls');
  
  if (fxState[fxName]) {
    btn.classList.add('active');
    if (controls) controls.style.display = 'block';
    activateFX(fxName);
  } else {
    btn.classList.remove('active');
    if (controls) controls.style.display = 'none';
    deactivateFX(fxName);
  }
  
  // Update FX load meter
  updateFXLoadMeter();
  
  // Update status dot in header (H1: Visibility of system status)
  const dot = document.getElementById('fx-dot-' + fxName);
  if (dot) {
    dot.classList.toggle('on', fxState[fxName]);
  }
  
  // Sync pad in main grid (H4: Consistency)
  const pad = document.getElementById('pad-' + fxName);
  if (pad) {
    pad.classList.toggle('on', fxState[fxName]);
  }
  
  log('FX ' + fxName + ': ' + (fxState[fxName] ? 'ON' : 'OFF'));
}

// Activate specific FX
function activateFX(fxName) {
  switch(fxName) {
    case 'arp':
      // Arpeggiator handles notes differently - processed in sequence callbacks
      break;
    case 'filtlfo':
      if (fxAutoFilter) {
        fxAutoFilter.wet.value = 1;
        fxAutoFilter.start();
      }
      break;
    case 'tapedelay':
      if (fxTapeDelay) {
        fxTapeDelay.wet.value = fxSettings.delay.wet;
        if (fxDelayWobble) fxDelayWobble.start();
      }
      break;
    case 'binaural':
      if (fxPanLFO) fxPanLFO.start();
      break;
    case 'entrain':
      if (fxEntrainLFO) fxEntrainLFO.start();
      break;
  }
}

// Deactivate specific FX
function deactivateFX(fxName) {
  switch(fxName) {
    case 'filtlfo':
      if (fxAutoFilter) {
        fxAutoFilter.wet.value = 0;
        fxAutoFilter.stop();
      }
      break;
    case 'tapedelay':
      if (fxTapeDelay) fxTapeDelay.wet.value = 0;
      if (fxDelayWobble) fxDelayWobble.stop();
      break;
    case 'binaural':
      if (fxPanLFO) fxPanLFO.stop();
      break;
    case 'entrain':
      if (fxEntrainLFO) fxEntrainLFO.stop();
      break;
  }
}

// Get arpeggiated notes from chord
function arpeggiate(chord, mode, octaves) {
  if (!Array.isArray(chord)) return [chord];
  
  let notes = [...chord];
  
  // Add octaves
  if (octaves > 1) {
    for (let oct = 1; oct < octaves; oct++) {
      chord.forEach(note => {
        const m = note.match(/([A-G][#b]?)(\d)/);
        if (m) notes.push(m[1] + (parseInt(m[2]) + oct));
      });
    }
  }
  
  // Apply pattern
  switch(mode) {
    case 'down': return notes.reverse();
    case 'upDown': return [...notes, ...notes.slice(1, -1).reverse()];
    case 'downUp': return [...notes.reverse(), ...notes.slice(1, -1).reverse()];
    case 'random': return notes.sort(() => Math.random() - 0.5);
    case 'alternateUp': return notes.filter((_, i) => i % 2 === 0).concat(notes.filter((_, i) => i % 2 === 1));
    case 'alternateDown': return notes.filter((_, i) => i % 2 === 1).concat(notes.filter((_, i) => i % 2 === 0)).reverse();
    default: return notes; // 'up'
  }
}
// ============= END FX ENGINE =============

const drumOn = () => document.getElementById('drums-on').classList.contains('on');
const bassOn = () => document.getElementById('bass-on').classList.contains('on');
const keysOn = () => document.getElementById('keys-on').classList.contains('on');
const padsOn = () => document.getElementById('pads-on').classList.contains('on');

// Drum patterns - J Dilla style + Industrial Techno + Theo Parrish House
const patterns = {
  'boom-bap': { 
    kick: [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0.5,0], 
    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], 
    ghost: [0,0,0.3,0,0,0,0.2,0,0,0,0.3,0,0,0,0.2,0],
    hat: [1,0.5,1,0.5,1,0.5,1,0.5,1,0.5,1,0.5,1,0.5,1,0.5],
    open: [0,0,0,0,0,0,0,0.6,0,0,0,0,0,0,0,0.5]
  },
  'shuffle': { 
    kick: [1,0,0,0,0,0.5,0,0,1,0,0,0.3,0,0,0,0], 
    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0.3], 
    ghost: [0,0.2,0,0.2,0,0,0.3,0,0,0.2,0,0,0,0.2,0,0],
    hat: [0.9,0.3,0.6,0.3,0.8,0.3,0.5,0.3,0.9,0.3,0.6,0.3,0.8,0.3,0.5,0.3],
    open: [0,0,0,0,0,0,0.5,0,0,0,0,0,0,0,0.6,0]
  },
  'sparse': { 
    kick: [1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0], 
    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], 
    ghost: [0,0,0,0.2,0,0,0,0.15,0,0,0,0.2,0,0,0,0.15],
    hat: [0.6,0,0.4,0,0.7,0,0.4,0,0.6,0,0.4,0,0.7,0,0.4,0],
    open: [0,0,0,0,0,0,0,0.4,0,0,0,0,0,0,0,0]
  },
  'pocket': { 
    kick: [1,0,0,0,0,0,0.6,0,0,0,1,0,0,0,0,0], 
    snare: [0,0,0,0,1,0,0,0.3,0,0,0,0,1,0,0,0], 
    ghost: [0,0,0.25,0,0,0.2,0,0,0,0,0.25,0,0,0.2,0,0.15],
    hat: [0.8,0.4,0.8,0.4,0.8,0.4,0.8,0.4,0.8,0.4,0.8,0.4,0.8,0.4,0.8,0.4],
    open: [0,0,0,0,0,0,0,0.5,0,0,0,0,0,0,0,0.5]
  },
  'swing': { 
    kick: [1,0,0,0,0,0,0,0,0.7,0,0,0,0,0,0,0.5], 
    snare: [0,0,0,0,1,0,0,0,0,0,0,0.4,1,0,0,0], 
    ghost: [0,0,0.3,0,0,0,0.2,0.15,0,0,0.3,0,0,0,0.2,0],
    hat: [1,0,0.6,0,1,0,0.5,0.3,1,0,0.6,0,1,0,0.5,0.3],
    open: [0,0,0,0,0,0,0.6,0,0,0,0,0,0,0,0.6,0]
  },
  // ========== INDUSTRIAL TECHNO (Perc, Ansome, Paula Temple) ==========
  // Research: Attack Magazine "Beat Dissected" - 4-on-floor + syncopated extra kicks
  // Key: Kicks on 1,5,9,13 + extra on 7,10,15 for aggression. Offbeat hats on 3,7,11,15.
  'industrial': { 
    // Classic industrial: 4-on-floor, clap on 5 & 13, offbeat hi-hats, metallic ghost
    kick: [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], 
    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], 
    ghost: [0,0,0.6,0,0,0,0.6,0,0,0,0.6,0,0,0,0.6,0], // Metallic perc on offbeats
    hat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0], // Offbeat hats (classic)
    open: [0,0,0,0,0,0,0,0.8,0,0,0,0,0,0,0,0.8]
  },
  'pounding': { 
    // Paula Temple style: double-kick for intensity, sparse hats
    // Research: Extra kicks just before/after main beats create "pummeling" feel
    kick: [1,0,0.7,0,1,0,0.6,0,1,0,0.7,0,1,0,0.6,0], // Doubled kicks
    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], 
    ghost: [0,0.4,0,0.4,0,0.4,0,0.4,0,0.4,0,0.4,0,0.4,0,0.4], // Constant metallic pulse
    hat: [0,0,0.8,0,0,0,0.8,0,0,0,0.8,0,0,0,0.8,0], // Sparse offbeat
    open: [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0] // One open for tension
  },
  'perc': { 
    // Perc style: Broken industrial with syncopated kicks on 7, 10, 15
    // Research: "Accent 'off' steps with ghost kicks for industrial groove"
    kick: [1,0,0,0,1,0,0.7,0,1,0.5,0,0,1,0,0.6,0], // Syncopated: extra on 7,10,15
    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], 
    ghost: [0.5,0,0.5,0,0,0,0.5,0,0.5,0,0.5,0,0,0,0.5,0], // Relentless metallic
    hat: [1,0.5,1,0.5,1,0.5,1,0.5,1,0.5,1,0.5,1,0.5,1,0.5], // Machine-gun 16ths
    open: [0,0,0,0,0,0,0.9,0,0,0,0,0,0,0.9,0,0]
  },
  'ansome': { 
    // Ansome style: Stuttering kick with heavy syncopation
    // Research: Syncopated fills on steps 3, 7, 10, 15 create chaos
    kick: [1,0,0.5,0,1,0,0.6,0,1,0.5,0,0,0.7,0,0.8,0], // Stuttering pattern
    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0.4], // Snare fill at end
    ghost: [0,0.6,0,0.4,0,0.6,0,0.4,0,0.6,0,0.4,0,0.6,0,0.4], // Constant noise
    hat: [1,0.7,1,0.7,1,0.7,1,0.7,1,0.7,1,0.7,1,0.7,1,0.7], // Crushed 16ths
    open: [0,0,0,0,0,0,0,0.9,0,0,0,0,0,0,0,0.9]
  },
  // ========== THEO PARRISH DETROIT HOUSE ==========
  // Research: Ableton Forum + beatproduction.net
  // Key: Ghost notes everywhere, nudged off-grid, clap on 3 (step 9), skip some downbeats
  'deep-house': { 
    // Classic deep house: 4-on-floor, clap on beat 3 only, pure offbeat hats
    kick: [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], 
    snare: [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], // Clap only on 3
    ghost: [0,0.15,0,0.1,0,0.15,0,0.1,0,0.15,0,0.1,0,0.15,0,0.1], // Soft ghost taps
    hat: [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0], // Pure offbeat
    open: [0,0,0,0,0,0,0,0.5,0,0,0,0,0,0,0,0.5]
  },
  'theo-swing': { 
    // Theo Parrish signature: ghost kicks, skip some 1s, swung feel
    // Research: "Deliberately omit kick on strong downbeats, use softer ghost kick"
    kick: [0.9,0,0,0.15,0.2,0,0.4,0,1,0,0,0.15,0.2,0,0.35,0], // Ghost kicks on 4,5,7,12,13,15
    snare: [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0.15,0], // Clap on 3 + ghost
    ghost: [0,0.12,0.08,0.12,0.08,0.12,0.08,0.12,0,0.12,0.08,0.12,0.08,0.12,0.08,0.12], // Dense ghosts
    hat: [0.4,0.25,0.9,0.3,0.4,0.25,0.85,0.35,0.4,0.25,0.9,0.3,0.4,0.25,0.85,0.35], // Varied swing
    open: [0,0,0,0,0,0,0,0.4,0,0,0,0,0,0,0,0.4]
  },
  'detroit': { 
    // Classic Detroit 909: punchy kick, clap on 2 & 4, offbeat hats with accents
    kick: [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], 
    snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], // 2 & 4
    ghost: [0,0,0.2,0,0,0,0.2,0,0,0,0.2,0,0,0,0.2,0], // Light ghost on offbeat
    hat: [0,0,0.9,0,0,0,0.9,0,0,0,0.9,0,0,0,0.9,0.4], // Offbeat + pickup
    open: [0,0,0,0,0,0,0.6,0,0,0,0,0,0,0,0.6,0]
  },
  'theo-jazz': {
    // Theo Parrish jazz-influenced: irregular kicks from funk drumming
    // Research: "Borrows from jazz/funk drummers like Clyde Stubblefield"
    kick: [1,0,0,0,0,0,0.5,0,0.3,0,0.7,0,0.2,0,0.4,0], // Irregular, almost random
    snare: [0,0,0,0,0,0,0,0,1,0,0,0.2,0,0,0.15,0], // Clap on 3 + ghost fills
    ghost: [0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1], // Constant soft taps
    hat: [0.6,0.2,0.8,0.25,0.5,0.2,0.75,0.3,0.6,0.2,0.8,0.25,0.5,0.2,0.75,0.3], // Jazz ride feel
    open: [0,0,0,0,0,0,0,0.35,0,0,0,0,0,0,0,0]
  }
};

// 15 Bass lines
const bassLines = {
  groove1: ['E1',null,'E1','G1','A1',null,'E1',null,'D1',null,'E1','G1','A1',null,'G1',null],
  groove2: ['C1',null,'C2','Bb1','Ab1',null,'G1',null,'F1','Ab1',null,'Bb1','C2',null,null,'G1'],
  pocket: ['Db1',null,null,'Db1','Ab1',null,'Gb1',null,'Eb1',null,'Db1','Eb1','Gb1',null,null,'Ab1'],
  thump: ['A1',null,'A1',null,'G1','A1',null,'E1','D1',null,null,'E1','F#1',null,'G1','A1'],
  slide: ['G1',null,'G1','A1','Bb1',null,'C2',null,'D2',null,'C2','Bb1','A1',null,'G1',null],
  funk: ['E1','E1',null,'E1',null,'G1','A1',null,'E1',null,'D1',null,'E1','G1',null,'A1'],
  mellow: ['D1',null,null,'D1',null,null,'F1',null,'G1',null,null,'A1',null,null,'G1',null],
  bounce: ['C1',null,'C1',null,'Eb1',null,'F1','G1','Ab1',null,'G1',null,'F1',null,'Eb1',null],
  deep: ['F1',null,null,null,'Ab1',null,null,null,'Bb1',null,null,null,'C2',null,'Bb1',null],
  walk: ['G1',null,'A1',null,'B1',null,'C2',null,'D2',null,'E2',null,'D2',null,'C2','B1'],
  pulse: ['A1','A1','A1','A1','G1','G1','G1','G1','F1','F1','F1','F1','E1','E1','E1','E1'],
  synco: ['E1',null,null,'E1',null,'G1',null,'A1',null,null,'B1',null,'A1',null,'G1',null],
  octave: ['E1',null,'E2',null,'E1',null,'E2',null,'D1',null,'D2',null,'D1',null,'D2',null],
  minimal: ['C1',null,null,null,null,null,null,null,'G1',null,null,null,null,null,null,null],
  chromatic: ['E1',null,'F1',null,'F#1',null,'G1',null,'G#1',null,'A1',null,'Bb1',null,'B1',null]
};

// 15 Key patterns - J Dilla style neo-soul chords (proper extended voicings)
const keyPatterns = {
  // Classic Dilla - stepwise bass, floating maj7/m7 motion
  soul1: [['Eb4','G4','Bb4','D5'],null,null,null,['Db4','F4','Ab4','C5'],null,null,null,['C4','E4','G4','B4'],null,null,null,['Bb3','D4','F4','A4'],null,null,null],
  // Gospel - rich extensions with 9ths
  gospel: [['Db4','F4','Ab4','C5','Eb5'],null,null,null,['Bb3','Db4','F4','Ab4'],null,null,null,['Ab3','C4','Eb4','G4'],null,null,null,['Gb3','Bb3','Db4','F4'],null,null,null],
  // "Time: Donut of Heart" - Emaj7 → D#m7 → G#m7 → C#m7 (Jackson 5 sample)
  donut: [['E4','G#4','B4','D#5'],null,null,null,['D#4','F#4','A#4','C#5'],null,null,null,['G#3','B3','D#4','F#4'],null,null,null,['C#4','E4','G#4','B4'],null,null,null],
  // Circular minor 9ths (no resolution) - jazz cycle
  m9loop: [['D4','F4','A4','C5','E5'],null,null,null,['G4','Bb4','D5','F5','A5'],null,null,null,['C4','Eb4','G4','Bb4','D5'],null,null,null,['F4','Ab4','C5','Eb5','G5'],null,null,null],
  // Chromatic passing - smooth voice leading (Dilla signature)
  chromatic: [['C4','E4','G4','B4'],null,['C#4','F4','G#4','C5'],null,['D4','F#4','A4','C#5'],null,['Eb4','G4','Bb4','D5'],null,['E4','G#4','B4','D#5'],null,null,null,null,null,null,null],
  // Quartal voicings (stacked 4ths) - Madlib/FlyLo style
  quartal: [['C4','F4','Bb4','Eb5'],null,null,null,['G3','C4','F4','Bb4'],null,null,null,['D4','G4','C5','F5'],null,null,null,['A3','D4','G4','C5'],null,null,null],
  // D'Angelo "Untitled" style - Dm9 → G13 → Cmaj9 → Am11
  dangelo: [['D4','F4','A4','C5','E5'],null,null,null,['G3','B3','D4','F4','A4','E5'],null,null,null,['C4','E4','G4','B4','D5'],null,null,null,['A3','C4','E4','G4','B4','D5'],null,null,null],
  // Erykah Badu "On & On" style - floating F#m9 dorian
  erykah: [['F#3','A3','C#4','E4','G#4'],null,null,null,['B3','D4','F#4','A4','C#5'],null,null,null,['E3','G#3','B3','D#4','F#4'],null,null,null,['A3','C#4','E4','G#4','B4'],null,null,null],
  // "Fall in Love" - Ebmaj7 → Gm7 → Abmaj7 → Fm7 (Gap Mangione sample)
  slumvil: [['Eb4','G4','Bb4','D5'],null,null,null,['G3','Bb3','D4','F4'],null,null,null,['Ab3','C4','Eb4','G4'],null,null,null,['F3','Ab3','C4','Eb4'],null,null,null],
  // "Fall in Love" - with lush 9th extensions
  fallinlove: [['Eb4','G4','Bb4','D5','F5'],null,null,null,['G3','Bb3','D4','F4','A4'],null,null,null,['Ab3','C4','Eb4','G4','Bb4'],null,null,null,['F3','Ab3','C4','Eb4','G4'],null,null,null],
  // "Get Dis Money" - C#m → G#m → A#7 → C# (Herbie Hancock sample)
  getdismoney: [['C#4','E4','G#4','B4'],null,null,null,['G#3','B3','D#4','F#4'],null,null,null,['A#3','C#4','E4','G#4'],null,null,null,['C#4','F4','G#4','B4'],null,null,null],
  // "Players" - dreamy Fmaj7 → Em7 → Dm7 → Cmaj7 (Clair sample)
  players: [['F4','A4','C5','E5'],null,null,null,['E4','G4','B4','D5'],null,null,null,['D4','F4','A4','C5'],null,null,null,['C4','E4','G4','B4'],null,null,null],
  // "Lightworks" - B → C#7 vamp (Raymond Scott sample)
  lightworks: [['B3','D#4','F#4','A#4'],null,['C#4','E#4','G#4','B4'],null,['B3','D#4','F#4','A#4'],null,['C#4','E#4','G#4','B4'],null,['B3','D#4','F#4','A#4'],null,null,null,null,null,null,null],
  // "Workinonit" - Gmaj7 → Am7 → F#m7 stabs (10cc sample)
  workinonit: [['G4','B4','D5','F#5'],null,null,['A3','C4','E4','G4'],null,null,['F#3','A3','C#4','E4'],null,null,null,['G4','B4','D5'],null,null,null,null,null],
  // "So Far to Go" - F#maj7 → G#m7 → C#7sus4 → Bmaj7 (Isley Brothers sample)
  sofartogo: [['F#4','A#4','C#5','E#5'],null,null,null,['G#3','B3','D#4','F#4'],null,null,null,['C#4','F#4','G#4','B4'],null,null,null,['B3','D#4','F#4','A#4'],null,null,null],
  // "Flowers" - Dm floating, rich minor extensions
  flowers: [['D4','F4','A4','C5','E5'],null,null,null,['G3','Bb3','D4','F4','A4'],null,null,null,['A3','C4','E4','G4','B4'],null,null,null,['Bb3','D4','F4','A4','C5'],null,null,null],
  // "Two Can Win" - Gm → Bbmaj7 → Dm7 (The Sylvers sample)
  twocanwin: [['G3','Bb3','D4','F4'],null,null,null,['Bb3','D4','F4','A4'],null,null,null,['Bb3','D4','F4','A4'],null,null,null,['D4','F4','A4','C5'],null,null,null],
  // ii-V-I jazz - Dm9 → G13 → Cmaj9 (fundamental neo-soul)
  twoFiveOne: [['D4','F4','A4','C5','E5'],null,null,null,['G3','B3','D4','F4','E4'],null,null,null,['C4','E4','G4','B4','D5'],null,null,null,['C4','E4','G4','B4','D5'],null,null,null],
  // Minor ii-V-i - Dm7b5 → G7alt → Cm9
  minorTwoFive: [['D4','F4','Ab4','C5'],null,null,null,['G3','B3','Db4','F4','Ab4'],null,null,null,['C4','Eb4','G4','Bb4','D5'],null,null,null,['C4','Eb4','G4','Bb4','D5'],null,null,null],
  // "Life" - Fm9 → Bbm9 rich minor 9th movement
  life: [['F4','Ab4','C5','Eb5','G5'],null,null,null,['Bb3','Db4','F4','Ab4','C5'],null,null,null,['F4','Ab4','C5','Eb5','G5'],null,null,null,['C4','Eb4','G4','Bb4','D5'],null,null,null],
  // Descending maj7 line (Roy Ayers influence)
  descending: [['Eb4','G4','Bb4','D5'],null,null,null,['Db4','F4','Ab4','C5'],null,null,null,['C4','E4','G4','B4'],null,null,null,['Bb3','D4','F4','A4'],null,null,null],
  // "E=MC2" - Marvin Gaye influence, Bbm floating
  emc2: [['Bb3','Db4','F4','Ab4'],null,null,null,['Eb4','Gb4','Bb4','Db5'],null,null,null,['Ab3','C4','Eb4','G4'],null,null,null,['Db4','F4','Ab4','C5'],null,null,null],
  // "Stakes Is High" De La Soul - Dmaj7 → Cmaj7 → Bm7 → Am7
  stakes: [['D4','F#4','A4','C#5'],null,null,null,['C4','E4','G4','B4'],null,null,null,['B3','D4','F#4','A4'],null,null,null,['A3','C4','E4','G4'],null,null,null],
  // "Runnin'" Pharcyde - Eb minor floating
  runnin: [['Eb4','Gb4','Bb4','Db5'],null,null,null,['Ab3','C4','Eb4','G4'],null,null,null,['Db4','F4','Ab4','C5'],null,null,null,['Gb3','Bb3','Db4','F4'],null,null,null],
  // "Electric Relaxation" ATCQ - Am7 → G7 → Fmaj7 → Em7
  electric: [['A3','C4','E4','G4'],null,null,null,['G3','B3','D4','F4'],null,null,null,['F3','A3','C4','E4'],null,null,null,['E3','G3','B3','D4'],null,null,null],
  // Rhodes - descending line with tremolo feel
  rhodes: [['Eb4','G4','Bb4'],null,['Db4','F4','Ab4'],null,['C4','Eb4','G4'],null,['Bb3','D4','F4'],null,['Ab3','C4','Eb4'],null,['G3','Bb3','D4'],null,['F3','Ab3','C4'],null,null,null],
  // Wurli stabs - punchy electric piano
  wurli: [['F4','A4','C5'],['F4','A4','C5'],null,null,['Bb4','D5','F5'],null,null,null,['Eb4','G4','Bb4'],['Eb4','G4','Bb4'],null,null,['Ab4','C5','Eb5'],null,null,null],
  // Sparse maj7 stabs - minimal
  stabs: [['C4','E4','G4','B4'],null,null,null,null,null,['F4','A4','C5','E5'],null,null,null,null,null,['G4','B4','D5','F#5'],null,null,null],
  // Long sustained pad
  pad: [['D4','F#4','A4','C#5'],null,null,null,null,null,null,null,['G4','B4','D5','F#5'],null,null,null,null,null,null,null],
  // Arpeggiated pattern
  arp: [['E4'],['G4'],['B4'],['E5'],['B4'],['G4'],['E4'],['D4'],['F#4'],['A4'],['D5'],['A4'],['F#4'],['D4'],['C#4'],['E4']],
  // Cluster voicings (tight, dense) - modern neo-soul
  cluster: [['C4','D4','E4','G4'],null,null,null,['F4','G4','A4','C5'],null,null,null,['Bb3','C4','D4','F4'],null,null,null,['Eb4','F4','G4','Bb4'],null,null,null],
  
  // === L.A. BEAT SCENE / LOW END THEORY ===
  // Afta-1 "Sunset" style - Bm9 → E13 → Amaj7 → G13 (dreamy jazz-hop)
  afta1: [['B3','D4','F#4','A4','C#5'],null,null,null,['E3','G#3','B3','D4','F#4'],null,null,null,['A3','C#4','E4','G#4'],null,null,null,['G3','B3','D4','F4','E4'],null,null,null],
  // Afta-1 dorian float - F#m9 suspended (unresolved tension)
  aftaSunset: [['F#3','A3','C#4','E4','G#4'],null,null,null,['B3','D4','F#4','A4','C#5'],null,null,null,['E3','G#3','B3','D#4','F#4'],null,null,null,['A3','C#4','E4','G#4','B4'],null,null,null],
  // Ras G cosmic jazz - modal, hypnotic (Sun Ra influence)
  rasG: [['Db4','F4','Ab4','C5'],null,null,null,['Db4','F4','Ab4','C5'],null,null,null,['Eb4','Gb4','Bb4','Db5'],null,null,null,['Db4','F4','Ab4','C5'],null,null,null],
  // Daedelus - chromatic surprise, ambiguous tonality
  daedelus: [['C4','E4','G4','B4'],null,['Db4','F4','Ab4','C5'],null,['D4','F#4','A4','C#5'],null,['Eb4','G4','Bb4','D5'],null,['E4','G#4','B4','D#5'],null,null,null,null,null,null,null],
  // TOKiMONSTA - dreamy future bass, lush synths
  tokimonsta: [['Gb3','Bb3','Db4','F4','Ab4'],null,null,null,['Eb3','Gb3','Bb3','Db4','F4'],null,null,null,['Ab3','C4','Eb4','G4','Bb4'],null,null,null,['Db3','F3','Ab3','C4','Eb4'],null,null,null],
  // FlyLo cosmic - suspended 4ths, quartal movement
  flylo: [['C4','F4','Bb4','Eb5'],null,null,['G3','C4','F4','Bb4'],null,null,['D4','G4','C5','F5'],null,null,['A3','D4','G4','C5'],null,null,null,null,null,null],
  // Knxwledge wonky soul - detuned feel
  knxwledge: [['Eb4','G4','Bb4','D5'],null,['Db4','F4','Ab4','C5'],null,null,['C4','E4','G4','B4'],null,['Bb3','D4','F4','A4'],null,null,null,null,null,null,null,null],
  // Chill-hop sunset - Fmaj9 → Em9 → Am11 → Dm9
  chillhop: [['F3','A3','C4','E4','G4'],null,null,null,['E3','G3','B3','D4','F#4'],null,null,null,['A3','C4','E4','G4','B4','D5'],null,null,null,['D4','F4','A4','C5','E5'],null,null,null],
  // Nujabes tribute - Dm9 floating melancholy
  nujabes: [['D4','F4','A4','C5','E5'],null,null,null,['G3','Bb3','D4','F4','A4'],null,null,null,['C4','E4','G4','B4','D5'],null,null,null,['A3','C4','E4','G4','B4'],null,null,null],
  // Seba Jun spiritual jazz - open voicings
  spiritual: [['E3','B3','F#4','A4'],null,null,null,['A3','E4','G#4','C#5'],null,null,null,['D4','A4','C#5','F#5'],null,null,null,['G3','D4','B4','E5'],null,null,null]
};

// 20 Pad progressions (all with proper note arrays, no chord names)
const padProgs = {
  // Classic Dilla - Ebmaj7 → Dbmaj7 → Cmaj7 → Bbmaj7
  velvet: [['Eb3','G3','Bb3','D4'],['Db3','F3','Ab3','C4'],['C3','E3','G3','B3'],['Bb2','D3','F3','A3']],
  // Gb lydian floating
  warmth: [['Gb3','Bb3','Db4','F4'],['Eb3','Gb3','Bb3','Db4'],['Ab3','C4','Eb4','G4'],['Db3','F3','Ab3','C4']],
  // Dmaj9 cycle
  drift: [['D3','F#3','A3','C#4','E4'],['G3','B3','D4','F#4','A4'],['E3','G#3','B3','D#4'],['A3','C#4','E4','G#4','B4']],
  // Fm9 → Bbm9 → Ebmaj9 → Abmaj9
  haze: [['F3','Ab3','C4','Eb4','G4'],['Bb2','Db3','F3','Ab3','C4'],['Eb3','G3','Bb3','D4','F4'],['Ab3','C4','Eb4','G4','Bb4']],
  // Cm11 rich
  smoke: [['C3','Eb3','G3','Bb3','D4','F4'],['F3','Ab3','C4','Eb4','G4'],['Bb2','D3','F3','A3','C4'],['Eb3','G3','Bb3','D4','F4']],
  // A major floating
  dream: [['A3','C#4','E4','G#4','B4'],['D3','F#3','A3','C#4','E4'],['G3','B3','D4','F#4','A4'],['E3','G#3','B3','D#4','F#4']],
  // Fm9 → Bbm7 → Ebmaj7 → Abmaj9
  night: [['F3','Ab3','C4','Eb4','G4'],['Bb3','Db4','F4','Ab4'],['Eb3','G3','Bb3','D4'],['Ab3','C4','Eb4','G4','Bb4']],
  // Chromatic motion Db → Gb → B → E
  glow: [['Db3','F3','Ab3','C4','Eb4'],['Gb3','Bb3','Db4','F4','Ab4'],['B2','D#3','F#3','A#3','C#4'],['E3','G#3','B3','D#4','F#4']],
  // E major 9 floating
  float: [['E3','G#3','B3','D#4','F#4'],['A3','C#4','E4','G#4','B4'],['D3','F#3','A3','C#4','E4'],['G3','B3','D4','F#4','A4']],
  // Deep Cm → Abm → Fm → Bbm
  deep: [['C3','Eb3','G3','Bb3','D4'],['Ab2','C3','Eb3','G3','Bb3'],['F2','Ab2','C3','Eb3','G3'],['Bb2','D3','F3','Ab3','C4']],
  // F# dorian floating
  cosmic: [['F#3','A3','C#4','E4','G#4'],['B3','D4','F#4','A4','C#5'],['E3','G#3','B3','D#4','F#4'],['A3','C#4','E4','G#4','B4']],
  // Dm9 → Gm7 → Am7 → Em7 (classic soul)
  soul: [['D3','F3','A3','C4','E4'],['G3','Bb3','D4','F4'],['A3','C4','E4','G4','B4'],['E3','G3','B3','D4','F#4']],
  // Ebmaj9 → Abmaj7 → Dbmaj9 → Gbmaj7
  jazz: [['Eb3','G3','Bb3','D4','F4'],['Ab3','C4','Eb4','G4'],['Db3','F3','Ab3','C4','Eb4'],['Gb3','Bb3','Db4','F4']],
  // Bbmaj7 → Ebmaj7 → Abmaj7 → Dbmaj7 (circle)
  neo: [['Bb3','D4','F4','A4'],['Eb3','G3','Bb3','D4'],['Ab3','C4','Eb4','G4'],['Db3','F3','Ab3','C4']],
  // Am7 → Fmaj7 → Dm7 → G7 (lofi standard)
  lofi: [['A3','C4','E4','G4','B4'],['F3','A3','C4','E4'],['D3','F3','A3','C4','E4'],['G3','B3','D4','F4']],
  // Em9 → Am9 → Dm9 → Gmaj7 (tape warmth)
  tape: [['E3','G3','B3','D4','F#4'],['A3','C4','E4','G4','B4'],['D3','F3','A3','C4','E4'],['G3','B3','D4','F#4']],
  // Cm9 → Fm9 → Bbm7 → Ebmaj9
  vinyl: [['C3','Eb3','G3','Bb3','D4'],['F3','Ab3','C4','Eb4','G4'],['Bb3','Db4','F4','Ab4'],['Eb3','G3','Bb3','D4','F4']],
  // Dm7 → Gm7 → Cmaj7 → Fmaj7
  rain: [['D3','F3','A3','C4'],['G3','Bb3','D4','F4'],['C3','E3','G3','B3'],['F3','A3','C4','E4']],
  // Am9 → Dm9 → Gmaj9 → Cmaj9
  dawn: [['A3','C4','E4','G4','B4'],['D3','F3','A3','C4','E4'],['G3','B3','D4','F#4','A4'],['C3','E3','G3','B3','D4']],
  // F#m9 → Bm7 → Emaj7 → Amaj9
  dusk: [['F#3','A3','C#4','E4','G#4'],['B3','D4','F#4','A4'],['E3','G#3','B3','D#4'],['A3','C#4','E4','G#4','B4']],
  // Slum Village "Fall in Love" pad - Ebmaj7 → Gm9 → Abmaj7 → Fm9
  fallinlove: [['Eb3','G3','Bb3','D4'],['G3','Bb3','D4','F4','A4'],['Ab3','C4','Eb4','G4'],['F3','Ab3','C4','Eb4','G4']],
  // "Get Dis Money" pad - C#m → G#m → A#dim → C# (darker Herbie Hancock vibe)
  getdismoney: [['C#3','E3','G#3','B3'],['G#2','B2','D#3','F#3'],['A#2','C#3','E3','G#3'],['C#3','F3','G#3','B3']],
  // Fantastic Vol 2 vibe - Dorian mode floating
  fantastic: [['D3','F3','A3','C4','E4'],['G3','Bb3','D4','F4','A4'],['A3','C4','E4','G4','B4'],['C3','E3','G3','B3','D4']],
  // Tainted - darker minor 9 cycle
  tainted: [['A3','C4','E4','G4','B4'],['D3','F4','A4','C5','E5'],['G3','Bb4','D5','F5'],['C3','Eb4','G4','Bb4','D5']],
  // "Once Upon a Time" feel - smooth jazz minor
  onceupon: [['F#3','A3','C#4','E4'],['B3','D4','F#4','A4','C#5'],['E3','G#3','B3','D#4','F#4'],['A3','C#4','E4','G#4']],
  // NEO-SOUL MINOR 11TH VOICINGS (signature sound)
  // Cm11 → Em11 → Ebm11 → Am11 (stacked 4ths with color)
  minor11s: [['C3','F3','Bb3','Eb4','G4'],['E3','A3','D4','G4','B4'],['Eb3','Ab3','Db4','Gb4','Bb4'],['A3','D4','G4','C5','E5']],
  // Fm11 → Bbm11 → Ebm11 → Abmaj9 (D'Angelo style)
  eleven: [['F3','Bb3','Eb4','Ab4','C5'],['Bb2','Eb3','Ab3','Db4','F4'],['Eb3','Ab3','Db4','Gb4','Bb4'],['Ab3','C4','Eb4','G4','Bb4']],
  // Shell voicings - root, 3rd, 7th only + 9th (airy Dilla)
  shells: [['D3','F#3','C4','E4'],['G3','B3','F4','A4'],['C3','E3','B3','D4'],['A3','C#4','G4','B4']],
  // Quartal minor - stacked 4ths in minor (Madlib/Dilla texture)
  quartalm: [['D3','G3','C4','F4'],['A3','D4','G4','C5'],['E3','A3','D4','G4'],['B3','E4','A4','D5']]
};

let currentBassLine = 'groove1';
let currentKeyPat = 'soul1';
let currentPadProg = 'velvet';

async function init() {
  if (ready) return;
  
  // Check for file:// protocol - AudioWorklets won't work
  const isFileProtocol = location.protocol === 'file:';
  if (isFileProtocol) {
    console.warn('[Dilla Machine] Running from file:// - some effects may not work. For full functionality, run via local server: python -m http.server 8000');
  }
  
  log('Loading Tone.js...');
  try {
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js';
      s.onload = res;
      s.onerror = rej;
      document.head.appendChild(s);
    });
  } catch (e) {
    log('Failed to load Tone.js - check internet connection');
    return;
  }
  
  Tone = window.Tone;
  log('Tone.js loaded');
  
  try {
    await Tone.start();
    await Tone.context.resume();
  } catch (e) {
    console.warn('[Dilla Machine] AudioContext start failed:', e.message);
  }
  
  // OPTIMIZATION: Increase lookAhead for slow systems
  Tone.context.lookAhead = 0.2;
  
  log('Audio context: ' + Tone.context.state);
  
  // Master output
  masterBus = new Tone.Gain(0.8).toDestination();
  
  // BitCrusher - skip on file:// (uses AudioWorklet)
  if (!isFileProtocol) {
    try {
      bitCrusher = new Tone.BitCrusher({ bits: 16 }).connect(masterBus);
      bitCrusher.wet.value = 0;
    } catch (e) {
      bitCrusher = null;
    }
  } else {
    bitCrusher = null;
  }
  
  // Analyser for meter
  analyser = new Tone.Analyser('waveform', 256);
  masterBus.connect(analyser);
  
  // Vinyl noise
  vinyl = new Tone.Noise('brown');
  const vinylFilt = new Tone.Filter({ frequency: 1200, type: 'bandpass', Q: 0.5 });
  vinylGain = new Tone.Gain(0.02).toDestination();
  vinyl.chain(vinylFilt, vinylGain);
  
  // ---- DRUMS - 808 style ----
  kick = new Tone.MembraneSynth({ 
    pitchDecay: 0.08,
    octaves: 5,
    oscillator: { type: 'sine' },
    envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.0 }
  }).connect(masterBus);
  kick.volume.value = -6;
  
  // Layered snare - noise snap + tonal body
  snare = new Tone.NoiseSynth({ 
    noise: { type: 'white' },
    envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.05 } 
  }).connect(masterBus);
  snare.volume.value = -12;
  
  snareBody = new Tone.MembraneSynth({
    pitchDecay: 0.01,
    octaves: 2,
    oscillator: { type: 'triangle' },
    envelope: { attack: 0.001, decay: 0.08, sustain: 0, release: 0.03 }
  }).connect(masterBus);
  snareBody.volume.value = -16;
  
  // Ghost snare
  ghost = new Tone.NoiseSynth({ 
    envelope: { attack: 0.001, decay: 0.05, sustain: 0 } 
  }).connect(masterBus);
  ghost.volume.value = -20;
  
  // Hi-hat
  const hatFilt = new Tone.Filter(9000, 'highpass').connect(masterBus);
  hat = new Tone.NoiseSynth({ envelope: { attack: 0.001, decay: 0.03, sustain: 0 } }).connect(hatFilt);
  hat.volume.value = -18;
  
  // Open hat
  openHat = new Tone.NoiseSynth({ 
    envelope: { attack: 0.001, decay: 0.18, sustain: 0.02, release: 0.1 } 
  }).connect(hatFilt);
  openHat.volume.value = -22;
  
  log('Drums ready (808 kick, layered snare, ghost, hats)');
  
  // ---- BASS - Moog style with sub ----
  bass = new Tone.MonoSynth({
    oscillator: { type: 'sawtooth' },
    envelope: { attack: 0.003, decay: 0.25, sustain: 0.35, release: 0.15 },
    filterEnvelope: { attack: 0.003, decay: 0.12, sustain: 0.15, release: 0.15, baseFrequency: 100, octaves: 2.5 },
    filter: { Q: 2, type: 'lowpass' }
  }).connect(masterBus);
  bass.volume.value = -6;
  
  // Sub bass
  sub = new Tone.MonoSynth({
    oscillator: { type: 'sine' },
    envelope: { attack: 0.01, decay: 0.25, sustain: 0.5, release: 0.25 }
  }).connect(masterBus);
  sub.volume.value = -12;
  
  log('Bass ready (Moog saw + sub)');
  
  // ---- KEYS - Rhodes style with chorus ----
  const keysChorus = new Tone.Chorus({ frequency: 1.5, delayTime: 3, depth: 0.3, wet: 0.25 }).connect(masterBus);
  keysChorus.start();
  
  // FMSynth for Rhodes character, but with lower polyphony for stability
  keys = new Tone.PolySynth(Tone.FMSynth, {
    maxPolyphony: 4,
    harmonicity: 2,
    modulationIndex: 1.2,
    oscillator: { type: 'sine' },
    modulation: { type: 'sine' },
    envelope: { attack: 0.01, decay: 0.4, sustain: 0.35, release: 0.5 },
    modulationEnvelope: { attack: 0.005, decay: 0.15, sustain: 0.1, release: 0.3 }
  }).connect(keysChorus);
  keys.volume.value = -8;
  
  log('Keys ready (Rhodes FM, poly:4)');
  
  // ---- PADS - J Dilla style neo-soul ----
  // Research: Rhodes/Wurli character = FM synthesis + chorus + tremolo + slow attack
  const padsChorus = new Tone.Chorus({ frequency: 0.5, delayTime: 3.5, depth: 0.7, spread: 180, wet: 0.4 }).start();
  const padsTremolo = new Tone.Tremolo({ frequency: 3, depth: 0.15, wet: 0.3 }).start();
  padsTremolo.connect(padsChorus);
  
  // Reverb - skip on file:// to avoid console errors
  let padsRevNode = null;
  if (location.protocol !== 'file:') {
    try {
      padsRevNode = new Tone.Reverb({ decay: 4, wet: 0.45, preDelay: 0.02 });
      await padsRevNode.generate();
      padsChorus.connect(padsRevNode);
      padsRevNode.connect(masterBus);
    } catch (e) {
      padsChorus.connect(masterBus);
    }
  } else {
    padsChorus.connect(masterBus);
  }
  
  // FMSynth for electric piano character (real Rhodes uses FM)
  // Lower polyphony + simpler FM for CPU stability
  pads = new Tone.PolySynth(Tone.FMSynth, { 
    maxPolyphony: 4,
    harmonicity: 3,
    modulationIndex: 2,
    oscillator: { type: 'sine' },
    modulation: { type: 'sine' },
    envelope: { attack: 0.4, decay: 1.0, sustain: 0.6, release: 2.5 },
    modulationEnvelope: { attack: 0.01, decay: 0.3, sustain: 0.2, release: 1.5 }
  }).connect(padsTremolo);
  pads.volume.value = -8;
  
  // Shimmer layer - connect to reverb if available, else to chorus
  shimmer = new Tone.PolySynth(Tone.Synth, {
    maxPolyphony: 3,
    oscillator: { type: 'sine' },
    envelope: { attack: 1.5, decay: 1.5, sustain: 0.4, release: 3.5 }
  }).connect(padsRevNode || padsChorus);
  shimmer.volume.value = -16;
  
  log('Pads ready (FM electric piano + tremolo + shimmer)');
  
  // Initialize FX engine
  initFX();
  
  // Initialize Synth FX (for pads/keys) - all start bypassed (wet=0)
  await initSynthFX();
  
  ready = true;
  log('OKAI DILLA MACHINE ready!');
}

function getPat() {
  const sel = document.getElementById('drums-pat').value;
  return patterns[sel] || patterns['boom-bap'];
}

function startSequences() {
  const pat = getPat();
  
  // Reset trigger counts
  triggerCounts = { kick: 0, snare: 0, hat: 0, bass: 0, keys: 0, pads: 0 };
  
  // Drums with scheduling offset for stability
  // NOTE: Stutter effect removed from callbacks - causes Tone.js timing issues
  kickSeq = new Tone.Sequence((time, vel) => {
    if (vel) {
      try {
        if (drumOn()) {
          const t = time + 0.01;
          const v = fxState.drunk ? vel * (0.85 + Math.random() * 0.3) : vel;
          kick.triggerAttackRelease('C1', 0.2, t, v);
          triggerCounts.kick++;
          lastTriggerTime.kick = Date.now();
        }
      } catch(e) { log('KICK ERROR: ' + e.message); }
    }
  }, pat.kick, '16n');
  kickSeq.loop = true;
  kickSeq.start(0);
  log('kickSeq created, state=' + kickSeq.state);
  
  snareSeq = new Tone.Sequence((time, vel) => {
    if (vel && drumOn()) {
      try {
        const t = time + 0.01;
        const v = fxState.drunk ? vel * (0.85 + Math.random() * 0.3) : vel;
        snare.triggerAttackRelease(0.12, t);
        snareBody.triggerAttackRelease('D3', 0.06, t, v * 0.7);
        triggerCounts.snare++;
        lastTriggerTime.snare = Date.now();
      } catch(e) { log('SNARE ERROR: ' + e.message); }
    }
  }, pat.snare, '16n');
  snareSeq.loop = true;
  snareSeq.start(0);
  
  ghostSeq = new Tone.Sequence((time, vel) => {
    if (vel && drumOn()) {
      try { 
        ghost.triggerAttackRelease(0.04, time + 0.01); 
      } catch(e) {}
    }
  }, pat.ghost, '16n');
  ghostSeq.loop = true;
  ghostSeq.start(0);
  
  hatSeq = new Tone.Sequence((time, vel) => {
    if (vel && drumOn()) {
      try {
        hat.triggerAttackRelease(0.02, time + 0.01);
        triggerCounts.hat++;
        lastTriggerTime.hat = Date.now();
      } catch(e) { log('HAT ERROR: ' + e.message); }
    }
  }, pat.hat, '16n');
  hatSeq.loop = true;
  hatSeq.start(0);
  
  openSeq = new Tone.Sequence((time, vel) => {
    if (vel && drumOn()) {
      try { 
        openHat.triggerAttackRelease(0.1, time + 0.01, vel); 
      } catch(e) {}
    }
  }, pat.open, '16n');
  openSeq.loop = true;
  openSeq.start(0);
  
  // Bass with sub + humanize
  const bassNotes = bassLines[document.getElementById('bass-line').value] || bassLines.groove1;
  log('Bass notes: ' + JSON.stringify(bassNotes.slice(0, 4)) + '... bassOn=' + bassOn());
  bassSeq = new Tone.Sequence((time, note) => {
    if (note && bassOn()) {
      try {
        const t = time + 0.01;
        bass.triggerAttackRelease(note, 0.15, t, 0.8);
        const m = note.match(/^([A-G][#b]?)(\d)$/);
        if (m) {
          const subNote = m[1] + Math.max(0, parseInt(m[2]) - 1);
          sub.triggerAttackRelease(subNote, 0.2, t, 0.5);
        }
        triggerCounts.bass++;
        lastTriggerTime.bass = Date.now();
      } catch(e) { log('BASS ERROR: ' + e.message); }
    }
  }, bassNotes, '16n');
  bassSeq.loop = true;
  bassSeq.start(0);
  
  // Keys with arpeggiator support
  const keyChords = keyPatterns[document.getElementById('key-pat').value] || keyPatterns.soul1;
  log('Key chords: ' + (keyChords ? keyChords.length + ' chords' : 'null') + ' keysOn=' + keysOn());
  keysSeq = new Tone.Sequence((time, chord) => {
    if (chord && keysOn()) {
      try {
        const t = time + 0.01;
        // Simple chord trigger - no arpeggiator inside callback (causes timing issues)
        keys.triggerAttackRelease(chord, 0.2, t, 0.6);
        triggerCounts.keys++;
        lastTriggerTime.keys = Date.now();
      } catch(e) { log('KEYS ERROR: ' + e.message); }
    }
  }, keyChords, '16n');
  keysSeq.loop = true;
  keysSeq.start(0);
  
  // Pads with shimmer + arpeggiator support
  const padChords = padProgs[document.getElementById('pad-prog').value] || padProgs.velvet;
  let padIdx = 0;
  padLoop = new Tone.Loop((time) => {
    if (padsOn()) {
      try {
        const chord = padChords[padIdx % padChords.length];
        const t = time + 0.01;
        
        // Simple chord trigger - no arpeggiator inside callback
        pads.triggerAttackRelease(chord, 2.5, t, 0.4);
        
        // Shimmer octave up
        const shimNotes = chord.slice(0, 3).map(n => {
          const m = n.match(/([A-G][#b]?)(\d)/);
          return m ? m[1] + (parseInt(m[2]) + 1) : n;
        });
        shimmer.triggerAttackRelease(shimNotes, 2.5, t, 0.2);
        triggerCounts.pads++;
        lastTriggerTime.pads = Date.now();
        padIdx++;
      } catch(e) { log('PADS ERROR: ' + e.message); }
    }
  }, '2m');
  padLoop.start(0);
  log('Sequences started');
  log('Sequence objects: kick=' + !!kickSeq + ' snare=' + !!snareSeq + ' bass=' + !!bassSeq);
}

function stopSequences() {
  log('Stopping sequences...');
  [kickSeq, snareSeq, ghostSeq, hatSeq, openSeq, bassSeq, keysSeq, padLoop].forEach((s, i) => {
    if (s) { 
      try { 
        log('Disposing seq #' + i + ' state=' + s.state);
        s.stop(); 
        s.dispose(); 
      } catch(e){ log('Dispose error #' + i + ': ' + e.message); } 
    }
  });
  kickSeq = snareSeq = ghostSeq = hatSeq = openSeq = bassSeq = keysSeq = padLoop = null;
  log('All sequences disposed');
}

function updateDisplay(msg, isPlaying) {
  const led = document.getElementById('led');
  const status = document.getElementById('status');
  
  status.textContent = msg;
  led.className = isPlaying ? 'led on' : 'led';
}

// Time display and interval management
let timeInterval, keepAliveInterval, audioDebugInterval;
function updateTime() {
  if (!playing) return;
  const t = Tone.Transport.seconds;
  const m = Math.floor(t / 60);
  const s = Math.floor(t % 60);
  const ms = Math.floor((t * 100) % 100);
  document.getElementById('time').textContent = 
    `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}:${String(ms).padStart(2,'0')}`;
  
  // Update audio meter
  if (analyser) {
    try {
      const values = analyser.getValue();
      const peak = Math.max(...values.map(Math.abs));
      const pct = Math.min(100, peak * 150);
      document.getElementById('meter').style.width = pct + '%';
    } catch(e) {}
  }
}

async function play() {
  try {
    if (!ready) await init();
    
    // Make sure context is running
    if (Tone.context.state !== 'running') {
      await Tone.context.resume();
    }
    
    Tone.Transport.stop();
    Tone.Transport.cancel();
    Tone.Transport.position = 0;  // Reset position to start
    Tone.Transport.bpm.value = +document.getElementById('bpm').value;
    Tone.Transport.swing = +document.getElementById('swing').value / 100;
    Tone.Transport.swingSubdivision = '16n';
    
    stopSequences();
    startSequences();
    
    // Start vinyl noise
    // Vinyl noise for lo-fi character
    vinyl.start();
    
    Tone.Transport.start();
    playing = true;
    updateDisplay('Playing @ ' + Tone.Transport.bpm.value + ' BPM', true);
    log('Transport started: ' + Tone.Transport.state);
    
    // Log sequence states immediately after start
    setTimeout(() => {
      log('After 100ms - kickSeq.state=' + (kickSeq ? kickSeq.state : 'null') + 
          ' Transport=' + Tone.Transport.state + ' pos=' + Tone.Transport.position);
    }, 100);
  } catch (err) {
    log('ERROR in play(): ' + err.message);
    console.error(err);
  }
  
  // Clear any existing intervals to prevent stacking
  if (timeInterval) clearInterval(timeInterval);
  if (keepAliveInterval) clearInterval(keepAliveInterval);
  if (audioDebugInterval) clearInterval(audioDebugInterval);
  
  // Time display update
  timeInterval = setInterval(updateTime, 100);
  
  // Aggressive context/transport monitoring - keep audio alive
  keepAliveInterval = setInterval(() => {
    if (!playing) { clearInterval(keepAliveInterval); return; }
    
    // Check and resume context if suspended
    if (Tone.context.state !== 'running') {
      log('Context suspended! Resuming...');
      Tone.context.resume();
    }
    
    // Check and restart transport if stopped
    if (Tone.Transport.state !== 'started') {
      log('Transport stopped! Restarting...');
      Tone.Transport.start();
    }
    
    updateDisplay(Tone.Transport.bpm.value + ' BPM', true);
  }, 250);  // Check 4x per second
  
  // DEBUG: Comprehensive audio monitoring every 2 seconds
  audioDebugInterval = setInterval(() => {
    if (!playing) { clearInterval(audioDebugInterval); return; }
    
    const now = Date.now();
    const audioLevelDb = analyser ? Math.max(...analyser.getValue()) : 'N/A';
    
    // Check if synths are still triggering
    const kickAge = now - lastTriggerTime.kick;
    const snareAge = now - lastTriggerTime.snare;
    const hatAge = now - lastTriggerTime.hat;
    
    // Log comprehensive debug info
    console.log('=== AUDIO DEBUG ===');
    console.log('Context:', Tone.context.state, '| Transport:', Tone.Transport.state, '| Position:', Tone.Transport.position);
    console.log('Audio Level (peak dB):', typeof audioLevelDb === 'number' ? audioLevelDb.toFixed(1) + ' dB' : audioLevelDb);
    console.log('Trigger counts:', triggerCounts);
    console.log('Time since last trigger (ms):', { kick: kickAge, snare: snareAge, hat: hatAge });
    console.log('Synth states:', {
      kick: kick ? (kick.disposed ? 'DISPOSED!' : 'ok') : 'null',
      snare: snare ? (snare.disposed ? 'DISPOSED!' : 'ok') : 'null',
      hat: hat ? (hat.disposed ? 'DISPOSED!' : 'ok') : 'null',
      bass: bass ? (bass.disposed ? 'DISPOSED!' : 'ok') : 'null',
      keys: keys ? (keys.disposed ? 'DISPOSED!' : 'ok') : 'null',
      pads: pads ? (pads.disposed ? 'DISPOSED!' : 'ok') : 'null'
    });
    console.log('Sequence states:', {
      kickSeq: kickSeq ? kickSeq.state : 'null',
      snareSeq: snareSeq ? snareSeq.state : 'null',
      hatSeq: hatSeq ? hatSeq.state : 'null',
      bassSeq: bassSeq ? bassSeq.state : 'null',
      keysSeq: keysSeq ? keysSeq.state : 'null'
    });
    console.log('MasterBus:', masterBus ? (masterBus.disposed ? 'DISPOSED!' : 'gain=' + masterBus.gain.value) : 'null');
    console.log('===================');
    
    // Detect silence - if level is very low (below -60 dB) and synths should be playing
    // Note: analyser.getValue() returns dB values (0 = max, -Infinity = silence)
    if (typeof audioLevelDb === 'number' && audioLevelDb < -60 && triggerCounts.kick > 5) {
      log('SILENT: Audio level near zero but triggers active');
      console.warn('POSSIBLE AUDIO DEATH - level:', audioLevelDb.toFixed(1), 'dB, triggers:', triggerCounts);
    }
    
    // Detect if triggers stopped
    if (kickAge > 3000 && drumOn() && playing) {
      log('KICK STALLED - no triggers for ' + (kickAge/1000).toFixed(1) + 's');
    }
  }, 2000);
}

function stop() {
  playing = false;
  stopSequences();
  try { vinyl.stop(); } catch(e){}
  if (pads) pads.releaseAll();
  if (shimmer) shimmer.releaseAll();
  Tone.Transport.stop();
  clearInterval(timeInterval);
  clearInterval(keepAliveInterval);
  clearInterval(audioDebugInterval);
  document.getElementById('time').textContent = '00:00:00';
  updateDisplay('Stopped — Press Play or Space', false);
  log('Stopped');
  console.log('Final trigger counts:', triggerCounts);
}

// Toggle play/pause
function togglePlay() {
  if (playing) stop(); else play();
}

// UI Event Handlers
document.getElementById('play').onclick = play;
document.getElementById('stop').onclick = stop;

// Helper: restart sequences if playing (define early so randomize can use it)
const restartIfPlaying = () => { if (playing) { stopSequences(); startSequences(); } };

// H3 User Control: Store state for undo
let previousState = null;
const saveState = () => {
  previousState = {
    drums: document.getElementById('drums-pat').value,
    bass: document.getElementById('bass-line').value,
    keys: document.getElementById('key-pat').value,
    pads: document.getElementById('pad-prog').value
  };
};

// Undo (Ctrl+Z) - H3 User Control and Freedom
document.addEventListener('keydown', e => {
  if (e.ctrlKey && e.key === 'z' && previousState) {
    document.getElementById('drums-pat').value = previousState.drums;
    document.getElementById('bass-line').value = previousState.bass;
    document.getElementById('key-pat').value = previousState.keys;
    document.getElementById('pad-prog').value = previousState.pads;
    restartIfPlaying();
    updateDisplay('Undo', true);
    log('Undo: restored previous patterns');
    previousState = null; // Only one level of undo
  }
});

// Randomize all patterns
document.getElementById('randomize').onclick = () => {
  saveState(); // Save before randomizing for undo
  const selects = ['drums-pat', 'bass-line', 'key-pat', 'pad-prog'];
  selects.forEach(id => {
    const sel = document.getElementById(id);
    if (sel) {
      const opts = sel.querySelectorAll('option');
      if (opts.length) {
        sel.value = opts[Math.floor(Math.random() * opts.length)].value;
      }
    }
  });
  // Auto-enable all instruments on randomize
  ['drums-on', 'bass-on', 'keys-on', 'pads-on'].forEach(id => {
    const el = document.getElementById(id);
    if (!el.classList.contains('on')) el.classList.add('on');
  });
  restartIfPlaying();
  updateDisplay('Randomized (Ctrl+Z to undo)', true);
  log('Randomized all patterns');
};

// H3 User Control: Reset to defaults
const defaultState = {
  drums: 'boom-bap', bass: 'groove1', keys: 'donut', pads: 'minor11s',
  bpm: 88, swing: 30, drumsVol: 75, bassVol: 70, keysVol: 60, padsVol: 55
};
document.getElementById('reset').onclick = () => {
  saveState(); // Allow undo
  document.getElementById('drums-pat').value = defaultState.drums;
  document.getElementById('bass-line').value = defaultState.bass;
  document.getElementById('key-pat').value = defaultState.keys;
  document.getElementById('pad-prog').value = defaultState.pads;
  document.getElementById('bpm').value = defaultState.bpm;
  document.getElementById('bpm-val').textContent = defaultState.bpm;
  document.getElementById('swing').value = defaultState.swing;
  document.getElementById('swing-val').textContent = defaultState.swing + '%';
  // Reset volumes
  ['drums', 'bass', 'keys', 'pads'].forEach(inst => {
    const slider = document.getElementById(inst + '-vol');
    const val = defaultState[inst + 'Vol'];
    if (slider) { slider.value = val; document.getElementById(inst + '-vol-val').textContent = val + '%'; }
  });
  // Turn off all FX
  Object.keys(fxState).forEach(fx => { if (fxState[fx]) toggleFX(fx); });
  Object.keys(synthFXState).forEach(fx => { if (synthFXState[fx]) document.querySelector('[data-synthfx="' + fx + '"]')?.click(); });
  restartIfPlaying();
  updateDisplay('Reset to defaults (Ctrl+Z to undo)', true);
  log('Reset to defaults');
};

// Export audio recording
let recorder = null;
document.getElementById('export').onclick = async () => {
  if (!recorder) {
    try {
      await Tone.start();
      recorder = new Tone.Recorder();
      masterBus.connect(recorder);
    } catch(e) { log('Recorder init failed: ' + e); return; }
  }
  
  updateDisplay('Recording 10s...', true);
  log('Starting 10-second recording...');
  
  recorder.start();
  const wasPlaying = playing;
  if (!wasPlaying) await play();
  
  setTimeout(async () => {
    const blob = await recorder.stop();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'okai-dilla-' + Date.now() + '.webm';
    a.click();
    URL.revokeObjectURL(url);
    updateDisplay('Exported!', true);
    log('Audio exported as WebM');
    if (!wasPlaying) stop();
  }, 10000);
};

// Instrument pad toggles (MPC style)
['drums-on','bass-on','keys-on','pads-on'].forEach(id => {
  const el = document.getElementById(id);
  const handler = () => {
    el.classList.toggle('on');
  };
  el.onclick = handler;
  el.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handler(); } });
});

// Preset pads - H4 Consistency: all set BOTH drums + keys for full vibe
const presetConfigs = {
  dilla: { drums: 'boom-bap', keys: 'donut', pads: 'minor11s' },
  soul: { drums: 'shuffle', keys: 'dangelo', pads: 'shells' },
  techno: { drums: 'industrial', keys: 'chromatic', pads: 'cosmic' },
  detroit: { drums: 'theo-swing', keys: 'quartal', pads: 'quartalm' }
};
document.querySelectorAll('[data-preset]').forEach(pad => {
  const handler = () => {
    const preset = presetConfigs[pad.dataset.preset];
    if (!preset) return;
    document.getElementById('drums-pat').value = preset.drums;
    document.getElementById('key-pat').value = preset.keys;
    document.getElementById('pad-prog').value = preset.pads;
    // Auto-enable instruments when preset selected
    ['drums-on', 'keys-on', 'pads-on'].forEach(id => {
      const el = document.getElementById(id);
      if (!el.classList.contains('on')) el.classList.add('on');
    });
    restartIfPlaying();
    log('Preset: ' + pad.dataset.preset + ' (' + preset.drums + ' / ' + preset.keys + ')');
    flashPad(pad.id || pad.dataset.preset);
  };
  pad.onclick = handler;
  pad.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handler(); } });
});

// NON-MUSICIAN FRIENDLY: Mood presets with emotional descriptions
const moodConfigs = {
  chill: { drums: 'shuffle', keys: 'afta1', pads: 'haze', bpm: 78, fx: ['lofi', 'binaural'] },
  hype: { drums: 'boom-bap', keys: 'donut', pads: 'minor11s', bpm: 95, fx: ['stutter'] },
  dreamy: { drums: 'sparse', keys: 'aftaSunset', pads: 'dream', bpm: 82, fx: ['tapedelay', 'binaural', 'entrain'] },
  dark: { drums: 'industrial', keys: 'chromatic', pads: 'cosmic', bpm: 100, fx: ['filtlfo'] },
  funky: { drums: 'pocket', keys: 'dangelo', pads: 'shells', bpm: 92, fx: ['drunk'] },
  jazzy: { drums: 'theo-jazz', keys: 'chillhop', pads: 'jazz', bpm: 85, fx: ['tapedelay', 'lofi'] }
};
document.querySelectorAll('[data-mood]').forEach(btn => {
  const handler = () => {
    // H3 User Control: clicking active mood deactivates it
    if (btn.classList.contains('active')) {
      btn.classList.remove('active');
      updateDisplay('■ Mood cleared', playing);
      return;
    }
    document.querySelectorAll('[data-mood]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const mood = moodConfigs[btn.dataset.mood];
    if (!mood) return;
    saveState(); // Allow undo
    document.getElementById('drums-pat').value = mood.drums;
    document.getElementById('key-pat').value = mood.keys;
    document.getElementById('pad-prog').value = mood.pads;
    document.getElementById('bpm').value = mood.bpm;
    document.getElementById('bpm-val').textContent = mood.bpm;
    // Auto-enable instruments when mood selected
    ['drums-on', 'keys-on', 'pads-on'].forEach(id => {
      const pad = document.getElementById(id);
      if (!pad.classList.contains('on')) pad.classList.add('on');
    });
    // Turn off current FX, enable mood FX
    FX_LIST.forEach(fx => { if (fxState[fx]) toggleFX(fx); });
    mood.fx.forEach(fx => { if (!fxState[fx]) toggleFX(fx); });
    restartIfPlaying();
    updateDisplay('Mood: ' + btn.dataset.mood, true);
    log('Mood: ' + btn.dataset.mood + ' (Ctrl+Z to undo)');
  };
  btn.onclick = handler;
  btn.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handler(); } });
});

// Helper: slider with synced display(s)
const bindSlider = (id, displayIds, transform, onChange) => {
  document.getElementById(id).oninput = e => {
    const val = e.target.value;
    const display = transform ? transform(val) : val;
    displayIds.forEach(dId => document.getElementById(dId).textContent = display);
    if (onChange) onChange(+val);
  };
};

// DRY Helper: Radio button group (KISS refactor)
const bindRadioGroup = (selector, onSelect) => {
  const btns = document.querySelectorAll(selector);
  btns.forEach(btn => {
    btn.onclick = () => {
      btns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      onSelect(btn);
    };
  });
};

// DRY Constants: FX lists (single source of truth)
const FX_LIST = ['arp', 'stutter', 'drunk', 'filtlfo', 'tapedelay', 'binaural', 'lofi', 'entrain'];
const SYNTH_FX_LIST = ['chorus', 'phaser', 'vibrato', 'reverb', 'pitch', 'widen', 'cheby', 'pingpong', 'stretch', 'freqshift', 'autowah', 'tremolo'];

// BPM & Swing sliders
bindSlider('bpm', ['bpm-val'], null, v => { if (playing) Tone.Transport.bpm.value = v; });
bindSlider('swing', ['swing-val'], v => v + '%', v => { if (playing) Tone.Transport.swing = v / 100; });

// Volume controls - config-driven
const volControls = [
  { id: 'drums-vol', display: 'drums-vol-val', getNode: () => drumsVol },
  { id: 'bass-vol', display: 'bass-vol-val', getNode: () => bassVol },
  { id: 'keys-vol', display: 'keys-vol-val', getNode: () => keysVol },
  { id: 'pads-vol', display: 'pads-vol-val', getNode: () => padsVol }
];
volControls.forEach(({ id, display, getNode }) => {
  bindSlider(id, [display], v => v + '%', v => { const n = getNode(); if (n) n.gain.value = v / 100; });
});

// Lo-fi controls
bindSlider('lofi-vinyl', ['vinyl-val'], v => v + '%', v => { if (vinylGain) vinylGain.gain.value = v / 100 * 0.06; });
bindSlider('lofi-sat', ['sat-val'], v => v + '%', v => { if (saturation) saturation.distortion = v / 100 * 0.25; });
bindSlider('lofi-rolloff', ['rolloff-val'], v => Math.round(v/1000) + 'kHz', v => { if (lofiFilter) lofiFilter.frequency.value = v; });

// BitCrusher controls (SP-404 style)
bindSlider('lofi-bits', ['bits-val'], v => v, v => { 
  fxSettings.crush.bits = v;
  if (bitCrusher) bitCrusher.bits.value = v; 
});
bindSlider('lofi-crush', ['crush-val'], v => v + '%', v => { 
  fxSettings.crush.wet = v / 100;
  if (bitCrusher) bitCrusher.wet.value = v / 100;
  updateFXLoadMeter();
});

// Pattern select changes - all use same restart logic
['drums-pat', 'bass-line', 'key-pat', 'pad-prog'].forEach(id => {
  document.getElementById(id).onchange = restartIfPlaying;
});

// Keyboard shortcuts (DRY: Use lookup tables)
const keyMappings = {
  // Instrument toggles
  Digit1: () => document.getElementById('drums-on').click(),
  Digit2: () => document.getElementById('bass-on').click(),
  Digit3: () => document.getElementById('keys-on').click(),
  Digit4: () => document.getElementById('pads-on').click(),
  // FX Row 2: Q W E R
  KeyQ: () => toggleFX('drunk'),
  KeyW: () => toggleFX('stutter'),
  KeyE: () => toggleFX('arp'),
  KeyR: () => toggleFX('filtlfo'),
  // FX Row 3: A S D F
  KeyA: () => toggleFX('tapedelay'),
  KeyS: () => toggleFX('binaural'),
  KeyD: () => toggleFX('lofi'),
  KeyF: () => toggleFX('entrain'),
  // Synth FX: Z X C V
  KeyZ: () => document.querySelector('[data-synthfx="chorus"]')?.click(),
  KeyX: () => document.querySelector('[data-synthfx="phaser"]')?.click(),
  KeyC: () => document.querySelector('[data-synthfx="reverb"]')?.click(),
  KeyV: () => document.querySelector('[data-synthfx="stretch"]')?.click()
};
document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
  if (e.code === 'Space') { e.preventDefault(); togglePlay(); return; }
  if (e.code === 'Escape') { stop(); return; }
  if (keyMappings[e.code]) keyMappings[e.code]();
});

// ============= FX BUTTON HANDLERS =============
// Main FX toggle buttons (DRY: use FX_LIST)
FX_LIST.forEach(fx => {
  const btn = document.getElementById('fx-' + fx);
  if (btn) btn.onclick = () => toggleFX(fx);
});

// Arpeggiator buttons (DRY refactor)
bindRadioGroup('[data-arp]', btn => {
  fxSettings.arp.mode = btn.dataset.arp;
  log('Arp mode: ' + fxSettings.arp.mode);
});
bindRadioGroup('[data-arprate]', btn => {
  fxSettings.arp.rate = btn.dataset.arprate;
  log('Arp rate: ' + fxSettings.arp.rate);
});
bindRadioGroup('[data-arpoct]', btn => {
  fxSettings.arp.octaves = parseInt(btn.dataset.arpoct);
  log('Arp octaves: ' + fxSettings.arp.octaves);
});

// FX Pads in main grid (DRY: use FX_LIST)
FX_LIST.forEach(fx => {
  const pad = document.getElementById('pad-' + fx);
  if (pad) {
    const handler = () => {
      toggleFX(fx);
      pad.classList.toggle('on', fxState[fx]);
    };
    pad.onclick = handler;
    pad.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handler(); } });
  }
});

// Synth FX buttons (DRY: use SYNTH_FX_LIST)
SYNTH_FX_LIST.forEach(fx => {
  const btn = document.getElementById('sfx-' + fx);
  if (btn) btn.onclick = () => toggleSynthFX(fx);
});

// Synth FX wet/depth sliders (DRY: use SYNTH_FX_LIST)
bindSlider('sfx-wet', ['sfx-wet-val'], v => v + '%', v => { 
  fxSettings.synthfx.wet = v / 100;
  const effectMap = { 
    chorus: sfxChorus, phaser: sfxPhaser, vibrato: sfxVibrato, reverb: sfxReverb, 
    pitch: sfxPitch, widen: sfxWiden, cheby: sfxCheby, pingpong: sfxPingPong,
    stretch: sfxStretch, freqshift: sfxFreqShift, autowah: sfxAutoWah, tremolo: sfxTremolo
  };
  SYNTH_FX_LIST.forEach(fx => {
    if (synthFXState[fx] && effectMap[fx]) effectMap[fx].wet.value = v / 100;
  });
});
bindSlider('sfx-depth', ['sfx-depth-val'], v => v + '%', v => { 
  fxSettings.synthfx.depth = v / 100;
  // DRY: Map-based depth handlers
  const depthHandlers = {
    chorus: () => sfxChorus && (sfxChorus.depth = v / 100),
    phaser: () => sfxPhaser && (sfxPhaser.octaves = Math.round(v / 20) + 1),
    vibrato: () => sfxVibrato && (sfxVibrato.depth.value = v / 100 * 0.3),
    stretch: () => sfxStretch && (sfxStretch.feedback.value = 0.5 + v / 100 * 0.4),
    freqshift: () => sfxFreqShift && (sfxFreqShift.frequency.value = v * 2),
    tremolo: () => sfxTremolo && (sfxTremolo.depth.value = v / 100)
  };
  Object.keys(depthHandlers).forEach(fx => { if (synthFXState[fx]) depthHandlers[fx](); });
});

// DRY: Use bindRadioGroup for all button groups
bindRadioGroup('[data-stutter]', btn => {
  fxSettings.stutter.division = btn.dataset.stutter;
  log('Stutter div: ' + fxSettings.stutter.division);
});

// Stutter sliders
bindSlider('stutter-chance', ['stutter-chance-val'], v => v + '%', v => { fxSettings.stutter.chance = v / 100; });
bindSlider('stutter-decay', ['stutter-decay-val'], v => v + '%', v => { fxSettings.stutter.decay = v / 100; });

// Scatter type buttons
bindRadioGroup('[data-scatter]', btn => {
  const type = parseInt(btn.dataset.scatter);
  document.getElementById('scatter-type').value = type;
  fxSettings.stutter.type = type;
  updateFXLoadMeter();
  log('Scatter type: ' + scatterTypes[type].name);
});
const scatterHumanize = document.getElementById('scatter-humanize');
if (scatterHumanize) {
  scatterHumanize.onchange = () => {
    fxSettings.stutter.humanize = scatterHumanize.checked;
  };
}

// Drunk (humanizer) sliders
bindSlider('drunk-time', ['drunk-time-val'], v => '±' + v + 'ms', v => { fxSettings.drunk.time = v; });
bindSlider('drunk-vel', ['drunk-vel-val'], v => '±' + v + '%', v => { fxSettings.drunk.velocity = v; });
bindSlider('drunk-pitch', ['drunk-pitch-val'], v => '±' + v + '¢', v => { fxSettings.drunk.pitch = v; });

// Filter LFO type buttons (DRY)
bindRadioGroup('[data-filttype]', btn => {
  fxSettings.filtlfo.type = btn.dataset.filttype;
  if (fxAutoFilter) fxAutoFilter.filter.type = btn.dataset.filttype;
});

// Filter LFO sliders
bindSlider('filt-rate', ['filt-rate-val'], v => parseFloat(v).toFixed(1) + ' Hz', v => { 
  fxSettings.filtlfo.rate = v; 
  if (fxAutoFilter) fxAutoFilter.frequency.value = v;
});
bindSlider('filt-depth', ['filt-depth-val'], v => v + '%', v => { 
  fxSettings.filtlfo.depth = v; 
  if (fxAutoFilter) fxAutoFilter.depth.value = v / 100;
});
bindSlider('filt-q', ['filt-q-val'], null, v => { 
  fxSettings.filtlfo.q = v; 
  if (fxAutoFilter) fxAutoFilter.filter.Q.value = v;
});

// Tape Delay sliders
bindSlider('delay-time', ['delay-time-val'], v => v + 'ms', v => { 
  fxSettings.delay.time = v; 
  if (fxTapeDelay) fxTapeDelay.delayTime.value = v / 1000;
});
bindSlider('delay-fb', ['delay-fb-val'], v => v + '%', v => { 
  fxSettings.delay.feedback = v / 100; 
  if (fxTapeDelay) fxTapeDelay.feedback.value = v / 100;
});
bindSlider('delay-wet', ['delay-wet-val'], v => v + '%', v => { 
  fxSettings.delay.wet = v / 100; 
  if (fxTapeDelay && fxState.tapedelay) fxTapeDelay.wet.value = v / 100;
});
bindSlider('delay-wobble', ['delay-wobble-val'], v => v + '%', v => { 
  fxSettings.delay.wobble = v / 100;
  if (fxDelayWobble) {
    fxDelayWobble.min = -0.01 * (v / 50);
    fxDelayWobble.max = 0.01 * (v / 50);
  }
});

// Binaural sliders
bindSlider('bin-detune', ['bin-detune-val'], v => v + '¢', v => { fxSettings.binaural.detune = v; });
bindSlider('bin-panrate', ['bin-panrate-val'], v => parseFloat(v).toFixed(1) + ' Hz', v => { 
  fxSettings.binaural.panRate = v; 
  if (fxPanLFO) fxPanLFO.frequency.value = v;
});
bindSlider('bin-width', ['bin-width-val'], v => v + '%', v => { 
  fxSettings.binaural.width = v / 100;
  if (fxPanLFO) {
    fxPanLFO.min = -(v / 100);
    fxPanLFO.max = v / 100;
  }
});

// Entrainment mode buttons (DRY pattern - custom logic required)
const brainFreqs = { delta: 2, theta: 6, alpha: 10, beta: 20, gamma: 35 };
bindRadioGroup('[data-brain]', btn => {
  fxSettings.entrain.mode = btn.dataset.brain;
  fxSettings.entrain.freq = brainFreqs[btn.dataset.brain] || 10;
  document.getElementById('entrain-freq').value = fxSettings.entrain.freq;
  document.getElementById('entrain-freq-val').textContent = fxSettings.entrain.freq + ' Hz';
  if (fxEntrainLFO) fxEntrainLFO.frequency.value = fxSettings.entrain.freq;
  log('Entrainment: ' + btn.dataset.brain + ' @ ' + fxSettings.entrain.freq + 'Hz');
});

// Entrainment sliders
bindSlider('entrain-intensity', ['entrain-intensity-val'], v => v + '%', v => { 
  fxSettings.entrain.intensity = v / 100;
  if (fxEntrainLFO) {
    fxEntrainLFO.min = 1 - (v / 200);
    fxEntrainLFO.max = 1;
  }
});
bindSlider('entrain-freq', ['entrain-freq-val'], v => v + ' Hz', v => { 
  fxSettings.entrain.freq = v; 
  if (fxEntrainLFO) fxEntrainLFO.frequency.value = v;
});

// ============= ONBOARDING & HELP MODALS =============

// Show onboarding on first load this session
let hasSeenOnboarding = false;
if (!hasSeenOnboarding) {
  document.getElementById('onboard-modal').style.display = 'flex';
}
document.getElementById('onboard-close').onclick = () => {
  document.getElementById('onboard-modal').style.display = 'none';
  hasSeenOnboarding = true;
  togglePlay(); // Auto-start after onboarding
};

// Help modal (? key)
document.getElementById('help-close').onclick = () => {
  document.getElementById('help-modal').style.display = 'none';
};
document.addEventListener('keydown', e => {
  if (e.key === '?' || (e.shiftKey && e.key === '/')) {
    const modal = document.getElementById('help-modal');
    modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
  }
  if (e.key === 'Escape') {
    document.getElementById('help-modal').style.display = 'none';
    document.getElementById('onboard-modal').style.display = 'none';
  }
});

// ============= ACCESSIBLE TOOLTIPS (Plain language) =============
const accessibleTips = {
  'bpm': 'Speed of the beat. Lower = slower & chill. Higher = faster & energetic.',
  'swing': 'Makes the beat feel "loose" and groovy instead of robotic.',
  'lofi-vinyl': 'Adds crackle and warmth like an old record.',
  'lofi-sat': 'Makes the sound warmer and slightly distorted.',
  'lofi-rolloff': 'Removes harsh high frequencies for a mellow tone.',
  'lofi-bits': 'Lower = grittier lo-fi sound (MPC60 used 12-bit).',
  'lofi-crush': 'Adds digital grit and aliasing artifacts.',
  'drunk-time': 'How "off" the timing is. More = sloppier/human.',
  'drunk-vel': 'Volume variation between hits. More = dynamic.',
  'drunk-pitch': 'Subtle pitch wobble for analog feel.',
  'stutter-chance': 'How often glitches happen. More = more chaos.',
  'stutter-decay': 'How quickly stutter repeats fade out.',
  'sfx-wet': 'How much effect you hear vs. the original sound.',
  'sfx-depth': 'Intensity of the effect modulation.',
  'delay-time': 'Time between echoes in milliseconds.',
  'delay-fb': 'How many times the echo repeats.',
  'delay-wet': 'How loud the echoes are.',
  'delay-wobble': 'Tape-like wobble on the delay for vintage feel.'
};
Object.entries(accessibleTips).forEach(([id, tip]) => {
  const el = document.getElementById(id);
  if (el) el.title = tip;
});

// ============= END FX HANDLERS =============

log('DILLA MACHINE ready • Space to play, ? for help');
log('L.A. Beat Scene progressions: Afta-1, Ras G, Daedelus, TOKiMONSTA, FlyLo');

// Debug: verify initial toggle states
log('Initial states: drums=' + drumOn() + ' bass=' + bassOn() + ' keys=' + keysOn() + ' pads=' + padsOn());
</script>
</body>
</html>