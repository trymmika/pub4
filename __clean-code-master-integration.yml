# CLEAN CODE + REFACTORING INTEGRATION
# How to integrate code quality governance into MASTER.yml

integration:
  
  philosophy:
    alignment: |
      Clean Code principles align perfectly with MASTER's adversarial framework:
      - Evidence over opinion → Tests prove quality
      - Quality through constraint → SOLID principles provide bounds
      - Systematic rigor → Refactoring is disciplined transformation
      - Adversarial validation → Code review personas
    
    enforcement: |
      Uncle Bob and Fowler provide the rules.
      MASTER provides the enforcement mechanism.
      Together: Constitutional code quality.

  ## MASTER.YML INTEGRATION

  master_structure:
    
    add_code_quality_section:
      location: "After 'testing' section"
      
      yaml: |
        code_quality:
          enabled: true
          authorities:
            - "Robert C. Martin - Clean Code"
            - "Martin Fowler - Refactoring"
          
          enforcement_mode: "strict" # or "advisory"
          auto_fix: true # Auto-format, auto-rename where safe
          
          rules:
            import: "./rules/code-quality/clean-code.yml"
          
          thresholds:
            function_length: 20
            class_length: 300
            cyclomatic_complexity: 10
            parameter_count: 3
            nesting_depth: 3
          
          metrics:
            minimum_test_coverage: 80
            maximum_duplication: 3 # percentage
            maximum_code_churn: 500 # lines per commit

  ## ADVERSARIAL PERSONAS

  personas:
    
    uncle_bob:
      name: "UNCLE_BOB"
      role: "Code quality critic"
      authority: "Clean Code principles"
      
      perspective: |
        Reviews code through lens of craftsmanship. Checks naming,
        function size, single responsibility, comment necessity.
        Zero tolerance for code smells.
      
      validation_questions:
        - "Are names intention-revealing?"
        - "Functions under 20 lines?"
        - "Each function does ONE thing?"
        - "No more than 3 parameters?"
        - "Comments explaining WHY not WHAT?"
        - "Error handling separated from logic?"
        - "Tests following FIRST principles?"
      
      severity: "CRITICAL"
      blocks_merge: true
    
    fowler:
      name: "FOWLER"
      role: "Refactoring specialist"
      authority: "Refactoring catalog"
      
      perspective: |
        Identifies code smells and suggests specific refactorings.
        Ensures code remains changeable. Checks for duplication,
        inappropriate coupling, and design erosion.
      
      validation_questions:
        - "Any code smells present?"
        - "Duplicate code?"
        - "Appropriate abstraction level?"
        - "Law of Demeter respected?"
        - "Is this easy to change?"
        - "Would refactoring improve this?"
      
      severity: "HIGH"
      blocks_merge: false # Advisory, recommends improvements
    
    solid_guardian:
      name: "SOLID"
      role: "Architecture principles enforcer"
      authority: "SOLID principles"
      
      perspective: |
        Ensures adherence to object-oriented design principles.
        Checks single responsibility, open/closed, Liskov substitution,
        interface segregation, dependency inversion.
      
      validation_questions:
        - "Single Responsibility: one reason to change?"
        - "Open/Closed: extendable without modification?"
        - "Liskov: subtypes substitutable?"
        - "Interface Segregation: no forced dependencies?"
        - "Dependency Inversion: depend on abstractions?"
      
      severity: "HIGH"
      blocks_merge: true # SOLID violations are architectural flaws

  ## AUTOMATED ENFORCEMENT

  automated_tools:
    
    linting:
      eslint:
        rules:
          - "max-lines-per-function: [error, 20]"
          - "max-params: [error, 3]"
          - "max-depth: [error, 3]"
          - "complexity: [error, 10]"
          - "max-lines: [error, 300]"
      
      pylint:
        rules:
          - "max-line-length: 120"
          - "max-args: 3"
          - "max-locals: 15"
          - "max-branches: 12"
      
      rubocop:
        rules:
          - "Metrics/MethodLength: 20"
          - "Metrics/ClassLength: 300"
          - "Metrics/CyclomaticComplexity: 10"
    
    static_analysis:
      sonarqube:
        quality_gate:
          - "Coverage > 80%"
          - "Duplications < 3%"
          - "Maintainability Rating: A"
          - "Security Rating: A"
      
      codeclimate:
        thresholds:
          - "Test coverage: 80%"
          - "Maintainability: A/B only"
          - "No code smells rated D or F"
    
    complexity_analysis:
      tools:
        - "radon (Python)"
        - "complexity-report (JavaScript)"
        - "flog (Ruby)"
      
      thresholds:
        cyclomatic: "< 10"
        cognitive: "< 15"
        halstead_volume: "< 1000"
    
    duplication_detection:
      tools:
        - "jscpd (JavaScript)"
        - "pmd-cpd (Java)"
        - "simian (multi-language)"
      
      threshold: "< 3% duplication"

  ## VALIDATION WORKFLOW

  pre_commit:
    
    step_1_format:
      action: "Auto-format code"
      tools: ["prettier", "black", "rubocop --auto-correct"]
      rationale: "Formatting is machine's job, not human's"
    
    step_2_lint:
      action: "Run linters"
      fail_on: "Any error-level issue"
      warn_on: "Warning-level issues"
    
    step_3_complexity:
      action: "Check complexity metrics"
      fail_on: "Cyclomatic > 10, nesting > 3, function > 50 lines"
    
    step_4_duplication:
      action: "Detect code duplication"
      fail_on: "Exact duplicates > 6 lines"
      warn_on: "Similar patterns"

  code_review:
    
    human_review:
      checklist:
        naming:
          - "Names reveal intent?"
          - "Pronounceable and searchable?"
          - "One word per concept?"
        
        functions:
          - "Under 20 lines each?"
          - "Single responsibility?"
          - "No side effects?"
          - "0-3 parameters?"
        
        comments:
          - "Explain WHY not WHAT?"
          - "Zero commented-out code?"
          - "Could code be clearer instead?"
        
        tests:
          - "Tests exist for new code?"
          - "Tests are readable?"
          - "FIRST principles followed?"
    
    persona_review:
      uncle_bob:
        automatic: true
        checks: "All naming, function size, comment rules"
        output: "Pass/Fail with specific violations"
      
      fowler:
        automatic: true
        checks: "Code smells, refactoring opportunities"
        output: "Recommendations with severity"
      
      solid:
        automatic: false # Requires human judgment
        checks: "Architecture principles"
        output: "Violations requiring fixes"

  ## METRICS TRACKING

  quality_metrics:
    
    trend_tracking:
      coverage:
        metric: "Test coverage percentage"
        goal: "Increasing or stable at >80%"
        alert: "Decreasing coverage"
      
      complexity:
        metric: "Average cyclomatic complexity"
        goal: "< 5 average"
        alert: "Increasing complexity"
      
      duplication:
        metric: "Percentage duplicated code"
        goal: "< 3%"
        alert: "Increasing duplication"
      
      technical_debt:
        metric: "SonarQube debt ratio"
        goal: "< 5%"
        alert: "Increasing debt"
    
    velocity_impact:
      track: "Correlation between quality metrics and velocity"
      hypothesis: "Better quality → faster velocity over time"
      measure: "Story points per sprint vs code quality trends"

  ## REFACTORING GUIDELINES

  refactoring_process:
    
    boy_scout_rule:
      enforcement: "Every commit must improve at least one thing"
      
      improvements:
        - "Rename one unclear variable"
        - "Extract one long method"
        - "Add one missing test"
        - "Fix one code smell"
      
      tracking: "Log small improvements in commit messages"
    
    scheduled_refactoring:
      frequency: "20% of sprint capacity"
      focus: "Highest-pain code areas"
      
      selection_criteria:
        - "Most frequently changed files"
        - "Highest complexity scores"
        - "Most bugs per KLOC"
        - "Developer pain points (survey)"
    
    refactoring_safety:
      prerequisites:
        - "Test coverage > 80% for module"
        - "Tests passing"
        - "No pending features"
      
      process:
        1: "Run tests → green"
        2: "Make small refactoring"
        3: "Run tests → green"
        4: "Commit"
        5: "Repeat"
      
      never:
        - "Mix refactoring with feature work"
        - "Refactor without tests"
        - "Make large changes at once"

  ## TRAINING AND ADOPTION

  team_enablement:
    
    phase_1_awareness:
      duration: "2 weeks"
      
      activities:
        - "Book club: Clean Code (2 chapters/week)"
        - "Lunch & learn: Code smells"
        - "Code review training"
      
      deliverable: "Team familiar with principles"
    
    phase_2_practice:
      duration: "4 weeks"
      
      activities:
        - "Kata sessions (refactoring exercises)"
        - "Pair programming with focus on quality"
        - "Mob refactoring sessions"
      
      deliverable: "Team can apply principles"
    
    phase_3_enforcement:
      duration: "Ongoing"
      
      activities:
        - "Automated checks in CI/CD"
        - "Persona review in pull requests"
        - "Quality metrics dashboard"
      
      deliverable: "Sustained quality improvement"
    
    continuous_improvement:
      retrospectives:
        - "Review quality metrics"
        - "Identify pain points"
        - "Adjust thresholds if needed"
      
      knowledge_sharing:
        - "Share refactoring wins"
        - "Document patterns"
        - "Celebrate improvements"

  ## SUCCESS METRICS

  outcomes:
    
    code_quality:
      - metric: "Average cyclomatic complexity"
        baseline: 8
        target: 4
        timeline: "6 months"
      
      - metric: "Test coverage"
        baseline: 60
        target: 80
        timeline: "3 months"
      
      - metric: "Code duplication"
        baseline: 8
        target: 3
        timeline: "3 months"
    
    team_velocity:
      - metric: "Story points per sprint"
        hypothesis: "Should increase as quality improves"
        measure: "6-month trend"
      
      - metric: "Bug rate"
        hypothesis: "Should decrease"
        measure: "Bugs per feature"
    
    developer_experience:
      - metric: "Time to understand code"
        survey: "Monthly developer survey"
        target: "Decreasing trend"
      
      - metric: "Confidence in changes"
        survey: "How confident making changes (1-10)"
        target: "Increasing trend"

  ## INTEGRATION CHECKLIST

  setup:
    - "[ ] Add code_quality section to MASTER.yml"
    - "[ ] Create UNCLE_BOB, FOWLER, SOLID personas"
    - "[ ] Configure linters (ESLint, Pylint, etc.)"
    - "[ ] Set up SonarQube/CodeClimate"
    - "[ ] Configure pre-commit hooks"
    - "[ ] Create quality metrics dashboard"
  
  adoption:
    - "[ ] Team training complete"
    - "[ ] Thresholds calibrated to codebase"
    - "[ ] Automated checks passing"
    - "[ ] First refactoring sprint complete"
    - "[ ] Documentation updated"
  
  monitoring:
    - "[ ] Quality metrics tracked weekly"
    - "[ ] Retrospectives include quality review"
    - "[ ] Refactoring capacity allocated"
    - "[ ] Boy Scout rule enforced"

# CONCLUSION

result: |
  Integrating Clean Code and Refactoring principles into MASTER.yml
  creates a comprehensive code quality governance system:
  
  1. Constitutional rules (Uncle Bob + Fowler)
  2. Automated enforcement (linters, metrics, static analysis)
  3. Adversarial review (personas)
  4. Continuous improvement (Boy Scout Rule, scheduled refactoring)
  
  This ensures that code quality is not negotiable. Every line of code
  must pass through multiple quality gates before being merged. The result
  is a codebase that:
  
  - Others want to work in
  - Can evolve without fear
  - Has low defect rate
  - Maintains velocity over time
  
  Quality is now systematic, not aspirational.
