<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>DILLA Ã— DUB | Lo-Fi Production System v2.1</title>

  <style>

    :root {

      --bg-dark: #0a0a0c;

      --bg-panel: #111114;

      --bg-control: #1a1a1e;

      --accent-dilla: #d4a574;

      --accent-dub: #2d8f6f;

      --accent-flylo: #6b4c9a;

      --text-primary: #e8e8e8;

      --text-dim: #888;

      --border: #2a2a30;

      --glow-dilla: rgba(212, 165, 116, 0.3);

      --glow-dub: rgba(45, 143, 111, 0.3);

    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;

      background: var(--bg-dark);

      color: var(--text-primary);

      min-height: 100vh;

    }

    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    header {
      display: flex;

      justify-content: space-between;

      align-items: center;

      padding: 20px 0;

      border-bottom: 1px solid var(--border);

      margin-bottom: 30px;

      flex-wrap: wrap;

      gap: 15px;

    }

    .logo {
      font-size: 1.8rem;

      font-weight: bold;

      background: linear-gradient(135deg, var(--accent-dilla), var(--accent-dub));

      -webkit-background-clip: text;

      -webkit-text-fill-color: transparent;

    }

    .lcd-display {
      background: #1a1c18;

      border: 2px solid #3a3c38;

      border-radius: 4px;

      padding: 10px 20px;

      color: #7cb342;

      text-shadow: 0 0 10px rgba(124, 179, 66, 0.5);

      display: flex;

      gap: 25px;

      flex-wrap: wrap;

    }

    .lcd-item { display: flex; flex-direction: column; }
    .lcd-label { font-size: 0.6rem; color: #5a5; }

    .lcd-value { font-size: 1.1rem; }

    .panels {
      display: grid;

      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));

      gap: 20px;

    }

    .panel {
      background: var(--bg-panel);

      border: 1px solid var(--border);

      border-radius: 12px;

      padding: 20px;

    }

    .panel-header {
      display: flex;

      justify-content: space-between;

      align-items: center;

      margin-bottom: 15px;

      padding-bottom: 10px;

      border-bottom: 1px solid var(--border);

      flex-wrap: wrap;

      gap: 10px;

    }

    .panel-title {
      font-size: 0.85rem;

      text-transform: uppercase;

      letter-spacing: 2px;

      color: var(--text-dim);

    }

    .panel-title.dilla { color: var(--accent-dilla); }
    .panel-title.dub { color: var(--accent-dub); }

    .panel-title.flylo { color: var(--accent-flylo); }

    .chord-display {
      display: grid;

      grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));

      gap: 10px;

      margin-bottom: 20px;

    }

    .chord-box {
      background: var(--bg-control);

      border: 1px solid var(--border);

      border-radius: 8px;

      padding: 12px 8px;

      text-align: center;

      cursor: pointer;

      transition: all 0.2s;

    }

    .chord-box:hover { border-color: var(--accent-dilla); }
    .chord-box.active {

      border-color: var(--accent-dilla);

      box-shadow: 0 0 15px var(--glow-dilla);

    }

    .chord-name { font-size: 1.2rem; font-weight: bold; }
    .chord-roman { font-size: 0.7rem; color: var(--text-dim); }

    .sequencer {
      display: grid;

      grid-template-columns: 60px repeat(16, 1fr);

      gap: 3px;

      margin-bottom: 20px;

    }

    .seq-label {
      display: flex;

      align-items: center;

      font-size: 0.65rem;

      color: var(--text-dim);

      text-transform: uppercase;

    }

    .seq-step {
      aspect-ratio: 1;

      background: var(--bg-control);

      border: 1px solid var(--border);

      border-radius: 3px;

      cursor: pointer;

      transition: all 0.1s;

      min-width: 16px;

    }

    .seq-step:hover { border-color: var(--accent-dub); }
    .seq-step.active {

      background: var(--accent-dub);

      box-shadow: 0 0 6px var(--glow-dub);

    }

    .seq-step.playing {

      background: var(--accent-dilla);

      transform: scale(1.15);

    }

    .chain-container {
      background: var(--bg-control);

      border-radius: 8px;

      padding: 12px;

      margin-bottom: 15px;

      min-height: 50px;

    }

    .chain-effects {
      display: flex;

      flex-wrap: wrap;

      gap: 6px;

      align-items: center;

    }

    .chain-effect {
      background: linear-gradient(135deg, #2a2a30, #1a1a1e);

      border: 1px solid var(--border);

      border-radius: 5px;

      padding: 6px 10px;

      font-size: 0.7rem;

      display: flex;

      align-items: center;

      gap: 4px;

    }

    .chain-effect .arrow { color: var(--accent-dilla); margin-left: 6px; }
    .chain-effect.bitcrush { border-color: #e74c3c; }

    .chain-effect.saturation { border-color: #f39c12; }

    .chain-effect.lowpass { border-color: #3498db; }

    .chain-effect.vinyl { border-color: #9b59b6; }

    .chain-effect.tape { border-color: #1abc9c; }

    .chain-effect.compression { border-color: #e67e22; }

    .control-row {
      display: flex;

      gap: 12px;

      margin-bottom: 12px;

      flex-wrap: wrap;

    }

    .control-group {
      flex: 1;

      min-width: 120px;

    }

    .control-label {
      font-size: 0.65rem;

      text-transform: uppercase;

      color: var(--text-dim);

      margin-bottom: 4px;

    }

    select, input[type="range"], button {
      background: var(--bg-control);

      border: 1px solid var(--border);

      color: var(--text-primary);

      padding: 8px 12px;

      border-radius: 5px;

      font-family: inherit;

      font-size: 0.8rem;

      cursor: pointer;

      transition: all 0.2s;

      width: 100%;

    }

    select:hover, button:hover { border-color: var(--accent-dilla); }
    button.primary {
      background: linear-gradient(135deg, var(--accent-dilla), var(--accent-dub));

      border: none;

      font-weight: bold;

    }

    button.primary:hover {
      transform: translateY(-1px);

      box-shadow: 0 4px 15px var(--glow-dilla);

    }

    input[type="range"] {
      -webkit-appearance: none;

      height: 6px;

      border-radius: 3px;

      padding: 0;

    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;

      width: 14px;

      height: 14px;

      border-radius: 50%;

      background: var(--accent-dilla);

      cursor: pointer;

    }

    .gear-grid {
      display: grid;

      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));

      gap: 8px;

    }

    .gear-item {
      background: var(--bg-control);

      border: 1px solid var(--border);

      border-radius: 6px;

      padding: 10px;

      cursor: pointer;

      transition: all 0.2s;

      text-align: center;

    }

    .gear-item:hover { border-color: var(--accent-dilla); }
    .gear-item.active {

      border-color: var(--accent-dilla);

      background: linear-gradient(135deg, rgba(212, 165, 116, 0.1), transparent);

    }

    .gear-name { font-size: 0.75rem; font-weight: bold; }
    .gear-bits { font-size: 0.6rem; color: var(--accent-dilla); }

    .gear-char { font-size: 0.55rem; color: var(--text-dim); margin-top: 3px; }

    .aesthetic-grid {
      display: flex;

      flex-wrap: wrap;

      gap: 6px;

    }

    .aesthetic-btn {
      padding: 6px 12px;

      font-size: 0.65rem;

      text-transform: uppercase;

      letter-spacing: 1px;

    }

    .aesthetic-btn.active {
      background: var(--accent-dilla);

      border-color: var(--accent-dilla);

      color: #000;

    }

    .waveform {
      background: var(--bg-control);

      border-radius: 8px;

      height: 80px;

      position: relative;

      overflow: hidden;

    }

    .waveform canvas { width: 100%; height: 100%; }
    .transport {
      display: flex;

      justify-content: center;

      gap: 12px;

      padding: 15px;

      background: var(--bg-panel);

      border-radius: 10px;

      margin-top: 20px;

      flex-wrap: wrap;

    }

    .transport button {
      width: 45px;

      height: 45px;

      border-radius: 50%;

      font-size: 1.1rem;

      display: flex;

      align-items: center;

      justify-content: center;

      padding: 0;

    }

    .transport button.play { background: var(--accent-dub); border: none; }
    .transport button.stop { background: #c0392b; border: none; }

    footer {
      text-align: center;

      padding: 25px;

      color: var(--text-dim);

      font-size: 0.7rem;

      border-top: 1px solid var(--border);

      margin-top: 25px;

    }

    footer a { color: var(--accent-dilla); text-decoration: none; }
    @media (max-width: 600px) {
      .panels { grid-template-columns: 1fr; }

      .sequencer { grid-template-columns: 40px repeat(16, 1fr); }

    }

  </style>

</head>

<body>

  <div class="container">

    <header>

      <div class="logo">DILLA Ã— DUB</div>

      <div class="lcd-display">

        <div class="lcd-item"><span class="lcd-label">BPM</span><span class="lcd-value" id="lcd-bpm">92</span></div>

        <div class="lcd-item"><span class="lcd-label">SWING</span><span class="lcd-value" id="lcd-swing">54%</span></div>

        <div class="lcd-item"><span class="lcd-label">KEY</span><span class="lcd-value" id="lcd-key">Fm</span></div>

        <div class="lcd-item"><span class="lcd-label">GEAR</span><span class="lcd-value" id="lcd-gear">SP1200</span></div>

      </div>

    </header>

    <div class="panels">
      <!-- Chord Progressions -->

      <div class="panel">

        <div class="panel-header">

          <span class="panel-title dilla">Chord Progressions</span>

          <select id="progression-select">

            <optgroup label="J Dilla - Fantastic Vol 2">

              <option value="dilla_fantastic_vol2.fall_in_love">Fall In Love (Fm)</option>

              <option value="dilla_fantastic_vol2.climax">Climax (E)</option>

              <option value="dilla_fantastic_vol2.thelonious">Thelonious (Ebm)</option>

              <option value="dilla_fantastic_vol2.selfish">Selfish (G)</option>

            </optgroup>

            <optgroup label="J Dilla - Donuts">

              <option value="dilla_donuts.time_donut">Time: Donut of the Heart</option>

              <option value="dilla_donuts.workinonit">Workinonit</option>

              <option value="dilla_donuts.lightworks">Lightworks</option>

              <option value="dilla_donuts.stop">Stop!</option>

            </optgroup>

            <optgroup label="J Dilla - Unreleased">

              <option value="dilla_unreleased.worlds_full_of_sadness">Worlds Full of Sadness</option>

              <option value="dilla_unreleased.earth">Earth</option>

              <option value="dilla_unreleased.time">Time</option>

            </optgroup>

            <optgroup label="Flying Lotus - Los Angeles">

              <option value="flying_lotus_la.camel">Camel</option>

              <option value="flying_lotus_la.robertaflack">Roberta Flack</option>

              <option value="flying_lotus_la.gng_bng">GNG BNG</option>

            </optgroup>

            <optgroup label="Madlib">

              <option value="madlib.accordion">Accordion</option>

              <option value="madlib.meat_grinder">Meat Grinder</option>

              <option value="madlib.raid">Raid</option>

            </optgroup>

            <optgroup label="Classic Samples">

              <option value="classics.minnie_riperton">Minnie Riperton - Inside My Love</option>

              <option value="classics.roy_ayers">Roy Ayers - Everybody Loves Sunshine</option>

              <option value="classics.lonnie_liston_smith">Lonnie Liston Smith - Expansions</option>

              <option value="classics.alice_coltrane">Alice Coltrane - Journey in Satchidananda</option>

            </optgroup>

          </select>

        </div>

        <div class="chord-display" id="chord-display"></div>

        <div class="control-row">

          <div class="control-group">

            <div class="control-label">Tempo</div>

            <input type="range" id="tempo" min="60" max="120" value="92">

          </div>

          <div class="control-group">

            <div class="control-label">Swing</div>

            <input type="range" id="swing" min="50" max="75" value="54">

          </div>

        </div>

      </div>

      <!-- Gear Emulation -->
      <div class="panel">

        <div class="panel-header">

          <span class="panel-title dilla">Vintage Gear</span>

        </div>

        <div class="gear-grid" id="gear-grid"></div>

      </div>

      <!-- Drum Sequencer -->
      <div class="panel">

        <div class="panel-header">

          <span class="panel-title dub">Sequencer</span>

          <select id="pattern-select">

            <option value="dilla_lazy">Dilla Lazy</option>

            <option value="dilla_bounce">Dilla Bounce</option>

            <option value="flylo_stutter">FlyLo Stutter</option>

            <option value="madlib_chop">Madlib Chop</option>

            <option value="boom_bap">Boom Bap Classic</option>

            <option value="one_drop">Dub One-Drop</option>

            <option value="steppers">Dub Steppers</option>

          </select>

        </div>

        <div class="sequencer" id="sequencer"></div>

      </div>

      <!-- Random Effect Chain -->
      <div class="panel">

        <div class="panel-header">

          <span class="panel-title flylo">Effect Chain</span>

          <button id="generate-chain" style="width:auto;padding:6px 12px;">ðŸŽ² Generate</button>

        </div>

        <div class="chain-container">

          <div class="chain-effects" id="chain-effects"></div>

        </div>

        <div class="control-label">Aesthetic</div>

        <div class="aesthetic-grid" id="aesthetic-grid"></div>

      </div>

      <!-- Sonitex Processing -->
      <div class="panel">

        <div class="panel-header">

          <span class="panel-title">Sonitex STX-1260</span>

        </div>

        <div class="control-row">

          <div class="control-group">

            <div class="control-label">Distortion</div>

            <input type="range" id="sonitex-dist" min="0" max="100" value="30">

          </div>

          <div class="control-group">

            <div class="control-label">Vinyl Warble</div>

            <input type="range" id="sonitex-warble" min="0" max="100" value="20">

          </div>

        </div>

        <div class="control-row">

          <div class="control-group">

            <div class="control-label">Sibilance</div>

            <input type="range" id="sonitex-sibilance" min="0" max="100" value="40">

          </div>

          <div class="control-group">

            <div class="control-label">Noise</div>

            <input type="range" id="sonitex-noise" min="0" max="100" value="15">

          </div>

        </div>

        <div class="control-row">

          <div class="control-group">

            <div class="control-label">Bits</div>

            <input type="range" id="sonitex-bits" min="8" max="16" value="12">

          </div>

          <div class="control-group">

            <div class="control-label">Rate</div>

            <select id="sonitex-rate">

              <option value="44100">44.1kHz</option>

              <option value="22050" selected>22kHz</option>

              <option value="11025">11kHz</option>

            </select>

          </div>

        </div>

      </div>

      <!-- NastyVCS Console -->
      <div class="panel">

        <div class="panel-header">

          <span class="panel-title">NastyVCS Console</span>

        </div>

        <div class="control-row">

          <div class="control-group">

            <div class="control-label">Transformer</div>

            <input type="range" id="nastyvcs-xfmr" min="0" max="100" value="50">

          </div>

          <div class="control-group">

            <div class="control-label">Saturation</div>

            <input type="range" id="nastyvcs-sat" min="0" max="100" value="30">

          </div>

        </div>

        <div class="control-row">

          <div class="control-group">

            <div class="control-label">AIR EQ</div>

            <input type="range" id="nastyvcs-air" min="-60" max="60" value="15">

          </div>

          <div class="control-group">

            <div class="control-label">LOW EQ</div>

            <input type="range" id="nastyvcs-low" min="-60" max="60" value="20">

          </div>

        </div>

      </div>

    </div>

    <!-- Waveform -->
    <div class="panel" style="margin-top:20px;">

      <div class="waveform"><canvas id="waveform-canvas"></canvas></div>

    </div>

    <!-- Transport -->
    <div class="transport">

      <button class="play" id="btn-play">â–¶</button>

      <button class="stop" id="btn-stop">â– </button>

      <button id="btn-random">ðŸŽ²</button>

      <button id="btn-export">ðŸ’¾</button>

    </div>

    <footer>
      <p>DILLA Ã— DUB v2.1 | J Dilla â€¢ Flying Lotus â€¢ Madlib</p>

      <p>Sonitex STX-1260 â€¢ NastyVCS â€¢ Moog DFAM â€¢ SP-1200 â€¢ MPC3000 â€¢ SP-303</p>

    </footer>

  </div>

<script>
const CONSTANTS = {

  CHAIN_MIN_LENGTH: 3,

  CHAIN_MAX_LENGTH: 7,

  KHZ_DIVISOR: 1000,

  CANVAS_SCALE: 2,

  WAVEFORM_BG: '#1a1a1e'

};

const CONFIG = {
  chords: {

    dilla_fantastic_vol2: {

      fall_in_love: { key:"Fm", bpm:91, chords:["Bbm","Ab","Fm7","Fm"], roman:["iv","bIII","i7","i"] },

      climax: { key:"E", bpm:96, chords:["Emaj7","G#m7","G#m7","G#maj7"], roman:["Imaj7","iii7","iii7","IIImaj7"] },

      thelonious: { key:"Ebm", bpm:92, chords:["Ebm","Bbm"], roman:["i","v"] },

      selfish: { key:"G", bpm:88, chords:["Cmaj7","Bm7","Am7","D7"], roman:["IVmaj7","iii7","ii7","V7"] }

    },

    dilla_donuts: {

      time_donut: { key:"Ab", bpm:94, chords:["Dbmaj7","Cm7","Fm7","Bbm7"], roman:["IVmaj7","iii7","vi7","ii7"] },

      workinonit: { key:"Bm", bpm:93, chords:["Bm7","Em7","F#m7","Bm7"], roman:["i7","iv7","v7","i7"] },

      lightworks: { key:"F#m", bpm:95, chords:["F#m7","C#m7","Dmaj7","E7"], roman:["i7","v7","VImaj7","VII7"] },

      stop: { key:"F#m", bpm:86, chords:["F#m9","Bm9"], roman:["i9","iv9"] }

    },

    dilla_unreleased: {

      worlds_full_of_sadness: { key:"Gm", bpm:78, chords:["Gm9","Cm9","Ebmaj7","D7#9"], roman:["i9","iv9","VImaj7","V7#9"] },

      earth: { key:"Dm", bpm:84, chords:["Dm11","Gm9","Am7","Bbmaj7"], roman:["i11","iv9","v7","VImaj7"] },

      time: { key:"Fm", bpm:82, chords:["Fm9","Bbm7","Dbmaj9","Cm7"], roman:["i9","iv7","VImaj9","v7"] }

    },

    flying_lotus_la: {

      camel: { key:"C", bpm:84, chords:["Cmaj7","Fmaj7","Am7","Em7"], roman:["Imaj7","IVmaj7","vi7","iii7"] },

      robertaflack: { key:"G", bpm:81, chords:["Gmaj9","Am9","Bm7","Cmaj7"], roman:["Imaj9","ii9","iii7","IVmaj7"] },

      gng_bng: { key:"Gm", bpm:103, chords:["Gm7","Cm7","D7","Gm7"], roman:["i7","iv7","V7","i7"] }

    },

    madlib: {

      accordion: { key:"Dm", bpm:96, chords:["Dm","Gm","Am"], roman:["i","iv","v"] },

      meat_grinder: { key:"Cm", bpm:92, chords:["Cm7","Fm7","Gm7","Ab7"], roman:["i7","iv7","v7","VI7"] },

      raid: { key:"Em", bpm:94, chords:["Em7","Am7","Bm7","Cmaj7"], roman:["i7","iv7","v7","VImaj7"] }

    },

    classics: {

      minnie_riperton: { key:"G", chords:["Gmaj7","Am7","Bm7","Cmaj7"], roman:["Imaj7","ii7","iii7","IVmaj7"] },

      roy_ayers: { key:"F", chords:["Fmaj7","Gm7","Am7","Bbmaj7"], roman:["Imaj7","ii7","iii7","IVmaj7"] },

      lonnie_liston_smith: { key:"Gm", chords:["Gm11","Cm9","Fm9","Bb7"], roman:["i11","iv9","bvii9","III7"] },

      alice_coltrane: { key:"Am", chords:["Am9","Dm11","Em7","Fmaj7#11"], roman:["i9","iv11","v7","VImaj7#11"] }

    }

  },

  patterns: {

    dilla_lazy: { kick:[1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], rim:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], swing:54 },

    dilla_bounce: { kick:[1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1], rim:[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1], swing:56 },

    flylo_stutter: { kick:[1,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0], snare:[0,0,0,0,1,0,0,0,0,0,1,0,1,0,0,1], hihat:[1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,0], rim:[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0], swing:52 },

    madlib_chop: { kick:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], rim:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], swing:50 },

    boom_bap: { kick:[1,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], rim:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0], swing:58 },

    one_drop: { kick:[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0], snare:[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], rim:[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0], swing:54 },

    steppers: { kick:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], rim:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], swing:50 }

  },

  gear: {

    sp1200: { name:"SP-1200", bits:12, rate:26040, char:"punchy â€¢ gritty" },

    mpc3000: { name:"MPC3000", bits:16, rate:44100, char:"warm â€¢ precise" },

    sp303: { name:"SP-303", bits:16, rate:22050, char:"lo-fi â€¢ cassette" },

    s950: { name:"S950", bits:12, rate:48000, char:"warm â€¢ classic" },

    mpc60: { name:"MPC60", bits:12, rate:40000, char:"fat â€¢ punchy" },

    mirage: { name:"Mirage", bits:8, rate:30000, char:"extreme lo-fi" },

    emax: { name:"Emax", bits:12, rate:28000, char:"gritty cousin" },

    s900: { name:"S900", bits:12, rate:40000, char:"raw â€¢ gritty" }

  },

  effects: [

    { type:'bitcrush', params:[8,10,12,14], weight:0.8 },

    { type:'lowpass', params:[4000,8000,12000], weight:0.9 },

    { type:'saturation', params:[1.2,1.5,1.8,2.2], weight:0.85 },

    { type:'tape_sat', params:[1.1,1.3,1.5], weight:0.7 },

    { type:'vinyl_noise', params:[0.05,0.1,0.2], weight:0.7 },

    { type:'wow_flutter', params:[0.2,0.4,0.7], weight:0.4 },

    { type:'compression', params:[2,4,6,8], weight:0.75 },

    { type:'reverb', params:[0.2,0.3,0.4], weight:0.3 },

    { type:'delay', params:[125,180,250], weight:0.3 }

  ],

  aesthetics: ['dark','deep','authentic','tape','vinyl','gritty','cosmic','industrial']

};

let state = { playing:false, bpm:92, swing:54, step:0, gear:'sp1200', aesthetic:'authentic', chain:[], audioCtx:null };
function initAudio() {
  if (!state.audioCtx) {

    state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    state.analyser = state.audioCtx.createAnalyser();

    state.analyser.fftSize = 256;

    state.analyser.connect(state.audioCtx.destination);

  }

}

function updateChords(prog) {
  const [cat, track] = prog.split('.');

  const data = CONFIG.chords[cat]?.[track];

  if (!data) return;

  const display = document.getElementById('chord-display');
  display.innerHTML = data.chords.map((c, i) =>

    `<div class="chord-box${i===0?' active':''}"><div class="chord-name">${c}</div><div class="chord-roman">${data.roman[i]}</div></div>`

  ).join('');

  document.getElementById('lcd-key').textContent = data.key;
  if (data.bpm) {

    document.getElementById('tempo').value = data.bpm;

    document.getElementById('lcd-bpm').textContent = data.bpm;

    state.bpm = data.bpm;

  }

}

function buildSequencer() {
  const seq = document.getElementById('sequencer');

  seq.innerHTML = '';

  ['kick','snare','hihat','rim'].forEach(track => {

    seq.innerHTML += `<div class="seq-label">${track.toUpperCase()}</div>`;

    for (let i = 0; i < 16; i++) {

      seq.innerHTML += `<div class="seq-step" data-track="${track}" data-step="${i}"></div>`;

    }

  });

  seq.querySelectorAll('.seq-step').forEach(s => s.addEventListener('click', () => s.classList.toggle('active')));

}

function loadPattern(name) {
  const p = CONFIG.patterns[name];

  if (!p) return;

  ['kick','snare','hihat','rim'].forEach(track => {

    (p[track]||[]).forEach((v, i) => {

      const step = document.querySelector(`.seq-step[data-track="${track}"][data-step="${i}"]`);

      if (step) step.classList.toggle('active', v === 1);

    });

  });

  document.getElementById('swing').value = p.swing || 50;

  document.getElementById('lcd-swing').textContent = (p.swing || 50) + '%';

  state.swing = p.swing || 50;

}

function toggleActiveButton(container, activeButton) {
  container.querySelectorAll('.aesthetic-btn, .gear-item, .chord-box').forEach(el => el.classList.remove('active'));

  activeButton.classList.add('active');

}

function buildGear() {
  const grid = document.getElementById('gear-grid');

  grid.innerHTML = Object.entries(CONFIG.gear).map(([id, g]) =>

    `<div class="gear-item${id===state.gear?' active':''}" data-gear="${id}">

      <div class="gear-name">${g.name}</div>

      <div class="gear-bits">${g.bits}-bit</div>

      <div class="gear-char">${g.char}</div>

    </div>`

  ).join('');

  grid.querySelectorAll('.gear-item').forEach(el => {

    el.addEventListener('click', () => {

      toggleActiveButton(grid, el);

      state.gear = el.dataset.gear;

      document.getElementById('lcd-gear').textContent = el.dataset.gear.toUpperCase();

      document.getElementById('sonitex-bits').value = CONFIG.gear[state.gear].bits;

    });

  });

}

function buildAesthetics() {
  const grid = document.getElementById('aesthetic-grid');

  grid.innerHTML = CONFIG.aesthetics.map(a =>

    `<button class="aesthetic-btn${a===state.aesthetic?' active':''}" data-aesthetic="${a}">${a}</button>`

  ).join('');

  grid.querySelectorAll('.aesthetic-btn').forEach(btn => {

    btn.addEventListener('click', () => {

      toggleActiveButton(grid, btn);

      state.aesthetic = btn.dataset.aesthetic;

      generateChain();

    });

  });

}

function generateChain() {
  const len = CONSTANTS.CHAIN_MIN_LENGTH + Math.floor(Math.random() * (CONSTANTS.CHAIN_MAX_LENGTH - CONSTANTS.CHAIN_MIN_LENGTH + 1));

  const used = new Set();

  state.chain = [];

  for (let i = 0; i < len && CONFIG.effects.length > used.size; i++) {
    const candidates = CONFIG.effects.filter(e => !used.has(e.type));

    const selected = candidates[Math.floor(Math.random() * candidates.length)];

    const param = selected.params[Math.floor(Math.random() * selected.params.length)];

    state.chain.push({ type: selected.type, value: param });

    used.add(selected.type);

  }

  renderChain();
}

function formatChainValue(type, value) {
  if (type === 'lowpass') return (value / CONSTANTS.KHZ_DIVISOR) + 'kHz';

  if (type === 'delay') return value + 'ms';

  return value;

}

function renderChain() {
  const container = document.getElementById('chain-effects');

  container.innerHTML = state.chain.map((e, i) => {

    const val = formatChainValue(e.type, e.value);

    const cls = e.type.replace('_','');

    const arrow = i < state.chain.length - 1 ? '<span class="arrow">â†’</span>' : '';

    return `<div class="chain-effect ${cls}">${e.type}:${val}${arrow}</div>`;

  }).join('');

}

function drawWaveform() {
  const canvas = document.getElementById('waveform-canvas');

  const ctx = canvas.getContext('2d');

  canvas.width = canvas.offsetWidth * CONSTANTS.CANVAS_SCALE;

  canvas.height = canvas.offsetHeight * CONSTANTS.CANVAS_SCALE;

  ctx.scale(CONSTANTS.CANVAS_SCALE, CONSTANTS.CANVAS_SCALE);

  const w = canvas.offsetWidth;

  const h = canvas.offsetHeight;

  function drawFrame() {
    requestAnimationFrame(drawFrame);

    ctx.fillStyle = CONSTANTS.WAVEFORM_BG;

    ctx.fillRect(0, 0, w, h);

    if (state.analyser && state.playing) {
      drawFrequencyBars(ctx, w, h);

    } else {

      drawIdleWave(ctx, w, h);

    }

  }

  drawFrame();

}

function drawFrequencyBars(ctx, w, h) {
  const data = new Uint8Array(state.analyser.frequencyBinCount);

  state.analyser.getByteFrequencyData(data);

  const barW = w / data.length * 2.5;

  let x = 0;

  for (let i = 0; i < data.length; i++) {
    const barH = (data[i] / 255) * h;

    const grad = ctx.createLinearGradient(0, h - barH, 0, h);

    grad.addColorStop(0, '#d4a574');

    grad.addColorStop(1, '#2d8f6f');

    ctx.fillStyle = grad;

    ctx.fillRect(x, h - barH, barW - 1, barH);

    x += barW;

  }

}

function drawIdleWave(ctx, w, h) {
  ctx.beginPath();

  ctx.strokeStyle = '#2d8f6f44';

  ctx.lineWidth = 2;

  for (let x = 0; x < w; x++) {

    const y = h / 2 + Math.sin(x * 0.05 + Date.now() * 0.001) * 15;

    x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);

  }

  ctx.stroke();

}

let sequencerInterval = null;
function startSequencer() {
  if (sequencerInterval) return;

  state.step = 0;

  const msPerStep = (60000 / state.bpm) / 4;

  sequencerInterval = setInterval(() => {

    document.querySelectorAll('.seq-step.playing').forEach(s => s.classList.remove('playing'));

    const activeSteps = document.querySelectorAll(`.seq-step[data-step="${state.step}"].active`);

    activeSteps.forEach(s => {

      s.classList.add('playing');

      playSound(s.dataset.track);

    });

    state.step = (state.step + 1) % 16;

  }, msPerStep);

}

function stopSequencer() {
  if (sequencerInterval) {

    clearInterval(sequencerInterval);

    sequencerInterval = null;

  }

  document.querySelectorAll('.seq-step.playing').forEach(s => s.classList.remove('playing'));

}

function playSound(track) {
  if (!state.audioCtx) return;

  const osc = state.audioCtx.createOscillator();

  const gain = state.audioCtx.createGain();

  const freqs = { kick: 55, snare: 200, hihat: 8000, rim: 300 };
  osc.frequency.value = freqs[track] || 440;

  osc.type = track === 'hihat' ? 'square' : 'sine';

  gain.gain.setValueAtTime(0.3, state.audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, state.audioCtx.currentTime + 0.1);

  osc.connect(gain);
  gain.connect(state.analyser);

  osc.start();

  osc.stop(state.audioCtx.currentTime + 0.1);

}

function randomizeAll() {
  const patterns = Object.keys(CONFIG.patterns);

  document.getElementById('pattern-select').value = patterns[Math.floor(Math.random() * patterns.length)];

  loadPattern(document.getElementById('pattern-select').value);

  const gears = Object.keys(CONFIG.gear);
  const g = gears[Math.floor(Math.random() * gears.length)];

  document.querySelectorAll('.gear-item').forEach(e => e.classList.toggle('active', e.dataset.gear === g));

  state.gear = g;

  document.getElementById('lcd-gear').textContent = g.toUpperCase();

  state.aesthetic = CONFIG.aesthetics[Math.floor(Math.random() * CONFIG.aesthetics.length)];
  document.querySelectorAll('.aesthetic-btn').forEach(b => b.classList.toggle('active', b.dataset.aesthetic === state.aesthetic));

  generateChain();

}

document.addEventListener('DOMContentLoaded', () => {
  buildSequencer();

  buildGear();

  buildAesthetics();

  loadPattern('dilla_lazy');

  updateChords('dilla_fantastic_vol2.fall_in_love');

  generateChain();

  drawWaveform();

  document.getElementById('progression-select').addEventListener('change', e => updateChords(e.target.value));
  document.getElementById('pattern-select').addEventListener('change', e => loadPattern(e.target.value));

  document.getElementById('generate-chain').addEventListener('click', generateChain);

  document.getElementById('tempo').addEventListener('input', e => {

    state.bpm = +e.target.value;

    document.getElementById('lcd-bpm').textContent = state.bpm;

  });

  document.getElementById('swing').addEventListener('input', e => {

    state.swing = +e.target.value;

    document.getElementById('lcd-swing').textContent = state.swing + '%';

  });

  document.getElementById('btn-play').addEventListener('click', () => {

    initAudio();

    state.playing = !state.playing;

    document.getElementById('btn-play').textContent = state.playing ? 'â¸' : 'â–¶';

    if (state.playing) {

      startSequencer();

    } else {

      stopSequencer();

    }

  });

  document.getElementById('btn-stop').addEventListener('click', () => {

    state.playing = false;

    state.step = 0;

    stopSequencer();

    document.getElementById('btn-play').textContent = 'â–¶';

  });

  document.getElementById('btn-random').addEventListener('click', randomizeAll);

});

document.addEventListener('keydown', e => {
  if (e.code === 'Space') { e.preventDefault(); document.getElementById('btn-play').click(); }

  if (e.code === 'Escape') document.getElementById('btn-stop').click();

  if (e.code === 'KeyR') document.getElementById('btn-random').click();

});

</script>

</body>

</html>

