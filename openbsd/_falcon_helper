#!/bin/ksh
# Falcon helper to wrap Falcon inside rcctl(8)
# Replaces puma/pumactl with falcon start/stop/restart

command=$1
restricted_user=$2
app=$3
port=$4

app_path="/home/${restricted_user}/rails/${app}"
pid_file="${app_path}/tmp/pids/falcon.pid"

cd "$app_path" || exit 1

case "$command" in
  start)
    doas -u "$restricted_user" env \
      PORT="$port" \
      RAILS_ENV=production \
      GEM_HOME="/home/${restricted_user}/.gem" \
      bundle exec falcon host &
    ;;
  status)
    if [ -f "$pid_file" ]; then
      pid=$(cat "$pid_file")
      if ps -p "$pid" > /dev/null 2>&1; then
        echo "${app}(ok)"
        exit 0
      fi
    fi
    echo "${app}(stopped)"
    exit 1
    ;;
  restart|phased-restart)
    doas -u "$restricted_user" env \
      PORT="$port" \
      RAILS_ENV=production \
      GEM_HOME="/home/${restricted_user}/.gem" \
      bundle exec falcon restart
    ;;
  stop)
    if [ -f "$pid_file" ]; then
      pid=$(cat "$pid_file")
      kill "$pid" 2>/dev/null
      rm -f "$pid_file"
    fi
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|status} user app port"
    exit 1
    ;;
esac
