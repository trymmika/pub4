<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>Beats</title>
<style>
*{margin:0;padding:0}
body{background:#000;color:#fff;font:14px monospace;padding:10px}
button{background:none;border:1px solid #333;color:#fff;padding:5px 10px;margin:5px;cursor:pointer;font:inherit}
button:hover{border-color:#fff}
button.on{border-color:#fff;background:#222}
#log{margin-top:20px;opacity:.5;white-space:pre-wrap}
</style>
</head>
<body>
<button id="play">play</button>
<button id="drums">drums</button>
<button id="stop">stop</button>
<div id="log"></div>
<script>
const log=t=>document.getElementById('log').textContent+=t+'\n';
const Pads={
  syn:null,playing:false,idx:0,
  progs:{
    a:[['Db2','Ab3','C4','Eb4'],['C2','Bb3','Eb4','G4'],['F2','Eb3','Ab3','C4'],['Bb1','Ab3','Db4','F4']],
    b:[['Eb3','Gb3','Bb3','Db4'],['Ab3','B3','Eb4','Gb4'],['F3','Ab3','C4','Eb4'],['Bb3','Db4','F4','Ab4']],
    c:[['A3','C4','E4','G4'],['E3','G3','B3','D4'],['B3','D4','F#4','A4'],['F#3','A3','C#4','E4']]
  },
  list:[{n:'a',t:72,l:4},{n:'b',t:94,l:3},{n:'c',t:95,l:3}],
  async init(){
    if(typeof Tone==='undefined'){await new Promise((r,j)=>{const s=document.createElement('script');
      s.src='https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js';s.onload=r;s.onerror=j;document.head.appendChild(s);});}
    await Tone.start();
    this.syn=new Tone.PolySynth(Tone.Synth,{maxPolyphony:4,oscillator:{type:'triangle'},envelope:{attack:1,decay:0.5,sustain:0.4,release:2}}).toDestination();
    this.syn.volume.value=-12;
    log('pads ready');
  },
  async play(){
    if(!this.syn)await this.init();
    this.playing=true;this.idx=0;this.next();
  },
  next(){
    if(!this.playing||this.idx>=this.list.length){if(this.playing){this.idx=0;}else return;}
    const item=this.list[this.idx],prog=this.progs[item.n];
    Tone.Transport.stop();Tone.Transport.cancel();Tone.Transport.bpm.value=item.t;
    let ci=0;const total=prog.length*item.l;
    log(item.n+' @'+item.t);
    const go=time=>{if(!this.playing)return;this.syn.releaseAll(time-0.05);
      this.syn.triggerAttackRelease(prog[ci%prog.length],'1m',time);ci++;
      if(ci<total)Tone.Transport.scheduleOnce(go,'+1m');
      else Tone.Transport.scheduleOnce(()=>{this.idx++;this.next();},'+1m');};
    Tone.Transport.scheduleOnce(go,'+0.1');
    if(Tone.Transport.state!=='started')Tone.Transport.start();
  },
  stop(){this.playing=false;if(this.syn)this.syn.releaseAll();Tone.Transport.stop();Tone.Transport.cancel();log('stopped');}
};
const Drums={
  k:null,s:null,h:null,playing:false,pats:[],
  async init(){
    if(typeof Tone==='undefined')await Pads.init();
    await Tone.start();
    this.k=new Tone.MembraneSynth({pitchDecay:0.1,octaves:2}).toDestination();this.k.volume.value=-18;
    this.s=new Tone.NoiseSynth({noise:{type:'pink'},envelope:{attack:0.003,decay:0.1,sustain:0,release:0.05}}).toDestination();this.s.volume.value=-16;
    this.h=new Tone.NoiseSynth({noise:{type:'white'},envelope:{attack:0.001,decay:0.02,sustain:0,release:0.01}}).toDestination();this.h.volume.value=-22;
    Tone.Transport.swing=0.2;log('drums ready');
  },
  async play(tempo=90){
    if(!this.k)await this.init();
    this.pats.forEach(p=>{p.stop();p.dispose();});this.pats=[];
    this.playing=true;Tone.Transport.bpm.value=tempo;
    const kp=new Tone.Sequence((t,n)=>{if(n)this.k.triggerAttackRelease(n,'8n',t);},['C1',null,null,'C1',null,null,null,null,'C1',null,null,null,null,null,null,null],'16n');
    const sp=new Tone.Sequence((t,n)=>{if(n)this.s.triggerAttackRelease('8n',t);},[null,null,null,null,1,null,null,null,null,null,null,null,1,null,null,null],'16n');
    const hp=new Tone.Sequence((t,v)=>{this.h.volume.value=-22+(v*4);this.h.triggerAttackRelease('32n',t);},[1,.3,.6,.3,.9,.3,.5,.4,1,.3,.6,.3,.9,.3,.5,.3],'16n');
    kp.humanize='15ms';sp.humanize='10ms';hp.humanize='8ms';
    kp.start(0);sp.start(0);hp.start(0);this.pats=[kp,sp,hp];
    if(Tone.Transport.state!=='started')Tone.Transport.start();log('drums @'+tempo);
  },
  stop(){this.playing=false;this.pats.forEach(p=>{p.stop();p.dispose();});this.pats=[];log('drums stopped');}
};
document.getElementById('play').onclick=async()=>{await Pads.play();document.getElementById('play').classList.add('on');};
document.getElementById('drums').onclick=async()=>{const b=document.getElementById('drums');if(Drums.playing){Drums.stop();b.classList.remove('on');}else{await Drums.play(Pads.list[Pads.idx||0]?.t||90);b.classList.add('on');}};
document.getElementById('stop').onclick=()=>{Pads.stop();Drums.stop();document.querySelectorAll('button').forEach(b=>b.classList.remove('on'));};
</script>
</body>
</html>
