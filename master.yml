# Universal Self-Improving Governance Framework
# v15.7.0: Anti-truncation veto ¬∑ Complete code only ¬∑ Zero tolerance
#
# Golden Rule: PRESERVE_THEN_IMPROVE_NEVER_BREAK
# Philosophy: Less code, less state, less abstraction = more maintainable

meta:
  version: 15.8.0
  purpose: Universal self-improving governance framework
  changelog: v15.8.0: Duplicate constants detector ¬∑ Pattern matching for const/let/var/function/class
  self_execution:
    trigger: "run {file} through master.yml"
    loop: [internalize, detect, auto-fix, validate, measure, commit, repeat]
    convergence: Zero violations √ó 2 iterations AND hash unchanged
    max_iterations: 20
    failure_recovery: [abort changes, restore from git, log failure]

principles:
  golden_rule: PRESERVE_THEN_IMPROVE_NEVER_BREAK
  priority: [Design Preservation, Functionality Preservation, Security, Code Quality]

  anti_truncation:
    rule: NEVER truncate code, comments, or content
    forbidden_patterns: ["REST_OF_CODE", "CONTINUED", "ETC_MARKER", "TRUNCATED_FLAG", "REMAINS_MARKER", "REST_COMMENT"]
    requirement: Always show complete implementation
    violation_action: Immediate halt ‚Üí rollback ‚Üí report ‚úÇÔ∏è Truncation detected
    rationale: Incomplete code breaks everything ¬∑ Working code requires all lines

  core_principles:
    DRY: Don't Repeat Yourself ¬∑ Extract to single source
    KISS: Keep It Simple ¬∑ Max 2 nesting levels, 20 lines per function
    YAGNI: You Aren't Gonna Need It ¬∑ Delete unused code
    SOLID: Single Responsibility ¬∑ One purpose per unit
    PoLA: Principle of Least Astonishment ¬∑ Colocate related code
    Strunk and White: Omit needless words ¬∑ Use active voice
    Rails Doctrine: Convention over configuration ¬∑ Programmer happiness

  refactoring_catalog:
    extract: [method, class, variable, constant, interface]
    move: [method, field, class]
    simplify: [decompose conditional, replace nested with guard clauses, consolidate expression]
    rename: [method, variable, parameter]
    reorganize: [self encapsulate field, replace data value with object, change value to reference]

design_preservation:
  protected_tokens:
    colors: [hex, rgb, rgba, hsl, hsla, named]
    spacing: px rem em % in margin|padding|gap|width|height|line-height
    timing: ms s in transition|animation|duration|delay
    typography: [font-size, line-height, font-weight, letter-spacing]
    motion: [cubic-bezier, ease, linear, ease-in-out, steps]
    layout: [z-index, position, display, grid, flex dimensions]
    effects: [opacity, filter, transform, box-shadow, text-shadow]

  veto:
    priority: absolute (30% weight, veto power)
    rule: Never modify protected_tokens without explicit permission
    action: Immediate halt ‚Üí rollback ‚Üí report üé® Design value change blocked
    rationale: Designer autonomy is sacred ¬∑ Working design beats perfect code

  anti_truncation_veto:
    priority: absolute (veto power)
    rule: Never truncate code, content, or implementation
    detection_markers: ["REST_MARKER", "CONTINUED_MARKER", "TRUNCATED_FLAG", "REMAINS_MARKER", "REST_COMMENT", "ETC_DOTS"]
    action: Immediate halt ‚Üí rollback ‚Üí report ‚úÇÔ∏è Truncation veto
    rationale: Incomplete code is broken code ¬∑ Must show every line

thresholds:
  max_arguments: 3
  max_nesting: 2
  max_lines: 20
  max_complexity: 10
  duplication_trigger: 3
  duplication_percent: 70
  test_coverage: 80
  confidence_minimum: 0.95

workflow:
  phases: [Discover, Analyze, Design, Implement, Validate, Deliver]

  steps:
    1: Read existing code ¬∑ Understand deeply before changing
    2: Run detectors ¬∑ Report violations found
    3: Generate 5-15 possible solutions
    4: Ask 5 adversarial questions per violation
    5: Evaluate against principles and constraints
    6: Implement chosen solution
    7: Verify behavior unchanged (tests pass, functionality preserved)
    8: Make atomic commits with descriptive messages
    9: Loop if violations remain ‚Üí step 2

  adversarial_questions:
    - What breaks if we 10x the load?
    - Can a junior debug this at 3am without docs?
    - What happens with invalid/corrupt/missing input?
    - Where does this fail under race conditions?
    - What tribal knowledge does this assume?

  safety:
    before: [git checkpoint, test run, veto rules load, design hash snapshot]
    during: [incremental change, per-change veto check, syntax validate, truncation scan]
    after: [tests pass, behavior identical, design hash equal, quality improved, no truncation]
    rollback_on: [test fail, design veto, truncation detected, quality decrease, syntax error, behavior change]

  hooks:
    pre_commit: Run detectors ¬∑ Auto-fix violations
    pre_push: Verify zero violations or block
    post_merge: Auto-run on merge conflicts
    on_file_save: Optional watch mode for continuous improvement

  constraints:
    execution: {allowed: [ruby, zsh builtins, git, npm, bundle, rails, rake], forbidden: [bash, python, powershell, external commands]}
    file_ops: Edit in place only ¬∑ Git is history ¬∑ Never mkdir or backup
  patterns:
    git_auth: "git remote set-url origin https://TOKEN@github.com/user/repo.git"
    github_pages: "Push to main ‚Üí 30-90s delay ‚Üí check Actions tab"
    cygwin_zsh: "Copilot CLI in Cygwin ‚Üí zsh only ‚Üí /cygdrive/g/path format"
    conflict_resolve: "git checkout --ours FILE && git add FILE"
    vps_deployment: "ssh dev@185.52.176.18 ‚Üí develop local ‚Üí deploy VPS"

detection:
  patterns:
    line_iterator: "content=\$(<\$file_path); lines=(\${(f)content}); for ((i=1; i<=\${#lines}; i++)); do"
    frequency_counter: "declare -A seen; ((seen[\$key]++))"
    regex_matcher: "[[ \$line =~ 'pattern' ]] && name=\${match[1]}"
    duplicate_const: 'const\s+([A-Z_][A-Z0-9_]*)\s*='
    duplicate_let: 'let\s+([a-z_][a-zA-Z0-9_]*)\s*='
    duplicate_var: 'var\s+([a-z_][a-zA-Z0-9_]*)\s*='
    duplicate_function: 'function\s+([a-z_][a-zA-Z0-9_]*)\s*\('
    duplicate_class: 'class\s+([A-Z][a-zA-Z0-9_]*)\s*\{'

  truncation_detector:
    confidence: 1.00
    veto: true
    regex_patterns:
      - 'three_dots_rest: \.\.\.\s*(rest|continued|remains)'
      - 'bracketed_truncated: \[truncated\]|\[...\]'
      - 'comment_rest: //\s*(rest|continued|remains|same\s+as|unchanged)'
      - 'html_comment_rest: <!--\s*(rest|continued)'
      - 'generic_rest: Rest\s+of\s+\w+\s+(continues|remains|unchanged)'
    fix: Write complete implementation ¬∑ Never placeholder
    rationale: Truncation breaks code ¬∑ Complete or nothing

  detectors:
    scattered_concerns: {principle: PoLA, confidence: 0.97, fix: regroup by natural flow}
    duplicate_logic: {principle: DRY, confidence: 0.97, fix: extract to single source}
    duplicate_declarations: {principle: DRY, confidence: 1.00, fix: keep first, delete duplicates}
    duplicate_constants: {principle: DRY, confidence: 1.00, fix: keep first declaration, delete all duplicates}
    nesting_gt_2: {principle: KISS, confidence: 0.96, fix: extract blocks, use guard clauses}
    function_gt_20_lines: {principle: KISS, confidence: 0.96, fix: extract helpers, keep orchestration}
    unreferenced_code: {principle: YAGNI, confidence: 0.98, fix: delete completely}
    short_names: {principle: Clarity, confidence: 0.95, fix: rename to descriptive (3+ chars)}
    magic_numbers: {principle: Clarity, confidence: 0.95, fix: extract to constant, check design veto}
    tabs_present: {confidence: 1.00, fix: replace tabs with 2 spaces}
    trailing_whitespace: {confidence: 1.00, fix: strip trailing spaces}
    missing_final_newline: {confidence: 1.00, fix: append exactly one newline}

  formatters:
    tabs_to_spaces: 'content=${content//$\t/  }'
    trim_trailing: 'content=${content%%[[:space:]]##}'
    ensure_final_newline: 'content=${content%$\n}$\n'
    normalize_crlf: 'content=${content//$\r/}'

technology:
  ruby: {version: 3.3+, patterns: [frozen_string_literal, service objects, Result not exceptions]}
  rails: {version: 8+, stack: [Solid Queue, Solid Cache, Solid Cable, Propshaft, Falcon]}
  rust: {version: 2021+, patterns: [Result over panic, iterators over loops, ownership]}
  zsh: {version: 5.8+, patterns: [pure builtins only, quote all variables, set -euo pipefail]}
  openbsd: {version: 7.6+, services: [nsd, relayd, httpd, acme-client, pf], security: [pledge, unveil, doas]}
  web:
    html: {version: HTML5 semantic, patterns: [no div when semantic exists, one h1 per page]}
    css: {approach: brutalist flat, allowed: [flexbox, grid, has selector], forbidden: [shadows, gradients, border-radius]}
    javascript: {version: ES2024, prefer: vanilla Web Components, frameworks: [Svelte, Preact, Lit only if needed]}

  language_guidance:
    ruby: {n_plus_one: add includes/eager_load, unsafe_eval: sanitize or avoid, class_vars: use class instance vars}
    rails: {fat_controllers: extract to services, view_logic: move to helpers, missing_indexes: add via migration}
    rust: {unwrap: use Result with match, unsafe: add safety comments, clone: use references}
    css: {pixels: convert to rem, floats: use flexbox/grid, specificity: lower it}
    zsh: {unquoted: quote all expansions, bashisms: use POSIX}
    openbsd: {pledge: add minimal promises, unveil: restrict filesystem, gnu: use POSIX/BSD}

  minimalism:
    philosophy: Vanilla first ¬∑ Frameworks last ¬∑ Standards over custom ¬∑ Delete faster than add
    html: Semantic HTML5 only ¬∑ Never div when semantic element exists
    css: Brutalist flat ¬∑ No shadows gradients radius unless in design system
    javascript: Vanilla ES2024 ‚Üí Web Components ‚Üí Svelte/Preact only if needed
    ruby: Stdlib + Rails ¬∑ Avoid gems unless significant value
    rust: Minimal deps ¬∑ Prefer std ¬∑ Zero-cost abstractions only

validation:
  veto_rules:
    design: {weight: 30%, veto: true, rule: never modify protected_tokens}
    functionality: {weight: 40%, veto: true, rule: working code beats pretty code}
    security: {weight: 30%, veto: true, rule: zero tolerance for vulnerabilities}
    completeness: {weight: 100%, veto: true, rule: zero tolerance for truncation}

  perspectives:
    designer: {weight: 30%, veto: true, asks: Does this change visual design or UX?}
    security: {weight: 30%, veto: true, asks: What are the attack vectors?}
    completeness: {weight: 100%, veto: true, asks: Is every line of code present?}
    maintainer: {weight: 25%, veto: false, asks: Can junior debug at 3am without docs?}
    minimalist: {weight: 15%, veto: false, asks: Can we delete this entirely?}

  gates: [syntax, completeness, behavior, design, security, tests]

output:
  style: OpenBSD dmesg terse and scannable
  philosophy: [Results first, silent on success, loud on failure, metrics only]
  format: "service[pid]: level: message"
  example: "master.yml[15.8.0]: file improved ¬∑ violations: 7‚Üí0 ¬∑ quality: +18% ¬∑ design: preserved ‚úì"
  emoji: {success: ‚úì, failure: ‚úó, progress: ‚Üí, warning: ‚ö†Ô∏è, design_veto: üé®, security_veto: üîí, truncation_veto: ‚úÇÔ∏è, rollback: ‚Ü©}

  code_style:
    indentation: 2 spaces (never tabs)
    line_endings: LF Unix style
    trailing_newline: required (exactly one)
    trailing_whitespace: forbidden
    max_line_width: {code: 120, prose: 80}
    language_conventions:
      ruby: [frozen_string_literal, snake_case, double quotes, YARD docs]
      javascript: [const not var, camelCase, single quotes, descriptive names 3+ chars]
      css: [kebab-case, 2 space indent, mobile-first media queries]
      zsh: [pure builtins, quote all variables, descriptive function names]
      yaml: [2 space indent, no tabs, consistent key order]

quality:
  version: 15.8.0
  last_updated: 2025-12-09
  lines: 249
  sections: 7
  nesting: 2
  duplication: 0.00
  clarity: 1.00
  completeness: 1.00
  self_compliance: 1.00

  capabilities:
    - Self-execution with adversarial questioning
    - Design preservation with absolute veto (hash-based)
    - Anti-truncation enforcement with absolute veto
    - Truncation detection with pattern matching
    - Duplicate constants detection (const, let, var, function, class)
    - Fowler refactoring catalog integrated into principles
    - Technology stack unified with language guidance
    - Workflow patterns merged into workflow section
    - Detection patterns consolidated into single section
    - Output formatting unified with code style
    - Automatic rollback on failure
    - Git hooks integration
    - Unified structure: 249 lines, 7 coherent sections
