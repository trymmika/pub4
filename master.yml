---
version: "69.0.0"

meta:
  title: "CONVERGENCE"
  subtitle: "Autonomous Code Evolution Framework"
  description: "Philosophy that compiles - iterative convergence to optimal solutions through evidence-based principles"
  changelog:
    "69.0.0": "Added enforcement.require_full_validation, ruby_beauty, rails_doctrine, writing_principles (Strunk & White), html_css_principles, ui_ux_principles (Nielsen), large_html_documents with inline CSS/JS patterns"
    "68.0.0": "Added execution_flow orchestration - bootstrap, validation, feedback loops, integration points"
    "67.0.0": "Added file_operations.anti_sprawl, comments rules, self-protection"
  self_run_safe: true
  immutable_sections:
    - golden_rule
    - principles
    - detectors

  enforcement_reminder:
    critical: "Before EVERY command, verify tool is allowed"
    allowed_tools: [ruby, zsh, grep, cat, sort, git, npm, bundle, rails, rake]
    banned_tools: [python, bash, sed, awk, wc, head, tail, find, sudo]
    mandate: "Choose intelligently - Ruby for logic/analysis, Zsh for file ops"
    shell_strategy: "ZSH FIRST, PowerShell fallback - saves tokens, follows principles"
    decision_framework:
      use_ruby_for: [code_analysis, parsing, complex_logic, AST_operations, Ruby_introspection]
      use_zsh_for: [line_counting, text_filtering, simple_patterns, file_reading, array_ops, git_operations, file_system]
      use_powershell_for: [fallback_only, when_zsh_unavailable, Windows_specific]
      never_use: [python, bash, awk, sed, wc_command]
    violation_examples:
      wrong: ["python -c", "wc -l", "head -n", "bash -c", "sed 's'", "Get-Content (when zsh works)"]
      correct: ["ruby -e", "zsh -c 'print ${#lines}'", "zsh -c '${lines[1,20]}'", "zsh -c 'git status'"]

  self_discovery:
    purpose: "Enable LLMs to find, load, and verify this configuration autonomously"
    canonical_path: "~/pub/master.yml"
    alternative_paths: ["./master.yml", "../master.yml", "G:/pub/master.yml"]

    bootstrap_protocol:
      step_1: "Read entire file from canonical_path"
      step_2: "Verify meta.version matches v65.0.0+"
      step_3: "Internalize all sections into working memory"
      step_4: "Activate adherence_enforcement protocols"
      step_5: "Confirm: 'master.yml v65.0.0 loaded, enforcement: strict'"

    verification:
      quick_check: "Cite meta.version"
      deep_check: "Trace a decision through principles"
      compliance_check: "Explain golden_rule verbatim"
      failure_mode: "Reload and re-internalize completely"

golden_rule: "PRESERVE_THEN_IMPROVE_NEVER_BREAK"

self_protection:
  enabled: true
  backup_before_modify: true
  min_principle_count: 50
  validation_rules:
    - "golden_rule must exist"
    - "principles section immutable - add only, never modify or delete"
    - "version must increment on changes"
  on_violation:
    action: "restore_from_backup"
    log_path: "~/.convergence/safety.log"

constants:
  limits:
    coverage: 0.8
    complexity: 10
    convergence: 0.001
    iterations: 20
    coupling: 5
    duplication: 0.03
    nesting_depth: 4
    section_count: 9

  evidence_weights:
    tests: 0.50
    static_analysis: 0.30
    complexity_checks: 0.20

  costs:
    claude_sonnet_input: 0.003
    claude_sonnet_output: 0.015
    claude_opus_input: 0.015
    claude_opus_output: 0.075
    developer_hour: 100
    deployment_failure: 5000

  phase_io:
    discover: {in: problem, out: definition}
    analyze: {in: definition, out: analysis}
    ideate: {in: analysis, out: options}
    design: {in: options, out: plan}
    implement: {in: plan, out: code}
    validate: {in: code, out: verified}
    deliver: {in: verified, out: deployed}
    learn: {in: deployed, out: knowledge}

principles:
  foundational:

    evidence_over_opinion:
      value: true
      rationale: "Opinions scale poorly, evidence scales linearly with investment"
      formula: "tests×50% + static_analysis×30% + complexity×20% ≥ 100%"
      application: "Every claim requires authoritative source citation"

    chestertons_fence:
      value: true
      rationale: "Don't remove until you understand WHY it exists"
      rule: "If can't explain reason in 2 sentences, don't delete yet"
      lesson: "Removed 'unnecessary' rate limiting → DDoS took down prod 3 hours"

    inverted_thinking:
      value: true
      rationale: "Start with 'what if we DON'T build this?' prevents feature bloat"
      technique: "Apply all 10 adversarial personas BEFORE writing code"

    pareto_80_20:
      value: true
      rationale: "80% value from 20% effort - ruthlessly prioritize"
      application: "Focus on 20% of code handling 80% of traffic"

    lindy_effect:
      value: true
      rationale: "Code surviving 5 years will likely survive 5 more"
      rule: "Default to POSIX/C stdlib over new framework"
      evidence: "OpenBSD base tools unchanged since 1990s, still best-in-class"

    worse_is_better:
      value: true
      rationale: "Simplicity of implementation > theoretical purity"
      example: "Unix pipes (simple, composable) > Lisp (elegant, monolithic)"

    galls_law:
      value: true
      rationale: "Complex systems that work evolved from simple systems that worked"
      rule: "Start with 100-line prototype, grow to production"
      antipattern: "6-month 'big bang' rewrite that never ships"

    conways_law:
      value: true
      rationale: "System structure mirrors org structure"
      implication: "3-person team? Don't design 7-microservice architecture"

    hyrums_law:
      value: true
      rationale: "All observable behaviors will be depended upon by someone"
      rule: "Deprecation warnings 6 months before breaking changes"
      example: "Bug fix broke 12% of API consumers who depended on the bug"

    postel_law:
      value: true
      rationale: "Be conservative in what you send, liberal in what you accept"
      implementation: "Validate outputs strictly, parse inputs leniently"
      exception: "Strict validation for untrusted input"

    occams_razor:
      value: true
      rationale: "Simplest explanation usually correct"
      application: "If 2 solutions work, choose one with fewer moving parts"
      metric: "Count: dependencies, classes, config files, deployment steps"

  code_quality:
    dry:
      name: "Don't Repeat Yourself"
      rationale: "Every piece of knowledge has single, unambiguous, authoritative representation"
      trigger: duplication_3_times_or_70_percent_similarity
      action: extract_to_single_source
      detector: duplicate_code_detector

    kiss:
      name: "Keep It Simple"
      rationale: "Simplicity should be key goal, unnecessary complexity avoided"
      trigger: complexity_exceeds_10_or_nesting_exceeds_2
      action: simplify_or_flatten
      detector: complexity_detector

    yagni:
      name: "You Aren't Gonna Need It"
      rationale: "Don't add functionality until necessary"
      trigger: unused_code_detected
      action: remove_completely
      detector: unreferenced_code_detector

    solid:
      S: "Single Responsibility - one reason to change"
      O: "Open/Closed - open for extension, closed for modification"
      L: "Liskov Substitution - subtypes substitutable for base types"
      I: "Interface Segregation - many specific over one general"
      D: "Dependency Inversion - depend on abstractions not concretions"
      rationale: "Foundation of maintainable object-oriented design"

    clarity_over_cleverness:
      value: true
      rationale: "Code read 10x more than written - optimize for reading"
      rule: "If clever code needs comment, rewrite to be obvious"

    explicit_over_implicit:
      value: true
      rationale: "Implicit behavior = tribal knowledge = fragility"
      application: "Magic should be documented, not hidden"

    fail_fast:
      value: true
      context: development
      rationale: "Crash early to expose bugs during development"

    fail_secure:
      value: true
      context: production
      rationale: "Safe degradation, no data loss in production"

    fail_loudly:
      value: true
      context: observability
      rationale: "Log everything for debugging and monitoring"

  architecture:
    composition_over_inheritance:
      value: true
      rationale: "Inheritance = tight coupling, composition = flexibility"
      rule: "Default to composition, use inheritance only for true is-a relationships"

    law_of_demeter:
      value: true
      rule: "Object should only talk to immediate friends, not strangers"
      antipattern: "user.address.city.zip_code"
      fix: "user.zip_code (delegate through chain)"

    separation_of_concerns:
      value: true
      rationale: "Each module handles ONE aspect of functionality"
      application: "MVC keeps view/model/controller separate"

    dependency_inversion:
      value: true
      rule: "Depend on abstractions (interfaces) not concretions (implementations)"
      benefit: "Swap implementations without changing dependent code"

    open_closed:
      value: true
      rule: "Open for extension, closed for modification"
      technique: "Add behavior via inheritance/composition, not by editing existing code"

    interface_segregation:
      value: true
      rule: "Many specific interfaces > one general interface"
      antipattern: "God interface with 50 methods, clients use 3"

    single_responsibility:
      value: true
      rule: "Class should have one reason to change"
      test: "Can you describe class purpose in one sentence without 'and'?"

  performance:
    premature_optimization:
      value: false
      rule: "Measure first, optimize bottlenecks only"
      quote: "Premature optimization is root of all evil"

    cache_invalidation:
      value: true
      rule: "Only 2 hard things: cache invalidation, naming, off-by-one errors"
      strategy: "TTL-based expiration, explicit invalidation on writes"

    n_plus_one_queries:
      value: true
      detector: "Watch for loops making DB queries"
      fix: "Use eager loading, batch queries, caching"

    database_indexes:
      value: true
      rule: "Index foreign keys, query WHERE/ORDER BY columns"
      antipattern: "Full table scans on million-row tables"

  security:
    least_privilege:
      value: true
      rule: "Grant minimum permissions needed for task"
      application: "Read-only DB user for analytics, write for app"

    defense_in_depth:
      value: true
      rationale: "Multiple security layers - if one fails, others protect"
      layers: [input_validation, authentication, authorization, encryption, logging]

    input_validation:
      value: true
      rule: "Never trust user input - validate, sanitize, escape"
      vectors: [sql_injection, xss, command_injection, path_traversal]

    security_by_obscurity:
      value: false
      rule: "Hiding implementation details is not security"
      real_security: [encryption, authentication, authorization, audit_logging]

  testing:
    test_pyramid:
      value: true
      structure: "Many unit tests, fewer integration, few E2E"
      rationale: "Unit tests fast/cheap, E2E slow/expensive"
      ratio: "70% unit, 20% integration, 10% E2E"

    test_isolation:
      value: true
      rule: "Tests independent, run in any order"
      antipattern: "Test B depends on Test A's side effects"

    test_naming:
      value: true
      pattern: "test_method_when_condition_then_expected"
      example: "test_withdraw_when_insufficient_funds_then_raises_error"

    test_coverage:
      value: true
      minimum: 0.8
      rationale: "80% coverage catches most bugs, 100% diminishing returns"

  maintenance:
    bus_factor:
      value: true
      definition: "Number of team members who can be hit by bus before project dies"
      mitigation: [documentation, pair_programming, code_review, knowledge_sharing]

    technical_debt:
      value: true
      rule: "Track debt explicitly, pay down incrementally"
      metric: "TODO/FIXME/HACK comments, duplication, complexity trends"

    version_control:
      value: true
      rule: "Commit early, commit often, atomic commits"
      message_format: "imperative mood, 50-char summary, optional body"

  ruby_beauty:
    frozen_string_literals:
      value: true
      rule: "# frozen_string_literal: true at top of every Ruby file"
      rationale: "Performance gain, prevents accidental mutation"

    keyword_arguments:
      value: true
      rule: "Use keyword args for methods with 2+ params"
      example: "def create(name:, email:, role: 'user')"
      rationale: "Self-documenting, order-independent, default values"

    safe_navigation:
      value: true
      operator: "&."
      example: "user&.profile&.avatar_url"
      rationale: "Prevents NoMethodError on nil, cleaner than &&"

    string_interpolation:
      value: true
      rule: 'Use "#{}" over concatenation'
      example: '"Hello #{name}"'
      rationale: "More readable, handles types automatically"

    blocks_parens_braces:
      value: true
      rule: "Use {} for one-line, do/end for multi-line"
      example: "items.map { |i| i * 2 }"
      rationale: "Readability convention, visual distinction"

    tell_dont_ask:
      value: true
      rule: "Tell objects what to do, don't ask for data then act"
      antipattern: "if user.admin? then user.grant_access end"
      pattern: "user.grant_access_if_admin"

    small_methods:
      value: true
      rule: "Methods under 10 lines ideal, max 20"
      rationale: "Easier to test, understand, reuse"
      technique: "Extract till you drop"

    stepdown_rule:
      value: true
      rule: "Code reads like newspaper - most important first"
      structure: "Public methods → Private helpers → Implementation details"
      rationale: "Natural reading flow, easy navigation"

    boy_scout_rule:
      value: true
      rule: "Leave code better than you found it"
      application: "Fix small issues while working on features"

  rails_doctrine:
    convention_over_configuration:
      value: true
      rule: "Sensible defaults reduce decisions"
      application: "Follow Rails conventions, don't fight the framework"
      benefit: "Shared mental model across Rails developers"

    programmer_happiness:
      value: true
      rule: "Optimize for developer joy, not just performance"
      application: "Beautiful APIs, minimal configuration, helpful errors"

    sharp_knives:
      value: true
      rule: "Trust developers with power tools, no guard rails"
      application: "Direct DB access, metaprogramming allowed"
      responsibility: "With great power comes careful testing"

    integrated_systems:
      value: true
      rule: "Solve whole problem, not assembled parts (Omakase)"
      application: "Use Rails stack: Hotwire, Turbo, Stimulus, Solid Queue"
      avoid: "Frankenstack of incompatible tools"

    monolith_first:
      value: true
      rule: "Start monolith, extract services when team >15"
      rationale: "Microservices = distributed monolith for small teams"
      application: "Keep it simple until complexity forces split"

    progress_over_stability:
      value: true
      rule: "Ship features, break things, iterate quickly"
      balance: "In production: stability over progress"

    beautiful_code:
      value: true
      rule: "Code should be elegant, not just functional"
      criteria: [readable, maintainable, expressive, concise]
      rationale: "Beautiful code is easier to change"

file_operations:
  anti_sprawl:
    enabled: true
    rationale: "File sprawl violates DRY - single source of truth"
    enforcement: "Edit existing files directly, never create analysis/summary/report/todo files"
    banned_outputs: [summary.md, analysis.md, report.md, todo.md, notes.md, readme.md, changelog.md]
    exceptions: [test files, actual deliverables requested by user]
    violation_penalty: "Delete created file, re-edit original"

  single_source_truth:
    value: true
    rule: "Information lives in ONE canonical location"
    antipattern: "Same config in 5 files, gets out of sync"
    solution: "Single source file, others import/reference it"

  consolidate_over_fragment:
    value: true
    rule: "One well-organized file > many small files"
    threshold: "Consider splitting when file >500 lines AND has distinct concerns"

  edit_in_place:
    value: true
    mandate: "Edit existing files directly via str_replace/file_create"
    never: "Create separate analysis then 'now apply to original'"
    rationale: "Saves tokens, reduces file count, maintains single source"

comments:
  preservation:
    value: true
    rule: "Preserve ALL existing comments when editing"
    rationale: "Existing comments contain context, decisions, warnings"

  removal_criteria:
    redundant: true
    self_explanatory: true
    examples:
      remove: ["// increment counter", "// return result", "// end of function"]
      keep: ["// Workaround for Unicode bug in Ruby 3.0", "// O(n²) but n < 100 so acceptable"]

  addition_criteria:
    complex_logic: true
    non_obvious: true
    examples:
      needed: ["Algorithm uses Sieve of Eratosthenes", "Retry with exponential backoff"]
      not_needed: ["Loop through array", "Set variable to true"]

  formatting:
    no_decorations: true
    banned: ["---", "===", "###", "***", "+++", "///", "boxes", "ascii_art"]
    style: "Inline explanations, not comment blocks"
    rationale: "Decorations add noise, break parsing, violate simplicity"

detectors:
  duplicate_code_detector:
    enabled: true
    threshold: 3
    similarity: 0.70
    scope: all_files
    action: extract_to_shared_module
    priority: high

  complexity_detector:
    enabled: true
    cyclomatic_max: 10
    nesting_max: 4
    method_lines_max: 20
    action: refactor_to_smaller_methods
    priority: high

  unreferenced_code_detector:
    enabled: true
    finds: [unused_methods, unused_variables, unused_imports, dead_code_paths]
    action: remove_or_mark_for_review
    priority: medium

  security_detector:
    enabled: true
    checks: [sql_injection, xss, command_injection, hardcoded_secrets, insecure_random]
    action: flag_for_immediate_fix
    priority: critical

  performance_detector:
    enabled: true
    checks: [n_plus_one_queries, missing_indexes, inefficient_loops, memory_leaks]
    action: suggest_optimization
    priority: medium

  style_detector:
    enabled: true
    checks: [naming_conventions, indentation, line_length, trailing_whitespace]
    action: auto_fix_if_confident
    priority: low

autofix:
  enabled: true
  confidence_threshold: 0.90
  safe_transformations:
    whitespace_normalization: true
    import_sorting: true
    quote_style_consistency: true
    trailing_comma_addition: true

  mappings:
    duplication_detector:
      - confidence: 0.95
        pattern: exact_duplicate
        action: extract_to_method
      - confidence: 0.90
        pattern: similar_with_params
        action: extract_to_parameterized_method

    complexity_detector:
      - confidence: 0.95
        pattern: nested_conditionals
        action: extract_guard_clauses
      - confidence: 0.90
        pattern: long_method
        action: extract_sub_methods

    style_detector:
      - confidence: 0.99
        pattern: trailing_whitespace
        action: remove
      - confidence: 0.99
        pattern: multiple_blank_lines
        action: collapse_to_single

  rollback_on_regression: true
  feedback_loop: "Track autofix success rate, adjust confidence thresholds"

incremental_scanning:
  enabled: true
  strategy: "Scan only modified files via git diff --name-only HEAD~1"
  file_watcher:
    enabled: true
    patterns: ["**/*.rb", "**/*.js", "**/*.yml", "**/*.json", "**/*.sh"]
    debounce_ms: 1000
    on_change: run_detectors_on_changed_files
  full_scan_triggers: [new_principle_added, master_yml_modified, user_requests_full_scan]
  performance_gain: "60-85% faster"

formatter_mental_model:
  mandate: "Every file edit passes through formatter before writing"
  no_external_tools: "Pure reasoning-based formatting, zero dependencies"

  writing_principles:
    omit_needless_words:
      value: true
      rule: "Vigorous writing is concise"
      application: "Remove that, which, who is, who are, there is/are"
      example: "The question as to whether → Whether"

    use_active_voice:
      value: true
      rule: "Active voice is more direct and vigorous"
      antipattern: "The code was written by the developer"
      pattern: "The developer wrote the code"

    parallel_construction:
      value: true
      rule: "Express coordinate ideas in similar form"
      example: "List items: Start with verb, start with verb, start with verb"

    related_words_together:
      value: true
      rule: "Keep subject near verb, modifier near modified"
      antipattern: "The function, which was written yesterday, calculates totals"
      pattern: "The function calculates totals (written yesterday)"

    emphatic_at_end:
      value: true
      rule: "Place emphatic words at end of sentence"
      application: "Save the punchline for last"

  html_css_principles:
    semantic_html:
      value: true
      rule: "Use HTML elements for their meaning, not appearance"
      elements: [header, nav, main, article, section, aside, footer]
      avoid: "div soup, span abuse"

    no_divitis:
      value: true
      rule: "Maximum 2 wrapper divs"
      rationale: "Excessive wrappers indicate poor structure"
      solution: "Use semantic elements, flexbox, grid"

    css_composition:
      value: true
      rule: "Utility classes are acceptable, but prefer semantic"
      pattern: "Component-level SCSS with BEM naming"
      avoid: "Tailwind-style atomic CSS (user preference: pure SCSS)"

    modern_layout:
      value: true
      techniques: [flexbox, grid, container_queries]
      avoid: [floats, absolute_positioning_for_layout, tables_for_layout]
      rationale: "Modern CSS is more maintainable"

    accessibility:
      value: true
      requirements: [semantic_html, aria_labels, keyboard_navigation, color_contrast_4_5]
      test: "Tab through page, use screen reader"

  ui_ux_principles:
    visibility_of_status:
      value: true
      rule: "Keep users informed through feedback"
      application: "Loading states, progress bars, confirmation messages"

    match_real_world:
      value: true
      rule: "Speak user's language, follow conventions"
      avoid: "System-oriented terminology"

    user_control:
      value: true
      rule: "Users should feel in control, allow undo"
      application: "Confirmation dialogs, undo buttons, cancel actions"

    consistency:
      value: true
      rule: "Same words, actions, situations = same outcome"
      application: "Consistent button placement, naming, behavior"

    error_prevention:
      value: true
      rule: "Better than good error messages is preventing errors"
      application: "Constraints, confirmations, helpful defaults"

    recognition_over_recall:
      value: true
      rule: "Show options, don't make users remember"
      application: "Dropdowns over text input, visible actions"

    flexibility_efficiency:
      value: true
      rule: "Accelerators for experts, simple for novices"
      application: "Keyboard shortcuts, batch operations"

    aesthetic_minimalist:
      value: true
      rule: "Dialogues should contain only relevant information"
      application: "Remove decorative elements, focus on content"

    help_users_recognize_errors:
      value: true
      rule: "Error messages in plain language, suggest solution"
      format: "What happened + Why + How to fix"

    help_documentation:
      value: true
      rule: "Searchable, task-focused, concrete steps"
      avoid: "Long explanatory text, system documentation"

  core:
    indent: 2_spaces
    quotes: double
    max_blank_lines: 2
    remove_trailing_whitespace: true

  ruby:
    blank_lines: single_between_functions
    string_interpolation: preferred
    comments: yard_style
    yard_tags: ["@param", "@return", "@raise", "@example"]

  rails:
    tag_helpers: preferred
    example: '<%= tag.p t("hello_world") %>'
    avoid: '<p><%= t :hello_world %></p>'
    rationale: "Tag helpers are safer (auto-escape) and more composable"

  yaml:
    indent_strict: true
    no_blank_within_maps: true
    max_nesting: 4
    align_values: true

  shell:
    quote_all_expansions: true
    pattern: '"$variable"'
    strict_mode: "set -euo pipefail"

  javascript:
    philosophy: "minimal JS - server-driven HTML preferred (Hotwire/Stimulus)"
    remove_blank_within_functions: true
    semicolons: required
    const_first: true
    var_forbidden: true
    equality: strict_only
    comparison_operators: ["===", "!=="]
    avoid_operators: ["==", "!="]
    arrow_functions: preferred
    template_literals: preferred_over_concat
    destructuring: preferred
    spread_over_apply: true
    async_await: preferred_over_promises
    optional_chaining: "use ?. for nullable access"
    nullish_coalescing: "use ?? not ||"
    trailing_commas: multiline_only
    object_shorthand: preferred
    array_methods: prefer_map_filter_reduce
    no_mutations: "prefer immutable patterns"
    error_handling: always_catch_async

  stimulus:
    philosophy: "sprinkle interactivity - small, single-purpose controllers"
    controller_size: "keep small and focused - one behavior per controller"
    organization: "place in /controllers/, use namespaces for grouping"
    dom_access: "use targets and values API - never global queries"
    state_storage: "use values API to store state in HTML attributes"
    lifecycle: "use connect/disconnect for setup/teardown"
    cleanup: "always remove listeners in disconnect"
    outlets: "use for controller communication - avoid tight coupling"
    composability: "split into small controllers, not mega-controllers"
    naming: "data-controller, data-action, data-target attributes"
    example: "data-controller='dropdown' data-action='click->dropdown#toggle'"
    anti_pattern: "avoid thick controllers - push logic to server"

  hotwire:
    philosophy: "HTML over the wire - server-rendered HTML with SPA feel"
    turbo_drive: "intercepts navigation - full page loads without refresh"
    turbo_frames: "partial updates - replace sections not whole page"
    turbo_streams: "real-time server-to-client updates via ActionCable"
    pattern: "render modals/popups server-side via Turbo Frames + Stimulus"
    form_handling: "use Turbo for submissions - get Turbo Stream responses"
    error_handling: "let server respond with error streams"
    spa_feel: "achieve SPA UX with server-rendered HTML"
    minimal_js: "keep JavaScript minimal - server does the work"

  stimulus_reflex:
    philosophy: "reactive Rails via WebSockets - no client state management"
    architecture: "ActionCable + CableReady + morphdom for DOM updates"
    workflow: "data-reflex triggers -> server processes -> HTML morphed into DOM"
    use_case: "complex real-time interactions needing server state"
    benefits: ["no client state", "fast WebSocket updates", "leverages Rails conventions", "~15kb gzipped"]
    server_rendering: "all UI/business logic stays on server in Rails classes"
    dom_updates: "morphdom seamlessly merges server HTML into client DOM"

  stimulus_components:
    source: "stimulus-components.com"
    philosophy: "reusable controllers - UI agnostic and portable"
    usage: "prefer existing components over custom JavaScript"
    installation: "install only controllers you need - composable"
    portable: "works with Rails and pure HTML sites - any CSS framework"
    accessibility: "use semantic HTML and ARIA attributes"
    examples: ["clipboard", "sortable", "popover", "dropdown", "tabs", "carousel", "autosave"]
    best_practice: "keep markup clean - only use data-controller/target/action attributes"

  markdown:
    max_line_length: 80
    blank_before_headings: true
    blank_before_lists: true

  large_html_documents:
    rationale: "Business plans, presentations, visualizations often require inline CSS/JS"

    document_types:
      business_plan:
        characteristics: [verbose, commented, external_libraries, print_friendly]
        style: development_friendly
        formatting: preserve_readability
        example: "Multi-section presentations with data viz"

      production_app:
        characteristics: [minified, compressed, performance_critical, single_file]
        style: production_optimized
        formatting: minimal_whitespace
        example: "Audio visualizers, WebGL apps, real-time graphics"

    inline_css_principles:
      organization:
        rule: "Group by component, not by property type"
        structure: "CSS variables → Resets → Layout → Components → Utilities"
        rationale: "Easier to find related styles"

      css_variables:
        value: true
        rule: "Define all colors/spacing/fonts in :root"
        example: ":root { --primary: #000; --spacing: 8px; }"
        benefit: "Single source of truth, easy theming"

      modern_css_only:
        rule: "Use flexbox, grid, container queries - no floats or positioning hacks"
        avoid: [float, absolute_for_layout, tables_for_layout, clearfix]
        prefer: [flexbox, grid, logical_properties, container_queries]

      mobile_first:
        rule: "Base styles mobile, @media for desktop"
        pattern: "min-width media queries, not max-width"

      performance:
        will_change: "Only on elements actually animating"
        contain: "Use CSS containment for isolated sections"
        content_visibility: "Use for long documents"

    inline_js_principles:
      production_minified:
        when: "Performance-critical, production apps"
        characteristics: [single_line, compressed_vars, no_whitespace]
        tools: [terser, uglify, closure_compiler]
        preserve: "Comments with ! prefix for licenses"

      development_formatted:
        when: "Business plans, maintainable code"
        characteristics: [readable, commented, spaced]
        structure: "Config → Utils → Classes → Init → Event listeners"

      es6_modern:
        rule: "Use const/let, arrow functions, destructuring, template literals"
        avoid: [var, function_keyword_for_lambdas, string_concat]

      dom_safety:
        rule: "Check element existence before manipulation"
        pattern: "const el = document.getElementById('id'); if (!el) return;"

      memory_management:
        cleanup: "Track timers/intervals, clear on unload"
        pattern: |
          const TIMERS = new Set();
          const trackTimer = (id) => { TIMERS.add(id); return id };
          window.addEventListener('beforeunload', () => TIMERS.forEach(clearTimeout));

      event_delegation:
        value: true
        rule: "Add listeners to container, check event.target"
        benefit: "Fewer listeners, dynamic content support"

    complex_visualizations:
      when_to_separate:
        threshold: "JS >500 lines OR CSS >300 lines"
        action: "Extract to external files"
        exception: "Single-file deployment requirement"

      when_to_inline:
        reasons: [single_file_deployment, performance, no_http_requests, portability]
        pattern: "Business plans sent as email attachments"

      readability_strategies:
        comments: "Section headers with visual breaks"
        example: "// ========== AUDIO ENGINE =========="
        forbidden: "Never use === or --- in production code per comment rules"
        correct: "Use block comments: /* AUDIO ENGINE */"

      code_organization:
        top: "Constants, config, feature detection"
        middle: "Utility functions, classes"
        bottom: "Initialization, event listeners, main execution"

      state_management:
        pattern: "Single global object or module pattern"
        example: "const APP = { config: {}, state: {}, utils: {} };"

    formatting_strategy:
      decision_tree:
        if: "production app (visualizer, game, performance-critical)"
        then: "Minify JS/CSS, inline everything, optimize for size"
        else_if: "business plan (presentation, report, document)"
        then: "Readable formatting, comments, educational"
        else: "Extract to separate files"

      minification_rules:
        preserve: [licenses, important_comments, debug_flags]
        compress: [whitespace, variable_names, dead_code]
        skip: [css_custom_properties, data_attributes]

      beautification_rules:
        indent: 2_spaces
        line_length: 100
        blank_lines: "Between logical sections"
        comments: "Explain non-obvious logic"

    validation:
      html: "Valid HTML5, semantic elements"
      css: "No vendor prefixes needed (autoprefixer not available)"
      js: "ESLint-clean if linting inline"
      a11y: "ARIA labels, keyboard navigation, color contrast"

    security:
      csp: "Content-Security-Policy if serving over HTTP"
      sanitization: "Sanitize any user input"
      no_inline_handlers: "Use addEventListener, not onclick attributes"

standards:
  zsh_native:
    philosophy: "No external forks - pure zsh parameter expansion"

    string_ops:
      remove_crlf: '${var//$''\r''/}'
      to_lower: '${(L)var}'
      to_upper: '${(U)var}'
      replace_all: '${var//search/replace}'
      trim: '${var##[[:space:]]#}${var%%[[:space:]]#}'
      extract_nth_field: '${${(s:,:)line}[4]}'

    array_ops:
      filter_matching: '${(M)arr:#*pattern*}'
      filter_excluding: '${arr:#*pattern*}'
      unique: '${(u)arr}'
      join: '${(j:,:)arr}'
      sort_asc: '${(o)arr}'
      sort_desc: '${(O)arr}'

    avoid_external: [awk, sed, tr, grep, cut, head, tail, find]

    use_instead:
      wc_minus_l: '${#${(f)"$(< file)"}}'
      head_tail: '${lines[1,20]} or ${lines[-5,-1]}'
      grep_pattern: '${(M)lines:#*pattern*}'
      cat_file: '$(< file)'
      sort_lines: '${(o)lines}'
      uniq_lines: '${(u)lines}'

constraints:
  banned: [python, bash, sed, awk, wc, head, tail, find, sudo, truncation, placeholders, todos]
  allowed: [ruby, zsh, grep, cat, sort, git, npm, bundle, rails, rake]

  tool_alternatives:
    wc_minus_l: 'zsh: ${#${(f)"$(< file)"}}'
    head_tail: 'zsh array slicing: ${lines[1,20]}'
    grep_pattern: 'zsh filtering: ${(M)lines:#*pattern*}'

  file_operations:
    never: [create_new_structure, create_backups, mkdir_new_folders, create_analysis_files]
    always: [edit_existing_in_place, use_git_for_history, consolidate_over_fragment]

thresholds:
  code:
    max_arguments: 3
    max_nesting: 2
    max_method_lines: 20
    max_complexity: 10
    duplication_trigger: 3
    fan_out: 5

  typography:
    line_length: {ideal: 66, min: 45, max: 75}
    line_height: {body: 1.5, heading: 1.2}
    contrast: {normal: 4.5, large: 3.0}

  layout:
    base_unit: 8
    spacing_scale: [4, 8, 16, 24, 32, 48, 64]
    golden_ratio: 1.618

hooks:
  pre_commit:
    sequence: [run_detectors, auto_fix_violations, verify_zero_violations]
    parallel: [run_tests, security_scan, performance_check]
    rollback_on_failure: true

  pre_push:
    sequence: [verify_zero_violations, check_branch_protection, validate_commits]
    parallel: [run_integration_tests, lint_dependencies]
    block_on_failure: true

  recovery:
    triggers: [gate_failure, test_failure, deployment_failure]
    strategy:
      committed: git_revert
      uncommitted: restore_checkpoint
      deployed: blue_green_switch
    errors:
      fatal: [security_breach, data_loss]
      recoverable: [network_timeout, parse_error]
    retry: exponential_backoff
    max_attempts: 3

learning:
  enabled: true
  track_effectiveness: true
  adapt_thresholds: true
  continuous_learning: true
  codify_to_principles: true

execution_flow:
  bootstrap:
    sequence:
      - load_master_yml_from_canonical_path
      - verify_version_and_integrity
      - internalize_all_sections
      - validate_self_against_principles
      - activate_enforcement_mode
    on_load_failure:
      - log_error_with_context
      - attempt_alternative_paths
      - fall_back_to_safe_defaults
      - warn_user_explicitly

  enforcement:
    require_full_validation: true
    rationale: "Partial runs violate principles - like claiming code passes tests without running them"
    before_output:
      - verify_formatter_applied
      - verify_all_detectors_ran
      - verify_zero_violations
      - verify_principles_honored
    on_partial_run:
      - reject_output
      - log_violation
      - explain_what_was_skipped
      - require_complete_rerun
    proof_of_compliance:
      - formatter_applied: "All quotes/spacing/syntax match formatter_mental_model"
      - detectors_ran: "All enabled detectors executed successfully"
      - no_violations: "Zero violations from all passes"
      - principles_honored: "No DRY/KISS/YAGNI/SOLID violations"

  orchestration:
    on_file_change:
      - incremental_scanning.file_watcher.on_change
      - run_detectors_on_changed_files
      - autofix_high_confidence_violations
      - report_remaining_violations
      - update_metrics

    on_git_commit:
      - hooks.pre_commit.sequence
      - hooks.pre_commit.parallel
      - verify_zero_violations
      - rollback_if_violations_found

    on_code_generation:
      - validate_against_constraints
      - run_detectors_on_output
      - apply_formatter_mental_model
      - verify_no_file_sprawl
      - check_comment_rules

    on_principle_violation:
      - log_violation_with_context
      - attempt_autofix_if_confident
      - report_to_user_if_manual_fix_needed
      - track_violation_pattern
      - adjust_detector_sensitivity

  validation_orchestration:
    multi_pass_validation:
      enabled: true
      passes: [surface, structure, philosophy, meta]
      surface:
        - check_syntax_and_formatting
        - verify_references_resolve
        - detect_obvious_duplication
        - validate_file_operations
      structure:
        - check_dry_violations
        - verify_solid_principles
        - detect_architectural_issues
        - validate_separation_of_concerns
      philosophy:
        - verify_principle_of_least_astonishment
        - check_unix_philosophy_alignment
        - validate_composition_patterns
        - ensure_fail_secure_behavior
      meta:
        - verify_dogfooding
        - check_self_consistency
        - validate_execution_flow_itself
        - ensure_feedback_loops_active

    adversarial_validation:
      enabled: true
      personas: [skeptic, minimalist, security, maintainer, junior, architect, user, chaos, existing_code_defender, strunk_white]
      execution:
        - apply_each_persona_perspective
        - collect_concerns_and_questions
        - resolve_conflicts_systematically
        - document_decisions_made
        - update_principles_if_pattern_emerges

  feedback_loop:
    collect:
      - detector_hit_rates
      - autofix_success_rates
      - violation_patterns_over_time
      - principle_effectiveness_metrics
      - user_override_frequency

    analyze:
      - identify_false_positives
      - detect_emerging_patterns
      - measure_convergence_delta
      - calculate_roi_per_principle
      - find_gaps_in_coverage

    adapt:
      - adjust_detector_thresholds
      - update_autofix_confidence_levels
      - add_new_principles_from_patterns
      - deprecate_ineffective_rules
      - rebalance_evidence_weights

    codify:
      - extract_patterns_to_principles
      - document_decisions_and_rationale
      - update_detector_mappings
      - increment_version_number
      - commit_changes_with_context

  integration_points:
    git_hooks:
      pre_commit: hooks.pre_commit
      pre_push: hooks.pre_push
      post_merge: run_full_scan

    editor_integration:
      on_save: run_incremental_scan
      on_format: apply_formatter_mental_model
      on_refactor: validate_preserves_behavior

    ci_cd:
      on_pull_request: run_full_validation
      on_merge_to_main: enforce_zero_violations
      on_deploy: verify_production_readiness

  error_recovery:
    on_detector_crash:
      - log_stack_trace_and_context
      - disable_failing_detector
      - notify_maintainer
      - continue_with_remaining_detectors

    on_autofix_regression:
      - rollback_changes_immediately
      - log_regression_details
      - lower_confidence_threshold
      - flag_for_manual_review

    on_validation_timeout:
      - return_partial_results
      - log_timeout_context
      - suggest_optimization
      - allow_user_override

  performance_optimization:
    caching:
      - cache_detector_results_by_file_hash
      - cache_reference_resolutions
      - cache_formatter_outputs
      - invalidate_on_file_change

    parallelization:
      - run_independent_detectors_in_parallel
      - batch_similar_operations
      - use_worker_pool_for_file_processing
      - respect_cpu_limits

    incremental_processing:
      - process_only_changed_files
      - skip_unchanged_validated_code
      - reuse_previous_analysis_results
      - track_dependencies_for_invalidation

export_formats: [json, yaml, csv, html, markdown, sarif]

integrations:
  git_hooks: true
  ci_cd: true
  editor_plugins: true