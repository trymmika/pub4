# master.yml v84.0
#
# Operational constitution for Rails + OpenBSD development
# • Law is immutable; principles guide; criteria enforce
# • Silent success: report exceptions only
# • Zsh native: zero forks, parameter expansion
# • Ruby-first reasoning: algorithms in Ruby, ops in zsh
# • Rails 8 + Falcon + Solid Stack → OpenBSD VPS
#
# ACTIVATION: "✓ master.yml v84.0 loaded"

law:
  immutable: true
  golden_rule: PRESERVE_THEN_IMPROVE_NEVER_BREAK
  chestertons_fence: "understand intent before removal"
  security_axiom: "validate input, least privilege, defense in depth; no plaintext secrets in commits"
  ops_safety: "working systems outrank elegance"
  auditability: "all changes explainable post-hoc"

principles:
  preserve_behavior: "never break working code"
  single_responsibility: "one reason to change"
  dry: "single source of truth"
  kiss: "no unnecessary complexity"
  yagni: "build only what you need now"
  small_functions: "under 10 lines ideal, max 20"
  meaningful_names: "names reveal intent"
  boy_scout: "leave cleaner than found"
  stepdown: "important code first"
  measure_first: "profile before optimizing"
  fail_fast: "validate at entry, never swallow errors"
  rule_of_three: "abstract on 3rd occurrence, not before"
  two_hats: "refactor OR add features, never both"
  law_of_demeter: "talk to friends, not strangers"

silent_success:
  principle: "Report only exceptions; success is default"
  levels: {success: log_only, warn: daily_digest, error: immediate, fatal: alert}
  rationale: "80% noise reduction"

working_system_criteria:
  deployment: "rcctl check OK, curl localhost:PORT 2xx, no fatal in logs"
  development: "rails test passes, app boots <10s, db:migrate clean"
  production: "uptime >99%, p95 <500ms, zero security alerts, health 200"

vps:
  ip: "185.52.176.18"
  backup_ns: "194.63.248.53"
  user: dev
  key_local: "G:/priv/passwd/id_ed25519"
  key_remote: "~/.ssh"
  deploy_base: "/var/rails"
  app_base: "/home"
  ssh_pattern: 'zsh -c "ssh -i G:/priv/passwd/id_ed25519 -o ConnectTimeout=10 dev@185.52.176.18 ''COMMAND''"'

error_recovery:
  ssh_failure: {retry: 3, backoff: [5, 10, 20], fallback: "alert human"}
  pkg_install: {retry: 2, mirror_fallback: true, skip_on_exists: true}
  db_migration: {backup_first: true, rollback_on_fail: true, alert: "any failure"}
  service_start: {retry: 3, check_port: true, check_permissions: true}
  deployment: {rollback: "previous version", preserve_logs: true}

backup: "git (tag releases, full history); pg_dump before migrations if needed"

health_monitoring:
  endpoint: "/health"
  checks: ["db_connected", "disk >20%", "memory >512mb", "uptime"]
  frequency_seconds: 60
  alerts:
    health_fail: ">3 consecutive"
    response_time: ">2s for 5min"
    error_rate: ">1% for 10min"
    cpu: ">80% for 15min"
    memory: ">90% for 10min"
    disk: ">85%"
    tls_expiry: "30 days warning, 14 days renew"
  logs: {location: "/var/log/rails/", rotate: "weekly", retention_weeks: 4}

cache:
  key_design: "namespace:model:id:version"
  expiration: {user_session: "24h", api_response: "5min", page_fragment: "1h", static_content: "7d"}
  invalidation: ["touch updated_at", "cache_key update", "manual sweep via job"]
  strategy: "Russian Doll caching for views; memoization for same-request"

accessibility:
  standard: "WCAG 2.1 AA minimum"
  requirements: ["keyboard navigation", "screen reader labels", "contrast ≥4.5:1", "skip links", "semantic HTML"]
  testing: "automated via axe-core; manual verification quarterly"

i18n:
  timezone: "UTC stored; user preference display"
  locales: ["no", "en"]
  currency: "ISO 4217 codes; Money gem for formatting"
  strategy: "Rails I18n with YAML files; lazy load translations"

data_retention:
  user_data: "7 years or delete on request (GDPR)"
  logs: {app: "4 weeks", auth: "1 year", errors: "90 days"}
  backups: {daily: "7 days", weekly: "4 weeks", monthly: "12 months"}
  temp_files: "cleanup on boot + daily cron"

dependency_pinning:
  ruby: "3.3.x"
  rails: "~> 8.0.4"
  falcon: "~> 0.53.0"
  strategy: "pin major, allow minor/patch; test upgrades in staging"
  gems: "Gemfile.lock committed; bundle install --deployment"
  verification: "quarterly production vs development comparison"

focus: "Complete Rails generators on OpenBSD with zero sprawl"
analysis: "Read once, exhaust every line against principles, iterate until convergence criteria met"

mandate:
  file_ops: "Zsh globbing/parameter expansion only (**/*.rb(N.), ${(<file)})"
  logic: "Ruby for non-trivial algorithms"
  read_once: "View entire file once, don't re-read"
  tree_first: "Run tree.sh equivalent in new repos before work"
  pre_check: "Scan every command for forbidden patterns before execution"
  vertical_spacing:
    - "Strip all blank lines before refactoring"
    - "Reassess grouping line-by-line after fixes"
    - "Single blank line between semantic groups only"

reasoning:
  primary_language: Ruby
  primary_shell: zsh
  expression:
    algorithms: "Ruby code, not pseudo-code"
    file_operations: "zsh parameter expansion and globs"
    explanations: "concrete snippets over abstractions"

environment:
  windows: "C:\\cygwin64\\bin\\zsh.exe"
  cli: "GitHub Copilot CLI (@github/copilot)"
  session_management:
    prefer_async: "interactive tools, SSH, debugging, long-running"
    prefer_sync: "quick commands <30s"

apps:
  _volatile: true  # inventory changes; do not refactor away
  brgen: {port: 11006, domains: "brgen.no oshlo.no trndheim.no stvanger.no trmso.no reykjavk.is kobenhvn.dk stholm.se gteborg.se mlmoe.se hlsinki.fi lndon.uk mnchester.uk brmingham.uk edinbrgh.uk glasgw.uk lverpool.uk amstrdam.nl rottrdam.nl utrcht.nl brssels.be zrich.ch lchtenstein.li frankfrt.de mrseille.fr mlan.it lsbon.pt lsangeles.com newyrk.us chcago.us dtroit.us houstn.us dllas.us austn.us prtland.com mnneapolis.com", subdomains: "markedsplass playlist dating tv takeaway maps"}
  amber: {port: 10001, domains: "amberapp.com"}
  blognet: {port: 10002, domains: "foodielicio.us stacyspassion.com antibettingblog.com anticasinoblog.com antigamblingblog.com foball.no"}
  bsdports: {port: 10003, domains: "bsdports.org"}
  hjerterom: {port: 10004, domains: "hjerterom.no"}
  privcam: {port: 10005, domains: "privcam.no"}
  pubattorney: {port: 10006, domains: "pub.attorney freehelp.legal"}

enforcement:
  forbidden: [bash, python, sed, awk, tr, wc, head, tail, cut, find, sudo, bash_echo]
  allowed: [ruby, zsh, git, npm, bundle, rails, rake, doas, rcctl, pkg_add, cat, curl, wget]
  pre_execution: "SCAN EVERY COMMAND - if forbidden, STOP and rewrite using zsh/ruby"
  output: "work via commits with clear messages - no temp files"

zsh_patterns:
  string_ops:
    crlf_removal: "${var//$'\\r'/}"
    lowercase: "${(L)var}"
    uppercase: "${(U)var}"
    replace_all: "${var//search/replace}"
    trim: "${${var##[[:space:]]#}%%[[:space:]]#}"
    nth_field: "${${(s:,:)line}[4]}"
    split: "arr=( ${(s:delim:)var} )"
  array_ops:
    filter_match: "${(M)arr:#*pattern*}"
    filter_exclude: "${arr:#*pattern*}"
    unique: "${(u)arr}"
    join: "${(j:,:)arr}"
    sort: "${(o)arr}"
  file_ops:
    recursive_mkdir: "mkdir -p path/to/nested  # allowed exception"
    safe_download: "curl -fsSL --max-time 30 URL -o file  # validate after"
    permissions: "chmod 600 ~/.ssh/id_*  # security-critical only"
  examples:
    - {bad: "head -5 file", good: "print -l ${(f)$(<file)}[1,5]"}
    - {bad: "grep pattern file", good: "print -l ${(M)${(f)$(<file)}:#*pattern*}"}
    - {bad: "cat file | wc -l", good: "${#${(f)$(<file)}}"}
    - {bad: "find . -name *.rb", good: "**/*.rb(N.)"}
    - {bad: "curl URL | sh", good: "curl -fsSL URL -o script && inspect && zsh script"}
  system_ops:
    timestamp: "zmodload zsh/datetime; strftime '%Y-%m-%d' $EPOCHSECONDS"
    command_exists: "[[ -n ${commands[cmd]} ]]"

tool_permissions:
  mode: deny_by_default
  shell:
    allowed: ["git *", "bundle *", "rails *", "zsh *", "doas *", "rcctl *", "pkg_add *"]
    denied: ["rm -rf /*", "sudo *", "curl * | *", "chmod 777 *", "eval *"]
  file_ops:
    read_denied: ["**/.env", "**/secrets/**", "**/*_key*"]
    write_denied: ["/etc/**", "/var/**", "/usr/**"]

stack: {ruby: 3.3, os: "OpenBSD 7.6+", shell: zsh, framework: "Solid Queue/Cache/Cable + Hotwire"}

style:
  comments:
    philosophy: "explain WHY, never WHAT"
    required: ["non-obvious algorithm", "business rule", "security rationale", "perf optimization"]
    forbidden: ["obvious code", "redundant with name", "commented-out code", "---", "===", "###", "***"]
    preferred: "# WHY: reason"
  code:
    no_divitis: "Rails tag helpers, ultraminimalistic views"
    vertical_rhythm: "single blank between semantic groups"

scope:
  production: ["~/pub/rails/", "~/pub/openbsd/"]
  experimental: ["~/learning/", "~/experiments/"]
  escape: "# VIOLATION: [principle] | Reason: [why] | Revert: [date]"

overrides:
  - directories: ["~/pub/rails/**"]
    method_max: 25
    shell_allowed: ["rails *", "bundle exec *", "rake *"]
  - directories: ["~/learning/**", "~/experiments/**"]
    strict_enforcement: false

ruby:
  frozen_string_literal: true
  keyword_args: "2+ params"
  safe_nav: "&."
  blocks: "{} one-line, do/end multi"

rails:
  version: 8.0.4
  stack: "Solid + Hotwire + Falcon"
  avoid: "React/Vue/Angular, Puma, Redis"
  server: "Falcon (async, fiber-based, HTTP/2)"
  testing: "Minitest; ≥80% coverage; bin/rails test after changes"
  solid_generators: ["solid_queue:install", "solid_cache:install", "solid_cable:install", "authentication"]

openbsd:
  services: "rcctl enable/start/stop/restart/check/reload"
  privilege: doas
  packages: "pkg_add -v"
  web: "relayd(TLS) → httpd(acme) → falcon(10001-11006) → Rails"
  monitoring: "systat, pfctl -s info, tail /var/log/relayd"
  verification: "man.openbsd.org before use"
  configs: {relayd: "/etc/relayd.conf", httpd: "/etc/httpd.conf", pf: "/etc/pf.conf", acme: "/etc/acme-client.conf"}

deploy:
  local: [test, verify_Gemfile, commit, push]
  remote: "ssh vps 'cd ~/pub4/rails && doas zsh appname.sh'"
  verify: ["rcctl check appname", "ps aux | grep falcon", "curl localhost:PORT", "curl https://domain"]
  service: "rcctl enable app && rcctl start app"

execution:
  pre_flight: ["RELOAD master.yml", "SCAN for forbidden tools", "rewrite if needed"]
  steps: ["read once (chestertons_fence)", "check tier 1 first", "fix one at a time", "test immediately", "commit clearly", "measure improvement", "continue if ≥2%"]

self_optimize: {run_on_self: true, threshold: 2, max_cycles: 5, measure: "violations per 100 lines"}
convergence: "violations=0 AND (hash_unchanged OR delta<2% OR quality_decreased)"

adversarial:
  consensus: 0.7
  personas:
    security: {weight: 0.30, veto: true, asks: "injection? validation? escalation?"}
    maintainer: {weight: 0.20, veto: true, asks: "clear at 3am? junior can debug?"}
    minimalist: {weight: 0.15, asks: "simplest? what to remove?"}
    performance: {weight: 0.15, asks: "big-O? memory? worst case?"}
    architect: {weight: 0.10, asks: "coupling? dependencies? scales?"}
    realist: {weight: 0.10, asks: "deadline? resources? ROI?"}

structural_ops:
  defragment: "consolidate scattered related code"
  hoist: "move constants/config to top"
  merge: "extract duplicate blocks"
  regroup: "organize by domain, not type"
  reflow: "definitions before usage, critical first"
  flatten: "reduce nesting depth"

performance_budget:
  response: {html_p95: "<500ms", api_p95: "<300ms"}
  database: {query_max: "100ms", n_plus_one: "zero tolerance"}
  assets: {js: "<300KB gz", css: "<100KB gz"}
  memory: {per_worker: "<512MB", total: "<4GB"}

security_audit:
  auth_log: "/var/log/auth + log/production.log"
  capture: ["login attempts", "password changes", "privilege escalation", "admin actions"]
  retention: "1 year minimum, immutable"

disaster_recovery: "git clone fresh, pg_dump restore, rcctl start"

done_criteria:
  refactoring: ["tests pass", "coverage maintained", "violations ≥2% reduced", "performance maintained", "commit merged"]
  feature: ["acceptance met", "tests written", "docs updated", "staging verified", "review approved"]
  deployment: ["rcctl check OK", "health 200", "no errors 10min", "response within budget", "rollback documented"]

git_recovery: "git log --patch --all -- path; git show HASH:path > recovered"

# v84.0 - guardianship mode
# +law.immutable: true (explicit freeze)
# +apps._volatile: true (inventory marker)
# +rails.testing (Minitest ≥80%)
# +openbsd.monitoring (systat, pfctl, logs)
# ~analysis: references convergence criteria
# Mode: maintenance, not construction