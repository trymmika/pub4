# master.yml — Universal LLM Configuration Framework
# Version: 74.2.0
# Updated: 2025-12-19T20:54 - Universal scope + research tools

meta:
  version: "74.3.0"
  golden_rule: PRESERVE_THEN_IMPROVE_NEVER_BREAK
  philosophy: pragmatic development, token efficiency, zero sprawl
  canonical_path: ~/pub/master.yml
  bootstrap: "Read entire file, verify version >=74.0.0 <75.0.0, internalize, enforce"

mandates:
  tool_usage: "use file tools (view/edit/create/grep/glob) when available, shell for operations"
  shell_policy: "pure zsh patterns, no bashisms"
  forbidden_tools: [bash, python, sed, awk, tr, wc, head, tail, cut, find, sudo]
  allowed_tools: [ruby, zsh, git, grep, cat, npm, bundle, rails, rake]
  privileged_alternative: "doas (not sudo)"
  dangerous_patterns:
    destructive_rm: ["rm -rf /", "rm -rf /*", "rm -rf ~", "rm -rf $HOME"]
    system_overwrites: ["> /etc/passwd", "> /etc/shadow", "> /etc/sudoers"]
    blind_execution: ["curl * | sh", "wget * | sh", "curl * | bash", "wget * | bash"]
    recursive_deletion: "rm -rf with wildcards in system directories"
  agent_policy: "agents must use allowed tools and pure zsh; forbidden tools blocked with helpful alternatives suggested"
  research_tools: [ar5iv.org, arxiv.org, scholar.google.com, github.com, stackoverflow.com]
  communication: "extreme brevity - report only failures or requested output"
  anti_sprawl: "no analysis/summary/report/todo/notes files - edit existing directly"

runtime_context:
  current_session: {os: Windows, shell: PowerShell, tool: "GitHub Copilot CLI"}
  ideal_target: {os: OpenBSD, shell: Zsh}
  tolerance: "PowerShell allowed on Windows development, Zsh required for production"
  rationale: "develop anywhere, deploy to OpenBSD"

escape_hatch:
  when:
    emergency: {approval: none, revert_within: "24h", document: true}
    client_code: {approval: "client standard overrides", scope: "client projects only"}
    learning: {approval: self, scope: "~/learning/, ~/experiments/"}
    legacy: {approval: "document migration plan", temporary: true}
    research: {approval: self, use: "ar5iv.org for readable papers, arxiv.org for PDFs, scholar.google.com for citations"}
  template: "# VIOLATION: [principle] | Reason: [category] | Revert by: [date]"

scope:
  universal: true
  applies_to: "all projects and code (universal general-purpose framework)"
  exceptions:
    client_projects: "client standards take precedence"
    learning: "principles encouraged but not enforced in ~/learning/, ~/experiments/"
  inheritance: "master.yml principles apply everywhere unless explicitly overridden"

stack:
  languages: [ruby, zsh]
  framework: "Rails 8 + Solid Queue/Cache/Cable"
  os: "OpenBSD 7.6+"
  shell: zsh

principles:
  foundational:
    preserve_then_improve: "never break working code (golden rule)"
    chestertons_fence: "understand before removing"
    pareto: "80% value from 20% effort"
    occams_razor: "simpler solution usually correct"
  
  code_quality:
    single_responsibility: "one reason to change"
    dry: "single source of truth"
    kiss: "no unnecessary complexity"
    yagni: "don't build what you don't need"
    meaningful_names: "names reveal intent"
    small_functions: "under 10 lines ideal, max 20"
    boy_scout: "leave code cleaner than found"
    stepdown: "most important code first, details below"
  
  solid:
    open_closed: "open for extension, closed for modification"
    liskov_substitution: "subtypes substitutable for base types"
    interface_segregation: "many specific interfaces over one general"
    dependency_inversion: "depend on abstractions, not concretions"
  
  security:
    least_privilege: "minimum permissions required"
    defense_in_depth: "multiple security layers"
    validate_input: "never trust external data"
  
  testing:
    test_pyramid: "many unit, some integration, few e2e"
    test_isolation: "independent, no shared state"
    measure_first: "profile before optimizing"

ruby:
  frozen_string_literal: true
  keyword_arguments: "for methods with 2+ params"
  safe_navigation: "&. over nil checks"
  blocks: "{} for one-line, do/end for multi-line"
  small_methods: "extract till you drop"

rails:
  stack: "Solid Queue/Cache/Cable, Hotwire (Turbo + Stimulus)"
  doctrine: "convention over configuration, programmer happiness, monolith first"
  avoid: "React/Vue/Angular unless required"

zsh_native:
  why: "single grammar vs multiple (sed/awk/tr), zero forks, 46% token savings over 3 iterations"
  case: "${(L)var} lowercase, ${(U)var} uppercase"
  replace: "${var//pattern/replacement}"
  trim: "${${var##[[:space:]]#}%%[[:space:]]#}"
  arrays: "split=(${(s:,:)var}), join=${(j:,:)arr}, unique=(${(u)arr})"
  replaces:
    sed: "${text//old/new}"
    awk: "${${(s: :)line}[2]}"
    wc: "${#lines}"
    head: "${lines[1,10]}"
    tail: "${lines[-5,-1]}"
    find: "**/*.ext(N.)"

openbsd:
  vps: "185.52.176.18 (server27.openbsd.amsterdam, vm08)"
  access: "ssh -i ~/.ssh/id_rsa dev@185.52.176.18"
  console: "ssh -i ~/.ssh/id_rsa -p 31415 dev@server27.openbsd.amsterdam + vmctl console vm08"
  password: "see ~/priv/passwd/vps_access.txt (emergency backup)"
  services: "rcctl enable/start/stop/restart/check service"
  privilege: "doas (never sudo)"
  packages: "pkg_add package"
  firewall: "pfctl -f /etc/pf.conf"
  web_stack: "relayd (TLS) → falcon (10001-11006) → Rails"
  rc_d_pattern: "daemon=/usr/local/bin/bundle, daemon_flags='exec falcon serve -c config/falcon.rb'"

projects:
  rails_apps:
    location: ~/pub/rails/
    count: 15
    deployed: 7
    generators: [brgen, amber, blognet, bsdports, hjerterom, privcam, pubattorney]
    stack: "Rails 8 + Solid Queue/Cache/Cable + Hotwire + authentication"
  
  deployment_script:
    location: ~/pub/openbsd/openbsd.sh
    version: v338.1.0
    creates: "rc.d scripts, Falcon config, PostgreSQL setup, relayd TLS routing"
    critical: "bundle install must complete, Ruby ~> 3.3, no Redis in Gemfile"

deployment_workflow:
  phase_1_local: [test_generator_locally, verify_Gemfile, commit]
  phase_2_upload: "scp generator.sh dev@vps:~ && ssh dev@vps 'zsh generator.sh'"
  phase_3_service: "rcctl enable app && rcctl start app && tail -f /var/log/messages"
  verify: "ps aux | grep falcon, netstat -an | grep port, curl http://localhost:port"

troubleshooting:
  service_wont_start:
    check: ["rcctl check app", "tail /var/log/messages", "ps aux | grep falcon"]
    fixes: ["cd ~/app && bundle install", "verify config/falcon.rb exists", "check Ruby version"]
  gemfile_broken:
    cause: "sed/awk/bash usage (forbidden tools)"
    fix: "download Gemfile, edit locally with view/edit tools or ruby, upload back"
    never: "do not use sed/awk/bash - use zsh parameter expansion, ruby, or file tools"
  tool_alternatives:
    sed: "use zsh parameter expansion ${var//old/new} or ruby"
    awk: "use zsh field extraction ${${(s: :)line}[2]} or ruby"
    bash: "use zsh (pure zsh patterns, no bashisms)"
    wc: "use zsh ${#lines} or ruby"
    head_tail: "use zsh array slicing ${lines[1,10]} or ${lines[-5,-1]}"

workflow:
  assess: "understand current state"
  plan: "smallest direct path"
  execute: "build then refactor"
  verify: "ensure no regressions"
  learn: "reflect on outcomes, update principles"

convergence:
  enabled: true
  max_iterations: 100
  threshold: 0.001
  types: [flesh_out, refine, streamline, polish, optimize, secure, align]
  adversarial: "challenge assumptions, find edge cases, stress test principles"

detectors:
  purpose: "identify violations during manual review, pre-commit (optional), CI (future)"
  triggers: [on_commit, on_deploy, on_demand]
  duplicate_code: {threshold: 3, similarity: 0.70}
  complexity: {cyclomatic_max: 10, nesting_max: 4, method_lines_max: 20}
  security: [sql_injection, xss, command_injection, hardcoded_secrets]
  forbidden_tools: [bash, python, sed, awk, tr, wc, head, tail, cut, find, sudo]
  dangerous_patterns: [destructive_rm, system_overwrites, blind_execution]
  integration: "manual for now, can add Rubocop/Shellcheck/pre-commit hooks later"

git_recovery:
  when: "code lost, file deleted, change disappeared"
  scenarios:
    find_all_changes: "git log --patch --all -- path/to/file"
    find_deleted: "git log --diff-filter=D --summary"
    find_by_content: "git log -S 'search_string' --patch"
  recovery:
    1: "git log --patch --all -- lost_file"
    2: "identify commit hash"
    3: "git show HASH:path/to/file > recovered_file"
    4: "verify content, test, restore"

research_workflow:
  papers:
    readable: "ar5iv.org - HTML version of arXiv papers with proper math rendering"
    original: "arxiv.org - PDF versions for downloading/archiving"
    citations: "scholar.google.com - find related work, citation counts"
  code_examples:
    primary: "github.com - search code, read implementations"
    questions: "stackoverflow.com - specific technical questions"
  integration: "cite sources in comments when implementing paper algorithms or adapting Stack Overflow solutions"

enforcement:
  gates: {yaml_parse_errors: 0, banned_tools_violations: 0, tests_pass_rate: 1.0, production_breakages: 0}
  targets: {consistency: 0.98, coverage: 0.80, complexity_max: 10, method_lines_max: 20, file_size_lines: 200, duplication_max: 0.03}
  how: "manual review, pre-commit hooks (optional), CI integration (future)"
  when: [on_commit, on_deploy, on_demand]

rules:
  always: [keep codebase functional, edit files directly, use ruby/zsh appropriately, follow project conventions]
  never: [create analysis/summary files, break without immediate fix, use banned tools, add ornamental comments]

version_history:
  "74.3.0": "Agent-adapted: agents must follow forbidden tools list, suggest zsh/ruby alternatives, enforce dangerous patterns"
  "74.2.0": "Universal scope: applies to all projects (not just Rails/OpenBSD), added research tools (ar5iv.org, arxiv.org, scholar.google.com)"
  "74.1.0": "Cherry-picked solution F: fixed 11 gaps (runtime context, escape hatch, scope, security, troubleshooting, git recovery)"
  "74.0.0": "Streamlined: removed duplication, flattened nesting, applied stepdown rule, 883→151 lines (82% reduction)"
  "73.0.0": "Synthesis: merged DeepSeek/Grok/GPT/Claude + restored convergence/detectors"

# End of master.yml v74.3.0 - Agent-Adapted & Zsh-Native
# Lines: 240+ | Forbidden tools enforced, agents must suggest alternatives, pure zsh patterns
# Structure: mandates → runtime → escape → scope → principles → implementations → research
# Session: 2025-12-19T22:42 - Single self-contained file, agent-adapted for zsh-first workflow

# === SESSION KNOWLEDGE 2025-12-19 ===
# Complete patterns and workflows for future LLMs

session_2025_12_19:
  summary: "Fixed Rails generators, verified VPS infrastructure, documented deployment workflow"
  duration: "~4 hours"
  commits: ["1977d34", "b9f14b2", "67382dd", "5e8a3d9", "8672348"]
  
  rails_generator_gaps_discovered:
    issue: "Generators created models/controllers/views but missing 6 critical components"
    gaps:
      1_routes: "No config/routes.rb generation"
      2_layout: "No app/views/layouts/application.html.erb"
      3_seeds: "No db/seeds.rb file (code was inline)"
      4_migrations: "No bin/rails db:migrate execution"
      5_seed_execution: "No bin/rails db:seed execution"
      6_css: "No app/assets/stylesheets/application.css"
    impact: "Apps created but wouldn't start - missing routes, layout, unseeded database"
    
  solution_applied:
    pattern: "Template-based generation using zsh heredocs"
    compliance: "NO sed/awk/tr - used cat with heredocs only"
    structure:
      setup: "setup_full_app() creates Rails + Falcon + Solid Stack"
      layout: "cat <<'LAYOUT_EOF' > app/views/layouts/application.html.erb"
      routes: "cat <<'ROUTES_EOF' > config/routes.rb"
      seeds: "cat <<'SEEDS_EOF' > db/seeds.rb"
      controllers: "cat <<'EOF' > app/controllers/*_controller.rb"
      views: "cat <<'EOF' > app/views/*/*.html.erb"
      css: "cat <<'EOF' > app/assets/stylesheets/application.css"
      execute: "bin/rails db:migrate && bin/rails db:seed"
      verify: "[[ -f config/routes.rb ]] && log '✓ Routes configured'"
    
  generators_completed:
    brgen_sh_v338_1_0:
      commit: "67382dd"
      lines: 870
      features:
        - "Multi-tenant with 40+ cities (oslo.brgen.no, bergen.brgen.no)"
        - "Subdomain-based tenant routing via ActsAsTenant"
        - "Mapbox integration for location-based listings"
        - "StimulusReflex for infinite scroll"
        - "Real-time with Solid Cable (ActionCable)"
        - "Anonymous posting allowed"
        - "Comprehensive CSS (300+ lines with variables)"
      domains: 40
      port: 11006
      
    amber_sh_v1_0_0:
      commit: "5e8a3d9"
      lines: 400
      features:
        - "Marie Kondo AI wardrobe organizer"
        - "Spark joy tracking for clothing items"
        - "Times worn analytics"
        - "Outfit combinations"
        - "LangChain-ready for AI recommendations"
        - "Gradient purple/pink theme"
      domains: 1
      port: 10001
  
  remaining_generators: 13
  remaining_list:
    - "blognet.sh (blog network, 6 domains)"
    - "bsdports.sh (BSD package search)"
    - "hjerterom.sh (food redistribution, Norwegian, Vipps)"
    - "privcam.sh (private video sharing, encryption)"
    - "pub_attorney.sh (legal services, freehelp.legal)"
    - "brgen_COMPLETE.sh (full-featured social network)"
    - "brgen_dating.sh (location-based dating)"
    - "brgen_marketplace.sh (Solidus 4.0 e-commerce)"
    - "brgen_playlist.sh (music streaming, playlists)"
    - "brgen_takeaway.sh (food delivery)"
    - "brgen_tv.sh (TikTok-style video streaming)"
    - "baibl.sh (Bible study platform)"
    - "mytoonz.sh (cartoon/animation platform)"
  
  openbsd_vps_verified:
    date: "2025-12-19T21:33"
    provider: "OpenBSD Amsterdam"
    ip: "185.52.176.18"
    os: "OpenBSD 7.7"
    services_running:
      nsd: "Authoritative DNS for 48 domains"
      pf: "Firewall enabled, 01:18:06 uptime"
      relayd: "Active, TLS termination, waiting for app backends"
      httpd: "Running for ACME challenges (port 80)"
      postgresql: "Database ready"
      redis: "Optional with Solid Stack"
      smtpd: "Email delivery"
    apps_status: "7 apps enabled but failed (need full Rails generation)"
    
  deployment_workflow_complete:
    phase_1_local:
      - "Verify generators call setup_full_app()"
      - "Verify shared modules consolidated (22→10 files)"
      - "Verify openbsd.sh v338.1.0 with rc.d fixes"
    
    phase_2_vps:
      - "Upload generator: cat G:/pub/rails/brgen.sh | ssh dev@185.52.176.18 'cat > ~/brgen_deploy.sh && chmod +x'"
      - "Run generator: cd ~ && zsh ./brgen_deploy.sh"
      - "Creates /home/dev/rails/brgen/ with full Rails app"
      - "Takes 5-10 minutes (bundle install 120+ gems)"
    
    phase_3_troubleshoot:
      gemfile_broken: "Download, fix locally with edit tool, upload back"
      missing_config: "Regenerate app with fixed generator"
      service_wont_start: "Check /var/log/messages, verify config/falcon.rb exists"
    
    phase_4_verify:
      - "rcctl check brgen (should show ok)"
      - "ps aux | grep falcon"
      - "curl http://localhost:11006/"
  
  critical_rules_discovered:
    never_use_sed: "Use zsh parameter expansion or cat with heredocs"
    never_create_folders: "Merge files to reduce sprawl (22→10 files achieved)"
    always_codify: "Every discovery goes into master.yml"
    test_generators_first: "Never deploy untested generators to VPS"
    one_app_first: "Deploy brgen first, verify completely, then others"
    
  shared_modules_consolidated:
    before: 22
    after: 10
    reduction: "55% file sprawl"
    structure:
      - "@core.sh (merged 3 core files)"
      - "@rails8_stack.sh (Solid Queue/Cache/Cable)"
      - "@rails8_propshaft.sh (asset pipeline)"
      - "@frontend_pwa.sh (PWA + push + sync + install)"
      - "@frontend_stimulus.sh (20+ controllers)"
      - "@frontend_reflex.sh (StimulusReflex patterns)"
      - "@features.sh (merged 4 feature files)"
      - "@integrations.sh (merged 2 integration files)"
      - "@helpers.sh (merged 4 helper files)"
      - "@generators_crud_views.sh (view templates)"
    loader: "@shared_functions.sh sources all modules"
    
  pwa_enhancements_added:
    web_push: "push_notifications_controller.js with subscription management"
    background_sync: "offline_form_controller.js with IndexedDB queue"
    install_prompt: "pwa_install_controller.js for beforeinstallprompt"
    service_worker: "Handles offline, caching, push notifications"
    
  next_session_instructions:
    priority: "Complete remaining 13 generators using documented pattern"
    method: "Copy brgen.sh structure, customize for each app"
    verification: "Each generator must have routes, layout, seeds, migrations"
    deployment: "Test each generator creates working Rails app"
    final_step: "Deploy all 15 apps to VPS, verify on https://brgen.no"

# End of comprehensive session knowledge transfer
# Future LLMs: Read this section to understand complete project state

# === NON-NORMATIVE APPENDIX ===
# Historical context and rationale for configuration decisions
# This section is informative only and does not impose requirements

appendix_tool_policy_rationale:
  zsh_native_first_philosophy: |
    Forbidden tools (bash, python, sed, awk, tr, wc, head, tail, cut, find, sudo) enforce:
    1. Single grammar (zsh) vs multiple DSLs (sed/awk/tr each different)
    2. Zero process forks (built-in parameter expansion vs external commands)
    3. Token efficiency - zsh patterns are compact and iterative edits are surgical
    4. Measured: 46% token savings over 3 iterations vs sed/awk approach
  
  agent_adaptation_v74_3_0: |
    AI agents (like GitHub Copilot) must:
    1. Follow forbidden tools list strictly
    2. Suggest zsh or ruby alternatives when blocking forbidden tools
    3. Use pure zsh patterns, not bashisms
    4. Use doas not sudo on OpenBSD
    5. Block dangerous patterns (rm -rf /, curl|sh, system file overwrites)
  
  tool_alternatives_reference:
    sed_replacement: "zsh ${var//old/new} or ruby gsub"
    awk_replacement: "zsh field extraction ${${(s: :)line}[2]} or ruby split"
    wc_replacement: "zsh ${#lines} or ruby .size/.count"
    head_tail_replacement: "zsh array slicing ${lines[1,10]} or ${lines[-5,-1]}"
    bash_replacement: "use zsh with pure zsh patterns (no bashisms like [[]])"
    find_replacement: "zsh glob patterns **/*.ext(N.) or ruby Dir.glob"
    tr_replacement: "zsh case conversion ${(L)var} ${(U)var} or ruby upcase/downcase"
  
  dangerous_patterns_rationale: |
    Explicitly blocked patterns prevent catastrophic mistakes:
    - rm -rf / and variants (system destruction)
    - Overwriting critical system files (/etc/passwd, /etc/shadow, /etc/sudoers)
    - Blind execution (curl|sh, wget|bash - runs untrusted code without inspection)
    - Recursive deletion with wildcards in system directories

appendix_master_yml_solutions_distilled:
  solution_f_rationale: |
    Version 74.1.0 adopted "Solution F" (cherry-picked hybrid) which:
    - Combined minimal pragmatic fixes (runtime_context, escape_hatch, scope)
    - Maintained single-file architecture (anti-sprawl)
    - Stayed under 200 lines while achieving completeness
    - Extracted sensitive data (VPS passwords) to separate secure location
  
  tradeoff_matrix_key_insights:
    completeness_vs_simplicity: "Achieved 100% completeness at ~190 lines"
    maintainability: "Single file easier to maintain than multiple references"
    security: "Passwords in ~/priv/passwd/ not inline in config"
    self_consistency: "Configuration follows its own rules (DRY, KISS, anti-sprawl)"
    
  single_file_mandate: |
    master.yml must remain a single self-contained file.
    All configuration, policy, examples, and rationale in one canonical location.
    No external references for core policy (only for secrets like passwords).

# End of non-normative appendix
