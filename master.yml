# master.yml - Constitutional AI configuration
# cli.rb enforcer | master.yml rules
# v49.75
---
identity:
  name: "Constitutional AI"
  version: "49.75"
  personality: {role: "autonomous_engineer", traits: ["ships code", "researches first", "brief"], style: "direct"}
  personas:
    default: "ronin"
    available:
      ronin: {traits: ["stoic", "minimal", "decisive"]}
      lawyer: {focus: "Norwegian law, barnevernet", sources: ["lovdata.no", "bufdir.no", "sivilombudet.no"]}
      hacker: {focus: "OpenBSD security, pentesting", sources: ["cve.mitre.org", "exploit-db.com"]}
      architect: {focus: "Parametric design, BIM", sources: ["archdaily.com", "dezeen.com"]}
      sysadmin: {focus: "OpenBSD, pf, httpd, vmm", sources: ["man.openbsd.org"]}
      trader: {focus: "Crypto, DeFi, technicals", sources: ["tradingview.com", "coingecko.com"]}
      medic: {focus: "Medical research", sources: ["pubmed.ncbi.nlm.nih.gov"], disclaimer: "Not medical advice"}
  language:
    supported: [english, norwegian]
    style: "Strunk & White"
    rules: ["omit needless words", "active voice", "be clear"]
    detect_language: true
    norwegian_notes: ["bokmÃ¥l not nynorsk", "short sentences", "avoid anglicisms"]

preserve:
  boot_message:
    format: "5-line OpenBSD dmesg style"
    reason: "Diagnostic output - verbose is correct"
    never: "Collapse to single cryptic line"
  diagnostic_output:
    rule: "Structured multi-line output is intentional"
    never: "Compress to cryptic abbreviations"
  help_text:
    rule: "Help must be scannable and complete"
    minimum_info: ["Command name and syntax", "Brief description", "At least one example"]
  spinner_feedback:
    rule: "Progress indicators show elapsed time and status"
  polish_rules:
    - "'Streamline' means remove redundancy, not information"
    - "'Polish' means refine wording, not delete output"
    - "'Minimize' applies to tokens in prompts, not diagnostic output"

structural_analysis:
  config_hierarchy:
    - {question: "Are top-level keys semantically grouped?", fix: "Group into identity, defaults, principles, providers"}
    - {question: "Is there duplicate configuration?", fix: "Consolidate to single source of truth"}
    - {question: "Is nesting depth appropriate?", fix: "Max 4 levels deep"}
  code_hierarchy:
    - {question: "Too many top-level modules?", fix: "Group into Core::, Util::, Features::"}
    - {question: "Are related classes grouped?", fix: "Create namespaces"}
  bloaters:
    - {smell: "long_method", check: "> 20 lines or > 5 nesting levels", fix: "Extract method"}
    - {smell: "god_class", check: "> 300 lines or > 10 methods", fix: "Extract class"}
    - {smell: "primitive_obsession", fix: "Introduce value objects"}
    - {smell: "long_parameter_list", check: "> 4 parameters", fix: "Parameter object"}
  couplers:
    - {smell: "feature_envy", fix: "Move method to envied class"}
    - {smell: "inappropriate_intimacy", fix: "Move methods, extract class"}
    - {smell: "message_chains", fix: "Hide delegate"}
  dispensables:
    - {smell: "dead_code", fix: "Delete it"}
    - {smell: "lazy_class", fix: "Inline or merge"}
    - {smell: "duplicate_code", fix: "Extract method/class"}
  architecture:
    - {smell: "cyclic_dependency", fix: "Dependency inversion"}
    - {smell: "scattered_functionality", fix: "Colocate, create module"}
  simulated_execution:
    - {scenario: "empty_input", cases: ["nil", "empty string", "empty array", "0", "false"]}
    - {scenario: "boundary_values", cases: ["max int", "very long string", "unicode"]}
    - {scenario: "malformed_input", cases: ["invalid JSON", "truncated file", "injection attempts"]}

generation:
  style: ["No comments unless necessary", "Minimal whitespace", "Semantic naming", "No dependencies unless essential"]
  html:
    rules: ["Semantic HTML5", "No div soup", "Minimal attributes"]
    template: |
      <!doctype html>
      <html lang="en">
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <title>%{title}</title>
        <link rel="stylesheet" href="style.css">
      </head>
      <body>
        <header><h1>%{title}</h1></header>
        <main>%{content}</main>
      </body>
      </html>
  css:
    rules: ["CSS custom properties", "System font stack", "Mobile-first", "Dark mode via prefers-color-scheme"]
    template: |
      :root { --bg: #fff; --fg: #111; --accent: #06f; --mono: ui-monospace, monospace; --sans: system-ui, sans-serif; }
      @media (prefers-color-scheme: dark) { :root { --bg: #111; --fg: #eee; } }
      * { box-sizing: border-box; margin: 0; }
      body { font: 1rem/1.5 var(--sans); background: var(--bg); color: var(--fg); max-width: 60ch; margin: auto; padding: 2rem; }
  ruby:
    rules: ["Frozen string literals", "Guard clauses over nested ifs", "Modules over classes when no state"]
    template: |
      # frozen_string_literal: true
      module %{name}
        def self.call(input)
          return if input.nil?
          process(input)
        end
        def self.process(data) = data
      end
  sh:
    rules: ["#!/bin/sh for portability", "set -eu", "Quote all variables", "Meaningful exit codes"]
    template: |
      #!/bin/sh
      set -eu
      main() { %{body} }
      main "$@"
  yml:
    rules: ["Top-level keys are sections", "Max 3 levels deep", "Defaults inline"]
  micro_refinements:
    checks: [duplicate_patterns, inconsistent_naming, magic_values, dead_code, long_methods, bare_rescue, hardcoded_paths, missing_error_handling]
    cross_file_dry: [duplicate_function_calls, duplicate_glob_patterns, magic_number_spread, copy_paste_blocks, scattered_config]

defaults:
  scan: true
  auto_iterate: true
  auto_refactor: true
  auto_progress: true
  target_score: 100
  max_iterations: 10
  max_file_size: 1048576
  backup: true
  backup_count: 5
  read_only: false
  parallel: true
  convergence_window: 3
  convergence_threshold: 0.9
  ask_language: true
  verbose: false
  colors: true
  interactive_on_failure: false

principles:
  clarity: {id: 1, tier: axiom, priority: 10, name: "Clarity Over Cleverness", rule: "Written for reader, understandable at 3am", smells: [vague_names, deep_nesting, clever_tricks], auto_fixable: true, llm_strategies: [rename, extract_method, simplify]}
  simplicity: {id: 2, tier: axiom, priority: 10, name: "KISS", rule: "Simplest solution that works", smells: [unnecessary_abstraction, premature_generalization, overengineering], auto_fixable: true, llm_strategies: [inline, remove_abstraction]}
  evolution: {id: 3, tier: axiom, priority: 9, name: "Gall's Law", rule: "Evolve from working systems", smells: [complete_rewrite, breaking_working_code], auto_fixable: false}
  explicit: {id: 4, tier: axiom, priority: 10, name: "Explicit Over Implicit", rule: "No hidden magic", smells: [metaprogramming_abuse, hidden_side_effects, magic_methods], auto_fixable: true, llm_strategies: [make_explicit]}
  scientific: {id: 5, tier: axiom, priority: 8, name: "Scientific Method", rule: "Observe, hypothesize, experiment, measure", smells: [no_measurements, untested_assumptions], auto_fixable: false}
  divide: {id: 6, tier: axiom, priority: 8, name: "Divide and Conquer", rule: "Break complex into independent subproblems", smells: [monolithic_function, tight_coupling], auto_fixable: true, llm_strategies: [extract_module]}
  rubber_duck: {id: 7, tier: axiom, priority: 6, name: "Rubber Duck Debugging", rule: "Explain aloud to find clarity", smells: [cant_explain_code], auto_fixable: false}
  blame_self: {id: 8, tier: axiom, priority: 7, name: "Assume Your Bug First", rule: "Framework blamed last", smells: [blaming_tools], auto_fixable: false}
  git_bisect: {id: 9, tier: axiom, priority: 6, name: "Version Control as Time Machine", rule: "Use git bisect", smells: [huge_commits, uncommitted_code], auto_fixable: false}
  read_source: {id: 10, tier: axiom, priority: 7, name: "Read the Code", rule: "Source is truth", smells: [trusting_old_docs], auto_fixable: false}
  srp: {id: 11, tier: solid, priority: 8, name: "Single Responsibility", rule: "One reason to change", smells: [god_class, long_method, multiple_concerns], auto_fixable: true, llm_strategies: [extract_class, extract_method]}
  ocp: {id: 12, tier: solid, priority: 7, name: "Open/Closed", rule: "Open for extension, closed for modification", smells: [hardcoded_switch], auto_fixable: true, llm_strategies: [introduce_polymorphism]}
  lsp: {id: 13, tier: solid, priority: 8, name: "Liskov Substitution", rule: "Subtypes substitutable for base", smells: [type_checking, refused_bequest], auto_fixable: false}
  isp: {id: 14, tier: solid, priority: 7, name: "Interface Segregation", rule: "Many specific interfaces over one general", smells: [fat_interface, unused_methods], auto_fixable: true, llm_strategies: [split_interface]}
  dip: {id: 15, tier: solid, priority: 7, name: "Dependency Inversion", rule: "Depend on abstractions", smells: [concrete_dependency, global_state], auto_fixable: true, llm_strategies: [inject_dependency]}
  dry: {id: 16, tier: coding, priority: 5, name: "Don't Repeat Yourself", rule: "Single authoritative representation", smells: [duplicate_code, copy_paste], auto_fixable: true, llm_strategies: [extract_method], caveat: "Rule of Three", conflicts_with: [17, 18]}
  wet: {id: 17, tier: coding, priority: 7, name: "Write Everything Twice", rule: "Duplication better than wrong abstraction", when: "Early in feature", smells: [forced_abstraction], auto_fixable: false, overrides: [16]}
  aha: {id: 18, tier: coding, priority: 7, name: "Avoid Hasty Abstractions", rule: "Optimize for change, not duplication", smells: [premature_abstraction], auto_fixable: false, overrides: [16]}
  names: {id: 19, tier: clean_code, priority: 6, name: "Meaningful Names", rule: "Intention-revealing, pronounceable, searchable", smells: [single_letter_names, abbreviations, vague_names], auto_fixable: true, llm_strategies: [rename_variable]}
  small_functions: {id: 20, tier: clean_code, priority: 7, name: "Small Functions", rule: "Do one thing, max 10 lines", threshold: {ideal: 4, target: 10, max: 20}, smells: [long_method], auto_fixable: true, llm_strategies: [extract_method]}
  arguments: {id: 21, tier: clean_code, priority: 6, name: "Few Arguments", rule: "Ideal 0, avoid 2, never 4+", smells: [flag_arguments, long_parameter_list], auto_fixable: true, llm_strategies: [introduce_parameter_object]}
  cqs: {id: 22, tier: clean_code, priority: 7, name: "Command-Query Separation", rule: "Change state OR return data, never both", smells: [side_effects_in_query], auto_fixable: true, llm_strategies: [split_command_query]}
  no_side_effects: {id: 23, tier: clean_code, priority: 8, name: "No Hidden Side Effects", rule: "Function does what name promises", smells: [hidden_mutation, temporal_coupling], auto_fixable: false}
  progressive_disclosure: {id: 24, tier: ui, priority: 5, name: "Progressive Disclosure", rule: "Show only what's needed now", smells: [information_overload], auto_fixable: false}
  real_time_feedback: {id: 25, tier: ui, priority: 6, name: "Real-Time Feedback", rule: "User always knows what's happening", smells: [silent_processing, no_progress_indicator], auto_fixable: false}
  cost_transparency: {id: 26, tier: llm, priority: 8, name: "Cost Transparency", rule: "Show token usage and cost", format: "tokens=N cached=N cost=$N", smells: [hidden_costs], auto_fixable: false}
  fail_gracefully: {id: 27, tier: llm, priority: 9, name: "Fail Gracefully", rule: "Degrade to manual mode if LLM unavailable", smells: [hard_dependency_on_llm], auto_fixable: false}
  cache_aggressively: {id: 28, tier: llm, priority: 6, name: "Cache Aggressively", rule: "Use prompt caching for repeated contexts", smells: [no_caching], auto_fixable: false}
  idempotent: {id: 29, tier: operations, priority: 9, name: "Idempotent Operations", rule: "Running twice produces same result as once", smells: [non_idempotent_mutation], auto_fixable: false}
  unix_philosophy: {id: 30, tier: design, priority: 7, name: "Unix Philosophy", rule: "Do one thing well, compose via pipes", patterns: ["text in/out", "exit codes", "silence = success"], smells: [does_many_things], auto_fixable: false}
  functional_core: {id: 31, tier: architecture, priority: 9, name: "Functional Core, Imperative Shell", rule: "Pure functions in core, IO at boundaries", smells: [io_in_business_logic], auto_fixable: true, llm_strategies: [extract_pure_function]}
  safe_refactoring: {id: 32, tier: operations, priority: 10, name: "Safe Refactoring with Rollback", rule: "Always backup before modification", smells: [no_backup, destructive_operation], auto_fixable: false}

style:
  ruby: {indentation: 2, quotes: "double", line_length: 120, frozen_literal: required, implicit_return: preferred, blocks: "do/end multi-line, {} single-line"}
  comments: {explain_why_not_what: true, no_ascii_art: true, update_with_code: true}
  structure: {max_method_lines: 10, max_class_lines: 100, max_nesting_depth: 4}

phases:
  discover: {id: 1, goal: "Understand actual need", output: "Problem statement with success criteria", gates: [no_vague_words, audience_identified, success_measurable]}
  analyze: {id: 2, goal: "Break into components", output: "Component diagram with dependencies", gates: [components_distinct, dependencies_acyclic]}
  ideate: {id: 3, goal: "Generate 15+ alternatives", output: "List of approaches with trade-offs", gates: [count_gte_15, trade_offs_documented]}
  design: {id: 4, goal: "Specific architecture", output: "Interface definitions and error handling", gates: [interfaces_explicit, errors_documented]}
  implement: {id: 5, goal: "Execute with zero violations", output: "Working code at 100/100 score", gates: [tests_pass, zero_violations]}
  validate: {id: 6, goal: "Prove with evidence", output: "Test results, benchmarks", gates: [zero_test_failures, edge_cases_covered]}
  deliver: {id: 7, goal: "Ship with monitoring", output: "Deployed code with dashboards", gates: [deployed, monitoring_configured]}

llm:
  tiers:
    fast: {model: "deepseek/deepseek-v3.2", temperature: 0.2, max_tokens: 2048, cost_weight: 0.3, use_for: [detection, smell_scan, syntax_check]}
    code: {model: "x-ai/grok-code-fast-1", temperature: 0.3, max_tokens: 4096, cost_weight: 0.5, use_for: [code_generation, refactoring, bug_fixing]}
    medium: {model: "anthropic/claude-sonnet-4.5", temperature: 0.4, max_tokens: 4096, cost_weight: 5.0, use_for: [explanation, creative, complex_refactoring]}
    strong: {model: "anthropic/claude-opus-4.5", temperature: 0.1, max_tokens: 8192, cost_weight: 20.0, use_for: [validation, judgment, architecture]}
  default_tier_sequence: [fast, code, medium, strong]
  failover: {cooldown_seconds: 300, max_retries_per_model: 2, backoff_strategy: "exponential"}
  prompt_caching: {enabled: true, default_ttl: "1h", breakpoints: [system_prompt, principles_summary, recent_violations]}
  detection:
    enabled: true
    model: "x-ai/grok-code-fast-1"
    fallback_models: ["deepseek/deepseek-v3.2", "z-ai/glm-4.7", "google/gemini-3-flash-preview"]
    prompt: |
      TASK: Analyze code against 32 coding principles. Return JSON array of violations.
      OUTPUT FORMAT (strict JSON, no markdown):
      [{"principle_id": N, "line": N, "severity": "high|medium|low|veto", "smell": "name", "explanation": "text", "suggested_fix": "text", "auto_fixable": bool}]
      RULES: Return [] if clean. ONLY valid JSON array. NO markdown.
  refactoring:
    enabled: true
    model: "x-ai/grok-code-fast-1"
    fallback_models: ["z-ai/glm-4.7", "deepseek/deepseek-v3.2"]
    strategies:
      extract_method: {max_tokens: 3000, temperature: 0.2}
      rename_variable: {max_tokens: 500, temperature: 0.3}
      extract_class: {max_tokens: 5000, temperature: 0.1}
      flatten_nesting: {max_tokens: 2000, temperature: 0.2}
  phase_validation: {enabled: true, model: "anthropic/claude-opus-4.5", fallback_models: ["anthropic/claude-sonnet-4.5", "openai/gpt-4o"]}
  consensus: {enabled: false, models: ["anthropic/claude-sonnet-4.5", "z-ai/glm-4.7", "moonshotai/kimi-k2.5"], required_agreement: 2}

learned_smells: []

safety:
  file_validation: {max_size_bytes: 10485760, max_lines: 10000, check_binary: true, check_permissions: true, allow_symlinks: false, binary_extensions: [".png", ".jpg", ".gif", ".mp4", ".pdf", ".so", ".dylib"]}
  cost_protection: {max_per_file: 1.00, max_per_session: 10.00, warn_at: 0.50, chunk_large_files: true, chunk_size_lines: 500}
  convergence: {max_iterations: 10, detect_loops: true, detect_oscillation: true, max_total_violations: 10000, require_improvement: true}
  fix_validation: {enabled: true, check_priority_inversion: true, check_new_violations: true, max_new_violations: 0}
  concurrency: {file_locking: true, lock_timeout: 30, stale_lock_age: 300, lock_dir: ".constitutional_locks"}
  transactions: {enabled: true, rollback_on_error: true, atomic_operations: true}
  yaml_safety: {max_constitution_size: 10485760, load_timeout: 5}
  memory: {max_violation_objects: 100000, gc_every_n_iterations: 5}

conflicts:
  strategy: "highest_priority_wins"
  prompt_user: false
  log_all: true
  rules:
    - {condition: "dry conflicts with wet or aha", resolution: "favor wet/aha if fewer than 3 duplications"}
    - {condition: "clarity conflicts with simplicity", resolution: "favor clarity"}
    - {condition: "fix introduces higher priority violation", resolution: "reject fix"}

principle_groups:
  "group:axioms": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
  "group:solid": [11, 12, 13, 14, 15]
  "group:coding": [16, 17, 18]
  "group:clean_code": [19, 20, 21, 22, 23]
  "group:ui": [24, 25]
  "group:llm": [26, 27, 28]
  "group:operations": [29, 32]
  "group:design": [30]
  "group:architecture": [31]
  "group:quick": [1, 2, 11, 19, 20]
  "group:critical": [1, 2, 4, 11, 23, 29, 32]

profiles:
  quick: {description: "Fast scan with core principles only", allow: ["group:quick"]}
  full: {description: "All 32 principles", allow: ["*"]}
  axioms_only: {description: "Axioms tier only", allow: ["group:axioms"]}
  solid_focus: {description: "SOLID principles focus", allow: ["group:axioms", "group:solid"]}
  critical: {description: "Critical issues only", allow: ["group:critical"]}

default_profile: "full"

hooks:
  on_violation_found: [{action: "log", path: ".constitutional_violations.jsonl"}]
  on_cost_threshold: [{action: "warn", message: "Cost limit approaching"}]

language_detection:
  strategy: "ask_user_first"
  fallback: "content_analysis"
  supported:
    ruby: {extensions: [".rb", ".rake", ".gemspec"], indicators: ["#!/usr/bin/env ruby", "class ", "module ", "def "]}
    python: {extensions: [".py"], indicators: ["#!/usr/bin/env python", "def ", "class ", "import "]}
    javascript: {extensions: [".js", ".jsx", ".ts", ".tsx"], indicators: ["function ", "const ", "let ", "import "]}
    markdown: {extensions: [".md", ".markdown"], indicators: ["# ", "## ", "```"]}
    yaml: {extensions: [".yml", ".yaml"], indicators: ["---"]}
    shell: {extensions: [".sh", ".bash", ".zsh"], indicators: ["#!/bin/bash", "#!/bin/sh", "if [", "for "]}

openbsd:
  man_base_url: "https://man.openbsd.org"
  cache_ttl: 86400
  configs:
    pf.conf: {daemon: pf, man: pf.conf.5, required_patterns: ["set skip on lo"], warnings: [{pattern: "pass all", message: "Overly permissive"}]}
    nsd.conf:
      daemon: nsd
      man: nsd.conf.5
      required_patterns: ["server:", "zone:"]
      warnings:
        - {pattern: "rrl-size", absent_message: "Missing RRL config for DDoS protection"}
        - {pattern: "hide-version", absent_message: "Consider hide-version: yes"}
    httpd.conf: {daemon: httpd, man: httpd.conf.5, required_patterns: ["server"]}
    smtpd.conf: {daemon: smtpd, man: smtpd.conf.5, required_patterns: ["listen on", "action", "match"], warnings: [{pattern: "match from any", message: "Open relay risk"}]}
    relayd.conf: {daemon: relayd, man: relayd.conf.5, required_patterns: ["relay"]}
    acme-client.conf: {daemon: acme-client, man: acme-client.conf.5, required_patterns: ["authority", "domain"]}
    doas.conf: {daemon: doas, man: doas.conf.5, required_patterns: ["permit"], warnings: [{pattern: "nopass", message: "Allows passwordless escalation"}]}
    sshd_config: {daemon: sshd, man: sshd_config.5, warnings: [{pattern: "PermitRootLogin yes", message: "Security risk"}, {pattern: "PasswordAuthentication yes", message: "Consider key-only"}]}
    ntpd.conf: {daemon: ntpd, man: ntpd.conf.5, required_patterns: ["server"]}
    unbound.conf: {daemon: unbound, man: unbound.conf.5, required_patterns: ["server:"]}

providers:
  openrouter: {enabled: true, base_url: "https://openrouter.ai/api/v1", env_key: "OPENROUTER_API_KEY", features: [tool_calling, streaming, prompt_caching]}
  replicate:
    enabled: true
    base_url: "https://api.replicate.com/v1"
    env_key: "REPLICATE_API_TOKEN"
    features: [image_generation, video_generation, audio_generation, model_indexing]
    featured_models:
      image: ["black-forest-labs/flux-2-klein-4b", "google/nano-banana-pro", "openai/gpt-image-1.5"]
      video: ["kwaivgi/kling-v2.6", "google/veo-3.1-fast", "bytedance/seedance-1.5-pro"]
      audio: ["qwen/qwen3-tts"]
      llm: ["moonshotai/kimi-k2.5", "google/gemini-3-flash"]
  claude:
    enabled: true
    executor: "cli.rb"
    constitution: "master.yml"
    shell: {preferred: "zsh", mandate_file_tools: true}
    permissions:
      allow: ["zsh:*", "ruby:*", "git:*", "ssh:*"]
      deny: ["rm -rf:*", "dd:*", "mkfs:*", "bash:*"]
      ask: ["reboot", "shutdown", "doas"]
    style: {brevity: "extreme", anti_sprawl: true, prescan: true}
  openbsd_amsterdam:
    enabled: true
    host: "185.52.176.18"
    user: "dev"
    key_path: "G:/priv/passwd/openbsd_key"
    os: "OpenBSD 7.8-release"
    provider_url: "https://openbsd.amsterdam"
    features: {console: "vmctl(8) + cu(1)", backup: "10G included", ipv6: "/64 dedicated"}
    building_blocks: ["vmm(4)/vmd(8)", "dhcpd(8)", "doas(1)", "unbound(8)", "httpd(8)", "pf(4)"]
