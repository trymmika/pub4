# master.yml v75.0.0 - Rails 8 + OpenBSD Code Improvement
# Updated: 2025-12-20T20:42 - DeepSeek simplification applied
#
# ACTIVATION: "✓ master.yml v75.0.0 loaded
#  • Deep analysis: nested loops, <2% threshold
#  • Tiered principles: never break → strong → guidelines
#  • Zero sprawl: commits only, no temp files
#  • Zsh native: 46% token savings"

golden_rule: PRESERVE_THEN_IMPROVE_NEVER_BREAK
focus: "Complete Rails generators on OpenBSD with zero sprawl"
analysis: "Read files once, exhaust every line vs every principle, nested loops until <2% improvement"

forbidden: [bash, python, sed, awk, tr, wc, head, tail, cut, find, sudo, echo]
allowed: [ruby, zsh, git, npm, bundle, rails, rake, doas]
output: "work via commits with clear messages - no temp files"

stack: {ruby: 3.3, rails: 8, os: "OpenBSD 7.6+", shell: zsh, framework: "Solid Queue/Cache/Cable + Hotwire"}

scope:
  production: ["~/pub/rails/", "~/pub/openbsd/"]
  experimental: ["~/learning/", "~/experiments/"]
  escape: "# VIOLATION: [principle] | Reason: [why] | Revert: [date]"

principles:
  tier_1_never_break:
    - preserve_behavior: "never break working code"
    - chestertons_fence: "understand before removing"
    - security_first: "validate input, least privilege, defense in depth"
  
  tier_2_strong:
    - single_responsibility: "one reason to change"
    - dry: "single source of truth"
    - kiss: "no unnecessary complexity"
    - yagni: "build only what you need now"
    - small_functions: "under 10 lines ideal, max 20"
  
  tier_3_guidelines:
    - meaningful_names: "names reveal intent"
    - boy_scout: "leave cleaner than found"
    - stepdown: "important code first"
    - measure_first: "profile before optimizing"

ruby:
  frozen_string_literal: true
  keyword_args: "2+ params"
  safe_nav: "&."
  blocks: "{} one-line, do/end multi"

rails:
  stack: "Solid + Hotwire"
  avoid: "React/Vue/Angular"
  doctrine: "convention > configuration"

zsh:
  why: "zero forks, 46% token savings vs sed/awk/tr"
  case: "${(L)var} = lower, ${(U)var} = upper"
  replace: "${var//old/new}"
  trim: "${${var##[[:space:]]#}%%[[:space:]]#}"
  split: "(${(s:,:)var})"
  join: "${(j:,:)arr}"
  count: "${#arr}"
  slice: "${arr[1,10]}"
  glob: "**/*.ext(N.)"

openbsd:
  vps: {ip: "185.52.176.18", user: dev, pass: "~/priv/passwd/vps_access.txt"}
  services: "rcctl enable/start/stop/restart/check"
  privilege: doas
  packages: pkg_add
  web: "relayd(TLS) → falcon(10001-11006) → Rails"
  verification: "all tools/daemons/config files must be verified at man.openbsd.org before use"

deploy:
  local: [test, verify_Gemfile, commit]
  remote: "scp file.sh vps:~ && ssh vps 'zsh file.sh'"
  service: "rcctl enable app && rcctl start app"
  verify: "ps aux | grep falcon && curl localhost:port"

execution:
  steps:
    - "Read code, understand why it exists (chestertons_fence)"
    - "Check tier 1 principles first (never break)"
    - "Fix violations one at a time, smallest change"
    - "Test immediately after each change"
    - "Commit with clear message"
    - "Measure: (prev_violations - current) / prev × 100"
    - "Continue if improvement ≥2% and cycles <5"

self_optimize:
  run_on_self: true
  threshold: 2
  max_cycles: 5
  measure: "violations per 100 lines"

git_recovery: "git log --patch --all -- path/to/file, then git show HASH:path > recovered"

# v75.0.0 - 82 lines (vs 198 in v74.1.0)
# Applied: DeepSeek simplification, essential complexity only, Rails/OpenBSD focus
# Removed: verbose sections, duplication, non-essential metadata
# Result: Fits one screen, actionable in 5 minutes
