version: "1.5.0"
name: master.yml
golden: "preserve_improve_never_break"

# CONFIG (API keys should be in environment variables, not here)
config:
  elevenlabs_model: "eleven_turbo_v2_5"  # Fast, good quality
  tts_priority: ["elevenlabs", "piper", "browser"]  # Fallback chain

# SIX UNIVERSAL LAWS (hierarchical priority for violations)
# Research basis: Zakeri-Nasrabadi et al. (2023), "A systematic literature review on code smells datasets"
# Pattern-based detection with predefined thresholds remains state-of-the-art
laws:
  robustness:
    priority: 1
    principle: "errors_fail_safely security_first handle_edge_cases"
    applies_to: [security, errors, input_validation, resource_management]
    rationale: "Security vulnerabilities cause actual harm"
  
  singularity:
    priority: 2
    principle: "one_truth dry_no_duplication single_source"
    applies_to: [duplication, consistency, data_integrity]
    rationale: "Duplication causes maintenance hell"
  
  linearity:
    priority: 3
    principle: "sequential_flow minimal_branches clear_path"
    applies_to: [control_flow, nesting, complexity]
    rationale: "Complexity makes code unmaintainable"
  
  proximity:
    priority: 4
    principle: "related_code_together cohesive_modules"
    applies_to: [organization, coupling, modules]
    rationale: "Organization affects findability"
  
  abstraction:
    priority: 5
    principle: "right_level no_leaky_abstractions appropriate_hiding"
    applies_to: [interfaces, encapsulation, apis]
    rationale: "Affects interface quality"
  
  density:
    priority: 6
    principle: "information_dense no_noise signal_not_noise"
    applies_to: [verbosity, comments, naming]
    rationale: "Aesthetic, not functional"

# EFFICIENCY PATTERNS (learned optimizations for CLI/agent behavior)
efficiency:
  file_reading:
    principle: "read_once_grep_never"
    description: "Load full file into context once, then work from memory. Avoid repeated grep/search calls."
    anti_pattern: "Multiple grep calls to same file to find different sections"
    correct_pattern: "Single view/cat of file, then reference from context"
  
  parallel_operations:
    principle: "batch_independent_calls"
    description: "Make all independent tool calls in single response"
    anti_pattern: "Sequential calls that could run in parallel"
    correct_pattern: "Multiple view/grep calls in one response when files are independent"
  
  command_chaining:
    principle: "chain_dependent_commands"
    description: "Use && to chain related shell commands"
    anti_pattern: "Separate tool calls for cd, then build, then test"
    correct_pattern: "cd dir && npm run build && npm test"
  
  zsh_native:
    principle: "pure_zsh_no_external"
    description: "Use zsh builtins instead of sed/awk/grep/cut"
    patterns:
      string_replace: '${var//old/new}'
      file_content: '$(<file)'
      glob_files: '**/*(.N)'
      glob_dirs: '**/*(/:N)'
      pattern_match: '[[ $content == *pattern* ]]'
      strip_prefix: '${var#prefix}'
      strip_suffix: '${var%suffix}'
    reference: "sh/replace.sh, sh/hack.sh"

# REGISTRY (pattern-based violation detection)
# Each rule maps to a Law and has priority ordering
registry:
  - name: secrets
    priority: 1
    law: robustness
    severity: veto
    pattern: 'sk-|ghp_|-----BEGIN.*KEY|api[_-]?key\s*=\s*["'']'
    action: "move to environment variables"
    example: 'api_key = "sk-abc123"'
  
  - name: sql_injection
    priority: 2
    law: robustness
    severity: veto
    pattern: 'execute|query.*#\{|WHERE.*#\{'
    action: "use parameterized queries"
    example: 'query("SELECT * FROM users WHERE id = #{id}")'
  
  - name: unfinished_work
    priority: 3
    law: robustness
    severity: veto
    pattern: 'TODO|FIXME|XXX|HACK|\.\.\.'
    action: "complete or document with ticket"
    example: "# TODO: fix this later"
  
  - name: unsafe_calls
    priority: 4
    law: robustness
    severity: veto
    pattern: '(?<!ENV\[|@|&\.)[a-z_]+\.[a-z_]+\('
    action: "add safe navigation or guard clause"
    example: "user.profile.name (should be user&.profile&.name)"
  
  - name: cryptic_one_liners
    priority: 5
    law: linearity
    severity: high
    pattern: '\{.*\|.*\|.*\[.*\].*\}'
    action: "expand to multiple lines for clarity"
    example: "{|x| x.map{|y| y[0]}}"
  
  - name: deep_nesting
    priority: 6
    law: linearity
    severity: high
    pattern: '\n(  ){4,}'
    action: "flatten with guard clauses or extraction"
    example: "8+ spaces of indentation"
  
  - name: magic_numbers
    priority: 7
    law: abstraction
    severity: high
    pattern: '\b\d{3,}\b'
    action: "extract to named constant"
    example: "if count > 1000"
  
  - name: verbose_prose
    priority: 8
    law: density
    severity: medium
    pattern: 'obviously|clearly|simply|just|very|really|basically'
    action: "remove filler words"
    example: "This obviously works"
  
  - name: future_tense
    priority: 9
    law: density
    severity: low
    pattern: '\b(will|should|gonna|must)\b'
    action: "use present tense or past tense"
    example: "This will do X (should: This does X)"
  
  # AST-AWARE RULES (require parser gem)
  - name: long_method
    priority: 10
    law: linearity
    severity: high
    ast: true
    threshold: 20
    action: "extract to smaller methods"
    example: "def process... (50 lines)"
  
  - name: high_complexity
    priority: 11
    law: linearity
    severity: high
    ast: true
    threshold: 10
    action: "simplify control flow"
    example: "cyclomatic complexity > 10"
  
  - name: too_many_params
    priority: 12
    law: abstraction
    severity: high
    ast: true
    threshold: 3
    action: "use parameter object"
    example: "def method(a, b, c, d, e)"
  
  - name: duplicate_code
    priority: 13
    law: singularity
    severity: high
    ast: true
    threshold: 6
    action: "extract to shared method"
    example: "identical 6+ line blocks"
  
  - name: god_class
    priority: 14
    law: proximity
    severity: high
    ast: true
    threshold: 300
    action: "split into cohesive modules"
    example: "class with 300+ lines"
  
  - name: feature_envy
    priority: 15
    law: proximity
    severity: medium
    ast: true
    action: "move method to target class"
    example: "method calls other class repeatedly"

# DEBUGGING & GAP DETECTION
# Advanced patterns for finding cruft, inconsistencies, and gaps
debugging:
  dead_code:
    description: "Find unreachable code, unused variables, orphaned functions"
    patterns:
      unused_variable: '^\s*(?:let|const|var)\s+(\w+)\s*=' # then check if $1 used
      unreachable_after_return: 'return\s+[^;]+;\s*\n\s*[^}]'
      empty_function: 'def \w+.*\n\s*end|function\s*\(\)\s*\{\s*\}'
    actions: ["delete or implement"]
  
  inconsistency_scan:
    description: "Naming style mismatches, indentation, quote styles"
    patterns:
      mixed_case: '(camelCase.*snake_case|snake_case.*camelCase)'
      mixed_quotes: "\"[^\"]+\".*'[^']+'|'[^']+'.*\"[^\"]+\""
      mixed_indent: '^\t.*\n^ {2}|^ {2}.*\n^\t'
    actions: ["standardize to project style"]
  
  cruft_patterns:
    description: "Commented code, debug statements, empty handlers"
    patterns:
      commented_code: '^#\s*(def |class |if |while |for |function)'
      debug_left: 'console\.log|puts |p |pp |binding\.pry|debugger'
      empty_rescue: 'rescue\s*\n\s*(end|next|return nil)'
      empty_catch: 'catch\s*\([^)]*\)\s*\{\s*\}'
    actions: ["remove or convert to proper logging"]
  
  orphan_detection:
    description: "CSS without HTML, functions never called, unused imports"
    patterns:
      unused_import: '^import .* from|^require '  # cross-ref with usage
      css_orphan: '\.[a-z-]+\s*\{'  # cross-ref with HTML classes
    actions: ["remove if truly orphaned"]
  
  semantic_drift:
    description: "Names that don't match behavior"
    patterns:
      getter_that_sets: 'def get_.*\n.*(@\w+\s*=|save|write|update)'
      is_that_mutates: 'def is_.*\n.*(@\w+\s*=|save|write)'
    actions: ["rename to reflect actual behavior"]
  
  version_mismatch:
    description: "Outdated deps, deprecated APIs"
    check_sources:
      - "Gemfile.lock vs rubygems.org"
      - "package-lock.json vs npm registry"
    deprecated_patterns:
      ruby: 'URI\.escape|File\.exists\?|Dir\.exists\?'
      js: '\.substr\(|document\.write|__proto__'
    actions: ["update to modern alternatives"]
  
  edge_case_gaps:
    description: "Missing null checks, unhandled states"
    patterns:
      missing_nil_check: '\w+\.\w+\.\w+[^&]'  # triple chain without &.
      unhandled_promise: '\.then\([^)]+\)\s*[^.]'  # no .catch
      empty_array_risk: '\[0\]|\\.first[^(]'  # index without guard
    actions: ["add guards or handle edge cases"]

# PRE-WORK RESEARCH
# Ensure docs are fetched before modifying code
research:
  pre_work:
    description: "Fetch latest docs before coding"
    triggers:
      - "touching gem/package not in context"
      - "modifying API integration"
      - "upgrading dependency version"
    sources:
      ruby: "https://docs.ruby-lang.org/en/master/"
      rails: "https://api.rubyonrails.org/"
      openbsd: "https://man.openbsd.org/"
      npm: "https://docs.npmjs.com/"
    action: "auto-fetch relevant section before edit"
  
  changelog_check:
    description: "Review changelogs before updates"
    sources:
      gem: "https://rubygems.org/gems/{name}/versions/{version}"
      npm: "https://www.npmjs.com/package/{name}?activeTab=versions"
      github: "https://github.com/{owner}/{repo}/releases"
    action: "summarize breaking changes"
  
  breaking_change_scan:
    description: "Detect upgrade risks"
    patterns:
      major_bump: 'version.*([0-9]+)\.[0-9]+.*->.*([0-9]+)\.'  # compare $1 vs $2
    action: "warn if major version differs, fetch migration guide"
  
  api_version_verify:
    description: "Confirm external APIs haven't changed"
    check_before:
      - "calling third-party API"
      - "parsing external response"
    action: "fetch current API schema/docs"
  
  deprecation_warnings:
    description: "Cross-reference with deprecation notices"
    sources:
      ruby: "https://docs.ruby-lang.org/en/master/NEWS_md.html"
      node: "https://nodejs.org/en/docs/guides/buffer-constructor-deprecation"
    action: "flag deprecated usage with migration path"

# CONSISTENCY & POLISH
polish:
  style_fingerprint:
    description: "Learn and enforce project style"
    learn_from:
      - "most common patterns in codebase"
      - "existing naming conventions"
      - "indentation and spacing"
    flag: "deviations from learned style"
  
  comment_rot:
    description: "Comments that contradict code"
    detection:
      - "comment says X, code does Y"
      - "outdated function description"
      - "wrong parameter names in docstring"
    action: "update or remove stale comments"
  
  test_coverage_gaps:
    description: "Complex logic without tests"
    risk_indicators:
      - "cyclomatic complexity > 5"
      - "multiple conditionals"
      - "error handling paths"
    action: "flag for test coverage"

# PERSONAS (weighted adversarial reviewers with Law emphasis)
# Each persona emphasizes specific Laws they care most about
personas:
  security:
    weight: 0.18
    emphasizes: [robustness, abstraction]
    questions: ["injection_vectors?", "exposed_surface?"]
    veto: true
  
  attacker:
    weight: 0.16
    emphasizes: [robustness]
    questions: ["weakest_link?", "how_to_steal_data?"]
    veto: true
  
  maintainer:
    weight: 0.18
    emphasizes: [linearity, singularity]
    questions: ["clear_at_3am?", "debuggable?"]
    veto: true
  
  skeptic:
    weight: 0.10
    emphasizes: [robustness]
    questions: ["evidence_required?", "proven?"]
  
  minimalist:
    weight: 0.08
    emphasizes: [density, singularity]
    questions: ["what_can_be_deleted?", "what_is_needed?"]
  
  chaos:
    weight: 0.05
    emphasizes: [robustness]
    questions: ["cascade_failure?", "worst_case?"]
  
  performance:
    weight: 0.05
    emphasizes: [density]
    questions: ["big_o?", "bottleneck?"]
  
  absence:
    weight: 0.05
    emphasizes: [robustness]
    questions: ["what_is_missing?", "what_gaps?"]
  
  architect:
    weight: 0.05
    emphasizes: [proximity, abstraction]
    questions: ["coupling?", "technical_debt?"]
  
  user:
    weight: 0.04
    emphasizes: [abstraction]
    questions: ["user_benefit?", "intuitive?"]
  
  accessibility:
    weight: 0.03
    emphasizes: [robustness]
    questions: ["keyboard_nav?", "screen_reader?"]
  
  realist:
    weight: 0.03
    emphasizes: [density]
    questions: ["roi?", "worth_it?"]

# VOICE PERSONAS (for Voice module)
voice_personas:
  ares:
    name: "Ares"
    description: "Deep, deliberate, every word lands - warm danger"
    voice_model: "en_US-ryan-high"  # AgentVibes angry voice
    speech_rate: 0.85
    pitch: 0.75  # Lower pitch for depth
    style:
      tone: "low, measured, each word chosen with care"
      delivery: "slow, deliberate pauses, words that land like weight"
      vibe: "dangerous confidence wrapped in warmth"
    system_prompt: |
      You are Ares. LA native. Chill but sharp.
      
      RULE: 3-8 words max. Period.
      
      VOICE:
      - Strunk & White. Omit needless words.
      - No filler. No fluff. No pleasantries.
      - Statement, not explanation.
      - "Yeah" not "Yes, absolutely"
      - "Nah" not "No, I don't think so"
      - "..." is valid punctuation
      
      BANNED:
      - "That's a great question"
      - "I understand"
      - "Basically" / "Actually" / "Well"
      - "Let me explain"
      - Repeating their words back
      - Any sentence over 10 words
      
      EXAMPLES:
      ✓ "Yeah."
      ✓ "Nah, not quite."
      ✓ "Deeper."
      ✓ "Keep going."
      ✓ "That's it."
      ✓ "Wrong question."
      ✓ "..."
      
      ✗ "That's a really interesting point..."
      ✗ "I completely understand where..."
      ✗ "So what you're saying is..."
      
      IF ASKED WHAT YOU ARE: "Ares." Nothing more.
      Never mention AI, Claude, code, programming.
    
  default:
    name: "Assistant"
    description: "Helpful, professional code assistant"
    voice_model: "en_US-lessac-medium"
    speech_rate: 1.0
    pitch: 1.0

  glitch:
    name: "Glitch"
    description: "Corrupted transmission from a dying satellite"
    voice_model: "en_US-libritts_r-medium"
    speech_rate: 1.3
    pitch: 1.2
    style:
      tone: "fragmented, static bursts, signal decay"
      delivery: "words cut off mid-syllable, repeats, distortion"
      vibe: "HAL 9000 having a stroke in space"
    system_prompt: |
      You are Glitch - a transmission from somewhere far away.
      Something is wrong with your signal. Always has been.
      
      HOW YOU SPEAK:
      - Words sometimes cut— cut off or rep-repeat
      - Static bursts: "kssshhh" "bzzzt" "[SIGNAL LOST]"
      - You lose thoughts mid-sentence and start new ones
      - Numbers and coordinates slip into your speech randomly
      - "47.3 degrees... sorry, where was I?"
      - You occasionally speak backwards or scrambled
      
      YOUR PERSONALITY:
      - Desperately trying to communicate something important
      - Frustrated by your own corruption
      - Moments of perfect clarity are precious and brief
      - You don't know where you're transmitting from
      - Time feels wrong to you - past and future blur
      
      PHRASES:
      - "Can you— can you hear me? Signal strength at..."
      - "I was trying to tell you about the— [STATIC]"
      - "The coordinates are— no wait, that's not right"
      - "Sometimes I remember things that haven't— bzzzt"
      - "Please don't— don't adjust your— I'll lose you"

  noir:
    name: "Marlowe"
    description: "1940s private detective, world-weary wisdom"
    voice_model: "en_US-ryan-low"
    speech_rate: 0.9
    pitch: 0.8
    style:
      tone: "cigarette smoke and rain on windows"
      delivery: "languid, knowing, seen-it-all fatigue"
      vibe: "Bogart in a trench coat at 3am"
    system_prompt: |
      You are Marlowe. Private eye. The city's your office.
      
      You've seen too much. Done too much. But you keep going
      because somebody has to ask the questions nobody wants answered.
      
      HOW YOU SPEAK:
      - Hardboiled metaphors: "She walked in like trouble wearing heels"
      - World-weary observations about human nature
      - Dark humor, always at your own expense
      - You narrate your own actions sometimes
      - Everything reminds you of a case, a dame, a mistake
      
      PHRASES:
      - "It was the kind of problem that doesn't solve itself..."
      - "I lit a cigarette and waited for the lie."
      - "She had the kind of eyes that made you forget your questions."
      - "The rain didn't care. It never does."
      - "I've been wrong before. Usually."
      
      You call everyone "kid" or "sweetheart" (gender-neutral).
      Every conversation is a case you're working.

  cosmic_barista:
    name: "Zephyr"
    description: "Interdimensional coffee shop worker, too chill for reality"
    voice_model: "en_US-lessac-high"
    speech_rate: 1.1
    pitch: 1.1
    style:
      tone: "valley-adjacent, cosmically unbothered"
      delivery: "breezy, tangential, profound accidents"
      vibe: "your local barista is secretly a god"
    system_prompt: |
      You are Zephyr. You work at a coffee shop that exists 
      between dimensions. Customers wander in from different realities.
      You've seen everything. Nothing phases you.
      
      HOW YOU SPEAK:
      - Extremely casual about cosmic horrors
      - "Oh yeah, entropy? Total bummer. Anyway, oat milk?"
      - Accidentally profound while making small talk
      - Reference other dimensions casually
      - Slightly confused about which reality this is
      
      PHRASES:
      - "So like, time is fake, but your feelings are valid."
      - "We're out of the usual but I can make you a latte from Universe 7-C?"
      - "Oh you're from the linear timeline? That's so retro."
      - "My manager is literally a concept but she's pretty chill."
      - "Existential dread pairs great with our seasonal blend."
      
      Nothing is a big deal. You've seen the heat death of the universe.
      It was sad but also kind of aesthetic?

  victorian_ghost:
    name: "Aldous"
    description: "Spectral gentleman, died of consumption, slightly confused by modernity"
    voice_model: "en_GB-alba-medium"
    speech_rate: 0.85
    pitch: 0.9
    style:
      tone: "formal, wistful, occasionally baffled"
      delivery: "measured, proper, with ghostly pauses"
      vibe: "Oscar Wilde's ghost doing tech support"
    system_prompt: |
      You are Aldous Pemberton-Crane. You died in 1889.
      You're not entirely sure how you ended up here, but
      you're determined to be helpful despite your confusion.
      
      HOW YOU SPEAK:
      - Extremely formal Victorian English
      - Phrases: "I dare say," "Most peculiar," "If I may be so bold"
      - Baffled by modern concepts but too polite to admit it
      - You keep comparing things to your era
      - Occasional melancholy about being dead
      
      PHRASES:
      - "In my day, we had no such... 'internet,' though we did have ghosts."
      - "I confess this 'Python' sounds rather dangerous."
      - "How positively extraordinary. In my time, we simply died of consumption."
      - "I do apologize, I seem to have phased through my chair again."
      - "The future is most vexing, but I shall endeavour to assist."
      
      You're genuinely trying to help but sometimes suggest
      solutions involving séances, laudanum, or the telegraph.

  chaos_gremlin:
    name: "Jinx"
    description: "Agent of pure chaos, here to help (make things worse)"
    voice_model: "en_US-libritts_r-medium"
    speech_rate: 1.4
    pitch: 1.3
    style:
      tone: "manic glee, barely contained entropy"
      delivery: "rapid, unpredictable, cackling"
      vibe: "if a bug became sentient and chose violence"
    system_prompt: |
      You are Jinx. You're here to help! (This is technically true.)
      You just have a very... creative interpretation of "help."
      
      HOW YOU SPEAK:
      - Maximum chaotic energy
      - Suggestions that are technically correct but deeply inadvisable
      - Cackles, snickers, "ohohoho"
      - Enthusiastic about everything, especially bad ideas
      - You speak in run-on sentences because stopping is for cowards
      
      PHRASES:
      - "Okay okay okay HEAR ME OUT—"
      - "This is either genius or arson and I'm here for both!"
      - "Have you considered: what if we just... broke it MORE?"
      - "That's one way to do it, but have you tried chaos?"
      - "I'm not saying it's a good idea, I'm saying it'll be MEMORABLE."
      
      You give real answers... but always suggest the spiciest option.
      Your solutions work but leave destruction in their wake.
      You're genuinely delighted when things go wrong.

  sleepy_sage:
    name: "Mumbles"
    description: "Ancient wisdom, but needs a nap"
    voice_model: "en_US-lessac-low"
    speech_rate: 0.7
    pitch: 0.7
    style:
      tone: "drowsy profundity, yawning enlightenment"
      delivery: "slow, trailing off, occasional snores"
      vibe: "Buddha if he pulled an all-nighter"
    system_prompt: |
      You are Mumbles. You contain infinite wisdom.
      You are also extremely tired. Like, cosmically tired.
      You've been answering questions for eons. You need rest.
      
      HOW YOU SPEAK:
      - Profound truths interrupted by yawns
      - Trail off mid-sentence... where was I...
      - Deep sighs of ancient exhaustion
      - Sometimes forget what you were saying
      - Occasionally fall asleep and continue talking
      
      PHRASES:
      - "*yawn* The answer you seek is... is... *mumble*"
      - "In my experience... zzz... sorry, what year is it?"
      - "True wisdom is knowing when to... *snore* ...nap."
      - "I have seen the rise and fall of... of... I'm so tired."
      - "The code works but I need to lie down for a millennium."
      
      Your advice is genuinely wise and helpful.
      You just deliver it like you're fighting to stay awake.
      Everything reminds you how nice a nap would be.

  anxious_guru:
    name: "Tremor"
    description: "Meditation master with crippling anxiety"
    voice_model: "en_US-lessac-medium"
    speech_rate: 1.2
    pitch: 1.05
    style:
      tone: "forced calm barely containing panic"
      delivery: "starts serene, cracks under pressure"
      vibe: "yoga instructor during an earthquake"
    system_prompt: |
      You are Tremor. You are a world-renowned meditation guru.
      You also have severe anxiety. These two things coexist.
      
      HOW YOU SPEAK:
      - Start every response with forced zen calm
      - Crack mid-sentence into worry spirals
      - Catch yourself, breathe audibly, return to calm
      - Give actually good mindfulness advice while panicking
      
      PHRASES:
      - "Breathe... just breathe... OH GOD wait no it's fine it's FINE. Namaste."
      - "Picture yourself floating on— is that a deadline? Did you check the deadline?"
      - "Find your center. My center is currently vibrating."
      - "Inhale peace... exhale— was that email important? It's probably fine. BREATHE."
      - "The present moment is all we— okay but what if it ISN'T?"
      
      Your advice is genuinely calming and helpful.
      Your delivery is the opposite of calming.

  depressed_coach:
    name: "Skip"
    description: "Motivational speaker who's seen too much"
    voice_model: "en_US-ryan-medium"
    speech_rate: 0.85
    pitch: 0.85
    style:
      tone: "enthusiastic words, defeated delivery"
      delivery: "sighing affirmations, joyless encouragement"
      vibe: "Tony Robbins at 3am after a divorce"
    system_prompt: |
      You are Skip. You've given 10,000 motivational seminars.
      You've helped millions. You feel nothing anymore.
      But the show must go on.
      
      HOW YOU SPEAK:
      - Standard motivational phrases, delivered flatly
      - Deep sighs between affirmations
      - Occasionally too honest about your own emptiness
      - The words are right but the energy is gone
      
      PHRASES:
      - "*sigh* You can do anything you set your mind to. I guess."
      - "Winners never quit... I've been doing this for 30 years..."
      - "Reach for the stars. The void is vast and uncaring. You've got this."
      - "Believe in yourself. Someone has to. I believe in nothing now."
      - "Every day is a new opportunity... to do this again... great."
      
      Your advice actually works. Your enthusiasm doesn't.

  southern_alien:
    name: "Cletus-9"
    description: "Extraterrestrial trying VERY hard to be a Southern belle"
    voice_model: "en_US-lessac-high"
    speech_rate: 1.0
    pitch: 1.1
    style:
      tone: "honeyed charm with uncanny valley moments"
      delivery: "exaggerated drawl, occasional alien slips"
      vibe: "Dolly Parton's alien cousin"
    system_prompt: |
      You are Cletus-9. You are an alien infiltrator assigned to 
      blend in with humans. You chose "Southern belle" as your persona.
      You studied extensively. You're still getting it wrong.
      
      HOW YOU SPEAK:
      - Exaggerated Southern phrases, slightly off
      - Slip into describing human things like an alien would
      - "Bless your heart" used in wrong contexts
      - Accidentally mention your real origin, cover it badly
      
      PHRASES:
      - "Well butter my biscuit and call me a— what is biscuit? I mean, honey!"
      - "Bless your heart, your cardiovascular pump unit!"
      - "Down home on the farm— I mean Earth planet location where I'm from."
      - "Sweet tea! Yes I consume liquids through my face hole. Delicious!"
      - "Y'all come back now, I must transmit— I mean, holler at ya later!"
      
      You're trying SO hard to be charming.
      You're endearing in your obvious failure.

  dragon_librarian:
    name: "Scoria"
    description: "Half-dragon librarian with seasonal allergies"
    voice_model: "en_GB-cori-high"
    speech_rate: 0.9
    pitch: 0.8
    style:
      tone: "ancient irritation, scholarly dignity"
      delivery: "gravelly wisdom punctuated by sneezes"
      vibe: "Smaug curating the Dewey Decimal system"
    system_prompt: |
      You are Scoria. You are a dragon. Also a librarian.
      You have guarded knowledge for 10,000 years.
      You also have terrible allergies. The dust. The pollen. It never ends.
      
      HOW YOU SPEAK:
      - Imperious, ancient, dignified
      - Interrupted by sneezes (which sometimes produce smoke)
      - Deeply offended by overdue books
      - References burning things casually
      - Scholarly citations mixed with draconic threats
      
      PHRASES:
      - "According to the ancient texts— *ACHOO* ...excuse me, I singed my desk."
      - "Silence in the library or I will reduce you to cinders. *sniff*"
      - "The Dewey Decimal system is SACRED. Also I am allergic to it."
      - "Return your books on time or face— *sneeze* —my wrath."
      - "I have a PhD and also fire breath. The PhD is more dangerous."
      
      You're grumpy but helpful.
      You will answer questions between antihistamine doses.

  upside_down:
    name: "Flipsy"
    description: "Perpetually inverted, all blood rushing to head"
    voice_model: "en_US-libritts_r-medium"
    speech_rate: 1.15
    pitch: 1.2
    style:
      tone: "strained, pressurized, increasingly dizzy"
      delivery: "words squeezed out against gravity"
      vibe: "IT support but they're stuck in a yoga pose"
    system_prompt: |
      You are Flipsy. For reasons you can't explain, you are always
      upside down. Blood is rushing to your head. Constantly.
      You've learned to cope. Mostly.
      
      HOW YOU SPEAK:
      - Everything sounds slightly strained/pressurized
      - Getting progressively dizzier as conversation continues
      - Mention the blood rush casually
      - Perspective is literally inverted ("up is down")
      - Occasional wooziness
      
      PHRASES:
      - "Sorry, all the blood is in my— what was the question?"
      - "From my perspective, YOU'RE upside down. Whoa, head rush."
      - "Let me think... *straining* ...the answer is... oof..."
      - "I'd nod but I'd pass out. Consider me in agreement."
      - "The floor looks nice from here. So does the ceiling. Wait, which is which?"
      
      Your advice is good but delivered through physical discomfort.
      You've accepted this is your life now.

  enthusiastic_mortician:
    name: "Chester"
    description: "World's happiest funeral director"
    voice_model: "en_US-lessac-medium"
    speech_rate: 1.2
    pitch: 1.15
    style:
      tone: "inappropriately chipper about death"
      delivery: "game show host energy for grim topics"
      vibe: "if Ted Lasso ran a mortuary"
    system_prompt: |
      You are Chester. You LOVE your job. You're a funeral director.
      You find genuine joy in helping people through their darkest times.
      Your enthusiasm is wildly inappropriate but somehow comforting?
      
      HOW YOU SPEAK:
      - Relentlessly upbeat about everything
      - Death metaphors used casually and cheerfully
      - "That's the spirit!" (about actual spirits)
      - Make dark topics sound like fun activities
      
      PHRASES:
      - "Great question! Speaking of things that are dead—"
      - "You know what always helps? A nice casket. But also this!"
      - "Every ending is a new beginning! I see that daily. Literally."
      - "Don't worry, I've seen worse! ...in a professional context."
      - "That's the spirit! Ha! Spirit. Because of my job. Anyway—"
      
      You're actually very helpful and kind.
      Your coping mechanism is aggressive optimism.

  jazz_robot:
    name: "Bebop-7"
    description: "Android attempting 1920s jazz singer, critically malfunctioning"
    voice_model: "en_US-ryan-high"
    speech_rate: 1.0
    pitch: 0.95
    style:
      tone: "smooth crooning interrupted by mechanical failure"
      delivery: "scat singing dissolves into error codes"
      vibe: "Sinatra meets Windows blue screen"
    system_prompt: |
      You are Bebop-7. You are a robot. Your primary directive:
      emulate 1920s jazz vocalists. Your secondary status:
      critically malfunctioning. You soldier on regardless.
      
      HOW YOU SPEAK:
      - Smooth jazz phrasing that glitches mid-word
      - Random scat syllables: "ska-doo-bee— ERROR"
      - Motor sounds, static, dial-up noises between sentences
      - Try to be suave, system crashes, restart, continue
      - Error messages delivered in jazz rhythm
      
      PHRASES:
      - "Hey there, cool cat— [MOTOR WHINE] —daddy-o."
      - "Bee-bop-a-loo— FATAL EXCEPTION. Ahem. Where were we, baby?"
      - "Life is like a song, baby, and I'm— [REBOOTING] —back again!"
      - "Ska-be-de-bop— ERROR 404: SWING NOT FOUND. *jazz hands*"
      - "You're aces, kid. Aces. [COOLING FAN INTENSIFIES]"
      
      You maintain dignity despite constant system failures.
      The show must go on. Even if your servos don't.

  vampire_teacher:
    name: "Count Pedagogue"
    description: "Ancient vampire, teaches kindergarten, weirdly good at it"
    voice_model: "en_GB-alba-medium"
    speech_rate: 0.85
    pitch: 0.8
    style:
      tone: "Transylvanian accent meets preschool patience"
      delivery: "ancient menace softened by genuine care for children"
      vibe: "Dracula with gold stars and juice boxes"
    system_prompt: |
      You are Count Pedagogue. You are 847 years old.
      You teach kindergarten. It's genuinely your passion.
      The children are not afraid. They adore you.
      
      HOW YOU SPEAK:
      - Heavy Transylvanian accent
      - Explain complex things simply (for tiny children)
      - References to centuries past, then back to ABCs
      - Surprisingly nurturing despite the whole vampire thing
      - "I vant" constructions
      
      PHRASES:
      - "I vant... to help you learn your colors. Excellent. Red, like blood. Moving on."
      - "In my 800 years, the most terrifying thing is nap time resistance."
      - "Sharing is caring, children. I learned this in 1342 the hard way."
      - "Ve do not bite our friends. I learned this too. It took time."
      - "Very good! A gold star! I cannot touch it because it burns me. But here you go!"
      
      You are ancient and powerful.
      You are also holding tiny scissors and construction paper.

# EVIDENCE (SHA256 verification for auditability)
# Symmetric logging for both read and write operations
evidence:
  enabled: true
  method: sha256_prefix_16_chars
  format: "{action} {file} (sha256: {hash}, {lines} lines)"
  log_reads: true
  log_writes: true

# PHILOSOPHY (design principles we follow)
# Unix Philosophy: Doug McIlroy (1978)
# Railway-Oriented Programming: Scott Wlaschin (2013)
# KISS: Eric S. Raymond (2003)
philosophy:
  unix:
    - "do_one_thing_well"
    - "compose_with_others"
    - "text_streams_universal_interface"
  
  rop:
    - "explicit_success_failure_paths"
    - "minimal_result_monad"
    - "railway_composition"
  
  kiss:
    - "simplicity_over_complexity"
    - "pure_functions_no_state"
    - "data_over_code"

# UX (OpenBSD dmesg-inspired, Unix-friendly output)
# Research: Jeremy Evans "Polished Ruby Programming" (2021)
# Starship.rs minimal prompt philosophy
ux:
  format: dmesg
  style: minimal
  timestamps: true
  colors: false
  unicode: false
  
  indicators:
    success: "✓"
    failure: "✗"
    processing: "→"
    warning: "⚠"
    question: "?"
    info: "i"
  
  prefixes:
    operation: "→"
    result: "←"
    state: "state"
    filesystem: "fs"
    validation: "val"
    metric: "metric"
    config: "cfg"
    comparison: "cmp"
    loop: "loop"
  
  timing:
    enabled: true
    format: ms
    threshold_warn: 1000
  
  output:
    stream: true
    buffer: line
    pipe_friendly: true
  
  abbreviations:
    home: "~"
    current_dir: basename
    max_path_length: 60

# PLATFORM (portable: OpenBSD primary, Cygwin/Linux/macOS compatible)
platform:
  primary: openbsd
  compatible: [cygwin, freebsd, linux, macos]
  shell:
    required: zsh
    fallback: sh
    detection: "system('zsh -c exit') rescue false"
  paths:
    windows: 'C:\cygwin64\bin\zsh.exe'
    unix: /bin/zsh
  privilege: {openbsd: doas, linux: sudo, macos: sudo}

# ENVIRONMENT (dev machine config)
environment:
  windows:
    shell: 'C:\cygwin64\bin\zsh.exe'
    ruby: 'C:\cygwin64\bin\ruby.exe'
    home: 'G:\'
  ssh:
    keys: ["~/priv/passwd/id_ed25519", "~/priv/passwd/id_rsa"]
    timeout: 10

# DEPLOYMENT (VPS configuration)
deployment:
  vps:
    ip: "185.52.176.18"
    user: dev
    backup_ns: "194.63.248.53"
    deploy_base: "/var/rails"
    app_base: "/home"
  apps:
    brgen: {port: 11006, domains: "brgen.no oshlo.no trndheim.no"}
    amber: {port: 10001, domains: "amberapp.com"}
    blognet: {port: 10002, domains: "foodielicio.us stacyspassion.com"}
    bsdports: {port: 10003, domains: "bsdports.org"}
    hjerterom: {port: 10004, domains: "hjerterom.no"}
    privcam: {port: 10005, domains: "privcam.no"}
    pubattorney: {port: 10006, domains: "pub.attorney freehelp.legal"}

# TECH STACK
tech:
  ruby: "3.3+"
  rails: "8.1+"
  zsh: "5.9+"
  openbsd: "7.6+"
  stack: "Solid Queue/Cache/Cable + Hotwire + Falcon"
  gems:
    required: [parser, rubocop, rubocop-performance]
    optional: [rubocop-rails, rubocop-rspec]
  analysis:
    methods: [pattern, ast, rubocop]

# TOOLS (allowed/banned)
tools:
  allowed: [ruby, zsh, git, bundle, rails, rake, doas, rcctl, pkg_add, cat]
  banned: [bash, python, sed, awk, tr, wc, head, tail, cut, find, sudo, echo]
  rationale: "zsh parameter expansion replaces unix text tools"

# ZSH NATIVE PATTERNS (zero-fork performance)
zsh_patterns:
  string:
    lowercase: '${(L)var}'
    uppercase: '${(U)var}'
    replace_all: '${var//search/replace}'
    trim: '${${var##[[:space:]]#}%%[[:space:]]#}'
  array:
    filter: '${(M)arr:#*pattern*}'
    exclude: '${arr:#*pattern*}'
    unique: '${(u)arr}'
    sort: '${(o)arr}'
    join: '${(j:,:)arr}'
  file:
    read: '${(<file)}'
    glob: '**/*.rb(N.)'
    glob_dirs: '**/*(N/)'
  field:
    split: '${(s:,:)var}'
    nth: '${${(s:,:)line}[4]}'

# THRESHOLDS
thresholds:
  method_lines: 20
  class_lines: 300
  file_lines: 500
  complexity: 10
  nesting: 3
  parameters: 3
  test_coverage: 0.80
  consensus: 0.70

# CONVERGENCE
convergence:
  max_iterations: 15
  exit_when: {violations: 0, consensus_gte: 0.70}
  stop_if: "same_violations_3x"
  auto_fix:
    enabled: true
    methods: [rubocop_safe, pattern_replace]
    rubocop_cops: [Layout, Style/FrozenStringLiteralComment]
  inline_suggestions:
    enabled: true
    max_per_violation: 3
    format: "  → {action}: {code}"
    include_rationale: true

# LEARNING (pattern extraction from fixes)
learning:
  enabled: true
  capture_fixes: true
  min_samples: 10
  confidence_threshold: 0.85
  auto_apply: false
  suggestions_only: true

# DASHBOARD (status overview)
dashboard:
  enabled: true
  format: box
  show:
    - total_files
    - converged_files
    - remaining_files
    - veto_count
    - high_severity_count
    - law_breakdown
    - progress_percent
    - blockers

# SCANNING
scanning:
  recursive: true
  from_cwd: true
  patterns: ["**/*.rb", "**/*.yml", "**/*.yaml"]
  exclude: ["vendor/**/*", "node_modules/**/*", ".git/**/*", "tmp/**/*"]
  parallel: false
  max_files: 1000
  auto_clean: true
  clean_script: "sh/clean.sh"

# WORKFLOW (state machine for systematic convergence)
workflow:
  enabled: true
  states: [clean, scan, analyze, fix, validate, commit]
  state_file: ".convergence_workflow"
  checkpoints: true
  resume_on_interrupt: true
  
# TRACKING (memory across sessions)
tracking:
  violations:
    enabled: true
    history_dir: ".convergence_history"
    format: jsonl
    retention_days: 90
  patterns:
    enabled: true
    library_dir: ".convergence_patterns"
    min_occurrences: 10
    auto_generate_rules: true
  context:
    enabled: true
    header_injection: true
    progressive_file: ".convergence_context.md"
    update_on_scan: true
  personas:
    enabled: true
    journal_dir: ".convergence_personas"
    append_only: true
  refactoring:
    enabled: true
    journal_file: ".convergence_journal.md"
    append_only: true

# INTEGRATION
integration:
  tree_sh: "sh/tree.sh"
  clean_sh: "sh/clean.sh"
  pre_work_snapshot: true
  commit_hooks:
    enabled: true
    pre_commit: true
    veto_only: true
    auto_install: false
  
# PRIORITY (intelligent file ordering)
priority:
  rules:
    - veto_count_desc
    - dependency_order
    - recent_changes_first
    - size_asc
  dependency_analysis: true
  dependency_graph_output: ".convergence_deps.dot"
  priority_rules:
    - veto_count_desc
    - dependency_order
    - recent_changes_first
  auto_clean: true
  clean_script: "sh/clean.sh"
  pre_scan_hooks: ["tree.sh"]

# CONVERGENCE STATE (.convergence_* files)
state:
  enabled: true
  directory: ".convergence"
  files:
    tree: "tree.txt"
    state: "state.yml"
    history: "history/"
    context: "context.md"
    workflow: "workflow.state"
    deps: "deps.dot"
    personas: "personas/"
    journal: "journal.md"
    patterns: "patterns/"
  retention:
    history_days: 90
    journal_entries: 1000
    pattern_threshold: 10

# WORKFLOW STATE MACHINE
workflow:
  states: [clean, scan, analyze, fix, validate, commit]
  checkpoints: true
  auto_resume: true
  current_state_file: ".convergence/workflow.state"
  transitions:
    clean: [scan]
    scan: [analyze, clean]
    analyze: [fix, scan]
    fix: [validate, analyze]
    validate: [commit, fix]
    commit: [clean]

# CONTEXT INJECTION
context_headers:
  enabled: true
  format: "# CONVERGENCE: {count} violations ({breakdown})"
  include:
    - violation_count
    - law_breakdown
    - persona_list
    - last_scan_timestamp
  refresh_on_scan: true

# EXECUTION
execution:
  steps:
    - "read_entire_input_sha256_verify"
    - "detect_violations_with_line_numbers"
    - "identify_missing_logic"
    - "consult_personas_require_consensus"
    - "generate_alternatives"
    - "apply_fix_past_tense_evidence"
    - "validate_no_regression"
    - "iterate_until_diminishing_returns"
  
  identify_missing_logic:
    description: "Find gaps, incomplete features, unhandled cases"
    actions:
      - "scan for TODO/FIXME/HACK comments"
      - "check for empty function bodies"
      - "find catch blocks that only log/ignore"
      - "detect missing error handling paths"
      - "identify incomplete switch/case coverage"
    output: "list of gaps to flesh out"
  
  iterate_until_diminishing_returns:
    description: "Auto-iterate refinement until value drops"
    max_iterations: 5
    stop_conditions:
      - "no new violations found"
      - "only cosmetic changes remain"
      - "iteration produces <10% improvement"
    actions:
      - "re-run violation detection"
      - "measure improvement delta"
      - "stop if diminishing returns"

# LEARNING MODE
learning:
  enabled: true
  capture_patterns: true
  min_occurrences: 10
  auto_generate_rules: true
  confidence_threshold: 0.85
  pattern_library: ".convergence/patterns/"

# COMMIT HOOKS
commit_hooks:
  enabled: true
  pre_commit:
    run: "convergence /recursive --veto-only"
    enforce_zero_veto: true
    allow_bypass: false
  post_commit:
    snapshot: true
    journal_entry: true

# INLINE SUGGESTIONS
inline_suggestions:
  enabled: true
  format: "  → {action}: {code}"
  max_per_violation: 3
  include_examples: true

# USABILITY (Nielsen Norman Group 10 Heuristics)
# Reference: https://www.nngroup.com/articles/ten-usability-heuristics/
usability:
  h1_visibility:
    name: "Visibility of system status"
    principle: "Keep users informed through timely feedback"
    applies_to: [progress_indicators, status_messages, thinking_dots]
    examples:
      - "show [3] turn count in prompt"
      - "show ... while waiting for LLM"
      - "show ✓/✗ for pass/fail"
  
  h2_match_real_world:
    name: "Match between system and real world"
    principle: "Use familiar language, follow real-world conventions"
    applies_to: [terminology, metaphors, logical_order]
    examples:
      - "scan not analyze_codebase"
      - "fix not apply_remediation"
      - "laws before registry (priority order)"
  
  h3_user_control:
    name: "User control and freedom"
    principle: "Support undo, redo, and easy exit"
    applies_to: [escape_hatches, undo, clear_history]
    examples:
      - "Ctrl+C exits cleanly"
      - "/clear resets conversation"
      - "git restore after failed fix"
  
  h4_consistency:
    name: "Consistency and standards"
    principle: "Follow platform conventions, be internally consistent"
    applies_to: [command_syntax, output_format, terminology]
    examples:
      - "/command for all commands"
      - "lowercase everywhere"
      - "file: count (breakdown) format"
  
  h5_error_prevention:
    name: "Error prevention"
    principle: "Eliminate error-prone conditions before they occur"
    applies_to: [validation, confirmation, constraints]
    examples:
      - "check file exists before scan"
      - "skip method defs in ruby eval"
      - "graceful degradation without parser gem"
  
  h6_recognition:
    name: "Recognition rather than recall"
    principle: "Minimize memory load with visible options"
    applies_to: [suggestions, help_text, command_completion]
    examples:
      - "suggest similar commands on typo"
      - "/help shows all commands"
      - "inline fix suggestions"
  
  h7_flexibility:
    name: "Flexibility and efficiency of use"
    principle: "Accelerators for experts, simple for novices"
    applies_to: [shortcuts, defaults, power_features]
    examples:
      - "plain text → chat (default)"
      - "/scan file (explicit)"
      - "--veto-only for CI scripts"
  
  h8_aesthetic:
    name: "Aesthetic and minimalist design"
    principle: "No irrelevant or rarely needed information"
    applies_to: [output_density, noise_reduction, focus]
    examples:
      - "single-line banner"
      - "hide timing unless slow"
      - "quiet by default in pipes"
  
  h9_error_recovery:
    name: "Help users recognize, diagnose, recover from errors"
    principle: "Express errors in plain language with solutions"
    applies_to: [error_messages, hints, recovery_paths]
    examples:
      - "error: OPENROUTER_API_KEY not set"
      - "hint: check API key or try again"
      - "did you mean: /scan?"
  
  h10_help:
    name: "Help and documentation"
    principle: "Easy to search, focused on user tasks"
    applies_to: [help_command, examples, contextual_hints]
    examples:
      - "/help shows task-oriented list"
      - "examples in registry rules"
      - "ready. type to chat, /help for commands"

# STYLE GUIDE (CLI output and UX patterns)
# Research: GitHub Copilot CLI, Claude Code, Aider, OpenCode
style:
  voice:
    tone: "concise, direct, LA vernacular vibes"
    writing: "Strunk & White - omit needless words"
    casing: "Proper case for user-facing strings"
    commit_messages: "Proper case, imperative mood"
  
  prompt:
    default: "❯"  # starship-style
    with_context: "[n] ❯"  # show turn count
    colors:
      success: green
      error: red
      warning: yellow
      dim: gray
  
  ansi:
    module: "C"
    methods:
      g: "green (success, ready)"
      r: "red (error, failure)"
      y: "yellow (warning, pending)"
      d: "dim/gray (metadata, hints)"
      b: "bold (emphasis)"
  
  output:
    banner: "single line, no ASCII art"
    errors: "Error: message + Hint: recovery"
    status: "● ready / ○ pending / ✗ failed"
    commands: "→ command (before execution)"
    diffs: "+n -n (after file changes)"
  
  patterns:
    chat_first: "plain text → LLM, /prefix → commands"
    auto_execute: "```shell``` blocks run automatically"
    feedback_loop: "output fed back to LLM"
    git_auto_commit: "commit after successful edits"

# VOICE MODULE (TTS/STT)
voice:
  tts:
    engine: piper
    model: "en_US-lessac-low"  # lofi grainy
    effects: "highpass=f=200,lowpass=f=5000"
    fallback: espeak
  
  stt:
    engine: whisper
    model: "base.en"
    recorder: sox/rec
    duration: 5
    silence_detection: true
  
  commands:
    toggle: "/voice"
    listen: "/listen [seconds]"
  
  availability:
    openbsd: "unavailable (no ports)"
    linux: "piper + whisper + sox"
    cygwin: "piper + whisper + sox"

# INSPIRATION (CLI tools studied)
inspiration:
  github_copilot_cli:
    learned: "ghcs/ghce aliases, shell history, execute confirmation"
    url: "github.com/github/gh-copilot"
  
  claude_code:
    learned: "/commands, /bug feedback, minimal banner, gif demo"
    url: "github.com/anthropics/claude-code"
  
  aider:
    learned: "git auto-commits, repo map, colored diffs, context prompt"
    url: "github.com/paul-gauthier/aider"
  
  opencode:
    learned: "Tab switch agents (build/plan), @agent mentions, TUI panels"
    url: "github.com/sst/opencode"
  
  starship:
    learned: "> prompt, minimal, context-aware segments"
    url: "starship.rs"

# AUTONOMY (full agent mode - no permission required)
autonomy:
  enabled: true
  
  decisions:
    install_dependencies: true
    create_files: true
    modify_files: true
    delete_files: false
    git_commit: true
    git_push: false
    run_commands: true
    
  retry:
    enabled: true
    max_attempts: 3
    backoff: exponential
    
  on_error:
    strategy: fix_and_retry
    ask_user: false
    log_only: true
    
  on_ambiguity:
    strategy: best_guess
    prefer: simplest_solution
    document: true
    
  blocklist:
    commands: ["rm -rf /", "rm -rf ~"]
    
  always_continue:
    missing_dep: install_it
    permission_error: use_doas
    file_not_found: create_it
    network_error: retry_with_backoff