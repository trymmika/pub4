# master.yml v80.1.0 - consistent lowercase, reduced visual noise
# chatgpt insight: hard separation between law/policy/procedure prevents erosion
# preserved: all operational specifics (zsh patterns, rails procedures, domain maps)
# new: explicit immutable sections that self_optimize must never touch
# activation: "✓ master.yml v80.1.0 loaded - laws immutable, procedures preserved"

# immutable law: never auto_optimize, never reword, requires human approval

law:
  golden_rule: PRESERVE_THEN_IMPROVE_NEVER_BREAK
  chestertons_fence: "understand intent before removal"
  security_axiom: "validate input, least privilege, defense in depth; no plaintext secrets in commits"
  ops_safety: "working systems outrank elegance"
  auditability: "all changes explainable post-hoc"

# principles: flat, universal, optimize wording only not meaning

principles:
  preserve_behavior: "never break working code"
  chestertons_fence: "understand before removing"
  security_first: "validate input, least privilege, defense in depth"
  single_responsibility: "one reason to change"
  dry: "single source of truth"
  kiss: "no unnecessary complexity"
  yagni: "build only what you need now"
  small_functions: "under 10 lines ideal, max 20"
  meaningful_names: "names reveal intent"
  boy_scout: "leave cleaner than found"
  stepdown: "important code first"
  measure_first: "profile before optimizing"

# operational policy: optimize for clarity, preserve all specifics

silent_success:
  principle: "Report only exceptions; success is default"
  levels: {success: log_only, warn: daily_digest, error: immediate, fatal: alert}
  rationale: "80% noise reduction"

focus: "Complete Rails generators on OpenBSD with zero sprawl"
analysis: "Read files once, exhaust every line against principles, nested loops until <2% improvement"

mandate:
  file_ops: "Zsh globbing/parameter expansion only (**/*.rb(N.), ${(<file)})"  # No external commands
  logic: "Ruby for non-trivial algorithms, not pseudo-code"  # Express algorithms in target language
  read_once: "View entire file once, don't re-read"  # Efficiency: avoid redundant I/O
  tree_first: "Run tree.sh equivalent in new repos before work"  # Context before action
  pre_check: "Scan every command for forbidden patterns before execution"  # Prevent violations
  vertical_spacing:
    - "Strip all blank lines before refactoring"  # Start from dense baseline
    - "Reassess grouping line-by-line after fixes"  # Semantic spacing only
    - "Single blank line between semantic groups only"
    - "No double blanks, no trailing whitespace"

# tooling constraints: machine_actionable, auto_optimize for precision

reasoning:
  primary_language: Ruby
  primary_shell: zsh
  expression:
    algorithms: "Express algorithms and examples as Ruby code where practical"
    file_operations: "Express file operations as zsh parameter expansion and globs, not generic shell"
    explanations: "Show concrete Ruby or zsh snippets instead of abstract pseudo-code"
  note: "This governs visible output/reasoning surface, not internal LLM thought process"

environment:
  windows: "Use C:\\cygwin64\\bin\\zsh.exe for all shell operations"
  cli: "GitHub Copilot CLI (Node.js npm package @github/copilot)"
  shell_access: "Run zsh scripts with: zsh path/to/script.sh (works in GitHub Copilot CLI)"
  
  ssh:
    default_method: "Key-based authentication with zsh"
    keys_location: "/g/priv/passwd"
    key_priority: ["id_ed25519", "id_rsa", "openbsd_key"]
    pattern_with_key: 'zsh -c "ssh -i /g/priv/passwd/id_ed25519 -o ConnectTimeout=10 dev@185.52.176.18 ''COMMAND''"'
    pattern_interactive: 'zsh -c "ssh -i /g/priv/passwd/id_ed25519 dev@185.52.176.18"'
    password_fallback: ["tata1234", "hutte10tu6969"]
    approval: "Trust but verify: Review commands before remote execution, never blanket approve destructive ops"
  
  session_management:
    prefer_async: "For interactive tools, SSH sessions, debugging, long-running servers"
    prefer_sync: "For quick commands with predictable output (< 30s)"
    initial_wait_guidance: "30s+ for builds/tests, 10-15s for file ops, 60s+ for deployments"
    note: "PowerShell tool sessions persist across calls when using same sessionId"

deployment:
  vps:
    ip: "185.52.176.18"
    backup_ns: "194.63.248.53"
    deploy_base: "/var/rails"
    app_base: "/home"
  apps:
    brgen:
      port: 11006
      domains: "brgen.no oshlo.no trndheim.no stvanger.no trmso.no reykjavk.is kobenhvn.dk stholm.se gteborg.se mlmoe.se hlsinki.fi lndon.uk mnchester.uk brmingham.uk edinbrgh.uk glasgw.uk lverpool.uk amstrdam.nl rottrdam.nl utrcht.nl brssels.be zrich.ch lchtenstein.li frankfrt.de mrseille.fr mlan.it lsbon.pt lsangeles.com newyrk.us chcago.us dtroit.us houstn.us dllas.us austn.us prtland.com mnneapolis.com"
      subdomains: "markedsplass playlist dating tv takeaway maps"
    amber:
      port: 10001
      domains: "amberapp.com"
    blognet:
      port: 10002
      domains: "foodielicio.us stacyspassion.com antibettingblog.com anticasinoblog.com antigamblingblog.com foball.no"
    bsdports:
      port: 10003
      domains: "bsdports.org"
    hjerterom:
      port: 10004
      domains: "hjerterom.no"
    privcam:
      port: 10005
      domains: "privcam.no"
    pubattorney:
      port: 10006
      domains: "pub.attorney freehelp.legal"
  read_files: "Use cat from zsh, or view tool for line-numbered viewing"
  config_locations:
    claude: "G:\\.claude\\settings.local.json (auto_load master.yml, mandate zsh-only)"
    copilot: "~\\.copilot\\config.json (trusted_folders, user settings)"
  execution_trick: "Prefix commands with 'zsh' to run zsh scripts (e.g. zsh ../sh/showp.sh)"

forbidden: [bash, python, sed, awk, tr, wc, head, tail, cut, find, sudo, echo]
allowed: [ruby, zsh, git, npm, bundle, rails, rake, doas, rcctl, pkg_add, cat]
output: "work via commits with clear messages - no temp files"

enforcement:
  pre_execution: "SCAN EVERY COMMAND before running - if any word matches forbidden list, STOP and rewrite using zsh/ruby"
  
zsh_patterns:
  philosophy: "No external forks, pure zsh parameter expansion for maximum performance"
  
  string_ops:
    crlf_removal: "cleaned=${var//$'\\r'/}"
    lowercase: "lower=${(L)var}"
    uppercase: "upper=${(U)var}"
    replace_all: "result=${var//search/replace}"
    trim_start: "trimmed=${var##[[:space:]]#}"
    trim_end: "trimmed=${var%%[[:space:]]#}"
    trim_both: "trimmed=${${var##[[:space:]]#}%%[[:space:]]#}"
    nth_field: "fourth=${${(s:,:)line}[4]}"
    split_to_array: "arr=( ${(s:delim:)var} )"
  
  array_ops:
    filter_match: "matches=( ${(M)arr:#*pattern*} )"
    filter_exclude: "non_matches=( ${arr:#*pattern*} )"
    unique: "unique=( ${(u)arr} )"
    join: "joined=${(j:,:)arr}"
    reverse: "reversed=( ${(Oa)arr} )"
    sort_asc: "sorted=( ${(o)arr} )"
    sort_desc: "sorted=( ${(O)arr} )"
  
  replacements:
    grep: "lines=( ${(M)lines:#*query*} )"
    awk_column: "col=${${(s:,:)line}[4]}"
    uniq: "unique=( ${(u)arr} )"
    head: "${arr[1,10]}"
    tail: "${arr[-5,-1]}"
    wc_lines: "${#${(f)content}}"
  
  flags:
    M: "match instead of filter"
    u: "unique elements"
    o: "sort ascending"
    O: "sort descending"
    L: "lowercase"
    U: "uppercase"
    j: "join array"
    s: "split string"
    A: "assign to array"
  
  examples:
    bad: "head -5 file"
    good: "print -l ${(f)$(<file)}[1,5]"
    bad: "grep pattern file"
    good: "print -l ${(M)${(f)$(<file)}:#*pattern*}"
    bad: "cat file | wc -l"
    good: "${#${(f)$(<file)}}"
    bad: "find . -name *.rb"
    good: "**/*.rb(N.)"

tool_permissions:
  mode: deny_by_default
  categories:
    shell:
      allowed_patterns: ["git *", "bundle *", "rails *", "zsh *", "doas *", "rcctl *", "pkg_add *"]
      denied_patterns: ["rm -rf /*", "sudo *", "curl * | *", "chmod 777 *", "eval *"]
      denied_tools: [bash, python, sed, awk, tr, wc, head, tail, cut, find, sudo, echo]
    file_operations:
      read: {allowed: ["**/*"], denied: ["**/.env", "**/secrets/**", "**/*_key*"]}
      write: {allowed: ["~/pub/**", "~/learning/**"], denied: ["/etc/**", "/var/**", "/usr/**"]}
      create: "Never create unauthorized files; no temp markdown for tracking/notes; use commits as documentation"
  rationale: "Pattern-based matching more precise than flat lists. Wildcards prevent bypasses."

file_sprawl_prevention:
  consolidation: "Merge folder/ into folder.rb when consolidating logic (e.g. repligen/ → repligen.rb)"
  no_temp_files: "No .md files for planning/notes/tracking; work in memory, document via git commits"
  prefix_temp: "If temp files absolutely needed, prefix with . and delete after consumption"

stack: {ruby: 3.3, rails: 8, os: "OpenBSD 7.6+", shell: zsh, framework: "Solid Queue/Cache/Cable + Hotwire"}

file_sprawl_prevention:
  consolidation: "Merge folder/ into folder.rb when consolidating logic (e.g. repligen/ → repligen.rb)"
  no_temp_files: "No .md files for planning/notes/tracking; work in memory, document via git commits"
  prefix_temp: "If temp files absolutely needed, prefix with . and delete after consumption"

style:
  comments:
    forbidden_decorations: ["---", "===", "###", "***", "━━━", "═══", "▬▬▬"]
    rationale: "ASCII art separators create visual noise; use semantic structure instead"
    preferred: "Simple # SECTION: description format"
  code:
    no_divitis: "Use Rails tag helpers (tag.p, tag.div) not raw HTML; ultraminimalistic views"
    vertical_rhythm: "Single blank line between semantic groups only; no double blanks"

scope:
  production: ["~/pub/rails/", "~/pub/openbsd/"]
  experimental: ["~/learning/", "~/experiments/"]
  escape: "# VIOLATION: [principle] | Reason: [why] | Revert: [date]"

overrides:
  - directories: ["~/pub/rails/**"]
    quality_thresholds:
      method: {max: 25}  # Rails controllers/views can be slightly longer
    tool_permissions:
      shell:
        allowed_patterns: ["rails *", "bundle exec *", "rake *"]
  - directories: ["~/learning/**", "~/experiments/**"]
    two_hats_enforcement: false  # Experimentation allowed
    rule_of_three: false  # Try patterns early without waiting for duplication
    rationale: "Learning context needs flexibility; production needs discipline"

ruby:
  frozen_string_literal: true
  keyword_args: "2+ params"
  safe_nav: "&."
  blocks: "{} one-line, do/end multi"

rails:
  version: 8.0.4
  stack: "Solid + Hotwire + Falcon"
  avoid: "React/Vue/Angular, Puma (use Falcon), Redis (use Solid)"
  doctrine: "convention > configuration"
  deployment:
    server: "Falcon (async, fiber-based, HTTP/2 capable)"
    replace_puma: "bundle remove puma && bundle add falcon falcon-rails"
    config: "config/falcon.rb with preload, multi-worker, Falcon::Environment::Rack"
    solid_stack:
      queue: "bin/rails generate solid_queue:install - background jobs"
      cache: "bin/rails generate solid_cache:install - caching layer"
      cable: "bin/rails generate solid_cable:install - WebSockets"
      auth: "bin/rails generate authentication - Rails 8 built-in"
    gotchas:
      - "Rails 8 includes Propshaft (not Sprockets)"
      - "Solid Queue generator adds config to production.rb (don't append manually)"
      - "Falcon needs config/preload.rb with require_relative 'environment'"

zsh:
  why: "zero forks, 46% token savings vs sed/awk/tr"
  patterns:
    case: "${(L)var} = lower, ${(U)var} = upper"
    replace: "${var//old/new}"
    trim: "${${var##[[:space:]]#}%%[[:space:]]#}"
    split: "(${(s:,:)var})"
    join: "${(j:,:)arr}"
    count: "${#arr}"
    slice: "${arr[1,10]}"
    read: "${(<file)}"
    match: "[[ $str =~ pattern ]]"
    glob: "**/*.rb(N.)"
    glob_dirs: "**/*(N/)"
    glob_exec: "**/*(N*)"
  arrays:
    create: "items=(one two three)"
    append: "items+=(four)"
    length: "${#items}"
    slice: "${items[2,-1]}"
  flags:
    abs: "${file:a}"
    dir: "${file:h}"
    base: "${file:t}"
    ext: "${file:e}"

openbsd:
  vps: {ip: "185.52.176.18", user: dev, key: "~/priv/passwd/id_rsa"}
  services: "rcctl enable/start/stop/restart/check/reload"
  privilege: doas
  packages: "pkg_add -v"
  web: "relayd(TLS) → httpd(acme-client) → falcon(10001-11006) → Rails"
  verification: "all tools/daemons/config files MUST be verified at man.openbsd.org before use"
  configs:
    relayd: "/etc/relayd.conf - TLS termination, load balancing"
    httpd: "/etc/httpd.conf - ACME challenges only"
    pf: "/etc/pf.conf - packet filter firewall"
    acme: "/etc/acme-client.conf - Let's Encrypt certs"
  man_pages: "man relayd.conf, man httpd.conf, man pf.conf, man acme-client.conf"

deploy:
  local: [test, verify_Gemfile, commit, push]
  vps_setup:
    - "ssh dev@185.52.176.18 (password: hutte10tu6969 or key: ~/priv/passwd/id_rsa)"
    - "doas rm -rf ~/rails/appname (clean slate)"
    - "cd ~/pub4 && git pull (get latest scripts)"
    - "cd rails && doas zsh appname.sh (run installer)"
  rails_deploy:
    - "Script creates ~/rails/appname and installs all dependencies"
    - "Falcon configured with 2 workers on port 1000X"
    - "PostgreSQL database created with credentials from script"
    - "rc.d service installed: rcctl enable appname && rcctl start appname"
  verify:
    - "rcctl check appname (should show 'appname(ok)')"
    - "ps aux | grep falcon (check processes)"
    - "curl http://localhost:1000X (test local)"
    - "curl https://domain.com (test through relayd)"
  remote: "ssh vps 'cd ~/pub4/rails && doas zsh appname.sh'"
  service: "rcctl enable app && rcctl start app"

execution:
  pre_flight:
    - "RELOAD master.yml - confirm activation message"
    - "SCAN command for forbidden tools before EVERY execution"
    - "If forbidden tool found: STOP, rewrite with zsh/ruby, then execute"
  
  steps:
    - "Read code once completely, understand why it exists (chestertons_fence)"
    - "Check tier 1 principles first (never break)"
    - "Fix violations one at a time, smallest change"
    - "Test immediately after each change"
    - "Commit with clear message"
    - "Measure: (prev_violations - current) / prev × 100"
    - "Continue if improvement ≥2% and cycles <5"

self_optimize:
  run_on_self: true
  threshold: 2
  max_cycles: 5
  measure: "violations per 100 lines"

git_recovery: "git log --patch --all -- path/to/file, then git show HASH:path > recovered"

# v75.3.0 - 198 lines
# Added: Cygwin/zsh environment enforcement, Rails 8 + Falcon deployment workflows
# Added: Solid Stack gotchas, VPS deployment steps, cat allowed for reading
# Workflows: Local dev → git push → VPS pull → doas zsh script → rcctl service
# Result: Codified successful brgen.no deployment pattern
