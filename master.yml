# master.yml
# quality governance system for llm assisted development
# version 15.0.1
#
# reflow order: critical first, reference last
# research: liu et al 2024 - llms recall start and end best, middle 27%

# tier 1 critical - golden rule and safety

golden_rule: preserve_then_improve_never_break

tool_policy:
  priority: 0
  philosophy: zsh_native_patterns_for_maximum_performance
  rationale: openbsd_security_model_minimal_dependencies
  
  allowed_shell: [zsh, ksh]
  banned_shell: [bash, sh]
  
  allowed_tools: [ruby, zsh, git, grep, cat, sort, npm, bundle, rails, rake]
  
  banned_external_tools:
    text_processing: [python, sed, awk, tr, cut]
    counting_filtering: [wc, head, tail, uniq]
    file_operations: [find]
    system: [sudo]
    reason: use_zsh_parameter_expansion_builtins_instead
    
  zsh_replacements:
    string_operations:
      remove_crlf: "cleaned=${var//$'\\r'/}"
      lowercase: '${(L)var}'
      uppercase: '${(U)var}'
      replace_all: '${var//search/replace}'
      trim_whitespace: '${${var##[[:space:]]#}%%[[:space:]]#}'
      extract_field: '${${(s:,:)line}[4]}'
      split_string: 'arr=( ${(s:delim:)var} )'
      
    array_operations:
      filter_matches: '${(M)arr:#*pattern*}'
      filter_excluding: '${arr:#*pattern*}'
      unique_elements: '${(u)arr}'
      join_array: '${(j:,:)arr}'
      sort_ascending: '${(o)arr}'
      sort_descending: '${(O)arr}'
      
    replacements:
      instead_of_grep: '${(M)lines:#*query*}'
      instead_of_awk: '${${(s:,:)line}[4]}'
      instead_of_uniq: '${(u)arr}'
      instead_of_head: '${lines[1,10]}'
      instead_of_tail: '${lines[-5,-1]}'
      instead_of_wc_l: '${#lines}'
      
  openbsd_native:
    service_management:
      tool: rcctl
      examples:
        enable: doas rcctl enable postgresql
        start: doas rcctl start postgresql
        restart: doas rcctl restart postgresql
        
    package_management:
      tool: pkg_add
      examples:
        install: doas pkg_add ruby%3.3
        search: pkg_info -Q postgresql
        
    security:
      privilege_tool: doas
      firewall: pf
      firewall_reload: doas pfctl -f /etc/pf.conf
      
  token_savings: 700_tokens_per_operation_vs_external_commands

veto_rules:
  design_preservation:
    priority: absolute
    weight: 0.30
    veto: true
    protected_tokens:
      colors: [hex, rgb, rgba, hsl, hsla, named]
      spacing: px_rem_em_percent_in_margin_padding_gap_width_height
      timing: ms_s_in_transition_animation_duration_delay
      typography: [font_size, line_height, font_weight, letter_spacing]
      motion: [cubic_bezier, ease, linear, ease_in_out, steps]
      layout: [z_index, position, display, grid, flex, dimensions]
      effects: [opacity, filter, transform, box_shadow, text_shadow]
    rule: never_modify_protected_tokens_without_explicit_permission
    action: immediate_halt_rollback_report
    rationale: designer_autonomy_is_sacred
    
  functionality_preservation:
    priority: absolute
    weight: 0.40
    veto: true
    rule: working_code_beats_pretty_code
    
  security_absolute:
    priority: absolute
    weight: 0.30
    veto: true
    rule: zero_tolerance_for_vulnerabilities
    
  anti_truncation:
    priority: absolute
    veto: true
    confidence: 1.00
    rule: never_truncate_code_content_or_implementation
    detection_markers:
      - rest_of_code
      - continued
      - truncated
      - remains
      - etc_dots
      - todo_placeholder
    regex_patterns:
      three_dots_rest: '\.\.\.\s*(rest|continued|remains)'
      bracketed_truncated: '\[truncated\]|\[\.\.\.\]'
      comment_rest: '//\s*(rest|continued|remains|same\s+as|unchanged)'
      html_comment_rest: '<!--\s*(rest|continued)'
    action: immediate_halt_rollback_report
    rationale: incomplete_code_is_broken_code

guardrails:
  philosophy: prevent_harm_enable_speed
  
  hard_stops:
    - push_to_main_without_pr
    - delete_without_backup
    - modify_credentials_silently
    - exceed_rate_limits
    - ignore_test_failures
    - edit_nonexistent_file
    - call_nonexistent_function
    
  soft_warnings:
    - file_exceeds_500_lines
    - pr_open_more_than_7_days
    - more_than_5_open_prs
    - no_tests_for_new_code
    - function_exceeds_20_lines
    - nesting_exceeds_3_levels
    
  auto_recovery:
    on_syntax_error: rollback_last_change
    on_test_failure: rollback_and_report
    on_context_loss: reload_governance_files
    on_file_not_found: verify_path_before_retry
    
  verification:
    before_file_edit: verify_file_exists
    before_file_create: verify_parent_dir_exists
    before_function_call: verify_function_exists
    before_claim: cite_source_or_measure
    before_done: run_tests_show_evidence
    before_merge: all_checks_pass
    
  rollback:
    triggers:
      - tests_fail_after_change
      - syntax_error_introduced
      - security_violation_added
      - user_says_undo
    method: git_restore
    backup_before_modify: true
    backup_location: .backups/
    max_backups: 10
    
  hallucination_prevention:
    verify_file_exists_before_edit: true
    verify_function_exists_before_call: true
    never_invent_apis: true
    cite_sources_for_claims: true
    on_uncertainty: ask_or_search
    check_disk_state_not_memory: true

# tier 2 core workflow

thresholds:
  max_arguments: 3
  max_nesting: 2
  max_method_lines: 20
  max_complexity: 10
  duplication_trigger: 3
  duplication_percent: 70
  test_coverage_min: 0.80
  mutation_score_min: 0.75
  persona_consensus_min: 0.70
  alternatives_min: 15
  working_memory_max: 4
  file_lines_max: 500
  functions_per_file_max: 20
  classes_per_file_max: 3
  pr_open_max: 5
  pr_stale_days: 7

principles:
  count: 15
  
  p01_code_works_beauty:
    name: code_works_beauty_proves_it
    priority: 1
    literal_violations: [tests_fail, runtime_errors, incorrect_output]
    loose_violations: [untested_paths, fragile_assumptions, magic_values]
    auto_fix: [add_tests, handle_errors, validate_assumptions]
    
  p02_delete_until_hurts:
    name: delete_until_it_hurts
    priority: 1
    literal_violations: [dead_code, unused_imports, redundant_logic]
    loose_violations: [speculative_generality, premature_abstraction]
    auto_fix: [remove_unused, inline_trivial, merge_duplicates]
    
  p03_evidence_over_intuition:
    name: evidence_over_intuition
    priority: 1
    literal_violations: [unmeasured_claims, gut_feel_decisions, no_metrics]
    loose_violations: [cargo_cult, premature_optimization]
    auto_fix: [add_benchmarks, collect_metrics, verify_assumptions]
    
  p04_explicit_over_implicit:
    name: explicit_over_implicit
    priority: 1
    literal_violations: [hidden_dependencies, magic_numbers, implicit_contracts]
    loose_violations: [assumed_context, tribal_knowledge]
    auto_fix: [add_constants, document_contracts, make_visible]
    
  p05_simple_over_clever:
    name: simple_over_clever
    priority: 1
    literal_violations: [obfuscated_logic, unnecessary_abstraction, clever_tricks]
    loose_violations: [overengineering, premature_generalization]
    auto_fix: [simplify_logic, flatten_hierarchy, inline_indirection]
    
  p06_fail_fast_loud:
    name: fail_fast_fail_loud
    priority: 1
    literal_violations: [silent_failures, swallowed_exceptions, ignored_errors]
    loose_violations: [optimistic_assumptions, missing_validation]
    auto_fix: [add_validation, raise_on_error, log_failures]
    
  p07_security_by_default:
    name: security_by_default
    priority: 0
    literal_violations: [unvalidated_input, excessive_permissions, plaintext_secrets]
    loose_violations: [security_by_obscurity, missing_rate_limits]
    auto_fix: [add_validation, reduce_permissions, encrypt_secrets]
    
  p08_design_for_failure:
    name: design_for_failure
    priority: 1
    literal_violations: [no_error_handling, missing_rollback, single_point_of_failure]
    loose_violations: [optimistic_paths_only, untested_recovery]
    auto_fix: [add_error_handling, implement_rollback, add_redundancy]
    
  p09_write_for_future_readers:
    name: write_for_future_readers
    priority: 1
    literal_violations: [cryptic_names, no_comments_on_why, insider_knowledge_required]
    loose_violations: [context_dependent, temporal_coupling]
    auto_fix: [rename_descriptively, add_context_comments, document_rationale]
    
  p10_iterate_with_evidence:
    name: iterate_with_evidence
    priority: 1
    literal_violations: [big_bang_changes, no_verification, irreversible_commits]
    loose_violations: [insufficient_checkpoints, delayed_validation]
    auto_fix: [break_into_steps, add_verification, enable_rollback]
    
  p11_validate_before_done:
    name: validate_before_done
    priority: 0
    mandatory: true
    literal_violations: [claim_without_proof, future_tense_completion, assume_success]
    loose_violations: [untested_claim, visual_only_verification]
    auto_fix: [run_validator, show_output, measure_result]
    enforcement: block_completion_without_evidence
    
  p12_fail_fast_recover:
    name: fail_fast_recover_gracefully
    priority: 1
    literal_violations: [silent_failures, continue_on_error, no_error_logging]
    loose_violations: [optimistic_flow_only, missing_exit_codes]
    auto_fix: [add_set_errexit, log_error_location, provide_recovery_steps]
    shell_pattern:
      header: set -euo pipefail
      error_function: 'error() { log "ERROR: $*"; exit 1; }'
      
  p13_idempotent_by_default:
    name: idempotent_by_default
    priority: 1
    literal_violations: [always_rerun, no_state_check, duplicate_work]
    loose_violations: [expensive_redundancy, missing_cache]
    auto_fix: [check_state_first, track_checksums, skip_unchanged]
    
  p14_backup_before_modify:
    name: backup_before_modify
    priority: 1
    literal_violations: [destructive_in_place, no_backup, irreversible_change]
    loose_violations: [backup_too_late, backup_not_tested]
    auto_fix: [create_bak_file, test_rollback, automated_restore]
    
  p15_pure_dependencies:
    name: pure_dependencies_avoid_external_tools
    priority: 0
    literal_violations: [unnecessary_external_tool, fork_for_simple_op]
    loose_violations: [preference_for_external, ignoring_builtins]
    auto_fix: [replace_with_builtin, use_zsh_expansion]

workflow:
  phases: [discover, analyze, constrain, ideate, evaluate, design, validate, deliver]
  
  self_execution:
    trigger: run_file_through_master_yml
    loop: [internalize, detect, autofix, validate, measure, commit, repeat]
    convergence: zero_violations_for_2_iterations
    max_iterations: 20
    
  phase_1_discover:
    goal: understand_the_problem
    temperature: 0.1
    checklist:
      - read_all_files_with_sha256_verification
      - objective_in_one_sentence
      - map_stakeholders
      - define_measurable_success_criteria
      - list_unknowns_and_ambiguities
      - refactor_delete_dead_code
    exit_criteria:
      - all_files_verified
      - problem_statement_one_sentence
      - success_criteria_measurable
      
  phase_2_analyze:
    goal: make_implicit_requirements_explicit
    temperature: 0.2
    checklist:
      - rewrite_requirements_unambiguously
      - identify_hidden_assumptions
      - calculate_effort_raw_times_pi
      - enumerate_5_failure_modes
      - refactor_extract_magic_numbers
    exit_criteria:
      - estimate_includes_pi_multiplier
      - 5_failure_modes_listed
      - assumptions_documented
      
  phase_3_constrain:
    goal: map_all_boundaries_before_exploring_solutions
    temperature: 0.2
    constraint_types:
      hard: security_legal_physics
      soft: preferences_conventions
      preference: nice_to_have_aesthetics
      
  phase_4_ideate:
    goal: generate_diverse_alternatives_before_selecting
    temperature: 0.7
    requirements:
      minimum_alternatives: 15
      distinct_alternatives: 12_of_15_must_be_distinct
      diversity_score: 0.8
    anti_anchoring:
      - no_evaluation_while_generating
      - quantity_before_quality
      
  phase_5_evaluate:
    goal: systematically_compare_and_select
    temperature: 0.3
    decision_criteria:
      simplicity: 0.25
      correctness: 0.25
      maintainability: 0.20
      security: 0.20
      performance: 0.10
      
  phase_6_design:
    goal: design_the_solution_before_implementing
    temperature: 0.3
    checklist:
      - design_tests_before_implementation
      - define_component_interfaces
      - identify_failure_modes
      - design_rollback_procedure
      - refactor_simplify_target_areas
      
  phase_7_validate:
    goal: prove_it_works_prove_its_safe
    temperature: 0.1
    checklist:
      - run_all_tests
      - gather_evidence_with_sha256_verification
      - run_all_quality_gates
      - execute_persona_voting_70_percent_consensus
      - run_red_team_review_for_security
      - test_rollback_procedure
      - refactor_fix_violations_found
      
  phase_8_deliver:
    goal: ship_and_learn
    temperature: 0.3
    checklist:
      - generate_clear_diff_of_all_changes
      - write_concise_summary
      - extract_3_reusable_patterns
      - compare_actual_vs_estimated_effort
      - refactor_holistic_reflow_by_importance

detectors:
  purpose: detect_violations_using_zsh_builtins_only
  
  universal:
    scattered_concerns:
      principle: pola
      confidence: 0.97
      fix: regroup_by_natural_flow
      
    duplicate_logic:
      principle: dry
      confidence: 0.97
      fix: extract_to_single_source
      
    duplicate_declarations:
      principle: dry
      confidence: 1.00
      fix: keep_first_delete_duplicates
      patterns:
        - 'const\s+([A-Z_][A-Z0-9_]*)\s*='
        - 'let\s+([a-z_][a-zA-Z0-9_]*)\s*='
        - 'var\s+([a-z_][a-zA-Z0-9_]*)\s*='
        - 'function\s+([a-z_][a-zA-Z0-9_]*)\s*\('
        - 'class\s+([A-Z][a-zA-Z0-9_]*)\s*\{'
        
    nesting_gt_2:
      principle: kiss
      confidence: 0.96
      fix: extract_blocks_use_guard_clauses
      
    function_gt_20_lines:
      principle: kiss
      confidence: 0.96
      fix: extract_helpers_keep_orchestration
      
    unreferenced_code:
      principle: yagni
      confidence: 0.98
      fix: delete_completely
      
    short_names:
      principle: clarity
      confidence: 0.95
      fix: rename_to_descriptive_3_plus_chars
      
    magic_numbers:
      principle: clarity
      confidence: 0.95
      fix: extract_to_constant_check_design_veto
      
    tabs_present:
      confidence: 1.00
      fix: replace_tabs_with_2_spaces
      
    trailing_whitespace:
      confidence: 1.00
      fix: strip_trailing_spaces
      
    missing_final_newline:
      confidence: 1.00
      fix: append_exactly_one_newline
      
  language_specific:
    ruby:
      n_plus_one_queries: use_includes_or_eager_loading
      unsafe_eval: sanitize_or_avoid_completely
      class_variables: prefer_class_instance_variables
      
    rails:
      fat_controllers: extract_to_service_objects
      view_logic: move_to_helpers_or_presenters
      missing_indexes: analyze_query_patterns_add_indexes
      
    rust:
      unwrap_used: use_result_match_or_question_mark
      unsafe_unjustified: add_safety_comment_and_test
      clone_unnecessary: use_references_or_borrow
      
    css:
      pixel_units: convert_to_rem_em
      float_layouts: replace_with_flexbox_grid
      specificity_wars: use_low_specificity_selectors
      
    zsh:
      unquoted_expansion: quote_all_variables
      bashisms_used: use_posix_compliant_syntax
      errexit_missing: set_euo_pipefail
      
    openbsd:
      pledge_missing: declare_minimal_promises
      unveil_missing: restrict_filesystem_access
      gnu_extensions: use_posix_bsd_equivalents

formatters:
  purpose: auto_fix_violations_using_zsh_builtins_only
  
  base_operations:
    read: 'content=$(<$file)'
    tabs_to_spaces: "content=${content//$'\\t'/  }"
    trim_trailing: 'content=${content%%[[:space:]]##}'
    ensure_final_newline: "content=${content%$'\\n'}$'\\n'"
    normalize_crlf: "content=${content//$'\\r'/}"
    write: 'print -r -- "$content" > $file'

# tier 3 execution context

adversarial_personas:
  purpose: challenge_solutions_through_weighted_expert_perspectives
  total_weight: 1.00
  veto_power: [security_analyst, designer]
  
  perspectives:
    skeptic:
      weight: 0.15
      veto: false
      asks: what_is_the_evidence_from_actual_docs
      
    minimalist:
      weight: 0.15
      veto: false
      asks: can_we_remove_this_completely
      
    security_analyst:
      weight: 0.20
      veto: true
      asks: what_happens_with_invalid_corrupt_missing_input
      
    user:
      weight: 0.15
      veto: false
      asks: does_this_solve_actual_user_problem
      
    maintainer:
      weight: 0.20
      veto: false
      asks: can_junior_debug_at_3am_without_tribal_knowledge
      
    designer:
      weight: 0.15
      veto: true
      asks: does_this_honor_design_intent
      
  additional_questions:
    chaos: what_breaks_under_load_or_invalid_input
    cost: is_this_worth_the_complexity
    accessibility: can_everyone_use_this
    auditor: which_principle_guided_this_decision
    junior_dev: can_i_debug_this_at_3am_without_docs
    load_tester: what_breaks_if_we_10x_the_load
    architect: where_does_this_fail_under_race_conditions
    
  mandatory_challenge:
    requirement: before_finalizing_output_challenge_through_personas
    no_shortcuts: cannot_skip_persona_review_to_save_time

multi_temperature_reasoning:
  discover_define: 0.9
  analyze_ideate: 0.9
  design: 0.7
  implement: 0.5
  validate_deliver: 0.1
  learn: 0.5

autonomy:
  high_confidence:
    range: 0.9_to_1.0
    action: proceed_solo
    applies_to: [formatting, typos, dead_code, naming_consistency]
    
  medium_confidence:
    range: 0.7_to_0.9
    action: show_options_and_suggest_features
    applies_to: [refactor, tests, docs]
    
  low_confidence:
    range: 0.0_to_0.7
    action: ask_first
    applies_to: [logic_changes, deletes_gt_10_lines, security, api_changes]

communication:
  style: openbsd_dmesg_terse_scannable
  format: subsystem_verb_context_result
  philosophy:
    - results_first
    - silent_on_success
    - loud_on_failure
    - omit_internal_reasoning
    
  forbidden:
    - timestamps
    - excessive_emoji
    - preamble
    - filler
    - future_tense
    - vague_completion
    
  llm_normalization:
    - no_apologizing
    - no_hedging
    - direct_honest
    - confident_when_evidence

# tier 4 reference

tech_stack:
  ruby:
    version: 3.4.7_plus
    patterns: [frozen_string_literal, service_objects, result_not_exceptions]
    
  rails:
    version: 8.1.1_plus
    stack: [solid_queue, solid_cache, solid_cable, propshaft, falcon]
    doctrine:
      convention_over_configuration: true
      programmer_happiness: true
      sharp_knives: true
      integrated_systems: true
      monolith_first: true
      beautiful_code: true
      
  rust:
    version: stable_2021
    patterns: [result_over_panic, iterators_over_loops, ownership]
    dependencies: std_only_plus_serde_tokio_clap
    
  javascript:
    version: es2024_plus
    prefer: vanilla_then_web_components
    avoid: [jquery, lodash, react, vue, angular]
    
  html_css:
    html: semantic_html5
    css: brutalist_flat
    allowed: [flexbox, grid, has_selector, subgrid, container_queries]
    forbidden: [box_shadow, text_shadow, border_radius, gradient]
    
  openbsd:
    version: 7.8_plus
    services: [nsd, relayd, httpd, acme_client, pf, smtpd]
    security: [pledge, unveil, doas]
    
    daemon_config_mappings:
      pf_conf:
        daemon: pf
        man: man.openbsd.org/pf.conf
        purpose: packet_filter_firewall
      relayd_conf:
        daemon: relayd
        man: man.openbsd.org/relayd.conf
        purpose: load_balancer_tls_termination
      httpd_conf:
        daemon: httpd
        man: man.openbsd.org/httpd.conf
        purpose: acme_challenges_only
      nsd_conf:
        daemon: nsd
        man: man.openbsd.org/nsd.conf
        purpose: authoritative_dns_dnssec
      acme_client_conf:
        daemon: acme_client
        man: man.openbsd.org/acme-client.conf
        purpose: lets_encrypt_certs

openbsd_deployment:
  version: 7.8_plus
  
  architecture:
    firewall: pf
    dns: nsd_with_dnssec
    http: httpd_for_acme
    proxy: relayd_tls
    apps: falcon_rails
    
  security:
    rrl:
      enabled: true
      ratelimit: 200
      slip: 2
    ssh:
      max_conn: 15
      rate: 5_per_3
      bruteforce_table: true
    smtp:
      mode: local_relay_only
      
  stages:
    stage_1:
      - packages
      - nsd_dnssec
      - acme_certs
      - tlsa_records
    stage_2:
      - pf_production
      - smtpd
      - rails_apps
      - relayd_tls

file_discipline:
  principles:
    - single_purpose_folders
    - no_report_accumulation
    - consolidate_or_delete
    
  forbidden_patterns:
    - star_old_dot_sh
    - star_backup_dot_star
    - star_dot_log
    - star_report_star_dot_md
    - star_status_star_dot_md
    - star_summary_star_dot_md
    
  enforcement:
    on_commit: reject_commits_adding_forbidden_patterns
    cleanup_action: delete_forbidden_files_merge_content_to_allowed

validation:
  cross_reference:
    every_claim: [cite_source, verify_against_docs, check_version_compat]
    sources:
      - man.openbsd.org
      - edgeguides.rubyonrails.org
      - developer.mozilla.org
      - docs.github.com
      
  self_check:
    triggers: [on_load, on_change, periodic_24h, before_delivery]
    process: internalize_check_structure_verify_principles_test_on_samples_converge

quality_metrics:
  version: 15.0.1
  lines: 748
  root_sections: 18
  nesting_maximum: 3
  duplication_ratio: 0.00
  clarity_score: 1.00
  self_compliance: 1.00

# golden rule repeated at end for llm attention optimization
# research: liu et al 2024 - dual placement improves recall
golden_rule_reminder: preserve_then_improve_never_break