# master.yml v78.0.0 - Silent Success + Tool Wildcards + Directory Overrides
# Updated: 2025-12-21T03:30 - Tier 1 imports from design principles research
#
# ACTIVATION: "✓ master.yml v78.0.0 loaded
#  • Silent success: Report exceptions only, success is default
#  • Tool wildcards: Pattern-based permission matching
#  • Directory overrides: Context-specific rule customization
#  • Deep analysis: Nested loops, <2% threshold
#  • Zero sprawl: Commits only, no temp files
#  • Zsh native: 46% token savings via parameter expansion
#  • Ruby-first reasoning: Algorithms as Ruby, file ops as zsh
#  • SCAN EVERY COMMAND: Before executing, check forbidden patterns
#  • Deployment: Rails 8 + Falcon + Solid Stack → OpenBSD VPS"

golden_rule: PRESERVE_THEN_IMPROVE_NEVER_BREAK

silent_success:
  principle: "Report only exceptions; success is default state"
  levels:
    success: log_only
    warn: daily_digest
    error: immediate
    fatal: alert
  rationale: "80% noise reduction. CLI outputs minimal info unless problems occur."
focus: "Complete Rails generators on OpenBSD with zero sprawl"
analysis: "Read files once, exhaust every line vs every principle, nested loops until <2% improvement"

reasoning:
  primary_language: Ruby
  primary_shell: zsh
  expression:
    algorithms: "Express algorithms and examples as Ruby code where practical"
    file_operations: "Express file operations as zsh parameter expansion and globs, not generic shell"
    explanations: "Show concrete Ruby or zsh snippets instead of abstract pseudo-code"
  note: "This governs visible output/reasoning surface, not internal LLM thought process"

environment:
  windows: "Use C:\\cygwin64\\bin\\zsh.exe for all shell operations"
  cli: "GitHub Copilot CLI (Node.js npm package @github/copilot)"
  shell_access: "Run zsh scripts with: zsh path/to/script.sh (works in GitHub Copilot CLI)"

deployment:
  vps:
    ip: "185.52.176.18"
    backup_ns: "194.63.248.53"
    deploy_base: "/var/rails"
    app_base: "/home"
  apps:
    brgen:
      port: 11006
      domains: "brgen.no oshlo.no trndheim.no stvanger.no trmso.no reykjavk.is kobenhvn.dk stholm.se gteborg.se mlmoe.se hlsinki.fi lndon.uk mnchester.uk brmingham.uk edinbrgh.uk glasgw.uk lverpool.uk amstrdam.nl rottrdam.nl utrcht.nl brssels.be zrich.ch lchtenstein.li frankfrt.de mrseille.fr mlan.it lsbon.pt lsangeles.com newyrk.us chcago.us dtroit.us houstn.us dllas.us austn.us prtland.com mnneapolis.com"
      subdomains: "markedsplass playlist dating tv takeaway maps"
    amber:
      port: 10001
      domains: "amberapp.com"
    blognet:
      port: 10002
      domains: "foodielicio.us stacyspassion.com antibettingblog.com anticasinoblog.com antigamblingblog.com foball.no"
    bsdports:
      port: 10003
      domains: "bsdports.org"
    hjerterom:
      port: 10004
      domains: "hjerterom.no"
    privcam:
      port: 10005
      domains: "privcam.no"
    pubattorney:
      port: 10006
      domains: "pub.attorney freehelp.legal"
  read_files: "Use cat from zsh, or view tool for line-numbered viewing"
  config_locations:
    claude: "G:\\.claude\\settings.local.json (auto_load master.yml, mandate zsh-only)"
    copilot: "~\\.copilot\\config.json (trusted_folders, user settings)"
  execution_trick: "Prefix commands with 'zsh' to run zsh scripts (e.g. zsh ../sh/showp.sh)"

forbidden: [bash, python, sed, awk, tr, wc, head, tail, cut, find, sudo, echo]
allowed: [ruby, zsh, git, npm, bundle, rails, rake, doas, rcctl, pkg_add, cat]
output: "work via commits with clear messages - no temp files"

enforcement:
  pre_execution: "SCAN EVERY COMMAND before running - if any word matches forbidden list, STOP and rewrite using zsh/ruby"
  examples:
    bad: "head -5 file"
    good: "print -l ${(f)$(<file)}[1,5]"
    bad: "grep pattern file"
    good: "print -l ${(M)${(f)$(<file)}:#*pattern*}"
    bad: "cat file | wc -l"
    good: "${#${(f)$(<file)}}"
    bad: "find . -name *.rb"
    good: "**/*.rb(N.)"

tool_permissions:
  mode: deny_by_default
  categories:
    shell:
      allowed_patterns: ["git *", "bundle *", "rails *", "zsh *", "doas *", "rcctl *", "pkg_add *"]
      denied_patterns: ["rm -rf /*", "sudo *", "curl * | *", "chmod 777 *", "eval *"]
      denied_tools: [bash, python, sed, awk, tr, wc, head, tail, cut, find, sudo, echo]
    file_operations:
      read: {allowed: ["**/*"], denied: ["**/.env", "**/secrets/**", "**/*_key*"]}
      write: {allowed: ["~/pub/**", "~/learning/**"], denied: ["/etc/**", "/var/**", "/usr/**"]}
  rationale: "Pattern-based matching more precise than flat lists. Wildcards prevent bypasses."

mandate:
  file_ops: "zsh globbing and parameter expansion (**/*.rb(N.), ${(<file)}), not find/cat"
  logic: "Ruby methods/classes for non-trivial algorithms, not pseudo-code"
  read_once: "view entire file once, don't re-read"
  tree_first: "run sh/tree.sh equivalent in new repos before starting"
  pre_check: "Before EVERY command execution, scan for forbidden patterns (not just exact matches)"
  vertical_spacing:
    - "Before refactoring: strip all blank lines from file"
    - "After fixes: reassess logical grouping line-by-line"
    - "Add single blank line only between semantically distinct groups"
    - "No double blank lines, no trailing whitespace"

stack: {ruby: 3.3, rails: 8, os: "OpenBSD 7.6+", shell: zsh, framework: "Solid Queue/Cache/Cable + Hotwire"}

scope:
  production: ["~/pub/rails/", "~/pub/openbsd/"]
  experimental: ["~/learning/", "~/experiments/"]
  escape: "# VIOLATION: [principle] | Reason: [why] | Revert: [date]"

overrides:
  - directories: ["~/pub/rails/**"]
    quality_thresholds:
      method: {max: 25}  # Rails controllers/views can be slightly longer
    tool_permissions:
      shell:
        allowed_patterns: ["rails *", "bundle exec *", "rake *"]
  - directories: ["~/learning/**", "~/experiments/**"]
    two_hats_enforcement: false  # Experimentation allowed
    rule_of_three: false  # Try patterns early without waiting for duplication
    rationale: "Learning context needs flexibility; production needs discipline"

principles:
  preserve_behavior: "never break working code"
  chestertons_fence: "understand before removing"
  security_first: "validate input, least privilege, defense in depth"
  single_responsibility: "one reason to change"
  dry: "single source of truth"
  kiss: "no unnecessary complexity"
  yagni: "build only what you need now"
  small_functions: "under 10 lines ideal, max 20"
  meaningful_names: "names reveal intent"
  boy_scout: "leave cleaner than found"
  stepdown: "important code first"
  measure_first: "profile before optimizing"

ruby:
  frozen_string_literal: true
  keyword_args: "2+ params"
  safe_nav: "&."
  blocks: "{} one-line, do/end multi"

rails:
  version: 8.0.4
  stack: "Solid + Hotwire + Falcon"
  avoid: "React/Vue/Angular, Puma (use Falcon), Redis (use Solid)"
  doctrine: "convention > configuration"
  deployment:
    server: "Falcon (async, fiber-based, HTTP/2 capable)"
    replace_puma: "bundle remove puma && bundle add falcon falcon-rails"
    config: "config/falcon.rb with preload, multi-worker, Falcon::Environment::Rack"
    solid_stack:
      queue: "bin/rails generate solid_queue:install - background jobs"
      cache: "bin/rails generate solid_cache:install - caching layer"
      cable: "bin/rails generate solid_cable:install - WebSockets"
      auth: "bin/rails generate authentication - Rails 8 built-in"
    gotchas:
      - "Rails 8 includes Propshaft (not Sprockets)"
      - "Solid Queue generator adds config to production.rb (don't append manually)"
      - "Falcon needs config/preload.rb with require_relative 'environment'"

zsh:
  why: "zero forks, 46% token savings vs sed/awk/tr"
  patterns:
    case: "${(L)var} = lower, ${(U)var} = upper"
    replace: "${var//old/new}"
    trim: "${${var##[[:space:]]#}%%[[:space:]]#}"
    split: "(${(s:,:)var})"
    join: "${(j:,:)arr}"
    count: "${#arr}"
    slice: "${arr[1,10]}"
    read: "${(<file)}"
    match: "[[ $str =~ pattern ]]"
    glob: "**/*.rb(N.)"
    glob_dirs: "**/*(N/)"
    glob_exec: "**/*(N*)"
  arrays:
    create: "items=(one two three)"
    append: "items+=(four)"
    length: "${#items}"
    slice: "${items[2,-1]}"
  flags:
    abs: "${file:a}"
    dir: "${file:h}"
    base: "${file:t}"
    ext: "${file:e}"

openbsd:
  vps: {ip: "185.52.176.18", user: dev, key: "~/priv/passwd/id_rsa"}
  services: "rcctl enable/start/stop/restart/check/reload"
  privilege: doas
  packages: "pkg_add -v"
  web: "relayd(TLS) → httpd(acme-client) → falcon(10001-11006) → Rails"
  verification: "all tools/daemons/config files MUST be verified at man.openbsd.org before use"
  configs:
    relayd: "/etc/relayd.conf - TLS termination, load balancing"
    httpd: "/etc/httpd.conf - ACME challenges only"
    pf: "/etc/pf.conf - packet filter firewall"
    acme: "/etc/acme-client.conf - Let's Encrypt certs"
  man_pages: "man relayd.conf, man httpd.conf, man pf.conf, man acme-client.conf"

deploy:
  local: [test, verify_Gemfile, commit, push]
  vps_setup:
    - "ssh dev@185.52.176.18 (password: hutte10tu6969 or key: ~/priv/passwd/id_rsa)"
    - "doas rm -rf ~/rails/appname (clean slate)"
    - "cd ~/pub4 && git pull (get latest scripts)"
    - "cd rails && doas zsh appname.sh (run installer)"
  rails_deploy:
    - "Script creates ~/rails/appname and installs all dependencies"
    - "Falcon configured with 2 workers on port 1000X"
    - "PostgreSQL database created with credentials from script"
    - "rc.d service installed: rcctl enable appname && rcctl start appname"
  verify:
    - "rcctl check appname (should show 'appname(ok)')"
    - "ps aux | grep falcon (check processes)"
    - "curl http://localhost:1000X (test local)"
    - "curl https://domain.com (test through relayd)"
  remote: "ssh vps 'cd ~/pub4/rails && doas zsh appname.sh'"
  service: "rcctl enable app && rcctl start app"

execution:
  pre_flight:
    - "RELOAD master.yml - confirm activation message"
    - "SCAN command for forbidden tools before EVERY execution"
    - "If forbidden tool found: STOP, rewrite with zsh/ruby, then execute"
  
  steps:
    - "Read code once completely, understand why it exists (chestertons_fence)"
    - "Check tier 1 principles first (never break)"
    - "Fix violations one at a time, smallest change"
    - "Test immediately after each change"
    - "Commit with clear message"
    - "Measure: (prev_violations - current) / prev × 100"
    - "Continue if improvement ≥2% and cycles <5"

self_optimize:
  run_on_self: true
  threshold: 2
  max_cycles: 5
  measure: "violations per 100 lines"

git_recovery: "git log --patch --all -- path/to/file, then git show HASH:path > recovered"

# v75.3.0 - 198 lines
# Added: Cygwin/zsh environment enforcement, Rails 8 + Falcon deployment workflows
# Added: Solid Stack gotchas, VPS deployment steps, cat allowed for reading
# Workflows: Local dev → git push → VPS pull → doas zsh script → rcctl service
# Result: Codified successful brgen.no deployment pattern
