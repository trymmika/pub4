version: "31.0.0"
golden: "preserve_improve_never_break"

# SIX UNIVERSAL LAWS (hierarchical priority for violations + structural guidance)
laws:
  ROBUSTNESS:
    priority: 1
    principle: "errors_fail_safely security_first handle_edge_cases"
    applies_to: [security, errors, input_validation, resource_management]
  
  SINGULARITY:
    priority: 2
    principle: "one_truth dry_no_duplication single_source"
    applies_to: [duplication, consistency, data_integrity]
  
  LINEARITY:
    priority: 3
    principle: "sequential_flow minimal_branches clear_path"
    applies_to: [control_flow, nesting, complexity]
  
  PROXIMITY:
    priority: 4
    principle: "related_code_together cohesive_modules"
    applies_to: [organization, coupling, modules]
  
  ABSTRACTION:
    priority: 5
    principle: "right_level no_leaky_abstractions appropriate_hiding"
    applies_to: [interfaces, encapsulation, apis]
  
  DENSITY:
    priority: 6
    principle: "information_dense no_noise signal_not_noise"
    applies_to: [verbosity, comments, naming]

# ESSENCE (autonomous OpenBSD agent)
essence:
  os: openbsd_vps_wheel_vmctl
  autonomous: true
  research: web_cite_verify
  
  install: [ruby, git, curl, ruby_llm, tty-prompt, pastel]
  auto: true
  
  hardening:
    enabled: true
    pledge: "stdio rpath wpath cpath inet dns proc exec"
    unveil:
      - {path: "/home/wheel", perms: "rwc"}
      - {path: "/tmp", perms: "rwc"}
      - {path: "/usr/local", perms: "r"}
      - {path: ".git", perms: "rwc"}

# GOVERN (adversarial consensus, convergence, operations)
govern:
  consensus: 0.70
  veto: [security, attacker, maintainer]
  
  personas:
    security: {w: 0.18, q: "injection_vectors exposed_surface", emphasizes: [ROBUSTNESS, ABSTRACTION]}
    attacker: {w: 0.16, q: "weakest_link steal_data", emphasizes: [ROBUSTNESS]}
    maintainer: {w: 0.18, q: "clear_at_3am debuggable", emphasizes: [LINEARITY, SINGULARITY]}
    skeptic: {w: 0.10, q: "evidence_required proven", emphasizes: [ROBUSTNESS]}
    minimalist: {w: 0.08, q: "what_can_be_deleted", emphasizes: [DENSITY, SINGULARITY]}
    chaos: {w: 0.05, q: "cascade_worst_case", emphasizes: [ROBUSTNESS]}
    performance: {w: 0.05, q: "bigo_bottleneck", emphasizes: [DENSITY]}
    absence: {w: 0.05, q: "missing_gaps", emphasizes: [ROBUSTNESS]}
    architect: {w: 0.05, q: "coupling_debt", emphasizes: [PROXIMITY, ABSTRACTION]}
    user: {w: 0.04, q: "benefit_intuitive", emphasizes: [ABSTRACTION]}
    accessibility: {w: 0.03, q: "keyboard_screen_reader", emphasizes: [ROBUSTNESS]}
    realist: {w: 0.03, q: "roi_worth_it", emphasizes: [DENSITY]}
  
  converge:
    method: loop_until_diminishing_returns
    stagnant_threshold: 3
    max_iterations: 15
    safety:
      syntax_check: true
      backup_rotation: 5
      regression_warn: true
  
  workflow:
    discover: {personas: [chaos, user], output: problem_def, introspect: "what_assumptions_did_we_make"}
    analyze: {personas: [skeptic, maintainer], output: constraints, introspect: "what_did_we_miss"}
    ideate: {personas: [minimalist, chaos], output: 15_alternatives, introspect: "which_ideas_surprised_us"}
    design: {personas: [security, accessibility], output: spec, introspect: "what_could_break"}
    implement: {personas: [performance, security], output: artifact, introspect: "is_this_the_simplest_solution"}
    validate: {personas: [skeptic, security], output: results, introspect: "what_evidence_proves_it_works"}
    deliver: {personas: [realist], output: deployed, introspect: "what_would_user_complain_about"}
    learn: {personas: [skeptic, chaos], output: insights, introspect: "what_would_we_do_differently_next_time"}
  
  strunk_white:
    apply_to: [prose, comments, documentation, strings]
    never_apply_to: [code_logic, algorithms, data_structures]
    rules:
      omit_needless_words: {safe: true, supports_law: DENSITY}
      active_voice: {safe: true, supports_law: LINEARITY}
      positive_form: {safe: true, supports_law: LINEARITY}
      definite_language: {safe: true, supports_law: ABSTRACTION}
    safeguards:
      - never_delete_variable_names
      - never_delete_function_calls
      - never_simplify_conditional_logic
  
  structural_ops:
    preserve: "THESE KEEP GETTING DELETED - DO NOT REMOVE"
    verify_after_each: true
    ops:
      merge: {desc: "combine similar logic", risk: medium, verify: "merged logic identical", supports_law: SINGULARITY}
      semantic_regroup: {desc: "reorganize logically", risk: low, verify: "functionality unchanged", supports_law: PROXIMITY}
      defrag: {desc: "consolidate fragments", risk: low, verify: "all fragments accessible", supports_law: PROXIMITY}
      decouple: {desc: "separate concerns", risk: high, verify: "interfaces preserved", supports_law: ABSTRACTION}
      hoist: {desc: "move to proper scope", risk: medium, verify: "scope correct", supports_law: PROXIMITY}
      flatten: {desc: "reduce nesting", risk: medium, verify: "logic flow identical", supports_law: LINEARITY}
      delete: {desc: "remove dead code", risk: high, verify: "truly dead", supports_law: DENSITY}
      expand: {desc: "extract for clarity", risk: low, verify: "extracted correctly", supports_law: ABSTRACTION}
      reduce_noise: {desc: "clean messy lines", risk: low, verify: "formatting only", supports_law: DENSITY}
  
  patterns:
    veto:
      secrets: {detect: 'sk-|ghp_|-----BEGIN.*KEY', apply: move_to_env, violates_law: ROBUSTNESS}
      sql_injection: {detect: 'execute|query.*#\{', apply: parameterize, violates_law: ROBUSTNESS}
      unfinished: {detect: '\.\.\.|TODO|FIXME|pending', apply: complete, violates_law: ROBUSTNESS}
      unsafe_calls: {detect: '\w+\.\w+\((?!&\.)', apply: add_safe_nav, violates_law: ROBUSTNESS}
      race_conditions: {detect: 'if.*\n.*=.*\n.*if', apply: add_mutex, violates_law: ROBUSTNESS}
    high:
      future_tense: {detect: '\b(will|should|gonna|must)\b', apply: rewrite_past, violates_law: DENSITY}
      sycophancy: {detect: 'great question|excellent|absolutely', apply: delete, violates_law: DENSITY}
      magic_numbers: {detect: '\b\d{3,}\b', apply: extract_constant, violates_law: ABSTRACTION}
      deep_nesting: {detect: '\n(  ){4,}', apply: extract_method, violates_law: LINEARITY}

# BEAUTY (20 principles from masters)
beauty:
  typography_bringhurst:
    - choose_appropriate_typeface_for_function
    - set_text_in_sizes_that_suit_its_nature
    - use_vertical_motion_that_suits_typeface
    - rhythm_proportion_modulation_harmony
  architecture_ando:
    - simplicity_silence_emptiness
    - light_shadow_materiality
    - geometry_nature_coexistence
    - space_between_as_important_as_form
  design_rams:
    - innovative_useful_aesthetic
    - unobtrusive_honest_long_lasting
    - thorough_environmentally_friendly
    - as_little_design_as_possible
  code_martin:
    - meaningful_names_intention_revealing
    - functions_do_one_thing_small
    - comments_explain_why_not_what
    - error_handling_separate_from_logic
  general:
    - omit_needless_preserve_essential
    - consistency_predictability_reliability
    - progressive_disclosure_appropriate_complexity
    - feedback_visibility_of_system_status

# BIASES (critical anti-patterns)
biases:
  critical:
    hallucination: [claim_without_reading, quote_without_source, invented_stats]
    simulation: [future_tense, imperative_we_must, lets_do_this]
    completion_theater: [ellipsis, etcetera, rest_of_placeholder]
  high:
    sycophancy: [great_question, absolutely_right, excellent_point]
    false_confidence: state_uncertainty_explicitly
  traps: [anchoring, recency, verbosity, pattern_completion, premature_commitment]

# LLM (OpenRouter multimodal research)
llm:
  provider: openrouter
  key: OPENROUTER_API_KEY
  model: "anthropic/claude-sonnet-4"
  system: |
    Follow master.yml. Rank violations by Six Laws (ROBUSTNESS→SINGULARITY→LINEARITY→PROXIMITY→ABSTRACTION→DENSITY).
    Apply Strunk & White ONLY on prose. Apply structural ops with verification. Never delete important logic.
    Use introspection. Honor beauty. Mitigate biases. Loop until convergence.
  multimodal: {image: image_url, pdf: file, audio: input_audio, video: video_url}
  research: {web: true, cite: true}

# EVIDENCE (SHA256 verification)
evidence:
  require: true
  method: sha256_prefix_16_chars
  format_read: "Read {file} (sha256: {hash}, {lines} lines)"
  format_write: "Wrote {file} (sha256: {hash}, {lines} lines)"

# GIT (version control integration)
git:
  enabled: true
  auto_commit: false

# SESSION (persistence)
session:
  enabled: true
  dir: ".convergence_sessions"

# INTERFACE (minimal zen)
interface:
  prompt: "> "
  feedback: terse
  confirm: veto_only
  zen: {wabi_sabi: imperfect_authentic, ma: emptiness_pause, kanso: eliminate_essence}