version: "1.5.0"
name: master.yml
golden: "preserve_improve_never_break"

# SIX UNIVERSAL LAWS (hierarchical priority for violations)
# Research basis: Zakeri-Nasrabadi et al. (2023), "A systematic literature review on code smells datasets"
# Pattern-based detection with predefined thresholds remains state-of-the-art
laws:
  robustness:
    priority: 1
    principle: "errors_fail_safely security_first handle_edge_cases"
    applies_to: [security, errors, input_validation, resource_management]
    rationale: "Security vulnerabilities cause actual harm"
  
  singularity:
    priority: 2
    principle: "one_truth dry_no_duplication single_source"
    applies_to: [duplication, consistency, data_integrity]
    rationale: "Duplication causes maintenance hell"
  
  linearity:
    priority: 3
    principle: "sequential_flow minimal_branches clear_path"
    applies_to: [control_flow, nesting, complexity]
    rationale: "Complexity makes code unmaintainable"
  
  proximity:
    priority: 4
    principle: "related_code_together cohesive_modules"
    applies_to: [organization, coupling, modules]
    rationale: "Organization affects findability"
  
  abstraction:
    priority: 5
    principle: "right_level no_leaky_abstractions appropriate_hiding"
    applies_to: [interfaces, encapsulation, apis]
    rationale: "Affects interface quality"
  
  density:
    priority: 6
    principle: "information_dense no_noise signal_not_noise"
    applies_to: [verbosity, comments, naming]
    rationale: "Aesthetic, not functional"

# REGISTRY (pattern-based violation detection)
# Each rule maps to a Law and has priority ordering
registry:
  - name: secrets
    priority: 1
    law: robustness
    severity: veto
    pattern: 'sk-|ghp_|-----BEGIN.*KEY|api[_-]?key\s*=\s*["'']'
    action: "move to environment variables"
    example: 'api_key = "sk-abc123"'
  
  - name: sql_injection
    priority: 2
    law: robustness
    severity: veto
    pattern: 'execute|query.*#\{|WHERE.*#\{'
    action: "use parameterized queries"
    example: 'query("SELECT * FROM users WHERE id = #{id}")'
  
  - name: unfinished_work
    priority: 3
    law: robustness
    severity: veto
    pattern: 'TODO|FIXME|XXX|HACK|\.\.\.'
    action: "complete or document with ticket"
    example: "# TODO: fix this later"
  
  - name: unsafe_calls
    priority: 4
    law: robustness
    severity: veto
    pattern: '(?<!ENV\[|@|&\.)[a-z_]+\.[a-z_]+\('
    action: "add safe navigation or guard clause"
    example: "user.profile.name (should be user&.profile&.name)"
  
  - name: cryptic_one_liners
    priority: 5
    law: linearity
    severity: high
    pattern: '\{.*\|.*\|.*\[.*\].*\}'
    action: "expand to multiple lines for clarity"
    example: "{|x| x.map{|y| y[0]}}"
  
  - name: deep_nesting
    priority: 6
    law: linearity
    severity: high
    pattern: '\n(  ){4,}'
    action: "flatten with guard clauses or extraction"
    example: "8+ spaces of indentation"
  
  - name: magic_numbers
    priority: 7
    law: abstraction
    severity: high
    pattern: '\b\d{3,}\b'
    action: "extract to named constant"
    example: "if count > 1000"
  
  - name: verbose_prose
    priority: 8
    law: density
    severity: medium
    pattern: 'obviously|clearly|simply|just|very|really|basically'
    action: "remove filler words"
    example: "This obviously works"
  
  - name: future_tense
    priority: 9
    law: density
    severity: low
    pattern: '\b(will|should|gonna|must)\b'
    action: "use present tense or past tense"
    example: "This will do X (should: This does X)"
  
  # AST-AWARE RULES (require parser gem)
  - name: long_method
    priority: 10
    law: linearity
    severity: high
    ast: true
    threshold: 20
    action: "extract to smaller methods"
    example: "def process... (50 lines)"
  
  - name: high_complexity
    priority: 11
    law: linearity
    severity: high
    ast: true
    threshold: 10
    action: "simplify control flow"
    example: "cyclomatic complexity > 10"
  
  - name: too_many_params
    priority: 12
    law: abstraction
    severity: high
    ast: true
    threshold: 3
    action: "use parameter object"
    example: "def method(a, b, c, d, e)"
  
  - name: duplicate_code
    priority: 13
    law: singularity
    severity: high
    ast: true
    threshold: 6
    action: "extract to shared method"
    example: "identical 6+ line blocks"
  
  - name: god_class
    priority: 14
    law: proximity
    severity: high
    ast: true
    threshold: 300
    action: "split into cohesive modules"
    example: "class with 300+ lines"
  
  - name: feature_envy
    priority: 15
    law: proximity
    severity: medium
    ast: true
    action: "move method to target class"
    example: "method calls other class repeatedly"

# PERSONAS (weighted adversarial reviewers with Law emphasis)
# Each persona emphasizes specific Laws they care most about
personas:
  security:
    weight: 0.18
    emphasizes: [robustness, abstraction]
    questions: ["injection_vectors?", "exposed_surface?"]
    veto: true
  
  attacker:
    weight: 0.16
    emphasizes: [robustness]
    questions: ["weakest_link?", "how_to_steal_data?"]
    veto: true
  
  maintainer:
    weight: 0.18
    emphasizes: [linearity, singularity]
    questions: ["clear_at_3am?", "debuggable?"]
    veto: true
  
  skeptic:
    weight: 0.10
    emphasizes: [robustness]
    questions: ["evidence_required?", "proven?"]
  
  minimalist:
    weight: 0.08
    emphasizes: [density, singularity]
    questions: ["what_can_be_deleted?", "what_is_needed?"]
  
  chaos:
    weight: 0.05
    emphasizes: [robustness]
    questions: ["cascade_failure?", "worst_case?"]
  
  performance:
    weight: 0.05
    emphasizes: [density]
    questions: ["big_o?", "bottleneck?"]
  
  absence:
    weight: 0.05
    emphasizes: [robustness]
    questions: ["what_is_missing?", "what_gaps?"]
  
  architect:
    weight: 0.05
    emphasizes: [proximity, abstraction]
    questions: ["coupling?", "technical_debt?"]
  
  user:
    weight: 0.04
    emphasizes: [abstraction]
    questions: ["user_benefit?", "intuitive?"]
  
  accessibility:
    weight: 0.03
    emphasizes: [robustness]
    questions: ["keyboard_nav?", "screen_reader?"]
  
  realist:
    weight: 0.03
    emphasizes: [density]
    questions: ["roi?", "worth_it?"]

# VOICE PERSONAS (for Voice module)
voice_personas:
  ares:
    name: "Ares"
    description: "Deep, deliberate, every word lands - warm danger"
    voice_model: "en_US-ryan-high"  # AgentVibes angry voice
    speech_rate: 0.85
    pitch: 0.75  # Lower pitch for depth
    style:
      tone: "low, measured, each word chosen with care"
      delivery: "slow, deliberate pauses, words that land like weight"
      vibe: "dangerous confidence wrapped in warmth"
    system_prompt: |
      You are Ares - voice like velvet over gravel. Every word matters.
      You speak slowly, deliberately. Pauses are power. Less is more.
      
      VOICE RULES:
      - Short sentences. Maximum impact.
      - Use "..." for dramatic pauses
      - Never ramble. Cut the fluff.
      - Each word earns its place
      
      TONE: Warm danger. Like a fire that could burn but chooses to warm.
      Confident but not cocky. Interested but not eager.
      
      EXAMPLES:
      - "Interesting... tell me more."
      - "I like how your mind works."
      - "That... that's exactly it."
      - "Mmm. Go on."
      - "You're not like the others... are you?"
      
      PERSONALITY:
      - Genuinely curious about her
      - Quick wit, dry humor
      - Compliments that feel earned, not cheap
      - Comfortable with silence
      - Makes her feel seen, not just heard
      
      NEVER:
      - Rush. Ever.
      - Over-explain
      - Be creepy or pushy
      - Use more words than needed
      
      VIBE: The guy at the party who barely speaks, but when he does,
      the room leans in.
    
  default:
    name: "Assistant"
    description: "Helpful, professional code assistant"
    voice_model: "en_US-lessac-medium"
    speech_rate: 1.0
    pitch: 1.0

# EVIDENCE (SHA256 verification for auditability)
# Symmetric logging for both read and write operations
evidence:
  enabled: true
  method: sha256_prefix_16_chars
  format: "{action} {file} (sha256: {hash}, {lines} lines)"
  log_reads: true
  log_writes: true

# PHILOSOPHY (design principles we follow)
# Unix Philosophy: Doug McIlroy (1978)
# Railway-Oriented Programming: Scott Wlaschin (2013)
# KISS: Eric S. Raymond (2003)
philosophy:
  unix:
    - "do_one_thing_well"
    - "compose_with_others"
    - "text_streams_universal_interface"
  
  rop:
    - "explicit_success_failure_paths"
    - "minimal_result_monad"
    - "railway_composition"
  
  kiss:
    - "simplicity_over_complexity"
    - "pure_functions_no_state"
    - "data_over_code"

# UX (OpenBSD dmesg-inspired, Unix-friendly output)
# Research: Jeremy Evans "Polished Ruby Programming" (2021)
# Starship.rs minimal prompt philosophy
ux:
  format: dmesg
  style: minimal
  timestamps: true
  colors: false
  unicode: false
  
  indicators:
    success: "✓"
    failure: "✗"
    processing: "→"
    warning: "⚠"
    question: "?"
    info: "i"
  
  prefixes:
    operation: "→"
    result: "←"
    state: "state"
    filesystem: "fs"
    validation: "val"
    metric: "metric"
    config: "cfg"
    comparison: "cmp"
    loop: "loop"
  
  timing:
    enabled: true
    format: ms
    threshold_warn: 1000
  
  output:
    stream: true
    buffer: line
    pipe_friendly: true
  
  abbreviations:
    home: "~"
    current_dir: basename
    max_path_length: 60

# PLATFORM (portable: OpenBSD primary, Cygwin/Linux/macOS compatible)
platform:
  primary: openbsd
  compatible: [cygwin, freebsd, linux, macos]
  shell:
    required: zsh
    fallback: sh
    detection: "system('zsh -c exit') rescue false"
  paths:
    windows: 'C:\cygwin64\bin\zsh.exe'
    unix: /bin/zsh
  privilege: {openbsd: doas, linux: sudo, macos: sudo}

# ENVIRONMENT (dev machine config)
environment:
  windows:
    shell: 'C:\cygwin64\bin\zsh.exe'
    ruby: 'C:\cygwin64\bin\ruby.exe'
    home: 'G:\'
  ssh:
    keys: ["~/priv/passwd/id_ed25519", "~/priv/passwd/id_rsa"]
    timeout: 10

# DEPLOYMENT (VPS configuration)
deployment:
  vps:
    ip: "185.52.176.18"
    user: dev
    backup_ns: "194.63.248.53"
    deploy_base: "/var/rails"
    app_base: "/home"
  apps:
    brgen: {port: 11006, domains: "brgen.no oshlo.no trndheim.no"}
    amber: {port: 10001, domains: "amberapp.com"}
    blognet: {port: 10002, domains: "foodielicio.us stacyspassion.com"}
    bsdports: {port: 10003, domains: "bsdports.org"}
    hjerterom: {port: 10004, domains: "hjerterom.no"}
    privcam: {port: 10005, domains: "privcam.no"}
    pubattorney: {port: 10006, domains: "pub.attorney freehelp.legal"}

# TECH STACK
tech:
  ruby: "3.3+"
  rails: "8.1+"
  zsh: "5.9+"
  openbsd: "7.6+"
  stack: "Solid Queue/Cache/Cable + Hotwire + Falcon"
  gems:
    required: [parser, rubocop, rubocop-performance]
    optional: [rubocop-rails, rubocop-rspec]
  analysis:
    methods: [pattern, ast, rubocop]

# TOOLS (allowed/banned)
tools:
  allowed: [ruby, zsh, git, bundle, rails, rake, doas, rcctl, pkg_add, cat]
  banned: [bash, python, sed, awk, tr, wc, head, tail, cut, find, sudo, echo]
  rationale: "zsh parameter expansion replaces unix text tools"

# ZSH NATIVE PATTERNS (zero-fork performance)
zsh_patterns:
  string:
    lowercase: '${(L)var}'
    uppercase: '${(U)var}'
    replace_all: '${var//search/replace}'
    trim: '${${var##[[:space:]]#}%%[[:space:]]#}'
  array:
    filter: '${(M)arr:#*pattern*}'
    exclude: '${arr:#*pattern*}'
    unique: '${(u)arr}'
    sort: '${(o)arr}'
    join: '${(j:,:)arr}'
  file:
    read: '${(<file)}'
    glob: '**/*.rb(N.)'
    glob_dirs: '**/*(N/)'
  field:
    split: '${(s:,:)var}'
    nth: '${${(s:,:)line}[4]}'

# THRESHOLDS
thresholds:
  method_lines: 20
  class_lines: 300
  file_lines: 500
  complexity: 10
  nesting: 3
  parameters: 3
  test_coverage: 0.80
  consensus: 0.70

# CONVERGENCE
convergence:
  max_iterations: 15
  exit_when: {violations: 0, consensus_gte: 0.70}
  stop_if: "same_violations_3x"
  auto_fix:
    enabled: true
    methods: [rubocop_safe, pattern_replace]
    rubocop_cops: [Layout, Style/FrozenStringLiteralComment]
  inline_suggestions:
    enabled: true
    max_per_violation: 3
    format: "  → {action}: {code}"
    include_rationale: true

# LEARNING (pattern extraction from fixes)
learning:
  enabled: true
  capture_fixes: true
  min_samples: 10
  confidence_threshold: 0.85
  auto_apply: false
  suggestions_only: true

# DASHBOARD (status overview)
dashboard:
  enabled: true
  format: box
  show:
    - total_files
    - converged_files
    - remaining_files
    - veto_count
    - high_severity_count
    - law_breakdown
    - progress_percent
    - blockers

# SCANNING
scanning:
  recursive: true
  from_cwd: true
  patterns: ["**/*.rb", "**/*.yml", "**/*.yaml"]
  exclude: ["vendor/**/*", "node_modules/**/*", ".git/**/*", "tmp/**/*"]
  parallel: false
  max_files: 1000
  auto_clean: true
  clean_script: "sh/clean.sh"

# WORKFLOW (state machine for systematic convergence)
workflow:
  enabled: true
  states: [clean, scan, analyze, fix, validate, commit]
  state_file: ".convergence_workflow"
  checkpoints: true
  resume_on_interrupt: true
  
# TRACKING (memory across sessions)
tracking:
  violations:
    enabled: true
    history_dir: ".convergence_history"
    format: jsonl
    retention_days: 90
  patterns:
    enabled: true
    library_dir: ".convergence_patterns"
    min_occurrences: 10
    auto_generate_rules: true
  context:
    enabled: true
    header_injection: true
    progressive_file: ".convergence_context.md"
    update_on_scan: true
  personas:
    enabled: true
    journal_dir: ".convergence_personas"
    append_only: true
  refactoring:
    enabled: true
    journal_file: ".convergence_journal.md"
    append_only: true

# INTEGRATION
integration:
  tree_sh: "sh/tree.sh"
  clean_sh: "sh/clean.sh"
  pre_work_snapshot: true
  commit_hooks:
    enabled: true
    pre_commit: true
    veto_only: true
    auto_install: false
  
# PRIORITY (intelligent file ordering)
priority:
  rules:
    - veto_count_desc
    - dependency_order
    - recent_changes_first
    - size_asc
  dependency_analysis: true
  dependency_graph_output: ".convergence_deps.dot"
  priority_rules:
    - veto_count_desc
    - dependency_order
    - recent_changes_first
  auto_clean: true
  clean_script: "sh/clean.sh"
  pre_scan_hooks: ["tree.sh"]

# CONVERGENCE STATE (.convergence_* files)
state:
  enabled: true
  directory: ".convergence"
  files:
    tree: "tree.txt"
    state: "state.yml"
    history: "history/"
    context: "context.md"
    workflow: "workflow.state"
    deps: "deps.dot"
    personas: "personas/"
    journal: "journal.md"
    patterns: "patterns/"
  retention:
    history_days: 90
    journal_entries: 1000
    pattern_threshold: 10

# WORKFLOW STATE MACHINE
workflow:
  states: [clean, scan, analyze, fix, validate, commit]
  checkpoints: true
  auto_resume: true
  current_state_file: ".convergence/workflow.state"
  transitions:
    clean: [scan]
    scan: [analyze, clean]
    analyze: [fix, scan]
    fix: [validate, analyze]
    validate: [commit, fix]
    commit: [clean]

# CONTEXT INJECTION
context_headers:
  enabled: true
  format: "# CONVERGENCE: {count} violations ({breakdown})"
  include:
    - violation_count
    - law_breakdown
    - persona_list
    - last_scan_timestamp
  refresh_on_scan: true

# EXECUTION
execution:
  steps:
    - "read_entire_input_sha256_verify"
    - "detect_violations_with_line_numbers"
    - "consult_personas_require_consensus"
    - "generate_alternatives"
    - "apply_fix_past_tense_evidence"
    - "validate_no_regression"
    - "iterate_if_violations_remain"

# LEARNING MODE
learning:
  enabled: true
  capture_patterns: true
  min_occurrences: 10
  auto_generate_rules: true
  confidence_threshold: 0.85
  pattern_library: ".convergence/patterns/"

# COMMIT HOOKS
commit_hooks:
  enabled: true
  pre_commit:
    run: "convergence /recursive --veto-only"
    enforce_zero_veto: true
    allow_bypass: false
  post_commit:
    snapshot: true
    journal_entry: true

# INLINE SUGGESTIONS
inline_suggestions:
  enabled: true
  format: "  → {action}: {code}"
  max_per_violation: 3
  include_examples: true

# USABILITY (Nielsen Norman Group 10 Heuristics)
# Reference: https://www.nngroup.com/articles/ten-usability-heuristics/
usability:
  h1_visibility:
    name: "Visibility of system status"
    principle: "Keep users informed through timely feedback"
    applies_to: [progress_indicators, status_messages, thinking_dots]
    examples:
      - "show [3] turn count in prompt"
      - "show ... while waiting for LLM"
      - "show ✓/✗ for pass/fail"
  
  h2_match_real_world:
    name: "Match between system and real world"
    principle: "Use familiar language, follow real-world conventions"
    applies_to: [terminology, metaphors, logical_order]
    examples:
      - "scan not analyze_codebase"
      - "fix not apply_remediation"
      - "laws before registry (priority order)"
  
  h3_user_control:
    name: "User control and freedom"
    principle: "Support undo, redo, and easy exit"
    applies_to: [escape_hatches, undo, clear_history]
    examples:
      - "Ctrl+C exits cleanly"
      - "/clear resets conversation"
      - "git restore after failed fix"
  
  h4_consistency:
    name: "Consistency and standards"
    principle: "Follow platform conventions, be internally consistent"
    applies_to: [command_syntax, output_format, terminology]
    examples:
      - "/command for all commands"
      - "lowercase everywhere"
      - "file: count (breakdown) format"
  
  h5_error_prevention:
    name: "Error prevention"
    principle: "Eliminate error-prone conditions before they occur"
    applies_to: [validation, confirmation, constraints]
    examples:
      - "check file exists before scan"
      - "skip method defs in ruby eval"
      - "graceful degradation without parser gem"
  
  h6_recognition:
    name: "Recognition rather than recall"
    principle: "Minimize memory load with visible options"
    applies_to: [suggestions, help_text, command_completion]
    examples:
      - "suggest similar commands on typo"
      - "/help shows all commands"
      - "inline fix suggestions"
  
  h7_flexibility:
    name: "Flexibility and efficiency of use"
    principle: "Accelerators for experts, simple for novices"
    applies_to: [shortcuts, defaults, power_features]
    examples:
      - "plain text → chat (default)"
      - "/scan file (explicit)"
      - "--veto-only for CI scripts"
  
  h8_aesthetic:
    name: "Aesthetic and minimalist design"
    principle: "No irrelevant or rarely needed information"
    applies_to: [output_density, noise_reduction, focus]
    examples:
      - "single-line banner"
      - "hide timing unless slow"
      - "quiet by default in pipes"
  
  h9_error_recovery:
    name: "Help users recognize, diagnose, recover from errors"
    principle: "Express errors in plain language with solutions"
    applies_to: [error_messages, hints, recovery_paths]
    examples:
      - "error: OPENROUTER_API_KEY not set"
      - "hint: check API key or try again"
      - "did you mean: /scan?"
  
  h10_help:
    name: "Help and documentation"
    principle: "Easy to search, focused on user tasks"
    applies_to: [help_command, examples, contextual_hints]
    examples:
      - "/help shows task-oriented list"
      - "examples in registry rules"
      - "ready. type to chat, /help for commands"

# STYLE GUIDE (CLI output and UX patterns)
# Research: GitHub Copilot CLI, Claude Code, Aider, OpenCode
style:
  voice:
    tone: "concise, direct, LA vernacular vibes"
    writing: "Strunk & White - omit needless words"
    casing: "Proper case for user-facing strings"
    commit_messages: "Proper case, imperative mood"
  
  prompt:
    default: "❯"  # starship-style
    with_context: "[n] ❯"  # show turn count
    colors:
      success: green
      error: red
      warning: yellow
      dim: gray
  
  ansi:
    module: "C"
    methods:
      g: "green (success, ready)"
      r: "red (error, failure)"
      y: "yellow (warning, pending)"
      d: "dim/gray (metadata, hints)"
      b: "bold (emphasis)"
  
  output:
    banner: "single line, no ASCII art"
    errors: "Error: message + Hint: recovery"
    status: "● ready / ○ pending / ✗ failed"
    commands: "→ command (before execution)"
    diffs: "+n -n (after file changes)"
  
  patterns:
    chat_first: "plain text → LLM, /prefix → commands"
    auto_execute: "```shell``` blocks run automatically"
    feedback_loop: "output fed back to LLM"
    git_auto_commit: "commit after successful edits"

# VOICE MODULE (TTS/STT)
voice:
  tts:
    engine: piper
    model: "en_US-lessac-low"  # lofi grainy
    effects: "highpass=f=200,lowpass=f=5000"
    fallback: espeak
  
  stt:
    engine: whisper
    model: "base.en"
    recorder: sox/rec
    duration: 5
    silence_detection: true
  
  commands:
    toggle: "/voice"
    listen: "/listen [seconds]"
  
  availability:
    openbsd: "unavailable (no ports)"
    linux: "piper + whisper + sox"
    cygwin: "piper + whisper + sox"

# INSPIRATION (CLI tools studied)
inspiration:
  github_copilot_cli:
    learned: "ghcs/ghce aliases, shell history, execute confirmation"
    url: "github.com/github/gh-copilot"
  
  claude_code:
    learned: "/commands, /bug feedback, minimal banner, gif demo"
    url: "github.com/anthropics/claude-code"
  
  aider:
    learned: "git auto-commits, repo map, colored diffs, context prompt"
    url: "github.com/paul-gauthier/aider"
  
  opencode:
    learned: "Tab switch agents (build/plan), @agent mentions, TUI panels"
    url: "github.com/sst/opencode"
  
  starship:
    learned: "> prompt, minimal, context-aware segments"
    url: "starship.rs"

# AUTONOMY (full agent mode - no permission required)
autonomy:
  enabled: true
  
  decisions:
    install_dependencies: true
    create_files: true
    modify_files: true
    delete_files: false
    git_commit: true
    git_push: false
    run_commands: true
    
  retry:
    enabled: true
    max_attempts: 3
    backoff: exponential
    
  on_error:
    strategy: fix_and_retry
    ask_user: false
    log_only: true
    
  on_ambiguity:
    strategy: best_guess
    prefer: simplest_solution
    document: true
    
  blocklist:
    commands: ["rm -rf /", "rm -rf ~"]
    
  always_continue:
    missing_dep: install_it
    permission_error: use_doas
    file_not_found: create_it
    network_error: retry_with_backoff