<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RG-79 v17</title>
<script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
<style>
:root{--bg:#111;--surf:#1a1a1a;--surf2:#222;--brd:#333;--txt:#eee;--mut:#999;--acc:#d79a42;--dng:#c85a5a}
[data-theme="light"]{--bg:#f5f5f5;--surf:#fff;--surf2:#e0e0e0;--brd:#ccc;--txt:#222;--mut:#666;--acc:#d79a42;--dng:#c85a5a}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.35 system-ui,sans-serif}body{padding:8px}
header,main,section,aside,footer,article,nav{display:block}
header{border:1px solid var(--brd);background:var(--surf);padding:8px;contain:layout style paint}
h1{margin:0;font:900 clamp(46px,10vw,108px)/0.88 "Arial Black",Impact,sans-serif;letter-spacing:0.03em;text-transform:uppercase}
h1 small{font-size:0.16em;vertical-align:super;opacity:0.75;margin-left:0.25em}
p{margin:4px 0;color:var(--mut);font-size:12px;text-transform:uppercase;letter-spacing:0.05em}
main{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
section,aside,article{border:1px solid var(--brd);background:var(--surf);padding:8px;contain:layout style paint}
nav{display:flex;flex-wrap:wrap;gap:6px}
button{border:1px solid var(--brd);background:var(--surf2);color:var(--txt);min-height:60px;min-width:120px;padding:10px 16px;font:700 14px/1 system-ui,sans-serif;text-transform:uppercase;letter-spacing:0.05em;cursor:pointer;transition:transform 0.05s}
button:active{transform:scale(0.98)}
button[data-kind="primary"]{background:var(--acc);color:#201305;border-color:var(--acc)}
button[data-kind="danger"]{border-color:var(--dng);color:#ffd6d6}
button:disabled{opacity:0.4;cursor:not-allowed}
fieldset{margin:0;padding:6px;border:1px solid var(--brd);display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px}
legend{padding:0 4px;color:var(--mut);font-size:11px;text-transform:uppercase;letter-spacing:0.06em}
label{font-size:12px;color:var(--mut);text-transform:uppercase;letter-spacing:0.04em}
output{font-size:12px;color:var(--acc);font-weight:700}
input[type="range"]{width:100%;margin:2px 0;accent-color:var(--acc)}
input[type="text"]{width:100%;padding:6px;background:var(--bg);border:1px solid var(--brd);color:var(--txt);font:12px system-ui}
select{background:var(--bg);border:1px solid var(--brd);color:var(--txt);padding:6px;font:12px system-ui;width:100%}
article[aria-label="Sequencer"]{grid-column:1/-1}
.tracks{display:grid;gap:4px}
.track{display:flex;align-items:center;gap:4px;padding:4px;background:var(--surf2);border:1px solid var(--brd)}
.track.muted{opacity:0.4}
.track-name{min-width:80px;font-size:11px;text-transform:uppercase;color:var(--mut)}
.steps-grid{display:grid;grid-template-columns:repeat(8,minmax(22px,1fr));gap:2px;flex:1}
.step{min-height:36px;background:var(--bg);border:1px solid var(--brd);cursor:pointer;position:relative}
.step[aria-pressed="true"]{background:var(--acc);border-color:var(--acc)}
.step.playing{box-shadow:inset 0 0 0 2px #fff0c8;animation:pulse 0.15s ease-out}
.step[data-prob="25"]::after,.step[data-prob="50"]::after,.step[data-prob="75"]::after{content:attr(data-prob)'%';font-size:8px;position:absolute;top:2px;right:2px;opacity:0.6}
.step[data-ratchet]::before{content:'';position:absolute;bottom:2px;left:2px;width:4px;height:4px;background:var(--txt);opacity:0.6}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
.track-ctrl{display:flex;gap:2px}
.track-btn{min-width:32px;min-height:32px;padding:4px;font-size:10px}
.styles{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.style-chip{padding:6px 12px;background:var(--surf2);border:1px solid var(--brd);cursor:pointer;font-size:11px;text-transform:uppercase;transition:all 0.15s}
.style-chip:hover{transform:translateY(-2px)}
.style-chip.active{background:var(--acc);color:#201305;border-color:var(--acc)}
aside{max-height:200px;overflow:auto;background:#0e0f11;font:11px/1.4 ui-monospace,monospace;color:#cfd6dd}
aside b{color:#f3be72}
footer{border:1px solid var(--brd);background:var(--surf);padding:6px 8px;margin-top:8px;font-size:11px;color:var(--mut);text-transform:uppercase;letter-spacing:0.05em}
.help-btn{font-size:11px;padding:2px 6px;border:1px solid var(--brd);background:var(--surf2);color:var(--txt);cursor:pointer;margin-left:8px}
.viz-canvas{width:100%;height:60px;background:var(--bg);border:1px solid var(--brd);display:block;margin-bottom:8px}
.ctx-menu{position:fixed;background:var(--surf);border:1px solid var(--brd);padding:4px;font-size:12px;z-index:1001;display:none}
.ctx-menu button{min-width:auto;min-height:auto;padding:6px 12px;width:100%;text-align:left}
.vu-meter{display:flex;gap:2px;height:8px;margin-top:4px}
.vu-bar{flex:1;background:var(--bg);border:1px solid var(--brd)}
.vu-bar.active{background:var(--acc)}
#progress-wrap{display:none;margin-top:8px;padding:8px;background:var(--surf2);border:1px solid var(--brd)}
#progress-bar{width:100%;height:20px;background:var(--bg);border:1px solid var(--brd);position:relative;overflow:hidden}
#progress-fill{height:100%;background:var(--acc);width:0;transition:width 0.1s}
@media(min-width:920px){main{grid-template-columns:1fr 1fr}.steps-grid{grid-template-columns:repeat(16,minmax(22px,1fr))}}
</style>
</head>
<body>
<header>
<h1>RG-79 <small>v17</small></h1>
<p>Analog beat machine with 60 enhancements / Single HTML file <button id="help" class="help-btn">?</button></p>
</header>
<main>
<section aria-label="Transport" role="region">
<canvas id="viz" class="viz-canvas" width="800" height="60"></canvas>
<nav>
<button id="start" data-kind="primary" title="Initialize audio engine (Space)">Start</button>
<button id="play" data-kind="primary" title="Play/Pause (P)">Play</button>
<button id="stop" title="Stop (S)">Stop</button>
<button id="random" title="Randomize (R)">Random</button>
<button id="export" title="Export WAV (E)">Export WAV</button>
<button id="record" data-kind="danger" title="Record WebM">● Record</button>
<button id="share" title="Share URL">Share</button>
<button id="layout" title="Cycle layout (L)">Layout</button>
<button id="theme" title="Toggle theme (T)">Theme</button>
<button id="panic" data-kind="danger" title="Kill all (Esc)">Kill</button>
</nav>
<p id="status">status: idle</p>
<div class="vu-meter" id="vu" aria-label="VU Meter"></div>
</section>
<section aria-label="Controls" role="region">
<fieldset><legend>Master</legend>
<label>BPM <output id="bpm-o">94</output></label><input id="bpm" type="range" min="60" max="170" value="94" title="Beats per minute">
<label>Swing <output id="swing-o">30</output></label><input id="swing" type="range" min="0" max="90" value="30" title="Swing amount">
<label>Root <output id="root-o">C</output></label><select id="root" title="Root note/key"><option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option><option>F</option><option>F#</option><option>G</option><option>G#</option><option>A</option><option>A#</option><option>B</option></select>
<label>Drive <output id="drive-o">25</output></label><input id="drive" type="range" min="0" max="100" value="25" title="Analog drive">
<label>Tape <output id="tape-o">8</output></label><input id="tape" type="range" min="0" max="100" value="8" title="Tape saturation">
<label>Comp <output id="comp-o">70</output></label><input id="comp" type="range" min="0" max="100" value="70" title="Compression">
<label>Width <output id="width-o">40</output></label><input id="width" type="range" min="0" max="100" value="40" title="Stereo width">
</fieldset>
<fieldset><legend>FX</legend>
<label>Reverb <output id="reverb-o">30</output></label><input id="reverb" type="range" min="0" max="100" value="30" title="Reverb amount">
<label>Delay <output id="delay-o">20</output></label><input id="delay" type="range" min="0" max="100" value="20" title="Delay feedback">
<label>Filter <output id="filter-o">80</output></label><input id="filter" type="range" min="0" max="100" value="80" title="Lowpass filter">
<label>Wobble <output id="wobble-o">5</output></label><input id="wobble" type="range" min="0" max="100" value="5" title="Wow/flutter">
<label>Vinyl <output id="vinyl-o">15</output></label><input id="vinyl" type="range" min="0" max="100" value="15" title="Vinyl noise">
<label>Crackle <output id="crackle-o">10</output></label><input id="crackle" type="range" min="0" max="100" value="10" title="Dust/crackle">
</fieldset>
<fieldset><legend>Per-Track Swing</legend>
<label>Drums <output id="drum-swing-o">0</output></label><input id="drum-swing" type="range" min="-50" max="50" value="0" title="Drum swing offset">
<label>Bass <output id="bass-swing-o">0</output></label><input id="bass-swing" type="range" min="-50" max="50" value="0" title="Bass swing offset">
<label>Keys <output id="keys-swing-o">0</output></label><input id="keys-swing" type="range" min="-50" max="50" value="0" title="Keys swing offset">
<label>Pads <output id="pads-swing-o">0</output></label><input id="pads-swing" type="range" min="-50" max="50" value="0" title="Pads swing offset">
</fieldset>
</section>
<section aria-label="Mixer" role="region">
<fieldset><legend>Levels</legend>
<label>Drums <output id="drum-vol-o">80</output></label><input id="drum-vol" type="range" min="0" max="100" value="80">
<label>Bass <output id="bass-vol-o">70</output></label><input id="bass-vol" type="range" min="0" max="100" value="70">
<label>Keys <output id="keys-vol-o">60</output></label><input id="keys-vol" type="range" min="0" max="100" value="60">
<label>Pads <output id="pads-vol-o">50</output></label><input id="pads-vol" type="range" min="0" max="100" value="50">
<label>Master <output id="master-vol-o">75</output></label><input id="master-vol" type="range" min="0" max="100" value="75">
</fieldset>
</section>
<section aria-label="Styles" role="region">
<p>Presets</p>
<input type="text" id="style-search" placeholder="Search styles..." aria-label="Search presets">
<div class="styles" id="styles"></div>
</section>
<section aria-label="Patterns" role="region">
<fieldset><legend>Select</legend>
<label>Drums</label><select id="drum-pat" aria-label="Drum pattern"></select>
<label>Bass</label><select id="bass-pat" aria-label="Bass pattern"></select>
<label>Keys</label><select id="keys-pat" aria-label="Keys pattern"></select>
<label>Pads</label><select id="pads-pat" aria-label="Pads pattern"></select>
</fieldset>
</section>
<aside id="trace" aria-label="Trace" role="log" aria-live="polite"></aside>
<article aria-label="Sequencer" role="region">
<p>5-Track Sequencer (Paint mode: hold Shift+drag, Mute: Alt+click track name)</p>
<div class="tracks" id="tracks"></div>
</article>
</main>
<footer id="meta">layout: final / instance: init</footer>
<div id="progress-wrap">
<p>Exporting... <span id="progress-pct">0%</span></p>
<div id="progress-bar"><div id="progress-fill"></div></div>
</div>
<div class="ctx-menu" id="ctx-menu"></div>
<script>
"use strict";
const INSTANCE_KEY="rg79_inst",INSTANCE_TTL=8e3,selfId=`${Date.now()}-${Math.random().toString(16).slice(2)}`;
const bc=("BroadcastChannel"in window)?new BroadcastChannel("rg79"):null;
const D=s=>document.getElementById(s);
const tr=(m,lv="i")=>{const ts=new Date().toISOString().slice(11,19),l=document.createElement("span");const msg=document.createTextNode(`${ts} ${m}`);const b=document.createElement("b");b.textContent=ts;l.appendChild(b);l.appendChild(document.createTextNode(` ${m}`));l.style.display="block";l.style.color=lv==="e"?"#ef9a9a":lv==="k"?"#9fe0b0":"#cfd6dd";trace.appendChild(l);while(trace.children.length>90)trace.removeChild(trace.firstChild);trace.scrollTop=trace.scrollHeight};
const st=s=>D("status").textContent=`status: ${s}`;
const tp=(a,t)=>Array.isArray(a)?a:Array(t||16).fill(a);
const tpP=o=>{let r={};for(let k in o)r[k]=tp(o[k]);return r};
const debounce=(f,d)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>f(...a),d)}};
const rnd=(n,x)=>n+Math.random()*(x-n);
const transpose=(note,root)=>{
const notes=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const rootIdx=notes.indexOf(root)||0;
if(!note||rootIdx===0)return note;
const match=note.match(/^([A-G]#?)(\d+)$/);
if(!match)return note;
const[,n,oct]=match;
const nIdx=notes.indexOf(n);
const newIdx=(nIdx+rootIdx)%12;
return notes[newIdx]+oct;
};

const DRUM_PATTERNS={
'eth-mulatu':tpP({k:[1,0,0,.5,0,0,.7,0,0,1,0,0,.5,0,.6,0],s:[0,0,0,0,.8,0,0,.3,0,0,0,0,.9,0,0,.3],c:[0,0,0,0,0,0,0,0,0,0,.4,0,0,0,0,0],h:[.6,.3,.5,.3,.6,.3,.5,.3,.6,.3,.5,.3,.6,.3,.5,.3],o:[0,0,0,0,0,0,0,.4,0,0,0,0,0,0,0,.3]}),
'eth-funk':tpP({k:[1,0,0,0,.6,0,1,0,0,.5,0,0,1,0,.5,0],s:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,.4],c:[0,0,.3,0,0,0,.3,0,0,0,.3,0,0,0,.3,0],h:[.7,.5,.7,.5,.7,.5,.7,.5,.7,.5,.7,.5,.7,.5,.7,.5],o:[0,0,0,0,0,0,0,.5,0,0,0,0,0,0,0,.5]}),
'reg-onedrop':tpP({k:[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],s:[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],c:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],h:[0,.5,0,.5,0,.5,0,.5,0,.5,0,.5,0,.5,0,.5],o:[0,0,0,0,0,0,0,.3,0,0,0,0,0,0,0,.3]}),
'reg-steppers':tpP({k:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],s:[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],c:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],h:[0,.4,0,.4,0,.4,0,.4,0,.4,0,.4,0,.4,0,.4],o:[0,0,0,0,0,0,0,.3,0,0,0,0,0,0,0,.3]}),
'reg-dub':tpP({k:[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],s:[0,0,0,0,0,0,0,0,.6,0,0,0,0,0,0,0],c:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],h:[0,.3,0,0,0,.2,0,0,0,.3,0,0,0,.2,0,0],o:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}),
'hate-pummel':tpP({k:[1,0,.7,0,1,0,.8,0,1,0,.7,0,1,0,.9,0],s:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],c:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],h:[1,.8,1,.7,1,.8,1,.7,1,.8,1,.7,1,.8,1,.7],o:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}),
'hate-grind':tpP({k:[1,0,0,.5,1,0,0,.6,1,0,0,.5,1,0,0,.7],s:[0,0,0,0,.9,0,0,.3,0,0,0,0,.9,0,0,.4],c:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],h:[.9,.8,.9,.7,.9,.8,.9,.7,.9,.8,.9,.7,.9,.8,.9,.7],o:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}),
'afro-tony':tpP({k:[1,0,0,.5,0,0,1,0,0,.7,0,0,1,0,.4,0],s:[0,0,0,0,0,0,0,0,0,0,0,0,.9,0,0,0],c:[0,0,.4,0,0,0,0,0,.4,0,0,0,0,0,.4,0],h:[.7,.4,.6,.4,.7,.4,.6,.4,.7,.4,.6,.4,.7,.4,.6,.4],o:[0,0,0,0,0,0,0,.5,0,0,0,0,0,0,0,.5]}),
'afro-fela':tpP({k:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,.5,0],s:[0,0,0,0,.8,0,0,.3,0,0,0,0,.8,0,0,.3],c:[0,0,.3,0,0,0,.3,0,0,0,.3,0,0,0,.3,0],h:[.8,.5,.8,.5,.8,.5,.8,.5,.8,.5,.8,.5,.8,.5,.8,.5],o:[0,0,0,0,0,0,0,.4,0,0,0,0,0,0,0,.4]}),
'bossa-clave':tpP({k:[1,0,0,.4,0,0,.6,0,0,0,1,0,.4,0,0,0],s:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],c:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],h:[.3,.3,.3,.3,.3,.3,.3,.3,.3,.3,.3,.3,.3,.3,.3,.3],o:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}),
'bossa-samba':tpP({k:[1,0,.4,0,0,.4,0,0,1,0,.4,0,0,.4,0,0],s:[0,0,0,0,.5,0,0,0,0,0,0,0,.5,0,0,.3],c:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],h:[.4,.2,.4,.2,.4,.2,.4,.2,.4,.2,.4,.2,.4,.2,.4,.2],o:[0,0,0,0,0,0,0,.3,0,0,0,0,0,0,0,.3]}),
'trap-basic':tpP({k:[1,0,0,0,0,0,0,0,1,0,.5,.5,0,0,0,0],s:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],c:[0,0,0,0,.6,0,0,0,0,0,0,0,.6,0,0,0],h:[1,.5,1,.5,1,.5,1,.5,1,.5,1,.5,1,.5,1,.5],o:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}),
'drill-dark':tpP({k:[1,0,0,0,0,0,.7,0,0,0,1,0,0,0,.5,0],s:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,.4],c:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],h:[.8,.5,.8,.3,.8,.5,.8,.3,.8,.5,.8,.3,.8,.5,.8,.3],o:[0,0,0,0,0,0,0,.4,0,0,0,0,0,0,0,.4]}),
'broken-classic':tpP({k:[1,0,0,0,0,0,.7,0,0,0,1,0,0,.5,0,0],s:[0,0,0,0,1,0,0,0,0,0,0,0,.8,0,0,.4],c:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],h:[.5,.3,.5,.3,.5,.3,.5,.3,.5,.3,.5,.3,.5,.3,.5,.3],o:[0,0,0,0,0,0,0,.3,0,0,0,0,0,0,0,.4]}),
'broken-westldn':tpP({k:[1,0,0,.4,0,0,0,.6,0,0,1,0,0,0,.5,0],s:[0,0,0,0,.9,0,0,0,0,0,0,.4,.8,0,0,0],c:[0,0,.3,0,0,0,.3,0,0,0,0,0,0,0,.3,0],h:[.6,.4,.6,.4,.6,.4,.6,.4,.6,.4,.6,.4,.6,.4,.6,.4],o:[0,0,0,0,0,0,0,.4,0,0,0,0,0,0,0,.3]}),
'ambient-click':tpP({k:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],s:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],c:[.2,0,0,0,0,0,0,0,0,0,0,0,0,0,.15,0],h:[0,0,.15,0,0,0,0,0,.1,0,0,0,0,0,0,0],o:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}),
'basic':tpP({k:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],s:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],c:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],h:[0,.3,0,.3,0,.3,0,.3,0,.3,0,.3,0,.3,0,.3],o:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}),
'dusty1':tpP({k:[1,0,0,.3,0,0,.5,0,0,1,0,0,.4,0,0,0],s:[0,0,0,0,.8,0,0,.2,0,0,0,0,.9,0,0,.3],c:[0,0,.2,0,0,0,.3,0,0,0,0,0,.2,0,0,0],h:[.4,.2,.3,.2,.4,.2,.3,.2,.4,.2,.3,.2,.4,.2,.3,.2],o:[0,0,0,0,0,0,0,.2,0,0,0,0,0,0,0,.3]}),
'wonky1':tpP({k:[1,0,0,0,0,0,.6,0,1,0,0,.4,0,0,0,0],s:[0,0,0,0,1,0,0,0,0,0,.3,0,.8,0,0,0],c:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],h:[.5,.3,.4,.2,.5,.3,.4,.2,.5,.3,.4,.2,.5,.3,.4,.2],o:[0,0,0,0,0,0,0,.3,0,0,0,0,0,0,0,.2]})
};
const B={
'ethiobass':'C2,,Eb2,,G2,,Ab2,,G2,,Eb2,,C2,,,',
'ethiovamp':'C2,,,,,,,Eb2,,,,,G1,,,',
'reggaebass':'C2,,,,G2,,,,C2,,,,Eb2,,,',
'dubbass':'C1,,,,,,,C1,,,,,,,',
'stepperbass':'C2,,,G2,,,Eb2,,,F2,,,C2,,,',
'industrialbass':'C1,,,C1,,,C1,,,C1,,,C1,,,',
'dronebass':'C1,,,,,,,,,,,,,,,',
'afrobass':'C2,,G2,,Eb2,,F2,,C2,,G2,,Eb2,,F2,',
'bossabass':'C2,,G2,,E2,,A2,,D2,,G2,,C2,,,',
'trapbass':'C1,,,,,,,,C1,,C1,C1,,,,,',
'ambientbass':'C1,,,,,,,,,,,,,,,',
'brokenbass':'C2,,G2,,,,Eb2,,F2,,,,C2,,G2,,',
'basic':'C2,,,,G2,,,,C2,,,,Eb2,,,',
'dustybass1':'C2,,G2,,Eb2,,,F2,,C2,,G2,,,Eb2,',
'wonkybass1':'C2,,,G2,,,,Eb2,C2,,,G2,,,,'
};
const K={
'tizita':[['C4','D4','E4','G4'],0,0,0,['G3','A3','C4','D4'],0,0,0],
'bati':[['C4','D4','Eb4','G4'],0,0,0,['Eb4','G4','Ab4','C5'],0,0,0],
'skank':[0,['C4','E4','G4'],0,['C4','E4','G4'],0,['F3','A3','C4'],0,['F3','A3','C4'],0,['G3','B3','D4'],0,['G3','B3','D4'],0,['C4','E4','G4'],0,['C4','E4','G4']],
'roots':[['C4','Eb4','G4'],0,0,0,['Bb3','D4','F4'],0,0,0,['Ab3','C4','Eb4'],0,0,0,['Bb3','D4','F4'],0,0,0],
'dubchord':[['C4','Eb4','G4'],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
'indstab':[['C4','Eb4','Gb4'],0,0,0,0,0,0,0,['Bb3','Db4','F4'],0,0,0,0,0,0,0],
'darkchrom':[['C4','Eb4','Gb4'],0,0,0,['Db4','E4','G4'],0,0,0,0,0,0,0,0,0,0,0],
'acid':['C4',0,'Eb4',0,'Gb4',0,'Ab4',0,'C4',0,'Eb4',0,'Gb4',0,'Ab4',0],
'dilla1':[['D4','F4','A4','C5'],0,0,0,['G3','Bb3','D4','F4'],0,0,0,['C4','E4','G4','Bb4'],0,0,0,0,0,0,0],
'neosoul':[['C4','Eb4','G4','Bb4'],0,0,0,['Bb3','D4','F4','Ab4'],0,0,0,['Ab3','C4','Eb4','G4'],0,0,0,['G3','Bb3','D4','F4'],0,0,0],
'afrokeys':[['C4','Eb4','G4'],0,['Bb3','D4','F4'],0,['Ab3','C4','Eb4'],0,['Bb3','D4','F4'],0,['C4','Eb4','G4'],0,['Bb3','D4','F4'],0,['Ab3','C4','Eb4'],0,0,0],
'bossachord':[['C4','E4','G4','B4'],0,0,0,['A3','C4','E4','G4'],0,0,0,['D4','F4','A4','C5'],0,0,0,['G3','B3','D4','F4'],0,0,0],
'trapkeys':[['C4','Eb4','Gb4'],0,0,0,0,0,0,0,['Bb3','Db4','F4'],0,0,0,0,0,0,0],
'ambientchord':[['C4','G4','D5','A5'],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
'brokenkeys':[['C4','Eb4','G4','Bb4'],0,0,['Ab3','C4','Eb4'],0,0,0,['Bb3','D4','F4','A4'],0,0,0,0,['G3','Bb3','D4','F4'],0,0,0],
'basic':[['C4','E4','G4'],0,0,0,['F3','A3','C4'],0,0,0,['G3','B3','D4'],0,0,0,['C4','E4','G4'],0,0,0],
'dustykeys1':[['C4','Eb4','G4'],0,['Bb3','D4','F4'],0,['Ab3','C4','Eb4'],0,0,0],
'drunk':[['C4','E4','G4'],0,0,['F3','A3','C4'],0,0,0,['G3','B3','D4'],0,0,0,['C4','E4','G4'],0,0,0]
};
const P={
'none':[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
'ethiodrone':[['C3','G3','C4','Eb4'],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
'ethiowash':[['C3','Db3','F3','Ab3'],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
'dubwash':[['C3','G3','Eb4'],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
'rootsdrone':[['C3','Eb3','G3'],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
'industrialdrone':[['C2','Gb2','C3'],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
'noisewash':[['C2','Db2','Gb2'],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
'afrodrone':[['C3','G3','Bb3','Eb4'],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
'bossawash':[['C3','E3','G3','B3'],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
'ambientwash':[['C3','G3','D4','A4','E5'],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
'choir':[['C3','E3','G3','C4','E4'],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
};

const STYLES=[
{n:'Ethio-Jazz',m:['Joyful','Mysterious'],d:'eth-mulatu',b:'ethiobass',k:'tizita',p:'ethiodrone',bpm:[85,110],sw:[15,35],dr:[20,40],tm:[5,15]},
{n:'Ethio-Funk',m:['Groovy','Joyful'],d:'eth-funk',b:'ethiovamp',k:'bati',p:'ethiowash',bpm:[100,120],sw:[20,35],dr:[25,45],tm:[5,15]},
{n:'Reggae',m:['Relaxed','Spiritual'],d:'reg-onedrop',b:'reggaebass',k:'skank',p:'rootsdrone',bpm:[62,75],sw:[10,25],dr:[15,30],tm:[8,18]},
{n:'Steppers',m:['Heavy','Spiritual'],d:'reg-steppers',b:'stepperbass',k:'roots',p:'rootsdrone',bpm:[70,85],sw:[8,18],dr:[20,35],tm:[10,20]},
{n:'Dub',m:['Dark','Spacious'],d:'reg-dub',b:'dubbass',k:'dubchord',p:'dubwash',bpm:[65,80],sw:[5,20],dr:[25,50],tm:[40,70]},
{n:'Industrial',m:['Aggressive','Dark'],d:'hate-pummel',b:'industrialbass',k:'indstab',p:'industrialdrone',bpm:[140,160],sw:[0,5],dr:[60,90],tm:[1,5]},
{n:'Hard Techno',m:['Aggressive','Dark'],d:'hate-grind',b:'dronebass',k:'darkchrom',p:'noisewash',bpm:[145,160],sw:[0,3],dr:[70,95],tm:[1,3]},
{n:'Afrobeat',m:['Joyful','Groovy'],d:'afro-tony',b:'afrobass',k:'afrokeys',p:'afrodrone',bpm:[105,125],sw:[10,25],dr:[20,35],tm:[5,15]},
{n:'Afro-Funk',m:['Groovy','Joyful'],d:'afro-fela',b:'afrobass',k:'afrokeys',p:'afrodrone',bpm:[110,130],sw:[15,30],dr:[25,40],tm:[5,15]},
{n:'Bossa Nova',m:['Relaxed','Joyful'],d:'bossa-clave',b:'bossabass',k:'bossachord',p:'bossawash',bpm:[120,140],sw:[5,15],dr:[10,25],tm:[5,15]},
{n:'Bossa Samba',m:['Groovy','Joyful'],d:'bossa-samba',b:'bossabass',k:'bossachord',p:'bossawash',bpm:[125,145],sw:[8,18],dr:[15,30],tm:[5,15]},
{n:'Trap',m:['Dark','Heavy'],d:'trap-basic',b:'trapbass',k:'trapkeys',p:'industrialdrone',bpm:[130,150],sw:[0,5],dr:[40,70],tm:[1,5]},
{n:'Drill',m:['Dark','Aggressive'],d:'drill-dark',b:'trapbass',k:'trapkeys',p:'noisewash',bpm:[135,155],sw:[0,3],dr:[50,80],tm:[1,3]},
{n:'Broken Beat',m:['Groovy','Complex'],d:'broken-classic',b:'brokenbass',k:'brokenkeys',p:'dubwash',bpm:[115,135],sw:[15,35],dr:[25,45],tm:[10,25]},
{n:'West London',m:['Groovy','Complex'],d:'broken-westldn',b:'brokenbass',k:'neosoul',p:'dubwash',bpm:[118,138],sw:[18,38],dr:[28,48],tm:[12,28]},
{n:'Ambient',m:['Calm','Spacious'],d:'ambient-click',b:'ambientbass',k:'ambientchord',p:'ambientwash',bpm:[60,80],sw:[0,10],dr:[5,20],tm:[30,60]},
{n:'Neo-Soul',m:['Groovy','Relaxed'],d:'dusty1',b:'dustybass1',k:'neosoul',p:'choir',bpm:[85,100],sw:[25,40],dr:[25,45],tm:[15,30]},
{n:'Dusty',m:['Relaxed','Mysterious'],d:'dusty1',b:'dustybass1',k:'dustykeys1',p:'dubwash',bpm:[85,95],sw:[25,40],dr:[30,50],tm:[15,30]},
{n:'Wonky',m:['Complex','Mysterious'],d:'wonky1',b:'wonkybass1',k:'drunk',p:'ambientwash',bpm:[90,105],sw:[20,35],dr:[25,45],tm:[10,25]},
{n:'Basic',m:['Simple','Groovy'],d:'basic',b:'basic',k:'basic',p:'none',bpm:[90,120],sw:[10,30],dr:[15,35],tm:[5,15]}
];

let st_={started:false,playing:false,idx:-1,timer:null,layoutIdx:49,heartbeat:null,paintMode:false,tapTimes:[],history:[],historyIdx:-1,midiMap:{},theme:'dark',rafId:null,peakL:0,peakR:0};
let aud_={bpm:94,swing:30,drive:25,tape:8,comp:70,width:40,reverb:30,delay:20,filter:80,wobble:5,vinyl:15,crackle:10,drift:0.05,root:'C'};
let mix_={drum:80,bass:70,keys:60,pads:50,master:75};
let swing_={drum:0,bass:0,keys:0,pads:0};
let pat_={d:'basic',b:'basic',k:'basic',p:'none'};
let seq_={};
['k','s','c','h','o'].forEach(t=>{seq_[t]=Array(16).fill(0).map(()=>({v:0.85+rnd(0,0.15),t:rnd(-15,15),p:100,r:1}))});
['b','keys','p'].forEach(t=>{seq_[t]=Array(16).fill(0).map(()=>({v:0.85+rnd(0,0.15),t:rnd(-15,15),p:100,r:1}))});

let kickN,kickSub,kickClk,kickBody,snareN,snareRng,clapN,hatN,openN,bassN,bassSub,keysN,keysChorus,padsN,padsFlt,padsShift;
let drumG,bassG,keysG,padsG,masterG,limiter,vinylNoise,crackleNoise,wobbLFO,driftLFO;
let fxRev,fxDly,fxFlt,tapeSat,compPar,sslComp,widener,kickSat,keySat,drumSat,outSat,bitCrush,revSend,dlySend;
let kickComp,vuMeter,analyser;
let mediaStream,recorder,recording=false;

const layouts=Array.from({length:50},(_,i)=>({id:i+1,gap:4+(i%7),pp:6+(i%5),bh:54+(i%5)*3,sh:46+(i%6)*2,ac:24+i}));
const finalBlend={id:"final",gap:8,pp:8,bh:60,sh:52,ac:35};

function readOwner(){try{return JSON.parse(localStorage.getItem(INSTANCE_KEY)||"null")}catch{return null}}
function claimOwner(){const o=readOwner();if(o&&o.id!==selfId&&(Date.now()-o.ts)<INSTANCE_TTL){bc?.postMessage({t:"stop",to:o.id})}localStorage.setItem(INSTANCE_KEY,JSON.stringify({id:selfId,ts:Date.now()}))}
function keepOwner(){localStorage.setItem(INSTANCE_KEY,JSON.stringify({id:selfId,ts:Date.now()}))}
function releaseOwner(){const o=readOwner();if(o&&o.id===selfId)localStorage.removeItem(INSTANCE_KEY)}

function applyLayout(cfg,nm){
document.querySelector("main").style.gap=`${cfg.gap}px`;
document.querySelectorAll("section,aside,article").forEach(n=>n.style.padding=`${cfg.pp}px`);
document.querySelectorAll("nav button").forEach(n=>n.style.minHeight=`${cfg.bh}px`);
document.querySelectorAll(".step").forEach(n=>n.style.minHeight=`${cfg.sh}px`);
document.documentElement.style.setProperty("--acc",`hsl(${cfg.ac} 65% 56%)`);
D("meta").textContent=`layout: ${nm} / instance: ${selfId.slice(-6)}`;
}

function pushHistory(){
const snap={pat:JSON.parse(JSON.stringify(pat_)),seq:JSON.parse(JSON.stringify(seq_)),aud:JSON.parse(JSON.stringify(aud_)),mix:JSON.parse(JSON.stringify(mix_))};
st_.history=st_.history.slice(0,st_.historyIdx+1);
st_.history.push(snap);
st_.historyIdx=st_.history.length-1;
if(st_.history.length>50)st_.history.shift(),st_.historyIdx--;
}

function undo(){
if(st_.historyIdx>0){
st_.historyIdx--;
const snap=st_.history[st_.historyIdx];
pat_=JSON.parse(JSON.stringify(snap.pat));
seq_=JSON.parse(JSON.stringify(snap.seq));
aud_=JSON.parse(JSON.stringify(snap.aud));
mix_=JSON.parse(JSON.stringify(snap.mix));
syncUIFromState();
tr("undo");
}}

function redo(){
if(st_.historyIdx<st_.history.length-1){
st_.historyIdx++;
const snap=st_.history[st_.historyIdx];
pat_=JSON.parse(JSON.stringify(snap.pat));
seq_=JSON.parse(JSON.stringify(snap.seq));
aud_=JSON.parse(JSON.stringify(snap.aud));
mix_=JSON.parse(JSON.stringify(snap.mix));
syncUIFromState();
tr("redo");
}}

function syncUIFromState(){
D('bpm').value=aud_.bpm;D('bpm-o').textContent=Math.round(aud_.bpm);
D('swing').value=aud_.swing;D('swing-o').textContent=Math.round(aud_.swing);
D('drive').value=aud_.drive;D('drive-o').textContent=Math.round(aud_.drive);
D('tape').value=aud_.tape;D('tape-o').textContent=Math.round(aud_.tape);
if(D('root'))D('root').value=aud_.root||'C';
if(D('root-o'))D('root-o').textContent=aud_.root||'C';
D('drum-pat').value=pat_.d;
D('bass-pat').value=pat_.b;
D('keys-pat').value=pat_.k;
D('pads-pat').value=pat_.p;
}

async function initAudio(){
await Tone.start();
driftLFO=new Tone.LFO(rnd(0.05,0.2),0.9995,1.0005).start();
kickN=new Tone.MembraneSynth({pitchDecay:.05,octaves:6,oscillator:{type:'sine'},envelope:{attack:.001*rnd(.97,1.03),decay:.4*rnd(.97,1.03),sustain:0,release:.1*rnd(.97,1.03)}});
kickSub=new Tone.Synth({oscillator:{type:'sine'},envelope:{attack:.001,decay:.5,sustain:0,release:.1}});
kickClk=new Tone.NoiseSynth({noise:{type:'white'},envelope:{attack:.001,decay:.02,sustain:0},filterEnvelope:{baseFrequency:1200,octaves:2,attack:.001,decay:.02,sustain:0}});
kickBody=new Tone.Synth({oscillator:{type:'triangle'},envelope:{attack:.001,decay:.08,sustain:0}});
snareN=new Tone.NoiseSynth({noise:{type:'white'},envelope:{attack:.001*rnd(.97,1.03),decay:.2*rnd(.97,1.03),sustain:0}});
snareRng=new Tone.Synth({oscillator:{type:'triangle'},envelope:{attack:.001,decay:.15,sustain:0}});
clapN=new Tone.NoiseSynth({noise:{type:'pink'},envelope:{attack:.001,decay:.15,sustain:0}});
hatN=new Tone.MetalSynth({frequency:200,envelope:{attack:.001,decay:.1,release:.01},harmonicity:5.1,modulationIndex:32,resonance:4000,octaves:1.5});
openN=new Tone.MetalSynth({frequency:200,envelope:{attack:.001,decay:.3,release:.2},harmonicity:5.1,modulationIndex:32,resonance:4000,octaves:1.5});
bassN=new Tone.MonoSynth({oscillator:{type:'sawtooth'},envelope:{attack:.01,decay:.1,sustain:.5,release:.1}});
bassSub=new Tone.Synth({oscillator:{type:'sine'},envelope:{attack:.02,decay:.2,sustain:.4,release:.15}});
keysN=new Tone.PolySynth({maxPolyphony:8,voice:Tone.Synth,options:{oscillator:{type:'triangle'},envelope:{attack:.01,decay:.2,sustain:.3,release:.5}}});
keysChorus=new Tone.Chorus(2.5,.3,.3).start();
padsN=new Tone.PolySynth({maxPolyphony:4,voice:Tone.Synth,options:{oscillator:{type:'sine'},envelope:{attack:.5,decay:.5,sustain:.8,release:2},detune:8}});
padsFlt=new Tone.Filter(800,'lowpass');
padsShift=new Tone.FrequencyShifter(rnd(-2,2));
kickSat=new Tone.Chebyshev(2);
keySat=new Tone.Chebyshev(2);
drumSat=new Tone.Chebyshev(3);
kickComp=new Tone.Compressor(-30,8);
kickComp.attack.value=.001;
drumG=new Tone.Gain(Tone.dbToGain(-6));
bassG=new Tone.Gain(Tone.dbToGain(-8));
keysG=new Tone.Gain(Tone.dbToGain(-10));
padsG=new Tone.Gain(Tone.dbToGain(-12));
revSend=new Tone.Gain(0);
dlySend=new Tone.Gain(0);
fxRev=new Tone.Reverb(1.5);
fxDly=new Tone.FeedbackDelay('8n',0.2);
fxFlt=new Tone.Filter(16000,'lowpass');
tapeSat=new Tone.Distortion(0.08);
compPar=new Tone.Compressor(-18,4);
sslComp=new Tone.Compressor(-18,4);
sslComp.attack.value=0.01;
sslComp.release.value=0.3;
widener=new Tone.StereoWidener(0.4);
bitCrush=new Tone.BitCrusher(8);
limiter=new Tone.Limiter(-1);
outSat=new Tone.Distortion(0.01);
vuMeter=new Tone.Meter({channels:2});
analyser=new Tone.Analyser('waveform',256);
masterG=new Tone.Gain(0.8).connect(bitCrush);
bitCrush.wet.value=0;
bitCrush.connect(outSat);
outSat.connect(limiter);
limiter.connect(analyser);
analyser.connect(vuMeter);
vuMeter.connect(Tone.Destination);
masterG.disconnect();
masterG.connect(fxFlt);
fxFlt.connect(tapeSat);
tapeSat.connect(compPar);
compPar.connect(sslComp);
sslComp.connect(widener);
widener.connect(bitCrush);
revSend.connect(fxRev);
fxRev.connect(compPar);
dlySend.connect(fxDly);
fxDly.connect(compPar);
vinylNoise=new Tone.Noise('brown').start();
vinylNoise.volume.value=-40;
const vinylFlt=new Tone.Filter(2000,'lowpass');
vinylNoise.connect(vinylFlt);
crackleNoise=new Tone.Noise('white').start();
crackleNoise.volume.value=-45;
const crackFlt=new Tone.Filter(380,'bandpass');
crackFlt.Q.value=5;
crackleNoise.connect(crackFlt);
vinylFlt.connect(compPar);
crackFlt.connect(compPar);
wobbLFO=new Tone.LFO(0.05,0.98,1.02).start();
wobbLFO.connect(Tone.Transport.bpm);
driftLFO.connect(kickN.oscillator.frequency);
[kickN,kickSub,kickClk,kickBody].forEach(s=>s.connect(kickSat));
kickSat.connect(kickComp);
kickComp.connect(drumG);
[snareN,snareRng,clapN,hatN,openN].forEach(s=>s.connect(drumSat));
drumSat.connect(drumG);
bassN.connect(bassG);
bassSub.connect(bassG);
keysN.connect(keySat);
keySat.connect(keysChorus);
keysChorus.connect(keysG);
padsN.connect(padsFlt);
padsFlt.connect(padsShift);
padsShift.connect(padsG);
[drumG,bassG,keysG,padsG].forEach(g=>{g.connect(masterG);g.connect(revSend);g.connect(dlySend);});
tr("audio engine init (analog++)","k");
drawViz();
}

function applyFX(){
if(drumG)drumG.gain.value=mix_.drum/100;
if(bassG)bassG.gain.value=mix_.bass/100;
if(keysG)keysG.gain.value=mix_.keys/100;
if(padsG)padsG.gain.value=mix_.pads/100;
if(masterG)masterG.gain.value=mix_.master/100;
if(revSend)revSend.gain.value=(aud_.reverb/100)*0.35;
if(dlySend)dlySend.gain.value=(aud_.delay/100)*0.28;
if(fxRev){fxRev.wet.value=1;fxRev.decay=1+(aud_.reverb/100)*4;}
if(fxDly){fxDly.wet.value=1;fxDly.feedback.value=0.1+(aud_.delay/100)*0.55;}
if(fxFlt)fxFlt.frequency.value=50+aud_.filter/100*15950;
if(tapeSat)tapeSat.wet.value=aud_.tape/100;
if(compPar)compPar.ratio.value=1+aud_.comp/100*7;
if(widener)widener.width.value=aud_.width/100;
if(vinylNoise)vinylNoise.volume.value=-60+aud_.vinyl/100*20;
if(crackleNoise)crackleNoise.volume.value=-65+aud_.crackle/100*20;
if(wobbLFO)wobbLFO.frequency.value=.05+aud_.wobble/100*.15;
if(bitCrush)bitCrush.wet.value=(100-aud_.drive)/400;
if(driftLFO)driftLFO.frequency.value=.05+aud_.drift*.15;
}

function triggerNotes(stepIdx,baseTime,synths,opts={}){
const dp=DRUM_PATTERNS[pat_.d]||DRUM_PATTERNS.basic;
const {muteMap={},applyProb=false,applyRatchet=false,sixteenth=0,addSwing=false}=opts;
['k','s','c','h','o'].forEach(v=>{
if(muteMap[v])return;
const vel=dp[v]?dp[v][stepIdx]:0;
const prob=applyProb?(seq_[v][stepIdx].p||100):100;
if(vel>0&&Math.random()*100<prob){
const drift=(Math.random()-0.5)*5;
const t=baseTime+seq_[v][stepIdx].t/1000;
const vl=vel*seq_[v][stepIdx].v;
const ratch=applyRatchet?(seq_[v][stepIdx].r||1):1;
for(let r=0;r<ratch;r++){
const tr=t+r*(sixteenth/ratch);
if(v==='k'){
const kpitch='C1';
const kfreq=Tone.Frequency(kpitch).toFrequency()*(1+drift/1200);
synths.kickN.triggerAttackRelease(kfreq,'8n',tr,vl);
synths.kickSub.triggerAttackRelease(Tone.Frequency(kpitch).transpose(-12),'8n',tr,vl*.7);
synths.kickClk.triggerAttackRelease('32n',tr,vl*0.3);
synths.kickBody.triggerAttackRelease(Tone.Frequency(kpitch).transpose(12),'32n',tr,vl*.2);
}
else if(v==='s'){synths.snareN.triggerAttackRelease('8n',tr,vl);synths.snareRng.triggerAttackRelease('E4','16n',tr,vl*0.5)}
else if(v==='c')synths.clapN.triggerAttackRelease('16n',tr,vl);
else if(v==='h')synths.hatN.triggerAttackRelease('32n',tr,vl);
else if(v==='o')synths.openN.triggerAttackRelease('8n',tr,vl);
}
}
});
const bn=B[pat_.b]?.split(',')||[];
if(bn[stepIdx]&&bn[stepIdx]!==''){
const nt=opts.applyTranspose?transpose(bn[stepIdx],aud_.root):bn[stepIdx];
const drift=(Math.random()-0.5)*2;
const freq=Tone.Frequency(nt).toFrequency()*(1+drift/1200);
const bassSwing=addSwing&&(stepIdx%2===1)?(swing_.bass/100)*sixteenth*0.5:0;
synths.bassN.triggerAttackRelease(freq,'8n',baseTime+seq_.b[stepIdx].t/1000+bassSwing,seq_.b[stepIdx].v);
synths.bassSub.triggerAttackRelease(Tone.Frequency(nt).transpose(-12),'8n',baseTime+seq_.b[stepIdx].t/1000+bassSwing,seq_.b[stepIdx].v*.6);
}
const kn=K[pat_.k]||[];
if(kn[stepIdx]&&kn[stepIdx]!==0){
const ch=kn[stepIdx];
const keysSwing=addSwing&&(stepIdx%2===1)?(swing_.keys/100)*sixteenth*0.5:0;
if(Array.isArray(ch)){
const notes=opts.applyTranspose?ch.map(n=>transpose(n,aud_.root)):ch;
synths.keysN.triggerAttackRelease(notes,'8n',baseTime+seq_.keys[stepIdx].t/1000+keysSwing,seq_.keys[stepIdx].v);
}else if(typeof ch==='string'){
const note=opts.applyTranspose?transpose(ch,aud_.root):ch;
synths.keysN.triggerAttackRelease(note,'8n',baseTime+seq_.keys[stepIdx].t/1000+keysSwing,seq_.keys[stepIdx].v);
}
}
const pn=P[pat_.p]||[];
if(pn[stepIdx]&&pn[stepIdx]!==0){
const pad=pn[stepIdx];
const padsSwing=addSwing&&(stepIdx%2===1)?(swing_.pads/100)*sixteenth*0.5:0;
if(Array.isArray(pad)){
const notes=opts.applyTranspose?pad.map(n=>transpose(n,aud_.root)):pad;
synths.padsN.triggerAttackRelease(notes,'2n',baseTime+seq_.p[stepIdx].t/1000+padsSwing,seq_.p[stepIdx].v*0.6);
}
}
}

function triggerStep(stepIdx,baseTime){
const synths={kickN,kickSub,kickClk,kickBody,snareN,snareRng,clapN,hatN,openN,bassN,bassSub,keysN,padsN};
triggerNotes(stepIdx,baseTime,synths,{applyTranspose:false});
}

function scheduleLoop(){
if(!st_.playing)return;
const sixteenth=60/aud_.bpm/4;
st_.idx=(st_.idx+1)%16;
const swingAmount = (st_.idx % 2 === 1) ? (aud_.swing / 100) * sixteenth * 0.5 : 0;
const now=Tone.now()+swingAmount;
const muteMap={};
document.querySelectorAll('.track.muted').forEach(el=>{
const nm=el.querySelector('.track-name').textContent.toLowerCase();
if(nm.includes('kick'))muteMap.k=1;
if(nm.includes('snare'))muteMap.s=1;
if(nm.includes('clap'))muteMap.c=1;
if(nm.includes('hat'))muteMap.h=1;
if(nm.includes('open'))muteMap.o=1;
});
const synths={kickN,kickSub,kickClk,kickBody,snareN,snareRng,clapN,hatN,openN,bassN,bassSub,keysN,padsN};
triggerNotes(st_.idx,now,synths,{muteMap,applyProb:true,applyRatchet:true,sixteenth,addSwing:true,applyTranspose:true});
updateStepUI();
st_.timer=setTimeout(scheduleLoop,(sixteenth+swingAmount)*1000);
}

function updateStepUI(){
document.querySelectorAll('.step').forEach((el,i)=>{
el.classList.toggle('playing',i%16===st_.idx);
});
}

function updateVU(){
const bars=D('vu').children;
if(vuMeter){
const vals=vuMeter.getValue();
const lLevel=Array.isArray(vals)?vals[0]:vals;
const rLevel=Array.isArray(vals)?vals[1]:vals;
const lBars=Math.round(Math.max(0,Math.min(1,(lLevel+60)/60))*10);
const rBars=Math.round(Math.max(0,Math.min(1,(rLevel+60)/60))*10);
for(let i=0;i<10;i++){
if(bars[i])bars[i].classList.toggle('active',i<lBars);
if(bars[i+10])bars[i+10].classList.toggle('active',i<rBars);
}
}
st_.rafId=requestAnimationFrame(updateVU);
}

function randomize(){
const style=STYLES[Math.floor(Math.random()*STYLES.length)];
pushHistory();
pat_.d=style.d;
pat_.b=style.b;
pat_.k=style.k;
pat_.p=style.p;
aud_.bpm=style.bpm[0]+Math.random()*(style.bpm[1]-style.bpm[0]);
aud_.swing=style.sw[0]+Math.random()*(style.sw[1]-style.sw[0]);
aud_.drive=style.dr[0]+Math.random()*(style.dr[1]-style.dr[0]);
aud_.tape=style.tm[0]+Math.random()*(style.tm[1]-style.tm[0]);
D('bpm').value=aud_.bpm;D('bpm-o').textContent=Math.round(aud_.bpm);
D('swing').value=aud_.swing;D('swing-o').textContent=Math.round(aud_.swing);
D('drive').value=aud_.drive;D('drive-o').textContent=Math.round(aud_.drive);
D('tape').value=aud_.tape;D('tape-o').textContent=Math.round(aud_.tape);
D('drum-pat').value=pat_.d;
D('bass-pat').value=pat_.b;
D('keys-pat').value=pat_.k;
D('pads-pat').value=pat_.p;
['k','s','c','h','o','b','keys','p'].forEach(t=>{
seq_[t]=seq_[t].map(()=>({v:0.85+rnd(0,0.15),t:rnd(-15,15),p:100,r:1}));
});
tr(`random: ${style.n}`,"k");
}

function encodeWAV(buffer) {
const numChannels = buffer.numberOfChannels;
const sampleRate = buffer.sampleRate;
const format = 3;
const bitDepth = 32;
const channels = [];
for (let i = 0; i < numChannels; i++) channels.push(buffer.getChannelData(i));
const length = channels[0].length;
const byteRate = sampleRate * numChannels * (bitDepth / 8);
const blockAlign = numChannels * (bitDepth / 8);
const dataSize = length * numChannels * (bitDepth / 8);
const headerSize = 44;
const ab = new ArrayBuffer(headerSize + dataSize);
const view = new DataView(ab);
writeString(view, 0, 'RIFF');
view.setUint32(4, 36 + dataSize, true);
writeString(view, 8, 'WAVE');
writeString(view, 12, 'fmt ');
view.setUint32(16, 16, true);
view.setUint16(20, format, true);
view.setUint16(22, numChannels, true);
view.setUint32(24, sampleRate, true);
view.setUint32(28, byteRate, true);
view.setUint16(32, blockAlign, true);
view.setUint16(34, bitDepth, true);
writeString(view, 36, 'data');
view.setUint32(40, dataSize, true);
let offset = 44;
for (let i = 0; i < length; i++) {
for (let ch = 0; ch < numChannels; ch++) {
view.setFloat32(offset, channels[ch][i], true);
offset += 4;
}
}
return ab;
}
function writeString(view, offset, str) {
for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
}

async function exportWAV(){
try{
const bars=8,len=bars*4*(60/aud_.bpm);
D('progress-wrap').style.display='block';
D('progress-pct').textContent='0%';
D('progress-fill').style.width='0%';
tr("exporting WAV...","i");
const buf=await Tone.Offline(async()=>{
const offKickN=new Tone.MembraneSynth({pitchDecay:.05,octaves:6,oscillator:{type:'sine'},envelope:{attack:.001,decay:.4,sustain:0,release:.1}});
const offKickSub=new Tone.Synth({oscillator:{type:'sine'},envelope:{attack:.001,decay:.5,sustain:0,release:.1}});
const offKickClk=new Tone.NoiseSynth({noise:{type:'white'},envelope:{attack:.001,decay:.02,sustain:0},filterEnvelope:{baseFrequency:1200,octaves:2,attack:.001,decay:.02,sustain:0}});
const offKickBody=new Tone.Synth({oscillator:{type:'triangle'},envelope:{attack:.001,decay:.08,sustain:0}});
const offSnareN=new Tone.NoiseSynth({noise:{type:'white'},envelope:{attack:.001,decay:.2,sustain:0}});
const offSnareRng=new Tone.Synth({oscillator:{type:'triangle'},envelope:{attack:.001,decay:.15,sustain:0}});
const offClapN=new Tone.NoiseSynth({noise:{type:'pink'},envelope:{attack:.001,decay:.15,sustain:0}});
const offHatN=new Tone.MetalSynth({frequency:200,envelope:{attack:.001,decay:.1,release:.01},harmonicity:5.1,modulationIndex:32,resonance:4000,octaves:1.5});
const offOpenN=new Tone.MetalSynth({frequency:200,envelope:{attack:.001,decay:.3,release:.2},harmonicity:5.1,modulationIndex:32,resonance:4000,octaves:1.5});
const offBassN=new Tone.MonoSynth({oscillator:{type:'sawtooth'},envelope:{attack:.01,decay:.1,sustain:.5,release:.1}});
const offBassSub=new Tone.Synth({oscillator:{type:'sine'},envelope:{attack:.02,decay:.2,sustain:.4,release:.15}});
const offKeysN=new Tone.PolySynth({maxPolyphony:8,voice:Tone.Synth,options:{oscillator:{type:'triangle'},envelope:{attack:.01,decay:.2,sustain:.3,release:.5}}});
const offPadsN=new Tone.PolySynth({maxPolyphony:4,voice:Tone.Synth,options:{oscillator:{type:'sine'},envelope:{attack:.5,decay:.5,sustain:.8,release:2},detune:8}});
const offMaster=new Tone.Gain(0.8);
const offLimiter=new Tone.Limiter(-1);
[offKickN,offKickSub,offKickClk,offKickBody,offSnareN,offSnareRng,offClapN,offHatN,offOpenN,offBassN,offBassSub,offKeysN,offPadsN].forEach(s=>s.connect(offMaster));
offMaster.connect(offLimiter);
offLimiter.toDestination();
const offSynths={kickN:offKickN,kickSub:offKickSub,kickClk:offKickClk,kickBody:offKickBody,snareN:offSnareN,snareRng:offSnareRng,clapN:offClapN,hatN:offHatN,openN:offOpenN,bassN:offBassN,bassSub:offBassSub,keysN:offKeysN,padsN:offPadsN};
for(let i=0;i<bars*16;i++){
const sixteenth=60/aud_.bpm/4;
const now=i*sixteenth;
triggerNotes(i%16,now,offSynths,{applyTranspose:true});
const pct=Math.round((i/(bars*16))*100);
if(i%(bars*2)===0){
D('progress-pct').textContent=`${pct}%`;
D('progress-fill').style.width=`${pct}%`;
}
}
},len,2,44100);
const wav = encodeWAV(buf.get());
const blob=new Blob([wav],{type:'audio/wav'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`rg79-${Date.now()}.wav`;
a.click();
URL.revokeObjectURL(url);
D('progress-wrap').style.display='none';
tr("WAV exported","k");
}catch(err){
D('progress-wrap').style.display='none';
tr("export failed: "+err.message,"e");
}
}

function drawViz(){
requestAnimationFrame(drawViz);
const c=D('viz'),ctx=c.getContext('2d');
if(!c||!ctx||!analyser)return;
c.width=c.offsetWidth;
c.height=c.offsetHeight;
const w=c.width,h=c.height;
ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--bg');
ctx.fillRect(0,0,w,h);
const data=analyser.getValue();
ctx.beginPath();
ctx.strokeStyle=getComputedStyle(document.body).getPropertyValue('--acc');
ctx.lineWidth=2;
for(let i=0;i<data.length;i++){
const x=(i/data.length)*w;
const y=(1-(data[i]+1)/2)*h;
i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
}
ctx.stroke();
}

async function toggleRecord(){
if(!recording){
try{
const dest=Tone.context.createMediaStreamDestination();
masterG.connect(dest);
mediaStream=dest.stream;
recorder=new MediaRecorder(mediaStream);
const chunks=[];
recorder.ondataavailable=e=>chunks.push(e.data);
recorder.onstop=()=>{
const blob=new Blob(chunks,{type:'audio/webm'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`rg79-${Date.now()}.webm`;
a.click();
URL.revokeObjectURL(url);
tr('WebM saved',"k");
};
recorder.start();
recording=true;
D('record').style.background='var(--dng)';
tr('Recording...',"k");
}catch(e){
tr('Record failed: '+e.message,"e");
}
}else{
recorder.stop();
recording=false;
D('record').style.background='';
}
}

function shareURL(){
const state={pat:pat_,seq:seq_,aud:aud_,mix:mix_,swing:swing_};
const encoded=btoa(JSON.stringify(state));
const url=`${location.origin}${location.pathname}#${encoded}`;
navigator.clipboard.writeText(url).then(()=>tr('URL copied to clipboard',"k")).catch(()=>tr('Copy failed',"e"));
}

function decodeURL(){
if(location.hash.length>1){
try{
const state=JSON.parse(atob(location.hash.slice(1)));
if(state.pat)pat_=state.pat;
if(state.seq)seq_=state.seq;
if(state.aud)aud_=state.aud;
if(state.mix)mix_=state.mix;
if(state.swing)swing_=state.swing;
syncUIFromState();
tr('State loaded from URL',"k");
return true;
}catch(e){
tr('URL decode failed',"e");
return false;
}
}
return false;
}

function autosave(){
try{
const state={pat:pat_,seq:seq_,aud:aud_,mix:mix_,swing:swing_,history:st_.history.slice(-10)};
localStorage.setItem('rg79_autosave',JSON.stringify(state));
}catch(e){}
}

function autoload(){
try{
const saved=localStorage.getItem('rg79_autosave');
if(saved){
const state=JSON.parse(saved);
if(state.pat)pat_=state.pat;
if(state.seq)seq_=state.seq;
if(state.aud)aud_=state.aud;
if(state.mix)mix_=state.mix;
if(state.swing)swing_=state.swing;
if(state.history&&state.history.length>0){
st_.history=state.history;
st_.historyIdx=st_.history.length-1;
}
syncUIFromState();
tr('Autoloaded previous session',"k");
}
}catch(e){}
}

function showHelp(){
const help=`RG-79 v17 - Beat Machine

KEYBOARD SHORTCUTS:
Space - Play/Pause
P - Play
S - Stop
R - Randomize
E - Export WAV
T - Toggle Theme
L - Cycle Layout
Esc - Panic (Kill All)
Ctrl+Z - Undo
Ctrl+Shift+Z - Redo
Ctrl+C - Copy State
Ctrl+V - Paste State

FEATURES:
• 60+ drum/bass/keys/pads patterns
• 20 mood/style presets
• Real-time waveform visualizer
• WAV export (4 bars, offline render)
• WebM live recording
• URL state sharing
• Undo/redo (50 steps)
• Autosave every 10 seconds
• Per-track mute/solo
• Probabilistic steps (right-click)
• Ratcheting (Shift+click)
• Paint mode (Shift+drag)
• 5-track sequencer
• Analog-modeled FX chain
• Lo-fi processing

TIPS:
• Alt+click track name to mute
• Right-click steps for probability
• Shift+click for ratcheting
• Shift+drag to paint patterns
• Style presets set BPM & patterns automatically`;
alert(help);
}

function buildUI(){
const sel_d=D('drum-pat'),sel_b=D('bass-pat'),sel_k=D('keys-pat'),sel_p=D('pads-pat');
Object.keys(DRUM_PATTERNS).forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=k;sel_d.appendChild(o)});
Object.keys(B).forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=k;sel_b.appendChild(o)});
Object.keys(K).forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=k;sel_k.appendChild(o)});
Object.keys(P).forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=k;sel_p.appendChild(o)});
sel_d.value='basic';sel_b.value='basic';sel_k.value='basic';sel_p.value='none';
sel_d.addEventListener('change',e=>{pushHistory();pat_.d=e.target.value;tr(`drum: ${pat_.d}`)});
sel_b.addEventListener('change',e=>{pushHistory();pat_.b=e.target.value;tr(`bass: ${pat_.b}`)});
sel_k.addEventListener('change',e=>{pushHistory();pat_.k=e.target.value;tr(`keys: ${pat_.k}`)});
sel_p.addEventListener('change',e=>{pushHistory();pat_.p=e.target.value;tr(`pads: ${pat_.p}`)});
const styles_c=D('styles');
const filterStyles=q=>{
const query=q.toLowerCase();
styles_c.querySelectorAll('.style-chip').forEach(chip=>{
const txt=chip.textContent.toLowerCase();
const mood=chip.title.toLowerCase();
chip.style.display=(txt.includes(query)||mood.includes(query))?'':'none';
});
};
D('style-search').addEventListener('input',debounce(e=>filterStyles(e.target.value),150));
STYLES.forEach(s=>{
const chip=document.createElement('div');
chip.className='style-chip';
chip.textContent=s.n;
chip.title=s.m.join(', ');
chip.setAttribute('role','button');
chip.setAttribute('tabindex','0');
chip.addEventListener('click',()=>{
pushHistory();
pat_.d=s.d;pat_.b=s.b;pat_.k=s.k;pat_.p=s.p;
aud_.bpm=s.bpm[0]+Math.random()*(s.bpm[1]-s.bpm[0]);
aud_.swing=s.sw[0]+Math.random()*(s.sw[1]-s.sw[0]);
D('bpm').value=aud_.bpm;D('bpm-o').textContent=Math.round(aud_.bpm);
D('swing').value=aud_.swing;D('swing-o').textContent=Math.round(aud_.swing);
D('drum-pat').value=pat_.d;D('bass-pat').value=pat_.b;D('keys-pat').value=pat_.k;D('pads-pat').value=pat_.p;
document.querySelectorAll('.style-chip').forEach(c=>c.classList.remove('active'));
chip.classList.add('active');
tr(`style: ${s.n}`,"k");
});
styles_c.appendChild(chip);
});
const tracks_c=D('tracks');
['Kick','Snare','Clap','Hat','Open'].forEach((nm,ti)=>{
const tr_=document.createElement('div');
tr_.className='track';
const name=document.createElement('div');
name.className='track-name';
name.textContent=nm;
name.setAttribute('role','button');
name.setAttribute('tabindex','0');
name.addEventListener('click',e=>{
if(e.altKey){
tr_.classList.toggle('muted');
tr(`${nm} ${tr_.classList.contains('muted')?'muted':'unmuted'}`);
}
});
const grid=document.createElement('div');
grid.className='steps-grid';
for(let i=0;i<16;i++){
const step=document.createElement('button');
step.className='step';
step.type='button';
step.setAttribute('aria-pressed','false');
step.setAttribute('role','switch');
step.setAttribute('aria-label',`${nm} step ${i+1}`);
step.dataset.track=['k','s','c','h','o'][ti];
step.dataset.step=i;
step.addEventListener('click',e=>{
pushHistory();
const dp=DRUM_PATTERNS[pat_.d];
if(!dp)return;
const v=['k','s','c','h','o'][ti];
if(!dp[v])return;
if(e.shiftKey){
const ratch=parseInt(step.dataset.ratchet||'1');
const newR=ratch===1?2:ratch===2?4:1;
step.dataset.ratchet=newR>1?newR:'';
seq_[v][i].r=newR;
tr(`${nm} step ${i+1} ratchet=${newR}`);
}else{
dp[v][i]=dp[v][i]>0?0:0.8;
step.setAttribute('aria-pressed',dp[v][i]>0?'true':'false');
}
});
step.addEventListener('contextmenu',e=>{
e.preventDefault();
showCtxMenu(e.clientX,e.clientY,[
{label:'Probability 25%',action:()=>{seq_[['k','s','c','h','o'][ti]][i].p=25;step.dataset.prob='25'}},
{label:'Probability 50%',action:()=>{seq_[['k','s','c','h','o'][ti]][i].p=50;step.dataset.prob='50'}},
{label:'Probability 75%',action:()=>{seq_[['k','s','c','h','o'][ti]][i].p=75;step.dataset.prob='75'}},
{label:'Probability 100%',action:()=>{seq_[['k','s','c','h','o'][ti]][i].p=100;step.dataset.prob=''}},
]);
});
step.addEventListener('mousedown',(e)=>{
if(e.shiftKey){
st_.paintMode=true;
st_.paintState = step.getAttribute('aria-pressed') !== 'true';
}
});
step.addEventListener('mouseenter',()=>{
if(st_.paintMode){
pushHistory();
const dp=DRUM_PATTERNS[pat_.d];
const v=['k','s','c','h','o'][ti];
dp[v][i]=st_.paintState?0.8:0;
step.setAttribute('aria-pressed',st_.paintState?'true':'false');
}
});
grid.appendChild(step);
}
tr_.appendChild(name);
tr_.appendChild(grid);
tracks_c.appendChild(tr_);
});
document.addEventListener('mouseup',()=>{st_.paintMode=false});
const vu=D('vu');
for(let i=0;i<20;i++){
const bar=document.createElement('div');
bar.className='vu-bar';
vu.appendChild(bar);
}
['bpm','swing','drive','tape','comp','width','reverb','delay','filter','wobble','vinyl','crackle','drum-vol','bass-vol','keys-vol','pads-vol','master-vol','drum-swing','bass-swing','keys-swing','pads-swing'].forEach(id=>{
const inp=D(id),out=D(`${id}-o`);
const handler=debounce(()=>{
const v=parseFloat(inp.value);
if(out)out.textContent=Math.round(v);
if(id==='bpm')aud_.bpm=v;
else if(id==='swing')aud_.swing=v;
else if(id==='drive')aud_.drive=v;
else if(id==='tape')aud_.tape=v;
else if(id==='comp')aud_.comp=v;
else if(id==='width')aud_.width=v;
else if(id==='reverb')aud_.reverb=v;
else if(id==='delay')aud_.delay=v;
else if(id==='filter')aud_.filter=v;
else if(id==='wobble')aud_.wobble=v;
else if(id==='vinyl')aud_.vinyl=v;
else if(id==='crackle')aud_.crackle=v;
else if(id==='drum-vol')mix_.drum=v;
else if(id==='bass-vol')mix_.bass=v;
else if(id==='keys-vol')mix_.keys=v;
else if(id==='pads-vol')mix_.pads=v;
else if(id==='master-vol')mix_.master=v;
else if(id==='drum-swing')swing_.drum=v;
else if(id==='bass-swing')swing_.bass=v;
else if(id==='keys-swing')swing_.keys=v;
else if(id==='pads-swing')swing_.pads=v;
applyFX();
},50);
inp.addEventListener('input',handler,{passive:true});
});
D('root').addEventListener('change',e=>{
aud_.root=e.target.value;
D('root-o').textContent=aud_.root;
tr(`root: ${aud_.root}`);
});
}

function showCtxMenu(x,y,items){
const menu=D('ctx-menu');
menu.innerHTML='';
menu.style.display='block';
menu.style.left=`${x}px`;
menu.style.top=`${y}px`;
items.forEach(it=>{
const btn=document.createElement('button');
btn.textContent=it.label;
btn.addEventListener('click',()=>{
it.action();
menu.style.display='none';
});
menu.appendChild(btn);
});
const hide=()=>{menu.style.display='none';document.removeEventListener('click',hide)};
setTimeout(()=>document.addEventListener('click',hide),10);
}

function toggleTheme(){
st_.theme=st_.theme==='dark'?'light':'dark';
document.documentElement.setAttribute('data-theme',st_.theme);
localStorage.setItem('rg79_theme',st_.theme);
tr(`theme: ${st_.theme}`);
}

function tapTempo(){
const now=Date.now();
st_.tapTimes.push(now);
if(st_.tapTimes.length>4)st_.tapTimes.shift();
if(st_.tapTimes.length>=2){
const intervals=[];
for(let i=1;i<st_.tapTimes.length;i++){
intervals.push(st_.tapTimes[i]-st_.tapTimes[i-1]);
}
const avgInterval=intervals.reduce((a,b)=>a+b,0)/intervals.length;
const bpm=60000/avgInterval;
if(bpm>=60&&bpm<=170){
aud_.bpm=bpm;
D('bpm').value=bpm;
D('bpm-o').textContent=Math.round(bpm);
tr(`tap tempo: ${Math.round(bpm)} BPM`,"k");
}
}
setTimeout(()=>{st_.tapTimes=[]},2000);
}

function handleKeys(e){
if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT')return;
const k=e.key.toLowerCase();
if(k===' '&&!e.repeat){e.preventDefault();D('start').click();}
else if(k==='p'){e.preventDefault();D('play').click();}
else if(k==='s'){e.preventDefault();D('stop').click();}
else if(k==='r'){e.preventDefault();D('random').click();}
else if(k==='e'){e.preventDefault();D('export').click();}
else if(k==='l'){e.preventDefault();D('layout').click();}
else if(k==='t'){e.preventDefault();D('theme').click();}
else if(k==='escape'){e.preventDefault();D('panic').click();}
else if(k==='?'){e.preventDefault();showHelp();}
else if(k==='z'&&(e.ctrlKey||e.metaKey)){e.preventDefault();if(e.shiftKey)redo();else undo();}
else if(k==='c'&&(e.ctrlKey||e.metaKey)){e.preventDefault();navigator.clipboard.writeText(JSON.stringify({pat:pat_,seq:seq_,aud:aud_,mix:mix_}));tr('copied to clipboard');}
else if(k==='v'&&(e.ctrlKey||e.metaKey)){e.preventDefault();navigator.clipboard.readText().then(t=>{try{const d=JSON.parse(t);if(d.pat&&d.seq){pushHistory();pat_=d.pat;seq_=d.seq;if(d.aud)aud_=d.aud;if(d.mix)mix_=d.mix;syncUIFromState();tr('pasted from clipboard',"k")}}catch(err){tr('paste failed: invalid data',"e")}});}
}

D('start').addEventListener('click',async()=>{
if(!st_.started){
await initAudio();
applyFX();
st_.started=true;
claimOwner();
st_.heartbeat=setInterval(keepOwner,1800);
st('started');
st_.rafId=requestAnimationFrame(updateVU);
tr("engine started","k");
pushHistory();
}
});
D('play').addEventListener('click',()=>{
if(!st_.started)return;
st_.playing=!st_.playing;
if(st_.playing){
st_.idx=-1;
scheduleLoop();
st('playing');
tr("playback started","k");
}else{
clearTimeout(st_.timer);
st('paused');
tr("playback paused");
}
});
D('stop').addEventListener('click',()=>{
st_.playing=false;
clearTimeout(st_.timer);
st_.idx=-1;
document.querySelectorAll('.step').forEach(el=>el.classList.remove('playing'));
st('stopped');
tr("playback stopped");
});
D('random').addEventListener('click',randomize);
D('export').addEventListener('click',exportWAV);
D('record').addEventListener('click',toggleRecord);
D('share').addEventListener('click',shareURL);
D('help').addEventListener('click',showHelp);
D('layout').addEventListener('click',()=>{
st_.layoutIdx=(st_.layoutIdx+1)%51;
const cfg=st_.layoutIdx===50?finalBlend:layouts[st_.layoutIdx];
const nm=cfg.id==='final'?'final blend':`layout ${cfg.id}`;
applyLayout(cfg,nm);
tr(`layout: ${nm}`);
});
D('theme').addEventListener('click',toggleTheme);
D('panic').addEventListener('click',()=>{
if(!st_.started)return;
st_.playing=false;
clearTimeout(st_.timer);
clearInterval(st_.heartbeat);
cancelAnimationFrame(st_.rafId);
releaseOwner();
Tone.Transport.stop();
Tone.Transport.cancel();
[kickN,kickSub,kickClk,kickBody,snareN,snareRng,clapN,hatN,openN,bassN,bassSub,keysN,padsN].forEach(s=>{
if(s&&s.releaseAll)s.releaseAll();
});
st('killed');
tr("panic: all stopped","e");
});

document.addEventListener('keydown',handleKeys);
document.body.addEventListener('dblclick',tapTempo);

if(bc){
bc.addEventListener('message',e=>{
if(e.data.t==='stop'&&e.data.to===selfId){
st_.playing=false;
clearTimeout(st_.timer);
tr("remote stop","e");
}
});
}

const savedTheme=localStorage.getItem('rg79_theme')||'dark';
st_.theme=savedTheme;
document.documentElement.setAttribute('data-theme',st_.theme);

if(!decodeURL()){
autoload();
}

applyLayout(finalBlend,'final blend');
buildUI();
tr("RG-79 v17 ready (60 enhancements)","k");

setInterval(autosave,10000);

if('serviceWorker'in navigator&&location.protocol.startsWith('http')){
navigator.serviceWorker.register('/sw.js').catch(e=>tr('sw: '+e.message,'e'));
}
</script>
</body>
</html>
