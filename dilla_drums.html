<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>Drums</title>
<style>
*{margin:0;padding:0}
body{background:#000;color:#fff;font:14px monospace;padding:10px}
button{background:none;border:1px solid #333;color:#fff;padding:5px 10px;margin:5px;cursor:pointer;font:inherit}
button:hover{border-color:#fff}
button.on{border-color:#fff;background:#222}
input[type=range]{width:100px;margin:0 10px}
#log{margin-top:20px;opacity:.5;white-space:pre-wrap;max-height:70vh;overflow-y:auto}
</style>
</head>
<body>
<button id="play">play</button>
<button id="stop">stop</button>
<span>bpm:</span><input type="range" id="bpm" min="60" max="120" value="90"><span id="bpmVal">90</span>
<div id="log"></div>
<script>
const log=t=>{const l=document.getElementById('log');l.textContent+=t+'\n';l.scrollTop=l.scrollHeight;};
const Drums={
  k:null,s:null,h:null,oh:null,playing:false,pats:[],
  async init(){
    if(typeof Tone==='undefined'){await new Promise((r,j)=>{const s=document.createElement('script');
      s.src='https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js';s.onload=r;s.onerror=j;document.head.appendChild(s);});}
    await Tone.start();
    // 808-style kick with highpass to cut sub rumble
    this.kf=new Tone.Filter(60,'highpass').toDestination();
    this.k=new Tone.MembraneSynth({pitchDecay:0.12,octaves:2,envelope:{attack:0.001,decay:0.2,sustain:0.01,release:0.4}}).connect(this.kf);
    this.k.volume.value=-18;
    // Snare - filtered pink noise
    this.sf=new Tone.Filter(7000,'lowpass').toDestination();
    this.s=new Tone.NoiseSynth({noise:{type:'pink'},envelope:{attack:0.003,decay:0.1,sustain:0,release:0.06}}).connect(this.sf);
    this.s.volume.value=-16;
    // Closed hat - highpass filtered
    this.hf=new Tone.Filter(9000,'highpass').toDestination();
    this.h=new Tone.NoiseSynth({noise:{type:'white'},envelope:{attack:0.001,decay:0.02,sustain:0,release:0.01}}).connect(this.hf);
    this.h.volume.value=-22;
    // Open hat
    this.oh=new Tone.NoiseSynth({noise:{type:'white'},envelope:{attack:0.001,decay:0.15,sustain:0,release:0.06}}).connect(this.hf);
    this.oh.volume.value=-24;
    // Dilla swing
    Tone.Transport.swing=0.22;
    Tone.Transport.swingSubdivision='16n';
    log('drums ready (swing 22%)');
  },
  async play(tempo=90){
    if(!this.k)await this.init();
    this.pats.forEach(p=>{p.stop();p.dispose();});this.pats=[];
    this.playing=true;Tone.Transport.bpm.value=tempo;
    // Kick: 1, 1-and-a, 3 (boom-bap)
    const kp=new Tone.Sequence((t,n)=>{if(!this.playing||!n)return;this.k.triggerAttackRelease(n,'8n',t);},
      ['C1',null,null,'C1',null,null,null,null,'C1',null,null,null,null,null,null,null],'16n');
    // Snare: 2 and 4
    const sp=new Tone.Sequence((t,n)=>{if(!this.playing||!n)return;this.s.triggerAttackRelease('8n',t);},
      [null,null,null,null,1,null,null,null,null,null,null,null,1,null,null,null],'16n');
    // Hats: 16ths with velocity groove
    const hp=new Tone.Sequence((t,v)=>{if(!this.playing)return;this.h.volume.value=-22+(v*4);this.h.triggerAttackRelease('32n',t);},
      [1,.3,.6,.3,.9,.3,.5,.4,1,.3,.6,.3,.9,.3,.5,.3],'16n');
    // Open hat on upbeats
    const ohp=new Tone.Sequence((t,n)=>{if(!this.playing||!n)return;this.oh.triggerAttackRelease('8n',t);},
      [null,null,null,null,null,null,null,1,null,null,null,null,null,null,null,1],'16n');
    kp.humanize='20ms';sp.humanize='15ms';hp.humanize='10ms';
    kp.start(0);sp.start(0);hp.start(0);ohp.start(0);
    this.pats=[kp,sp,hp,ohp];
    if(Tone.Transport.state!=='started')Tone.Transport.start();
    log('drums @'+tempo+'bpm');
  },
  stop(){
    this.playing=false;
    // Stop and dispose sequences before transport
    this.pats.forEach(p=>{try{p.stop(0);p.dispose();}catch(e){}});
    this.pats=[];
    // Small delay before stopping transport
    setTimeout(()=>{try{Tone.Transport.stop();Tone.Transport.cancel();}catch(e){}},50);
    log('stopped');
  }
};
const bpmSlider=document.getElementById('bpm'),bpmVal=document.getElementById('bpmVal');
bpmSlider.oninput=()=>{bpmVal.textContent=bpmSlider.value;if(Drums.playing)Tone.Transport.bpm.value=+bpmSlider.value;};
document.getElementById('play').onclick=async()=>{await Drums.play(+bpmSlider.value);document.getElementById('play').classList.add('on');};
document.getElementById('stop').onclick=()=>{Drums.stop();document.querySelectorAll('button').forEach(b=>b.classList.remove('on'));};
</script>
</body>
</html>
